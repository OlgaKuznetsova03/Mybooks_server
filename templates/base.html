{% load static %}
<!doctype html>
<html lang="ru" data-bs-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{% block title %}ReadTogether{% endblock %}</title>

  <!-- Bootstrap + Icons (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  {% block theme_colors %}
  <style>
    :root,
    [data-bs-theme="light"] {
      --rt-primary: #40535c;
      --rt-primary-rgb: 64, 83, 92;
      --rt-body-bg: #f7f3ee;
      --rt-body-color: #25323a;
      --rt-link-color: #40535c;
      --rt-link-hover: #2c3b42;
      --rt-card-shadow: 0 10px 24px rgba(0, 0, 0, 0.06);
      --rt-shelf-card-surface: #f3ebe1;
      --rt-shelf-card-shadow: 0 0.75rem 1.5rem rgba(33, 37, 41, 0.08);
      --rt-shelf-card-sheen: linear-gradient(160deg, rgba(255, 255, 255, 0.6), rgba(214, 197, 178, 0.25));
      --rt-shelf-card-highlight: linear-gradient(90deg, #9c6b3f, #c58d54, #9c6b3f);
      --rt-shelf-card-highlight-shadow: rgba(108, 63, 28, 0.4);

      --bs-primary: var(--rt-primary);
      --bs-primary-rgb: var(--rt-primary-rgb);
      --bs-body-bg: var(--rt-body-bg);
      --bs-body-color: var(--rt-body-color);
      --bs-link-color: var(--rt-link-color);
      --bs-link-hover-color: var(--rt-link-hover);
      --bs-btn-bg: var(--bs-primary);
      --bs-btn-border-color: var(--bs-primary);
      --bs-btn-hover-bg: #314148;
      --bs-btn-hover-border-color: #314148;
      --bs-btn-active-bg: #28353b;
      --bs-btn-active-border-color: #28353b;
    }

    [data-bs-theme="dark"] {
      --rt-primary: #9cc4d4;
      --rt-primary-rgb: 156, 196, 212;
      --rt-body-bg: #151a1e;
      --rt-body-color: #e6eaed;
      --rt-link-color: #9cc4d4;
      --rt-link-hover: #c0dbe6;
      --rt-card-shadow: 0 10px 24px rgba(0, 0, 0, 0.4);
      --rt-shelf-card-surface: #2a2a2a;
      --rt-shelf-card-shadow: 0 0.75rem 1.5rem rgba(0, 0, 0, 0.45);
      --rt-shelf-card-sheen: linear-gradient(160deg, rgba(58, 58, 58, 0.65), rgba(18, 18, 18, 0.45));
      --rt-shelf-card-highlight: linear-gradient(90deg, #6f451b, #8c5d29, #6f451b);
      --rt-shelf-card-highlight-shadow: rgba(0, 0, 0, 0.55);

      --bs-primary: var(--rt-primary);
      --bs-primary-rgb: var(--rt-primary-rgb);
      --bs-body-bg: var(--rt-body-bg);
      --bs-body-color: var(--rt-body-color);
      --bs-link-color: var(--rt-link-color);
      --bs-link-hover-color: var(--rt-link-hover);
    }
  </style>
  {% endblock %}
  
  <!-- Brand styles -->
  <link href="{% static 'books/styles.css' %}" rel="stylesheet">
  {% block extra_css %}{% endblock %}
</head>
<body class="bg-light{% block body_class %}{% endblock %}">

<!-- ===== NAVBAR + OFFCANVAS ===== -->
<nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
  <div class="container align-items-center">

    <!-- –ì–∞–º–±—É—Ä–≥–µ—Ä (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–µ–Ω) -->
    <button class="btn btn-outline-secondary me-2"
            type="button"
            data-bs-toggle="offcanvas"
            data-bs-target="#mainOffcanvas"
            aria-controls="mainOffcanvas"
            aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é">
      <i class="bi bi-list" style="font-size:1.5rem"></i>
    </button>

    <!-- –ë—Ä–µ–Ω–¥ -->
    <a class="navbar-brand fw-bold me-3" href="/">üìö ReadTogether</a>

    <!-- –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–µ–Ω—é (–¥–µ—Å–∫—Ç–æ–ø): –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç—å –ø—É–Ω–∫—Ç–æ–≤ -->
    <ul class="navbar-nav me-auto d-none d-lg-flex">
      <li class="nav-item"><a class="nav-link" href="{% url 'book_list' %}">–ö–Ω–∏–≥–∏</a></li>
      <li class="nav-item"><a class="nav-link" href="{% url 'shelves:reading_feed' %}">–õ–µ–Ω—Ç–∞</a></li>
      <li class="nav-item"><a class="nav-link" href="{% url 'shelves:reading_now' %}">–ß–∏—Ç–∞—é —Å–µ–π—á–∞—Å</a></li>
      <li class="nav-item"><a class="nav-link" href="{% url 'premium_overview' %}">–ü—Ä–µ–º–∏—É–º</a></li>
    </ul>

    <!-- –ü–æ–∏—Å–∫ (–¥–µ—Å–∫—Ç–æ–ø) -->
    <form class="d-none d-lg-flex me-3" method="get" action="{% url 'book_list' %}">
      <input class="form-control me-2" name="q" value="{{ q|default:'' }}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ, –∞–≤—Ç–æ—Ä, –∂–∞–Ω—Ä">
      <button class="btn btn-primary" type="submit"><i class="bi bi-search"></i></button>
    </form>

    <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã -->
    <button class="btn btn-outline-secondary me-2" id="themeToggle" type="button" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
      <i class="bi bi-moon"></i>
    </button>

    <!-- –ê–∫–∫–∞—É–Ω—Ç (–¥–µ—Å–∫—Ç–æ–ø) -->
    <div class="d-none d-lg-flex align-items-center">
      {% if request.user.is_authenticated %}
        <a class="btn btn-outline-secondary me-2" href="{% url 'profile' request.user.username %}">
          <i class="bi bi-person-circle me-1"></i>{{ request.user.username }}
        </a>
        <a class="btn btn-outline-danger" href="{% url 'logout' %}">–í—ã–π—Ç–∏</a>
      {% else %}
        <a class="btn btn-outline-primary me-2" href="{% url 'login' %}">–í–æ–π—Ç–∏</a>
        <a class="btn btn-primary" href="{% url 'signup' %}">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
      {% endif %}
    </div>
  </div>
</nav>

<!-- Offcanvas: –ü–û–õ–ù–û–ï –º–µ–Ω—é (–∏ –¥–ª—è –º–æ–±–∞–π–ª–∞, –∏ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞ –ø–æ –∫–Ω–æ–ø–∫–µ) -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="mainOffcanvas" aria-labelledby="mainOffcanvasLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="mainOffcanvasLabel">–ú–µ–Ω—é</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
  </div>
  <div class="offcanvas-body d-flex flex-column gap-3">

    <!-- –ü–æ–∏—Å–∫ (–≤–Ω—É—Ç—Ä–∏ offcanvas) -->
    <form class="d-flex" method="get" action="{% url 'book_list' %}">
      <input class="form-control me-2" name="q" value="{{ q|default:'' }}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ, –∞–≤—Ç–æ—Ä, –∂–∞–Ω—Ä">
      <button class="btn btn-primary" type="submit"><i class="bi bi-search"></i></button>
    </form>

    <ul class="navbar-nav" id="offcanvasLinks">
      <li class="nav-item"><a class="nav-link" href="{% url 'book_list' %}">–ö–Ω–∏–≥–∏</a></li>
      {% if request.user.is_authenticated %}
      <li class="nav-item"><a class="nav-link" href="{% url 'shelves:home_library' %}">–î–æ–º–∞—à–Ω—è—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞</a></li>
      {% endif %}
      <li class="nav-item"><a class="nav-link" href="{% url 'games:index' %}">–ò–≥—Ä—ã</a></li>
      <li class="nav-item"><a class="nav-link" href="{% url 'shelves:reading_feed' %}">–õ–µ–Ω—Ç–∞</a></li>
      <li class="nav-item"><a class="nav-link" href="{% url 'collaborations:offer_list' %}">–°–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ</a></li>
      <li class="nav-item"><a class="nav-link" href="{% url 'collaborations:blogger_community' %}">–ë–ª–æ–≥–µ—Ä—Å–∫–∏–π —Ö–∞–±</a></li>
      <li class="nav-item"><a class="nav-link" href="{% url 'reading_communities_overview' %}">–°–æ–≤–º–µ—Å—Ç–Ω—ã–µ —á—Ç–µ–Ω–∏—è –∏ –º–∞—Ä–∞—Ñ–æ–Ω—ã</a></li>
      <li class="nav-item"><a class="nav-link" href="{% url 'shelves:reading_now' %}">–ß–∏—Ç–∞—é —Å–µ–π—á–∞—Å</a></li>
      <li class="nav-item"><a class="nav-link" href="{% url 'premium_overview' %}">–ü—Ä–µ–º–∏—É–º</a></li>
    </ul>

    <hr class="my-2">

    <!-- –ê–∫–∫–∞—É–Ω—Ç (–≤–Ω—É—Ç—Ä–∏ offcanvas) -->
    <div class="d-grid gap-2">
      {% if request.user.is_authenticated %}
        <a class="btn btn-outline-secondary" href="{% url 'profile' request.user.username %}">
          <i class="bi bi-person-circle me-1"></i>{{ request.user.username }}
        </a>
        <a class="btn btn-outline-danger" href="{% url 'logout' %}">–í—ã–π—Ç–∏</a>
      {% else %}
        <a class="btn btn-outline-primary" href="{% url 'login' %}">–í–æ–π—Ç–∏</a>
        <a class="btn btn-primary" href="{% url 'signup' %}">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
      {% endif %}
    </div>
  </div>
</div>

<!-- –ù–µ–±–æ–ª—å—à–∞—è –ø–æ–¥—Å—Ç—Ä–æ–π–∫–∞ —Ü–≤–µ—Ç–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) -->
<style>
  .offcanvas { background: var(--bs-body-bg); color: var(--bs-body-color); }
  .offcanvas .nav-link { font-size: 1rem; }
</style>

<!-- –ù–∞–¥—ë–∂–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–∞–º –∏–∑ offcanvas -->
<script>
  (function () {
    const ocEl = document.getElementById('mainOffcanvas');
    if (!ocEl) return;
    const oc = bootstrap.Offcanvas.getOrCreateInstance(ocEl);

    // –î–µ–ª–µ–≥–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –ø–æ —Å—Å—ã–ª–∫–∞–º –≤–Ω—É—Ç—Ä–∏ offcanvas
    ocEl.addEventListener('click', function (e) {
      const link = e.target.closest('a.nav-link[href]');
      if (!link) return;
      const href = link.getAttribute('href');
      if (!href || href === '#') return;

      e.preventDefault();        // –∂–¥—ë–º –∑–∞–∫—Ä—ã—Ç–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
      oc.hide();                 // –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
      ocEl.addEventListener('hidden.bs.offcanvas', function handler() {
        ocEl.removeEventListener('hidden.bs.offcanvas', handler);
        window.location.assign(href);
      }, { once: true });
    }, false);
  })();
</script>
<!-- ===== /NAVBAR + OFFCANVAS ===== -->


<!-- (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ø–æ–¥—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥ —Ç–µ–º—É -->
<style>
  .offcanvas{ background: var(--bs-body-bg); color: var(--bs-body-color); }
  .offcanvas .nav-link{ font-size:1rem; }
</style>

<main class="container py-4">
    {% if messages %}
    <div class="mb-4">
      {% for message in messages %}
        {% with tag=message.level_tag %}
          {% if tag == 'error' %}
            {% with alert_class='danger' %}
              <div class="alert alert-{{ alert_class }} alert-dismissible fade show" role="alert">
                {{ message|safe }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
              </div>
            {% endwith %}
          {% elif tag == 'debug' %}
            {% with alert_class='secondary' %}
              <div class="alert alert-{{ alert_class }} alert-dismissible fade show" role="alert">
                {{ message|safe }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
              </div>
            {% endwith %}
          {% else %}
            <div class="alert alert-{{ tag }} alert-dismissible fade show" role="alert">
              {{ message|safe }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
            </div>
          {% endif %}
        {% endwith %}
      {% endfor %}
    </div>
  {% endif %}
  {% block content %}{% endblock %}
</main>

<footer class="border-top py-3 small text-muted bg-white">
  <div class="container d-flex justify-content-between">
    <div>¬© {% now "Y" %} ReadTogether</div>
    <div><a class="text-muted" href="mailto:hello@example.com">–°–≤—è–∑–∞—Ç—å—Å—è</a></div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Theme toggle (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä)
  const html = document.documentElement;
  const saved = localStorage.getItem('theme');
  if (saved) html.setAttribute('data-bs-theme', saved);
  document.getElementById('themeToggle')?.addEventListener('click', () => {
    const current = html.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark';
    html.setAttribute('data-bs-theme', current);
    localStorage.setItem('theme', current);
  });

  // –£–ª—É—á—à–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä –¥–ª—è select[multiple]
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('select[data-enhanced-multi]').forEach((select) => {
      if (select.dataset.enhancedMultiApplied === '1') {
        return;
      }
      select.dataset.enhancedMultiApplied = '1';

      if (!select.multiple) {
        return;
      }

      const options = Array.from(select.options);
      if (!options.length) {
        return;
      }

      const wrapper = document.createElement('div');
      wrapper.className = 'multi-select-enhanced border rounded-3 bg-body-tertiary p-3 mt-2';
      const list = document.createElement('div');
      list.className = 'multi-select-enhanced__list d-flex flex-column gap-2';

      options.forEach((option, index) => {
        const checkboxId = `${select.id || select.name}-choice-${index}`;
        const item = document.createElement('div');
        item.className = 'form-check';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'form-check-input';
        checkbox.id = checkboxId;
        checkbox.dataset.optionIndex = String(index);
        checkbox.checked = option.selected;
        checkbox.disabled = option.disabled;
        checkbox.addEventListener('change', () => {
          option.selected = checkbox.checked;
        });

        const label = document.createElement('label');
        label.className = 'form-check-label';
        label.setAttribute('for', checkboxId);
        label.textContent = option.textContent;

        item.appendChild(checkbox);
        item.appendChild(label);
        list.appendChild(item);
      });

      wrapper.appendChild(list);

      const controls = document.createElement('div');
      controls.className = 'd-flex justify-content-end mt-3';
      const clearButton = document.createElement('button');
      clearButton.type = 'button';
      clearButton.className = 'btn btn-outline-secondary btn-sm';
      clearButton.textContent = select.dataset.clearLabel || '–û—á–∏—Å—Ç–∏—Ç—å –≤—ã–±–æ—Ä';
      clearButton.addEventListener('click', () => {
        list.querySelectorAll('input[type="checkbox"]').forEach((checkbox) => {
          const idx = Number(checkbox.dataset.optionIndex || -1);
          if (idx >= 0) {
            options[idx].selected = false;
          }
          checkbox.checked = false;
        });
      });
      controls.appendChild(clearButton);
      wrapper.appendChild(controls);

      const originalId = select.id;
      if (originalId) {
        wrapper.id = `${originalId}__enhanced`;
        const labelEl = document.getElementById(`${originalId}_label`);
        if (labelEl) {
          labelEl.setAttribute('for', list.querySelector('input[type="checkbox"]')?.id || originalId);
          wrapper.setAttribute('aria-labelledby', labelEl.id);
        }
      }

      select.classList.add('visually-hidden');
      select.setAttribute('tabindex', '-1');
      select.insertAdjacentElement('afterend', wrapper);
    });
  });
</script>
{% block extra_js %}{% endblock %}
</body>
</html>
