{% load static %}
<!doctype html>
<html lang="ru" data-bs-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{% block title %}Калейдоскоп книг{% endblock %}</title>

  <!-- Bootstrap + Icons (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css?v={{ STATIC_VERSION }}" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css?v={{ STATIC_VERSION }}" rel="stylesheet">
  {% if not user.profile.has_active_premium %}
    <script src="https://yandex.ru/ads/system/context.js" async></script>
  {% endif %}

  {% block theme_colors %}
  <!-- Базовая цветовая тема сайта -->
  <style>
    :root,
    [data-bs-theme="light"] {
      --rt-primary: #40535c;
      --rt-primary-rgb: 64, 83, 92;
      --rt-body-bg: #f7f3ee;
      --rt-body-color: #25323a;
      --rt-link-color: #40535c;
      --rt-link-hover: #2c3b42;
      --rt-card-shadow: 0 10px 24px rgba(0, 0, 0, 0.06);

      --rt-shelf-card-surface: #f3ebe1;
      --rt-shelf-card-shadow: 0 0.75rem 1.5rem rgba(33, 37, 41, 0.08);
      --rt-shelf-card-sheen: linear-gradient(160deg, rgba(255, 255, 255, 0.6), rgba(214, 197, 178, 0.25));
      --rt-shelf-card-highlight: linear-gradient(90deg, #9c6b3f, #c58d54, #9c6b3f);
      --rt-shelf-card-highlight-shadow: rgba(108, 63, 28, 0.4);

      /* прокидываем в Bootstrap */
      --bs-primary: var(--rt-primary);
      --bs-primary-rgb: var(--rt-primary-rgb);
      --bs-body-bg: var(--rt-body-bg);
      --bs-body-color: var(--rt-body-color);
      --bs-link-color: var(--rt-link-color);
      --bs-link-hover-color: var(--rt-link-hover);
    }

    [data-bs-theme="dark"] {
      --rt-primary: #f8d794;
      --rt-primary-rgb: 248, 215, 148;
      --rt-body-bg: #111a19;
      --rt-body-color: #f8d794;
      --rt-link-color: #ffe4b0;
      --rt-link-hover: #ffefca;
      --rt-card-shadow: 0 10px 24px rgba(0, 0, 0, 0.55);

      --rt-shelf-card-surface: #1b2624;
      --rt-shelf-card-shadow: 0 0.75rem 1.5rem rgba(0, 0, 0, 0.6);
      --rt-shelf-card-sheen: linear-gradient(160deg, rgba(248, 215, 148, 0.14), rgba(17, 26, 25, 0.6));
      --rt-shelf-card-highlight: linear-gradient(90deg, #f8d794, #d6b379, #f8d794);
      --rt-shelf-card-highlight-shadow: rgba(0, 0, 0, 0.65);

      --bs-primary: var(--rt-primary);
      --bs-primary-rgb: var(--rt-primary-rgb);
      --bs-body-bg: var(--rt-body-bg);
      --bs-body-color: var(--rt-body-color);
      --bs-body-color-rgb: var(--rt-primary-rgb);
      --bs-link-color: var(--rt-link-color);
      --bs-link-hover-color: var(--rt-link-hover);
      --bs-emphasis-color: var(--rt-primary);
      --bs-secondary-color: rgba(248, 215, 148, 0.7);
      --bs-secondary-rgb: 248, 215, 148;
      --bs-tertiary-color: rgba(248, 215, 148, 0.5);
      --bs-border-color: rgba(248, 215, 148, 0.2);
      --bs-navbar-color: rgba(248, 215, 148, 0.85);
      --bs-navbar-hover-color: #f8d794;
      --bs-navbar-active-color: #f8d794;
      --bs-navbar-brand-color: #f8d794;
      --bs-navbar-brand-hover-color: #ffefca;
      --bs-nav-link-color: rgba(248, 215, 148, 0.8);
      --bs-nav-link-hover-color: #f8d794;
    }

    body {
      background-color: var(--bs-body-bg);
      color: var(--bs-body-color);
    }

    [data-bs-theme="dark"] .navbar {
      background-color: #111a19 !important;
    }

    [data-bs-theme="dark"] footer,
    [data-bs-theme="dark"] .bg-body {
      background-color: #121c1b !important;
    }

    [data-bs-theme="dark"] .bg-body-tertiary {
      background-color: #182421 !important;
    }

    [data-bs-theme="dark"] .border-top,
    [data-bs-theme="dark"] .border-bottom {
      border-color: rgba(248, 215, 148, 0.18) !important;
    }
  </style>
  {% endblock %}

  <!-- Глобальная тема кнопок «как в шапке» -->
  <style>
    :root{
      /* оттенки «жанровых» чипов */
      --rt-chip-text: #111;     /* почти чёрный текст для контраста */
      --rt-chip-bg:   #f1dfcc;  /* основной фон */
      --rt-chip-bg-h: #ead2bd;  /* hover */
      --rt-chip-bg-a: #e3c6ad;  /* active */
      --rt-chip-br:   #d7b89a;  /* тонкая рамка */
      --rt-focus:     201,135,91; /* фокусная подсветка */
    }
    [data-bs-theme="dark"]{
      /* в тёмной теме чуть темнее фон, но стиль тот же */
      --rt-chip-text:#111;
      --rt-chip-bg:#e8d7c5;
      --rt-chip-bg-h:#e0cbb6;
      --rt-chip-bg-a:#d9bea6;
      --rt-chip-br:#caa985;
    }

    /* База для всех .btn: превращаем в бежевые «пилюли» */
    .btn{
      --bs-btn-font-weight: 600;
      --bs-btn-padding-y: .475rem;
      --bs-btn-padding-x: .9rem;
      --bs-btn-border-radius: 999px;

      --bs-btn-color: var(--rt-chip-text);
      --bs-btn-bg: var(--rt-chip-bg);
      --bs-btn-border-color: var(--rt-chip-br);

      --bs-btn-hover-color: var(--rt-chip-text);
      --bs-btn-hover-bg: var(--rt-chip-bg-h);
      --bs-btn-hover-border-color: var(--rt-chip-br);

      --bs-btn-active-color: var(--rt-chip-text);
      --bs-btn-active-bg: var(--rt-chip-bg-a);
      --bs-btn-active-border-color: var(--rt-chip-br);

      --bs-btn-disabled-color: rgba(0,0,0,.55);
      --bs-btn-disabled-bg: #f5e8da;
      --bs-btn-disabled-border-color: #ead8c7;

      --bs-btn-focus-shadow-rgb: var(--rt-focus);
      box-shadow: none;
    }
    .btn:focus{ box-shadow: 0 0 0 .2rem rgba(var(--rt-focus), .25); }

    /* Любые цветовые вариации Bootstrap выглядят одинаково как «чипы» */
    .btn-primary,
    .btn-secondary,
    .btn-success,
    .btn-danger,
    .btn-warning,
    .btn-info,
    .btn-light,
    .btn-dark,
    .btn-outline-primary,
    .btn-outline-secondary,
    .btn-outline-success,
    .btn-outline-danger,
    .btn-outline-warning,
    .btn-outline-info,
    .btn-outline-light,
    .btn-outline-dark{
      --bs-btn-color: var(--rt-chip-text);
      --bs-btn-bg: var(--rt-chip-bg);
      --bs-btn-border-color: var(--rt-chip-br);
      --bs-btn-hover-color: var(--rt-chip-text);
      --bs-btn-hover-bg: var(--rt-chip-bg-h);
      --bs-btn-hover-border-color: var(--rt-chip-br);
      --bs-btn-active-color: var(--rt-chip-text);
      --bs-btn-active-bg: var(--rt-chip-bg-a);
      --bs-btn-active-border-color: var(--rt-chip-br);
    }

    /* Кнопки-ссылки */
    .btn-link{
      color: var(--rt-chip-text) !important;
      text-decoration: none;
      background: var(--rt-chip-bg);
      border: 1px solid var(--rt-chip-br);
      border-radius: 999px;
      padding: .45rem .85rem;
      font-weight: 600;
    }
    .btn-link:hover{ background: var(--rt-chip-bg-h); color: var(--rt-chip-text) !important; }

    /* Компактная версия */
    .btn-sm{
      --bs-btn-padding-y: .35rem;
      --bs-btn-padding-x: .65rem;
    }
  </style>

  <!-- Брендовые стили проекта -->
  <link href="{% static 'books/styles.css' %}?v={{ STATIC_VERSION }}" rel="stylesheet">

  {% block extra_css %}{% endblock %}
<head><!-- Yandex.RTB -->
<script>window.yaContextCb=window.yaContextCb||[]</script>
<script src="https://yandex.ru/ads/system/context.js" async></script></head>

<body class="bg-body{% block body_class %}{% endblock %}">

<!-- ===== NAVBAR + OFFCANVAS ===== -->
<nav class="navbar navbar-expand-lg bg-body border-bottom sticky-top">
  <div class="container align-items-center">

    <!-- Гамбургер (всегда виден) -->
    <button class="btn btn-outline-secondary me-2"
            type="button"
            data-bs-toggle="offcanvas"
            data-bs-target="#mainOffcanvas"
            aria-controls="mainOffcanvas"
            aria-label="Открыть меню">
      <i class="bi bi-list" style="font-size:1.5rem"></i>
    </button>

    <!-- Бренд -->
    <a class="navbar-brand fw-bold me-3 d-flex align-items-center" href="/">
      <img
        src="{% static 'img/logo_1.png' %}"
        alt="Логотип Калейдоскоп Книг"
        class="me-2"
        width="36"
        height="36"
      >
      <span>Калейдоскоп Книг</span>
    </a>

    <!-- Горизонтальное меню (десктоп) -->
    <ul class="navbar-nav me-auto d-none d-lg-flex">
      <li class="nav-item"><a class="nav-link" href="{% url 'book_list' %}">Книги</a></li>
      <li class="nav-item"><a class="nav-link" href="{% url 'shelves:reading_feed' %}">Лента</a></li>
      <li class="nav-item"><a class="nav-link" href="{% url 'shelves:reading_now' %}">Читаю сейчас</a></li>
      <li class="nav-item"><a class="nav-link" href="{% url 'premium_overview' %}">Премиум</a></li>
    </ul>

    <!-- Поиск (десктоп) -->
    <form class="d-none d-lg-flex me-3" method="get" action="{% url 'book_list' %}">
      <input class="form-control me-2" name="q" value="{{ q|default:'' }}" placeholder="Название, автор, жанр">
      <button class="btn" type="submit"><i class="bi bi-search"></i></button>
    </form>

      {% with notifications=collaboration_notifications %}
      <a
        class="btn btn-outline-secondary me-2 position-relative"
        href="{% url 'collaborations:collaboration_notifications' %}"
        aria-label="Уведомления сотрудничества"
      >
        <i class="bi {% if notifications.total %}bi-bell-fill{% else %}bi-bell{% endif %}"></i>
        {% if notifications.total %}
          <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
            {{ notifications.total }}
            <span class="visually-hidden">новых уведомлений</span>
          </span>
        {% endif %}
      </a>
    {% endwith %}

    <!-- Аккаунт (десктоп) -->
    <div class="d-none d-lg-flex align-items-center">
      {% if request.user.is_authenticated %}
        <a class="btn btn-outline-secondary me-2" href="{% url 'profile' request.user.username %}">
          <i class="bi bi-person-circle me-1"></i>{{ request.user.username }}
        </a>
        <a class="btn btn-outline-danger" href="{% url 'logout' %}">Выйти</a>
      {% else %}
        <a class="btn btn-outline-primary me-2" href="{% url 'login' %}">Войти</a>
        <a class="btn" href="{% url 'signup' %}">Регистрация</a>
      {% endif %}
    </div>
  </div>
</nav>

<!-- Offcanvas: ПОЛНОЕ меню -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="mainOffcanvas" aria-labelledby="mainOffcanvasLabel">
  <div class="offcanvas-header">
    <form class="d-flex" method="get" action="{% url 'book_list' %}">
      <input class="form-control me-2" name="q" value="{{ q|default:'' }}" placeholder="Название, автор, жанр">
      <button class="btn" type="submit"><i class="bi bi-search"></i></button>
    </form>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Закрыть"></button>
  </div>
  <div class="offcanvas-body d-flex flex-column gap-3">

    {% if request.user.is_authenticated %}
      <a
        class="btn btn-outline-secondary d-flex align-items-center justify-content-center gap-2"
        href="{% url 'profile' request.user.username %}"
      >
        <i class="bi bi-person-circle"></i>
        <span>{{ request.user.username }}</span>
      </a>
    {% endif %}

    <a
      class="offcanvas-title btn btn-primary d-flex align-items-center justify-content-center gap-2"
      id="mainOffcanvasLabel"
      href="{% url 'book_create' %}"
    >
      <i class="bi bi-plus-lg"></i>
      <span>Добавить книгу</span>
    </a>

    <ul class="navbar-nav" id="offcanvasLinks">
      <li class="nav-item">
        <a class="nav-link d-flex align-items-center gap-2" href="{% url 'book_list' %}">
          <i class="bi bi-journal-bookmark"></i>
          <span>Книги</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link d-flex align-items-center gap-2" href="{% url 'shelves:reading_now' %}">
          <i class="bi bi-bookmark-check"></i>
          <span>Читаю сейчас</span>
        </a>
      </li>
      {% if request.user.is_authenticated %}
      <li class="nav-item">
        <a class="nav-link d-flex align-items-center gap-2" href="{% url 'shelves:home_library' %}">
          <i class="bi bi-house-heart"></i>
          <span>Домашняя библиотека</span>
        </a>
      </li>
      {% endif %}
      <li class="nav-item">
        <a class="nav-link d-flex align-items-center gap-2" href="{% url 'reading_communities_overview' %}">
          <i class="bi bi-chat-dots"></i>
          <span>Совместные чтения и марафоны</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link d-flex align-items-center gap-2" href="{% url 'games:index' %}">
          <i class="bi bi-controller"></i>
          <span>Игры</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link d-flex align-items-center gap-2" href="{% url 'shelves:reading_feed' %}">
          <i class="bi bi-stars"></i>
          <span>Отзывы и Рейтинг</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link d-flex align-items-center gap-2" href="{% url 'collaborations:offer_list' %}">
          <i class="bi bi-people"></i>
          <span>Сотрудничество</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link d-flex align-items-center gap-2" href="{% url 'collaborations:blogger_community' %}">
          <i class="bi bi-megaphone"></i>
          <span>Блогерский хаб</span>
        </a>
      </li>
      <li class="nav-item">
        <a
          class="nav-link d-flex align-items-center justify-content-between gap-2"
          href="{% url 'collaborations:collaboration_notifications' %}"
        >
          <span class="d-flex align-items-center gap-2">
            <i class="bi bi-bell"></i>
            <span>Уведомления</span>
          </span>
          {% if collaboration_notifications.total %}
            <span class="badge text-bg-secondary">{{ collaboration_notifications.total }}</span>
          {% endif %}
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link d-flex align-items-center gap-2" href="{% url 'premium_overview' %}">
          <i class="bi bi-gem"></i>
          <span>Премиум</span>
        </a>
      </li>
    </ul>

    <hr class="my-2">

    <!-- Аккаунт -->
    <div class="d-grid gap-2">
      {% if request.user.is_authenticated %}
        <a class="btn btn-outline-danger d-flex align-items-center justify-content-center gap-2" href="{% url 'logout' %}">
          <i class="bi bi-box-arrow-right"></i>
          <span>Выйти</span>
        </a>
      {% else %}
        <a class="btn btn-outline-primary d-flex align-items-center justify-content-center gap-2" href="{% url 'login' %}">
          <i class="bi bi-box-arrow-in-right"></i>
          <span>Войти</span>
        </a>
        <a class="btn d-flex align-items-center justify-content-center gap-2" href="{% url 'signup' %}">
          <i class="bi bi-pencil-square"></i>
          <span>Регистрация</span>
        </a>
      {% endif %}
    </div>
  </div>
</div>

<!-- Небольшая подстройка цветов Offcanvas -->
<style>
  .offcanvas { background: var(--bs-body-bg); color: var(--bs-body-color); }
  .offcanvas .nav-link { font-size: 1rem; }
</style>

<!-- Надёжный переход по ссылкам из offcanvas -->
<script>
  (function () {
    const ocEl = document.getElementById('mainOffcanvas');
    if (!ocEl) return;
    const oc = bootstrap.Offcanvas.getOrCreateInstance(ocEl);

    ocEl.addEventListener('click', function (e) {
      const link = e.target.closest('a.nav-link[href]');
      if (!link) return;
      const href = link.getAttribute('href');
      if (!href || href === '#') return;

      e.preventDefault();
      oc.hide();
      ocEl.addEventListener('hidden.bs.offcanvas', function handler() {
        ocEl.removeEventListener('hidden.bs.offcanvas', handler);
        window.location.assign(href);
      }, { once: true });
    }, false);
  })();
</script>
<!-- ===== /NAVBAR + OFFCANVAS ===== -->

<main class="container py-4">
  {% if messages %}
    <div class="mb-4">
      {% for message in messages %}
        {% with tag=message.level_tag %}
          {% if tag == 'error' %}
            {% with alert_class='danger' %}
              <div class="alert alert-{{ alert_class }} alert-dismissible fade show" role="alert">
                {{ message|safe }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
              </div>
            {% endwith %}
          {% elif tag == 'debug' %}
            {% with alert_class='secondary' %}
              <div class="alert alert-{{ alert_class }} alert-dismissible fade show" role="alert">
                {{ message|safe }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
              </div>
            {% endwith %}
          {% else %}
            <div class="alert alert-{{ tag }} alert-dismissible fade show" role="alert">
              {{ message|safe }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
            </div>
          {% endif %}
        {% endwith %}
      {% endfor %}
    </div>
  {% endif %}

  {% block content %}{% endblock %}
</main>

<div class="border-top bg-body-tertiary">
  <div class="container py-3">
    <div id="yandex_rtb_R-A-1780994-1" class="yandex-ads-banner"></div>
  </div>
</div>

<script>
  window.yaContextCb = window.yaContextCb || [];
  window.yaContextCb.push(() => {
    if (window.Ya && Ya.Context && Ya.Context.AdvManager) {
      Ya.Context.AdvManager.render({
        blockId: "R-A-1780994-1",
        renderTo: "yandex_rtb_R-A-1780994-1",
        horizontalAlign: true,
      });
    }
  });
</script>

<footer class="border-top py-3 small text-muted bg-body">
  <div class="container d-flex justify-content-between">
    <div>© {% now "Y" %} Калейдоскоп Книг</div>
    <div><a class="text-muted" href="mailto:info@kalejdoskopknig.ru">Связаться</a></div>
    <div>Кузнецов С.В.</div>
    <div>ИНН: 774391787507</div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Theme toggle (сохраняем выбор)
  const html = document.documentElement;
  const saved = localStorage.getItem('theme');
  if (saved) html.setAttribute('data-bs-theme', saved);
  document.getElementById('themeToggle')?.addEventListener('click', () => {
    const current = html.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark';
    html.setAttribute('data-bs-theme', current);
    localStorage.setItem('theme', current);
  });

  // Улучшенный выбор для select[multiple]
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('select[data-enhanced-multi]').forEach((select) => {
      if (select.dataset.enhancedMultiApplied === '1') return;
      select.dataset.enhancedMultiApplied = '1';
      if (!select.multiple) return;

      const options = Array.from(select.options);
      if (!options.length) return;

      const wrapper = document.createElement('div');
      wrapper.className = 'multi-select-enhanced border rounded-3 bg-body-tertiary p-3 mt-2';
      const list = document.createElement('div');
      list.className = 'multi-select-enhanced__list d-flex flex-column gap-2';

      options.forEach((option, index) => {
        const checkboxId = `${select.id || select.name}-choice-${index}`;
        const item = document.createElement('div');
        item.className = 'form-check';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'form-check-input';
        checkbox.id = checkboxId;
        checkbox.dataset.optionIndex = String(index);
        checkbox.checked = option.selected;
        checkbox.disabled = option.disabled;
        checkbox.addEventListener('change', () => { option.selected = checkbox.checked; });

        const label = document.createElement('label');
        label.className = 'form-check-label';
        label.setAttribute('for', checkboxId);
        label.textContent = option.textContent;

        item.appendChild(checkbox);
        item.appendChild(label);
        list.appendChild(item);
      });

      wrapper.appendChild(list);

      const controls = document.createElement('div');
      controls.className = 'd-flex justify-content-end mt-3';
      const clearButton = document.createElement('button');
      clearButton.type = 'button';
      clearButton.className = 'btn btn-outline-secondary btn-sm';
      clearButton.textContent = select.dataset.clearLabel || 'Очистить выбор';
      clearButton.addEventListener('click', () => {
        list.querySelectorAll('input[type="checkbox"]').forEach((checkbox) => {
          const idx = Number(checkbox.dataset.optionIndex || -1);
          if (idx >= 0) options[idx].selected = false;
          checkbox.checked = false;
        });
      });
      controls.appendChild(clearButton);
      wrapper.appendChild(controls);

      const originalId = select.id;
      if (originalId) {
        wrapper.id = `${originalId}__enhanced`;
        const labelEl = document.getElementById(`${originalId}_label`);
        if (labelEl) {
          labelEl.setAttribute('for', list.querySelector('input[type="checkbox"]')?.id || originalId);
          wrapper.setAttribute('aria-labelledby', labelEl.id);
        }
      }

      select.classList.add('visually-hidden');
      select.setAttribute('tabindex', '-1');
      select.insertAdjacentElement('afterend', wrapper);
    });
  });
</script>

{% block extra_js %}{% endblock %}
</body>
</html>
