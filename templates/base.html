{% load static %}
<!doctype html>
<html lang="ru" data-bs-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{% block title %}ReadTogether{% endblock %}</title>

  <!-- Bootstrap + Icons (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  {% block theme_colors %}
  <style>
    /* Default theme color (override via the ``theme_colors`` block in child templates) */
    :root {
      --rt-primary: #40535c;
      --rt-primary-rgb: 64, 83, 92;
    }
  </style>
  {% endblock %}
  
  <!-- Brand styles -->
  <link href="{% static 'books/styles.css' %}" rel="stylesheet">
  {% block extra_css %}{% endblock %}
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
  <div class="container">
    <a class="navbar-brand fw-bold" href="/">üìö ReadTogether</a>
    <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#nav"><span class="navbar-toggler-icon"></span></button>
    <div id="nav" class="collapse navbar-collapse">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link" href="{% url 'book_list' %}">–ö–Ω–∏–≥–∏</a></li>
        {% if request.user.is_authenticated %}
        <li class="nav-item"><a class="nav-link" href="{% url 'home_library' %}">–î–æ–º–∞—à–Ω—è—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞</a></li>
        {% endif %}
        <li class="nav-item"><a class="nav-link" href="{% url 'games:index' %}">–ò–≥—Ä—ã</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'reading_feed' %}">–õ–µ–Ω—Ç–∞</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'collaborations:offer_list' %}">–°–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'reading_communities_overview' %}">–°–æ–≤–º–µ—Å—Ç–Ω—ã–µ —á—Ç–µ–Ω–∏—è –∏ –º–∞—Ä–∞—Ñ–æ–Ω—ã</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'reading_now' %}">–ß–∏—Ç–∞—é —Å–µ–π—á–∞—Å</a></li>
      </ul>

      <form class="d-flex me-3" method="get" action="{% url 'book_list' %}">
        <input class="form-control me-2" name="q" value="{{ q|default:'' }}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ, –∞–≤—Ç–æ—Ä, –∂–∞–Ω—Ä">
        <button class="btn btn-primary"><i class="bi bi-search"></i></button>
      </form>

      <button class="btn btn-outline-secondary me-2" id="themeToggle" type="button" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
        <i class="bi bi-moon"></i>
      </button>

      {% if request.user.is_authenticated %}
         <a class="btn btn-outline-secondary me-2" href="{% url 'profile' request.user.username %}">
           <i class="bi bi-person-circle me-1"></i>{{ request.user.username }}
         </a>
         <a class="btn btn-outline-danger" href="{% url 'logout' %}">–í—ã–π—Ç–∏</a>
      {% else %}
         <a class="btn btn-outline-primary me-2" href="{% url 'login' %}">–í–æ–π—Ç–∏</a>
         <a class="btn btn-primary" href="{% url 'signup' %}">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
      {% endif %}
    </div>
  </div>
</nav>

<main class="container py-4">
    {% if messages %}
    <div class="mb-4">
      {% for message in messages %}
        {% with tag=message.level_tag %}
          {% if tag == 'error' %}
            {% with alert_class='danger' %}
              <div class="alert alert-{{ alert_class }} alert-dismissible fade show" role="alert">
                {{ message|safe }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
              </div>
            {% endwith %}
          {% elif tag == 'debug' %}
            {% with alert_class='secondary' %}
              <div class="alert alert-{{ alert_class }} alert-dismissible fade show" role="alert">
                {{ message|safe }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
              </div>
            {% endwith %}
          {% else %}
            <div class="alert alert-{{ tag }} alert-dismissible fade show" role="alert">
              {{ message|safe }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
            </div>
          {% endif %}
        {% endwith %}
      {% endfor %}
    </div>
  {% endif %}
  {% block content %}{% endblock %}
</main>

<footer class="border-top py-3 small text-muted bg-white">
  <div class="container d-flex justify-content-between">
    <div>¬© {{ now|date:"Y" }} ReadTogether</div>
    <div><a class="text-muted" href="mailto:hello@example.com">–°–≤—è–∑–∞—Ç—å—Å—è</a></div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Theme toggle (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä)
  const html = document.documentElement;
  const saved = localStorage.getItem('theme');
  if (saved) html.setAttribute('data-bs-theme', saved);
  document.getElementById('themeToggle')?.addEventListener('click', () => {
    const current = html.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark';
    html.setAttribute('data-bs-theme', current);
    localStorage.setItem('theme', current);
  });

  // –£–ª—É—á—à–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä –¥–ª—è select[multiple]
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('select[data-enhanced-multi]').forEach((select) => {
      if (select.dataset.enhancedMultiApplied === '1') {
        return;
      }
      select.dataset.enhancedMultiApplied = '1';

      if (!select.multiple) {
        return;
      }

      const options = Array.from(select.options);
      if (!options.length) {
        return;
      }

      const wrapper = document.createElement('div');
      wrapper.className = 'multi-select-enhanced border rounded-3 bg-body-tertiary p-3 mt-2';
      const list = document.createElement('div');
      list.className = 'multi-select-enhanced__list d-flex flex-column gap-2';

      options.forEach((option, index) => {
        const checkboxId = `${select.id || select.name}-choice-${index}`;
        const item = document.createElement('div');
        item.className = 'form-check';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'form-check-input';
        checkbox.id = checkboxId;
        checkbox.dataset.optionIndex = String(index);
        checkbox.checked = option.selected;
        checkbox.disabled = option.disabled;
        checkbox.addEventListener('change', () => {
          option.selected = checkbox.checked;
        });

        const label = document.createElement('label');
        label.className = 'form-check-label';
        label.setAttribute('for', checkboxId);
        label.textContent = option.textContent;

        item.appendChild(checkbox);
        item.appendChild(label);
        list.appendChild(item);
      });

      wrapper.appendChild(list);

      const controls = document.createElement('div');
      controls.className = 'd-flex justify-content-end mt-3';
      const clearButton = document.createElement('button');
      clearButton.type = 'button';
      clearButton.className = 'btn btn-outline-secondary btn-sm';
      clearButton.textContent = select.dataset.clearLabel || '–û—á–∏—Å—Ç–∏—Ç—å –≤—ã–±–æ—Ä';
      clearButton.addEventListener('click', () => {
        list.querySelectorAll('input[type="checkbox"]').forEach((checkbox) => {
          const idx = Number(checkbox.dataset.optionIndex || -1);
          if (idx >= 0) {
            options[idx].selected = false;
          }
          checkbox.checked = false;
        });
      });
      controls.appendChild(clearButton);
      wrapper.appendChild(controls);

      const originalId = select.id;
      if (originalId) {
        wrapper.id = `${originalId}__enhanced`;
        const labelEl = document.getElementById(`${originalId}_label`);
        if (labelEl) {
          labelEl.setAttribute('for', list.querySelector('input[type="checkbox"]')?.id || originalId);
          wrapper.setAttribute('aria-labelledby', labelEl.id);
        }
      }

      select.classList.add('visually-hidden');
      select.setAttribute('tabindex', '-1');
      select.insertAdjacentElement('afterend', wrapper);
    });
  });
</script>
{% block extra_js %}{% endblock %}
</body>
</html>
