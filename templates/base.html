{% load static %}
<!doctype html>
<html lang="ru" data-bs-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{% block title %}–ö–∞–ª–µ–π–¥–æ—Å–∫–æ–ø –∫–Ω–∏–≥{% endblock %}</title>

  <!-- Bootstrap + Icons (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css?v={{ STATIC_VERSION }}" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css?v={{ STATIC_VERSION }}" rel="stylesheet">
  <script src="https://yandex.ru/ads/system/context.js" async></script>

  {% block theme_colors %}
  <!-- –ë–∞–∑–æ–≤–∞—è —Ü–≤–µ—Ç–æ–≤–∞—è —Ç–µ–º–∞ —Å–∞–π—Ç–∞ -->
  <style>
    :root,
    [data-bs-theme="light"] {
      --rt-primary: #40535c;
      --rt-primary-rgb: 64, 83, 92;
      --rt-body-bg: #f7f3ee;
      --rt-body-color: #25323a;
      --rt-link-color: #40535c;
      --rt-link-hover: #2c3b42;
      --rt-card-shadow: 0 10px 24px rgba(0, 0, 0, 0.06);

      --rt-shelf-card-surface: #f3ebe1;
      --rt-shelf-card-shadow: 0 0.75rem 1.5rem rgba(33, 37, 41, 0.08);
      --rt-shelf-card-sheen: linear-gradient(160deg, rgba(255, 255, 255, 0.6), rgba(214, 197, 178, 0.25));
      --rt-shelf-card-highlight: linear-gradient(90deg, #9c6b3f, #c58d54, #9c6b3f);
      --rt-shelf-card-highlight-shadow: rgba(108, 63, 28, 0.4);

      /* –ø—Ä–æ–∫–∏–¥—ã–≤–∞–µ–º –≤ Bootstrap */
      --bs-primary: var(--rt-primary);
      --bs-primary-rgb: var(--rt-primary-rgb);
      --bs-body-bg: var(--rt-body-bg);
      --bs-body-color: var(--rt-body-color);
      --bs-link-color: var(--rt-link-color);
      --bs-link-hover-color: var(--rt-link-hover);
    }

    [data-bs-theme="dark"] {
      --rt-primary: #f8d794;
      --rt-primary-rgb: 248, 215, 148;
      --rt-body-bg: #111a19;
      --rt-body-color: #f8d794;
      --rt-link-color: #ffe4b0;
      --rt-link-hover: #ffefca;
      --rt-card-shadow: 0 10px 24px rgba(0, 0, 0, 0.55);

      --rt-shelf-card-surface: #1b2624;
      --rt-shelf-card-shadow: 0 0.75rem 1.5rem rgba(0, 0, 0, 0.6);
      --rt-shelf-card-sheen: linear-gradient(160deg, rgba(248, 215, 148, 0.14), rgba(17, 26, 25, 0.6));
      --rt-shelf-card-highlight: linear-gradient(90deg, #f8d794, #d6b379, #f8d794);
      --rt-shelf-card-highlight-shadow: rgba(0, 0, 0, 0.65);

      --bs-primary: var(--rt-primary);
      --bs-primary-rgb: var(--rt-primary-rgb);
      --bs-body-bg: var(--rt-body-bg);
      --bs-body-color: var(--rt-body-color);
      --bs-body-color-rgb: var(--rt-primary-rgb);
      --bs-link-color: var(--rt-link-color);
      --bs-link-hover-color: var(--rt-link-hover);
      --bs-emphasis-color: var(--rt-primary);
      --bs-secondary-color: rgba(248, 215, 148, 0.7);
      --bs-secondary-rgb: 248, 215, 148;
      --bs-tertiary-color: rgba(248, 215, 148, 0.5);
      --bs-border-color: rgba(248, 215, 148, 0.2);
      --bs-navbar-color: rgba(248, 215, 148, 0.85);
      --bs-navbar-hover-color: #f8d794;
      --bs-navbar-active-color: #f8d794;
      --bs-navbar-brand-color: #f8d794;
      --bs-navbar-brand-hover-color: #ffefca;
      --bs-nav-link-color: rgba(248, 215, 148, 0.8);
      --bs-nav-link-hover-color: #f8d794;
    }

    body {
      background-color: var(--bs-body-bg);
      color: var(--bs-body-color);
    }

    [data-bs-theme="dark"] .navbar {
      background-color: #111a19 !important;
    }

    [data-bs-theme="dark"] footer,
    [data-bs-theme="dark"] .bg-body {
      background-color: #121c1b !important;
    }

    [data-bs-theme="dark"] .bg-body-tertiary {
      background-color: #182421 !important;
    }

    [data-bs-theme="dark"] .border-top,
    [data-bs-theme="dark"] .border-bottom {
      border-color: rgba(248, 215, 148, 0.18) !important;
    }
  </style>
  {% endblock %}

  <!-- –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ç–µ–º–∞ –∫–Ω–æ–ø–æ–∫ ¬´–∫–∞–∫ –≤ —à–∞–ø–∫–µ¬ª -->
  <style>
    :root{
      /* –æ—Ç—Ç–µ–Ω–∫–∏ ¬´–∂–∞–Ω—Ä–æ–≤—ã—Ö¬ª —á–∏–ø–æ–≤ */
      --rt-chip-text: #111;     /* –ø–æ—á—Ç–∏ —á—ë—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ */
      --rt-chip-bg:   #f1dfcc;  /* –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ–Ω */
      --rt-chip-bg-h: #ead2bd;  /* hover */
      --rt-chip-bg-a: #e3c6ad;  /* active */
      --rt-chip-br:   #d7b89a;  /* —Ç–æ–Ω–∫–∞—è —Ä–∞–º–∫–∞ */
      --rt-focus:     201,135,91; /* —Ñ–æ–∫—É—Å–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ */
    }
    [data-bs-theme="dark"]{
      /* –≤ —Ç—ë–º–Ω–æ–π —Ç–µ–º–µ —á—É—Ç—å —Ç–µ–º–Ω–µ–µ —Ñ–æ–Ω, –Ω–æ —Å—Ç–∏–ª—å —Ç–æ—Ç –∂–µ */
      --rt-chip-text:#111;
      --rt-chip-bg:#e8d7c5;
      --rt-chip-bg-h:#e0cbb6;
      --rt-chip-bg-a:#d9bea6;
      --rt-chip-br:#caa985;
    }

    /* –ë–∞–∑–∞ –¥–ª—è –≤—Å–µ—Ö .btn: –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º –≤ –±–µ–∂–µ–≤—ã–µ ¬´–ø–∏–ª—é–ª–∏¬ª */
    .btn{
      --bs-btn-font-weight: 600;
      --bs-btn-padding-y: .475rem;
      --bs-btn-padding-x: .9rem;
      --bs-btn-border-radius: 999px;

      --bs-btn-color: var(--rt-chip-text);
      --bs-btn-bg: var(--rt-chip-bg);
      --bs-btn-border-color: var(--rt-chip-br);

      --bs-btn-hover-color: var(--rt-chip-text);
      --bs-btn-hover-bg: var(--rt-chip-bg-h);
      --bs-btn-hover-border-color: var(--rt-chip-br);

      --bs-btn-active-color: var(--rt-chip-text);
      --bs-btn-active-bg: var(--rt-chip-bg-a);
      --bs-btn-active-border-color: var(--rt-chip-br);

      --bs-btn-disabled-color: rgba(0,0,0,.55);
      --bs-btn-disabled-bg: #f5e8da;
      --bs-btn-disabled-border-color: #ead8c7;

      --bs-btn-focus-shadow-rgb: var(--rt-focus);
      box-shadow: none;
    }
    .btn:focus{ box-shadow: 0 0 0 .2rem rgba(var(--rt-focus), .25); }

    /* –õ—é–±—ã–µ —Ü–≤–µ—Ç–æ–≤—ã–µ –≤–∞—Ä–∏–∞—Ü–∏–∏ Bootstrap –≤—ã–≥–ª—è–¥—è—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ –∫–∞–∫ ¬´—á–∏–ø—ã¬ª */
    .btn-primary,
    .btn-secondary,
    .btn-success,
    .btn-danger,
    .btn-warning,
    .btn-info,
    .btn-light,
    .btn-dark,
    .btn-outline-primary,
    .btn-outline-secondary,
    .btn-outline-success,
    .btn-outline-danger,
    .btn-outline-warning,
    .btn-outline-info,
    .btn-outline-light,
    .btn-outline-dark{
      --bs-btn-color: var(--rt-chip-text);
      --bs-btn-bg: var(--rt-chip-bg);
      --bs-btn-border-color: var(--rt-chip-br);
      --bs-btn-hover-color: var(--rt-chip-text);
      --bs-btn-hover-bg: var(--rt-chip-bg-h);
      --bs-btn-hover-border-color: var(--rt-chip-br);
      --bs-btn-active-color: var(--rt-chip-text);
      --bs-btn-active-bg: var(--rt-chip-bg-a);
      --bs-btn-active-border-color: var(--rt-chip-br);
    }

    /* –ö–Ω–æ–ø–∫–∏-—Å—Å—ã–ª–∫–∏ */
    .btn-link{
      color: var(--rt-chip-text) !important;
      text-decoration: none;
      background: var(--rt-chip-bg);
      border: 1px solid var(--rt-chip-br);
      border-radius: 999px;
      padding: .45rem .85rem;
      font-weight: 600;
    }
    .btn-link:hover{ background: var(--rt-chip-bg-h); color: var(--rt-chip-text) !important; }

    /* –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –≤–µ—Ä—Å–∏—è */
    .btn-sm{
      --bs-btn-padding-y: .35rem;
      --bs-btn-padding-x: .65rem;
    }
  </style>

  <!-- –ë—Ä–µ–Ω–¥–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞ -->
  <link href="{% static 'books/styles.css' %}?v={{ STATIC_VERSION }}" rel="stylesheet">

  {% block extra_css %}{% endblock %}
<head><!-- Yandex.RTB -->
<script>window.yaContextCb=window.yaContextCb||[]</script>
<script src="https://yandex.ru/ads/system/context.js" async></script></head>

<body class="bg-body{% block body_class %}{% endblock %}">

<!-- ===== NAVBAR + OFFCANVAS ===== -->
<nav class="navbar navbar-expand-lg bg-body border-bottom sticky-top">
  <div class="container align-items-center">

    <!-- –ì–∞–º–±—É—Ä–≥–µ—Ä (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–µ–Ω) -->
    <button class="btn btn-outline-secondary me-2"
            type="button"
            data-bs-toggle="offcanvas"
            data-bs-target="#mainOffcanvas"
            aria-controls="mainOffcanvas"
            aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é">
      <i class="bi bi-list" style="font-size:1.5rem"></i>
    </button>

    <!-- –ë—Ä–µ–Ω–¥ -->
    <a class="navbar-brand fw-bold me-3" href="/">üìö –ö–∞–ª–µ–π–¥–æ—Å–∫–æ–ø –ö–Ω–∏–≥</a>

    <!-- –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–µ–Ω—é (–¥–µ—Å–∫—Ç–æ–ø) -->
    <ul class="navbar-nav me-auto d-none d-lg-flex">
      <li class="nav-item"><a class="nav-link" href="{% url 'book_list' %}">–ö–Ω–∏–≥–∏</a></li>
      <li class="nav-item"><a class="nav-link" href="{% url 'shelves:reading_feed' %}">–õ–µ–Ω—Ç–∞</a></li>
      <li class="nav-item"><a class="nav-link" href="{% url 'shelves:reading_now' %}">–ß–∏—Ç–∞—é —Å–µ–π—á–∞—Å</a></li>
      <li class="nav-item"><a class="nav-link" href="{% url 'premium_overview' %}">–ü—Ä–µ–º–∏—É–º</a></li>
    </ul>

    <!-- –ü–æ–∏—Å–∫ (–¥–µ—Å–∫—Ç–æ–ø) -->
    <form class="d-none d-lg-flex me-3" method="get" action="{% url 'book_list' %}">
      <input class="form-control me-2" name="q" value="{{ q|default:'' }}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ, –∞–≤—Ç–æ—Ä, –∂–∞–Ω—Ä">
      <button class="btn" type="submit"><i class="bi bi-search"></i></button>
    </form>

    <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã -->
    <button class="btn btn-outline-secondary me-2" id="themeToggle" type="button" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
      <i class="bi bi-moon"></i>
    </button>

      {% with notifications=collaboration_notifications %}
      <a
        class="btn btn-outline-secondary me-2 position-relative"
        href="{% url 'collaborations:collaboration_notifications' %}"
        aria-label="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞"
      >
        <i class="bi {% if notifications.total %}bi-bell-fill{% else %}bi-bell{% endif %}"></i>
        {% if notifications.total %}
          <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
            {{ notifications.total }}
            <span class="visually-hidden">–Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</span>
          </span>
        {% endif %}
      </a>
    {% endwith %}

    <!-- –ê–∫–∫–∞—É–Ω—Ç (–¥–µ—Å–∫—Ç–æ–ø) -->
    <div class="d-none d-lg-flex align-items-center">
      {% if request.user.is_authenticated %}
        <a class="btn btn-outline-secondary me-2" href="{% url 'profile' request.user.username %}">
          <i class="bi bi-person-circle me-1"></i>{{ request.user.username }}
        </a>
        <a class="btn btn-outline-danger" href="{% url 'logout' %}">–í—ã–π—Ç–∏</a>
      {% else %}
        <a class="btn btn-outline-primary me-2" href="{% url 'login' %}">–í–æ–π—Ç–∏</a>
        <a class="btn" href="{% url 'signup' %}">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
      {% endif %}
    </div>
  </div>
</nav>

<!-- Offcanvas: –ü–û–õ–ù–û–ï –º–µ–Ω—é -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="mainOffcanvas" aria-labelledby="mainOffcanvasLabel">
  <div class="offcanvas-header">
    <form class="d-flex" method="get" action="{% url 'book_list' %}">
      <input class="form-control me-2" name="q" value="{{ q|default:'' }}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ, –∞–≤—Ç–æ—Ä, –∂–∞–Ω—Ä">
      <button class="btn" type="submit"><i class="bi bi-search"></i></button>
    </form>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
  </div>
  <div class="offcanvas-body d-flex flex-column gap-3">

    <!-- –ü–æ–∏—Å–∫ -->
    <a class="offcanvas-title btn btn-primary" id="mainOffcanvasLabel" href="{% url 'book_create' %}">
      <i class="bi bi-plus-lg me-2"></i>–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É
    </a>

    <ul class="navbar-nav" id="offcanvasLinks">
      <li class="nav-item"><a class="nav-link" href="{% url 'book_list' %}">–ö–Ω–∏–≥–∏</a></li>
      {% if request.user.is_authenticated %}
      <li class="nav-item"><a class="nav-link" href="{% url 'shelves:home_library' %}">–î–æ–º–∞—à–Ω—è—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞</a></li>
      {% endif %}
      <li class="nav-item"><a class="nav-link" href="{% url 'games:index' %}">–ò–≥—Ä—ã</a></li>
      <li class="nav-item"><a class="nav-link" href="{% url 'shelves:reading_feed' %}">–õ–µ–Ω—Ç–∞</a></li>
      <li class="nav-item"><a class="nav-link" href="{% url 'collaborations:offer_list' %}">–°–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ</a></li>
      <li class="nav-item"><a class="nav-link" href="{% url 'collaborations:blogger_community' %}">–ë–ª–æ–≥–µ—Ä—Å–∫–∏–π —Ö–∞–±</a></li>
      <li class="nav-item">
        <a class="nav-link d-flex justify-content-between align-items-center" href="{% url 'collaborations:collaboration_notifications' %}">
          <span>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
          {% if collaboration_notifications.total %}
            <span class="badge text-bg-secondary">{{ collaboration_notifications.total }}</span>
          {% endif %}
        </a>
      </li>
      <li class="nav-item"><a class="nav-link" href="{% url 'reading_communities_overview' %}">–°–æ–≤–º–µ—Å—Ç–Ω—ã–µ —á—Ç–µ–Ω–∏—è –∏ –º–∞—Ä–∞—Ñ–æ–Ω—ã</a></li>
      <li class="nav-item"><a class="nav-link" href="{% url 'shelves:reading_now' %}">–ß–∏—Ç–∞—é —Å–µ–π—á–∞—Å</a></li>
      <li class="nav-item"><a class="nav-link" href="{% url 'premium_overview' %}">–ü—Ä–µ–º–∏—É–º</a></li>
    </ul>

    <hr class="my-2">

    <!-- –ê–∫–∫–∞—É–Ω—Ç -->
    <div class="d-grid gap-2">
      {% if request.user.is_authenticated %}
        <a class="btn btn-outline-secondary" href="{% url 'profile' request.user.username %}">
          <i class="bi bi-person-circle me-1"></i>{{ request.user.username }}
        </a>
        <a class="btn btn-outline-danger" href="{% url 'logout' %}">–í—ã–π—Ç–∏</a>
      {% else %}
        <a class="btn btn-outline-primary" href="{% url 'login' %}">–í–æ–π—Ç–∏</a>
        <a class="btn" href="{% url 'signup' %}">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
      {% endif %}
    </div>
  </div>
</div>

<!-- –ù–µ–±–æ–ª—å—à–∞—è –ø–æ–¥—Å—Ç—Ä–æ–π–∫–∞ —Ü–≤–µ—Ç–æ–≤ Offcanvas -->
<style>
  .offcanvas { background: var(--bs-body-bg); color: var(--bs-body-color); }
  .offcanvas .nav-link { font-size: 1rem; }
</style>

<!-- –ù–∞–¥—ë–∂–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–∞–º –∏–∑ offcanvas -->
<script>
  (function () {
    const ocEl = document.getElementById('mainOffcanvas');
    if (!ocEl) return;
    const oc = bootstrap.Offcanvas.getOrCreateInstance(ocEl);

    ocEl.addEventListener('click', function (e) {
      const link = e.target.closest('a.nav-link[href]');
      if (!link) return;
      const href = link.getAttribute('href');
      if (!href || href === '#') return;

      e.preventDefault();
      oc.hide();
      ocEl.addEventListener('hidden.bs.offcanvas', function handler() {
        ocEl.removeEventListener('hidden.bs.offcanvas', handler);
        window.location.assign(href);
      }, { once: true });
    }, false);
  })();
</script>
<!-- ===== /NAVBAR + OFFCANVAS ===== -->

<main class="container py-4">
  {% if messages %}
    <div class="mb-4">
      {% for message in messages %}
        {% with tag=message.level_tag %}
          {% if tag == 'error' %}
            {% with alert_class='danger' %}
              <div class="alert alert-{{ alert_class }} alert-dismissible fade show" role="alert">
                {{ message|safe }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
              </div>
            {% endwith %}
          {% elif tag == 'debug' %}
            {% with alert_class='secondary' %}
              <div class="alert alert-{{ alert_class }} alert-dismissible fade show" role="alert">
                {{ message|safe }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
              </div>
            {% endwith %}
          {% else %}
            <div class="alert alert-{{ tag }} alert-dismissible fade show" role="alert">
              {{ message|safe }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
            </div>
          {% endif %}
        {% endwith %}
      {% endfor %}
    </div>
  {% endif %}

  {% block content %}{% endblock %}
</main>

<div class="border-top bg-body-tertiary">
  <div class="container py-3">
    <div id="yandex_rtb_R-A-1780994-1" class="yandex-ads-banner"></div>
  </div>
</div>

<script>
  window.yaContextCb = window.yaContextCb || [];
  window.yaContextCb.push(() => {
    if (window.Ya && Ya.Context && Ya.Context.AdvManager) {
      Ya.Context.AdvManager.render({
        blockId: "R-A-1780994-1",
        renderTo: "yandex_rtb_R-A-1780994-1",
        horizontalAlign: true,
      });
    }
  });
</script>

<footer class="border-top py-3 small text-muted bg-body">
  <div class="container d-flex justify-content-between">
    <div>¬© {% now "Y" %} –ö–∞–ª–µ–π–¥–æ—Å–∫–æ–ø –ö–Ω–∏–≥</div>
    <div><a class="text-muted" href="mailto:hello@example.com">–°–≤—è–∑–∞—Ç—å—Å—è</a></div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Theme toggle (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä)
  const html = document.documentElement;
  const saved = localStorage.getItem('theme');
  if (saved) html.setAttribute('data-bs-theme', saved);
  document.getElementById('themeToggle')?.addEventListener('click', () => {
    const current = html.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark';
    html.setAttribute('data-bs-theme', current);
    localStorage.setItem('theme', current);
  });

  // –£–ª—É—á—à–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä –¥–ª—è select[multiple]
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('select[data-enhanced-multi]').forEach((select) => {
      if (select.dataset.enhancedMultiApplied === '1') return;
      select.dataset.enhancedMultiApplied = '1';
      if (!select.multiple) return;

      const options = Array.from(select.options);
      if (!options.length) return;

      const wrapper = document.createElement('div');
      wrapper.className = 'multi-select-enhanced border rounded-3 bg-body-tertiary p-3 mt-2';
      const list = document.createElement('div');
      list.className = 'multi-select-enhanced__list d-flex flex-column gap-2';

      options.forEach((option, index) => {
        const checkboxId = `${select.id || select.name}-choice-${index}`;
        const item = document.createElement('div');
        item.className = 'form-check';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'form-check-input';
        checkbox.id = checkboxId;
        checkbox.dataset.optionIndex = String(index);
        checkbox.checked = option.selected;
        checkbox.disabled = option.disabled;
        checkbox.addEventListener('change', () => { option.selected = checkbox.checked; });

        const label = document.createElement('label');
        label.className = 'form-check-label';
        label.setAttribute('for', checkboxId);
        label.textContent = option.textContent;

        item.appendChild(checkbox);
        item.appendChild(label);
        list.appendChild(item);
      });

      wrapper.appendChild(list);

      const controls = document.createElement('div');
      controls.className = 'd-flex justify-content-end mt-3';
      const clearButton = document.createElement('button');
      clearButton.type = 'button';
      clearButton.className = 'btn btn-outline-secondary btn-sm';
      clearButton.textContent = select.dataset.clearLabel || '–û—á–∏—Å—Ç–∏—Ç—å –≤—ã–±–æ—Ä';
      clearButton.addEventListener('click', () => {
        list.querySelectorAll('input[type="checkbox"]').forEach((checkbox) => {
          const idx = Number(checkbox.dataset.optionIndex || -1);
          if (idx >= 0) options[idx].selected = false;
          checkbox.checked = false;
        });
      });
      controls.appendChild(clearButton);
      wrapper.appendChild(controls);

      const originalId = select.id;
      if (originalId) {
        wrapper.id = `${originalId}__enhanced`;
        const labelEl = document.getElementById(`${originalId}_label`);
        if (labelEl) {
          labelEl.setAttribute('for', list.querySelector('input[type="checkbox"]')?.id || originalId);
          wrapper.setAttribute('aria-labelledby', labelEl.id);
        }
      }

      select.classList.add('visually-hidden');
      select.setAttribute('tabindex', '-1');
      select.insertAdjacentElement('afterend', wrapper);
    });
  });
</script>

{% block extra_js %}{% endblock %}
</body>
</html>
