{% extends "base.html" %}
{% load static %}
{% block title %}{{ book.title }} · Калейдоскоп книг{% endblock %}

{% block extra_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'books/book-detail.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'books/genre-shelf.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'reading_clubs/style.css' %}?v={{ STATIC_VERSION }}">

  <style>
    /* =========================
       Глобальная кнопочная тема «как жанры»
       ========================= */
    :root{
      --rt-chip-text: #111;        /* почти чёрный текст */
      --rt-chip-bg:   #f1dfcc;     /* базовый фон (как у жанров) */
      --rt-chip-bg-h: #ead2bd;     /* hover — чуть темнее */
      --rt-chip-bg-a: #e3c6ad;     /* active — ещё шаг темнее */
      --rt-chip-br:   #d7b89a;     /* тонкая рамка */
      --rt-focus:     201, 135, 91;/* акцент в фокус-тени (родственная палитра) */
    }

    /* База для ВСЕХ .btn */
    .btn{
      --bs-btn-font-weight: 600;
      --bs-btn-padding-y: .475rem;
      --bs-btn-padding-x: .9rem;
      --bs-btn-border-radius: 999px;

      /* делаем залитой по умолчанию */
      --bs-btn-color: var(--rt-chip-text);
      --bs-btn-bg: var(--rt-chip-bg);
      --bs-btn-border-color: var(--rt-chip-br);

      --bs-btn-hover-color: var(--rt-chip-text);
      --bs-btn-hover-bg: var(--rt-chip-bg-h);
      --bs-btn-hover-border-color: var(--rt-chip-br);

      --bs-btn-active-color: var(--rt-chip-text);
      --bs-btn-active-bg: var(--rt-chip-bg-a);
      --bs-btn-active-border-color: var(--rt-chip-br);

      --bs-btn-disabled-color: rgba(0,0,0,.55);
      --bs-btn-disabled-bg: #f5e8da;
      --bs-btn-disabled-border-color: #ead8c7;

      --bs-btn-focus-shadow-rgb: var(--rt-focus);
      box-shadow: none;
    }
    .btn:focus{
      box-shadow: 0 0 0 .2rem rgba(var(--rt-focus), .25);
    }

    /* Чтобы ЛЮБЫЕ вариации Bootstrap выглядели как «чипы» */
    .btn-primary,
    .btn-secondary,
    .btn-success,
    .btn-danger,
    .btn-warning,
    .btn-info,
    .btn-light,
    .btn-dark,
    .btn-outline-primary,
    .btn-outline-secondary,
    .btn-outline-success,
    .btn-outline-danger,
    .btn-outline-warning,
    .btn-outline-info,
    .btn-outline-light,
    .btn-outline-dark{
      --bs-btn-color: var(--rt-chip-text);
      --bs-btn-bg: var(--rt-chip-bg);
      --bs-btn-border-color: var(--rt-chip-br);
      --bs-btn-hover-color: var(--rt-chip-text);
      --bs-btn-hover-bg: var(--rt-chip-bg-h);
      --bs-btn-hover-border-color: var(--rt-chip-br);
      --bs-btn-active-color: var(--rt-chip-text);
      --bs-btn-active-bg: var(--rt-chip-bg-a);
      --bs-btn-active-border-color: var(--rt-chip-br);
    }

    /* Кнопки-ссылки тоже делаем видимыми */
    .btn-link{
      color: var(--rt-chip-text);
      text-decoration: none;
      background: var(--rt-chip-bg);
      border: 1px solid var(--rt-chip-br);
      border-radius: 999px;
      padding: .45rem .85rem;
      font-weight: 600;
    }
    .btn-link:hover{ background: var(--rt-chip-bg-h); color: var(--rt-chip-text); }

    /* Маленькие кнопки — компактнее */
    .btn-sm{
      --bs-btn-padding-y: .35rem;
      --bs-btn-padding-x: .65rem;
    }

    /* =========================
       Шапка книги (как раньше)
       ========================= */
    .book-appbar{
      position: sticky; top: 0; z-index: 1030;
      background: #e0c4a0 !important;
      color: #2a221c;
      border-bottom: 1px solid rgba(0,0,0,.06);
      backdrop-filter: blur(6px);
      transition: box-shadow .2s ease, background-color .2s ease, border-color .2s ease;
      --appbar-gap: 20px;
      margin-bottom: var(--appbar-gap);
    }
    .book-appbar.is-scrolled{
      background: #d59a6d !important;
      border-color: rgba(0,0,0,.08);
      box-shadow: 0 6px 18px rgba(0,0,0,.12);
    }
    .book-appbar__row{ display:flex; gap:.75rem; align-items:center; padding:.6rem 0; }
    .book-appbar__thumb{
      width:40px; height:56px; border-radius:6px; overflow:hidden; flex:0 0 auto;
      box-shadow: 0 6px 14px rgba(0,0,0,.12); background:#e9ecef;
    }
    .book-appbar__thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .book-appbar__meta{ min-width:0; display:flex; flex-direction:column; gap:.15rem; }
    .book-appbar__title{ font-weight:800; line-height:1.2; margin:0; max-width:100%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .book-appbar__authors{ color: rgba(0,0,0,.75); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .book-appbar__tags{
      display:flex; gap:.4rem; align-items:center; overflow:auto hidden; max-width:100%;
      -webkit-overflow-scrolling:touch; scrollbar-width:thin;
    }
    .book-appbar__tags a{
      flex:0 0 auto; font-size:.75rem; font-weight:600;
      padding:.25rem .6rem; border-radius:999px; text-decoration:none;
      background: rgba(255,255,255,.25); color:#2a221c; border:1px solid rgba(0,0,0,.08);
    }
    .book-appbar__tags a:hover{ background: rgba(255,255,255,.35); text-decoration:none; }
    @media (max-width: 575.98px){
      .book-appbar__row{ padding:.5rem 0; gap:.6rem; }
      .book-appbar__title{ font-size:1rem; }
      .book-appbar__authors{ font-size:.85rem; }
      .book-appbar__tags a{ font-size:.7rem; }
    }

    /* На всякий случай — убираем старые отступы рядом с layout */
    .book-appbar + .book-detail-layout,
    .book-appbar ~ .book-detail-layout{
      margin-top: 0 !important;
    }
    @media (min-width: 992px){
      .book-appbar{ --appbar-gap: 24px; }
    }

    /* =========================
       Мобильные улучшения
       ========================= */
    @media (max-width: 991.98px) {
      /* Переносим формы под обложку */
      .book-detail-layout__aside {
        order: -1;
        margin-bottom: 1.5rem;
      }
      
      /* Компактные кнопки действий */
      .book-detail-actions-mobile {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
        justify-content: center;
      }
      
      .book-detail-actions-mobile .btn {
        flex: 1;
        min-width: 140px;
        max-width: 200px;
      }
      
      /* Скрываем сложные формы на мобильных */
      .book-detail-shelf-form,
      .home-library-form-desktop {
        display: none !important;
      }
    }
    
    @media (min-width: 992px) {
      /* Скрываем мобильные кнопки на десктопе */
      .book-detail-actions-mobile {
        display: none !important;
      }
    }
    
    /* Улучшения для модальных окон */
    .shelf-modal .modal-dialog {
      max-width: 400px;
    }
    
    .shelf-modal .form-control:focus,
    .shelf-modal .form-select:focus {
      border-color: #d59a6d;
      box-shadow: 0 0 0 0.2rem rgba(213, 154, 109, 0.25);
    }
    
    .date-fields {
      background: #f8f9fa;
      border-radius: 0.375rem;
      padding: 1rem;
      margin-top: 1rem;
    }
  </style>
{% endblock %}

{% block content %}

<!-- ========= ШАПКА КНИГИ ========= -->
<div class="book-appbar" id="bookAppbar">
  <div class="container">
    <div class="book-appbar__row">
      {% with cover_src=active_cover.image %}
        {% if cover_src %}
          <div class="book-appbar__thumb d-none d-sm-block">
            <img src="{{ cover_src }}" alt="Обложка {{ book.title }}">
          </div>
        {% endif %}
      {% endwith %}

      <div class="book-appbar__meta flex-grow-1">
        <h1 class="book-appbar__title h5 mb-0">{{ book.title }}</h1>
        <div class="book-appbar__authors small">
          {% with authors=book.authors.all %}
            {% if authors %}
              {% for author in authors %}
                <a href="{{ author.get_absolute_url }}" class="text-reset text-decoration-none">{{ author.name }}</a>{% if not forloop.last %}, {% endif %}
              {% endfor %}
            {% else %}
              Автор неизвестен
            {% endif %}
          {% endwith %}
        </div>
        {% with genres=book.genres.all %}
          {% if genres %}
            <div class="book-appbar__tags mt-1" aria-label="Жанры">
              {% for g in genres %}
                <a href="{{ g.get_absolute_url }}">{{ g.name }}</a>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}
      </div>

      <div class="ms-auto">
        {% if user.is_authenticated %}
          <a class="btn btn-primary btn-sm" href="#write-review">Оставить отзыв</a>
        {% else %}
          <a class="btn btn-outline-primary btn-sm" href="{% url 'login' %}?next={{ request.path }}">Войти</a>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="book-detail-layout">
  <div class="row g-4 g-xl-5 align-items-start">
    <div class="col-12 col-lg-4 book-detail-layout__aside">
      <div class="book-detail-cover text-center"
           data-role="book-cover-display"
           data-default-alt="Обложка книги «{{ book.title }}»"
           data-default-label="{{ cover_label|default_if_none:''|escape }}">
        <img
          src="{% if active_cover and active_cover.image %}{{ active_cover.image }}{% endif %}"
          class="book-detail-cover__image rounded shadow-sm img-fluid mx-auto{% if not active_cover or not active_cover.image %} d-none{% endif %}"
          alt="{% if active_cover and active_cover.alt %}{{ active_cover.alt }}{% else %}Обложка книги «{{ book.title }}»{% endif %}"
          loading="lazy"
          data-role="book-cover-image">
        <div class="book-detail-cover__placeholder mx-auto{% if active_cover and active_cover.image %} d-none{% endif %}" data-role="book-cover-placeholder">
          <span class="text-muted">Нет обложки</span>
        </div>
        <div class="small text-muted mt-2{% if not cover_label %} d-none{% endif %}" data-role="book-cover-label">
          {{ cover_label|default_if_none:"" }}
        </div>
        {% if active_edition and active_edition.total_pages is not None %}
          <div class="small text-muted" data-role="book-cover-pages">
            Страниц: {{ active_edition.total_pages }}
          </div>
        {% endif %}
      </div>

      <!-- Мобильные кнопки действий -->
      {% if user.is_authenticated %}
      <div class="book-detail-actions-mobile">
        {% if default_shelf_status %}
          <div class="w-100 text-center bg-light border rounded px-3 py-2 small mb-2">
            {% if default_shelf_status.code == 'read' %}
              Книга прочитана{% if default_shelf_status.added_at %} {{ default_shelf_status.added_at|date:"d.m.Y" }}{% endif %}.
            {% else %}
              Книга находится на полке «{{ default_shelf_status.label }}».
            {% endif %}
          </div>
        {% else %}
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addToShelfModal">
            Добавить на полку
          </button>
        {% endif %}
        
        {% if home_library_form %}
          <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#homeLibraryModal">
            В домашнюю библиотеку
          </button>
        {% endif %}
        {% if edit_request_form %}
          <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#bookEditRequestModal">
            Попросить правку
          </button>
        {% endif %}
      </div>
      {% endif %}

      {% if show_cover_thumbnails %}
      {% url 'book_detail' book.pk as book_detail_url %}
        <div class="book-detail-thumbnails" aria-labelledby="additional-editions-heading">
          <h3 class="visually-hidden" id="additional-editions-heading">Дополнительные издания</h3>
          <div class="book-cover-thumbnails" data-role="book-cover-thumbnails" data-active-page-index="{{ active_thumbnail_page_index }}">
            <div class="book-cover-thumbnails__viewport">
              {% for page in cover_thumbnail_pages %}
                <div class="book-cover-thumbnails__page{% if page.is_active %} is-active{% else %} d-none{% endif %}"
                     data-role="book-cover-thumbnails-page"
                     data-page-index="{{ forloop.counter0 }}">
                  {% for variant in page.variants %}
                    <a href="{{ book_detail_url }}{{ variant.url_query }}"
                       class="additional-edition-cover{% if variant.is_active %} is-active{% endif %}"
                       data-cover-src="{{ variant.image }}"
                       data-cover-alt="{{ variant.alt|escape }}"
                       data-cover-label="{{ variant.label|default_if_none:''|escape }}"
                       data-edition-id="{{ variant.edition_id }}"
                       data-role="book-cover-thumb"
                       aria-pressed="{% if variant.is_active %}true{% else %}false{% endif %}"
                       title="{{ variant.label|default_if_none:'Дополнительное издание' }}"
                       aria-label="{{ variant.label|default_if_none:'Дополнительное издание' }}"
                       {% if variant.is_active %}aria-current="true"{% endif %}>
                      <img src="{{ variant.image }}" alt="{{ variant.alt }}" class="additional-edition-cover__image" loading="lazy">
                      <span class="visually-hidden">{{ variant.label|default_if_none:'Дополнительное издание' }}</span>
                    </a>
                  {% endfor %}
                </div>
              {% endfor %}
            </div>

            {% if cover_thumbnail_pages|length > 1 %}
              <div class="book-cover-thumbnails__controls">
                <button class="btn btn-outline-primary btn-sm" type="button" data-role="book-cover-thumbnails-prev" aria-label="Предыдущие обложки">
                  <i class="bi bi-chevron-left" aria-hidden="true"></i>
                </button>
                <div class="book-cover-thumbnails__dots" role="tablist" aria-label="Страницы миниатюр">
                  {% for page in cover_thumbnail_pages %}
                    <button class="book-cover-thumbnails__dot{% if page.is_active %} is-active{% endif %}"
                            type="button"
                            data-role="book-cover-thumbnails-dot"
                            data-page-index="{{ forloop.counter0 }}"
                            aria-label="Показать миниатюры страницы {{ forloop.counter }}"
                            aria-current="{% if page.is_active %}true{% else %}false{% endif %}"></button>
                  {% endfor %}
                </div>
                <button class="btn btn-outline-primary btn-sm" type="button" data-role="book-cover-thumbnails-next" aria-label="Следующие обложки">
                  <i class="bi bi-chevron-right" aria-hidden="true"></i>
                </button>
              </div>
            {% endif %}
          </div>
        </div>
      {% endif %}

      <div class="card border-0 shadow-sm book-detail-layout__ratings">
        <div class="card-body">
          <h3 class="h6 mb-3">Средние оценки читателей</h3>
          {% if ratings %}
            <ul class="list-unstyled mb-0 small">
              {% for key, info in rating_summary.items %}
                <li class="d-flex justify-content-between py-1 border-bottom border-light-subtle">
                  <span class="me-2">{{ info.label }}</span>
                  <span>
                    {% if info.average %}
                      <strong>{{ info.average }}</strong><span class="text-muted"> / 10</span>
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                    {% if info.count %}
                      <span class="text-muted ms-1">({{ info.count }} оцен{{ info.count|pluralize:"ка,ки,ок" }})</span>
                    {% endif %}
                  </span>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted mb-0">Пока нет оценок. Будьте первым, кто поделится впечатлениями.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-8 book-detail-layout__main">
      {# заголовок книги не дублируем — он в шапке #}

      {% if book_quick_facts %}
        <div class="card border-0 shadow-sm book-detail-quick-facts">
          <div class="card-body">
            <dl class="book-detail-quick-facts__list">
              {% for fact in book_quick_facts %}
                <div class="book-detail-quick-facts__item">
                  <dt class="book-detail-quick-facts__label">{{ fact.label }}</dt>
                  <dd class="book-detail-quick-facts__value">{{ fact.value }}</dd>
                </div>
              {% endfor %}
            </dl>
          </div>
        </div>
      {% endif %}

      {% with active=reading_clubs_by_status.active upcoming=reading_clubs_by_status.upcoming past=reading_clubs_by_status.past %}
        {% if active or upcoming or past %}
          <div class="reading-group mb-4">
            <h2 class="h5 reading-group__title">Совместные чтения по книге</h2>
            <div class="small text-muted mb-3">Присоединяйтесь к обсуждениям или создайте свои чтения.</div>
            <div class="vstack gap-3">
              {% if active %}
                <div>
                  <h3 class="h6 text-uppercase text-muted">Актуальные</h3>
                  <div class="row g-3">
                    {% for club in active %}
                      <div class="col-12 col-md-6">
                        <article class="reading-card h-100">
                          <div class="reading-card__title mb-1"><a href="{{ club.get_absolute_url }}">{{ club.title }}</a></div>
                          <div class="reading-card__meta small">Старт {{ club.start_date|date:"d E Y" }}{% if club.end_date %} · Завершение {{ club.end_date|date:"d E Y" }}{% endif %}</div>
                          <div class="reading-card__footer mt-3 text-muted">
                            <span><i class="bi bi-people me-1"></i> {{ club.approved_participant_count }}</span>
                            <span><i class="bi bi-chat-left-text me-1"></i> {{ club.message_count }}</span>
                          </div>
                        </article>
                      </div>
                    {% endfor %}
                  </div>
                </div>
              {% endif %}

              {% if upcoming %}
                <div>
                  <h3 class="h6 text-uppercase text-muted">Предстоящие</h3>
                  <div class="row g-3">
                    {% for club in upcoming %}
                      <div class="col-12 col-md-6">
                        <article class="reading-card h-100">
                          <div class="reading-card__title mb-1"><a href="{{ club.get_absolute_url }}">{{ club.title }}</a></div>
                          <div class="reading-card__meta small">Старт {{ club.start_date|date:"d E Y" }}</div>
                          <p class="text-muted small mb-0">{{ club.description|truncatewords:20 }}</p>
                        </article>
                      </div>
                    {% endfor %}
                  </div>
                </div>
              {% endif %}

              {% if past %}
                <div>
                  <h3 class="h6 text-uppercase text-muted">Прошедшие</h3>
                  <div class="row g-3">
                    {% for club in past %}
                      <div class="col-12 col-md-6">
                        <article class="reading-card h-100">
                          <div class="reading-card__title mb-1"><a href="{{ club.get_absolute_url }}">{{ club.title }}</a></div>
                          <div class="reading-card__meta small">{{ club.start_date|date:"d E Y" }} — {{ club.end_date|date:"d E Y" }}</div>
                          <div class="reading-card__footer mt-3 text-muted">
                            <span><i class="bi bi-chat-left-text me-1"></i> {{ club.message_count }}</span>
                          </div>
                        </article>
                      </div>
                    {% endfor %}
                  </div>
                </div>
              {% endif %}
            </div>

            <div class="mt-3">
              <a class="btn btn-sm btn-primary" href="{% url 'reading_clubs:create' %}?book={{ book.pk }}">Создать совместное чтение</a>
              <a class="btn btn-sm btn-outline-primary ms-2" href="{% url 'reading_clubs:list' %}">Все совместные чтения</a>
            </div>
          </div>
        {% endif %}
      {% endwith %}

      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h2 class="h6 mb-3">Описание</h2>
          {% if book.synopsis %}
            <p class="mb-0">{{ book.synopsis|linebreaksbr }}</p>
          {% else %}
            <p class="mb-0 text-muted">Описание пока не добавлено.</p>
          {% endif %}
        </div>
      </div>

      {% if request.user.is_authenticated %}
        <!-- Десктопные формы (скрыты на мобильных) -->
        <div class="book-detail-actions d-none d-lg-flex flex-wrap gap-2" aria-label="Быстрые действия">
          {% if default_shelf_status %}
            <div class="bg-light border rounded px-3 py-2 small">
              {% if default_shelf_status.code == 'read' %}
                Книга прочитана{% if default_shelf_status.added_at %} {{ default_shelf_status.added_at|date:"d.m.Y" }}{% endif %}.
              {% else %}
                Книга находится на полке «{{ default_shelf_status.label }}».
              {% endif %}
            </div>
          {% else %}
            {% if quick_add_form %}
              <form method="post"
                    action="{% url 'book_detail' book.pk %}"
                    class="book-detail-shelf-form card border-0 shadow-sm p-3 flex-grow-1"
                    data-role="book-shelf-form"
                    data-read-shelf-ids="{{ read_shelf_ids_str|join:',' }}"
                    data-read-shelf-names="{{ read_shelf_name_tokens|join:'|' }}">
                {% csrf_token %}
                <input type="hidden" name="action" value="quick-add-shelf">
                {% if quick_add_form.non_field_errors %}
                  <div class="alert alert-danger mb-3 small" role="alert">
                    {{ quick_add_form.non_field_errors|join:' ' }}
                  </div>
                {% endif %}
                <div class="row g-3 align-items-start">
                  <div class="col-12 col-md-4">
                    <label class="form-label small" for="{{ quick_add_form.shelf.id_for_label }}">{{ quick_add_form.shelf.label }}</label>
                    {{ quick_add_form.shelf }}
                    {% if quick_add_form.shelf.errors %}
                      <div class="invalid-feedback d-block small">{{ quick_add_form.shelf.errors|join:', ' }}</div>
                    {% endif %}
                  </div>
                  <div class="col-12 col-lg-6 book-detail-shelf-form__extras{% if not quick_add_is_read_shelf_selected %} d-none{% endif %}"
                       data-role="read-fields"
                       aria-hidden="{% if quick_add_is_read_shelf_selected %}false{% else %}true{% endif %}"
                       {% if not quick_add_is_read_shelf_selected %}hidden{% endif %}>
                      <div class="row g-3">
                        <div class="col-12 col-md-6">
                          <label class="form-label small" for="{{ quick_add_form.read_at.id_for_label }}">{{ quick_add_form.read_at.label }}</label>
                          {{ quick_add_form.read_at }}
                          {% if quick_add_form.read_at.errors %}
                            <div class="invalid-feedback d-block small">{{ quick_add_form.read_at.errors|join:', ' }}</div>
                          {% endif %}
                        </div>
                        <div class="col-12">
                          <label class="form-label small" for="{{ quick_add_form.quote.id_for_label }}">{{ quick_add_form.quote.label }} <span class="text-muted">(необязательно)</span></label>
                          {{ quick_add_form.quote }}
                          {% if quick_add_form.quote.errors %}
                            <div class="invalid-feedback d-block small">{{ quick_add_form.quote.errors|join:', ' }}</div>
                          {% endif %}
                        </div>
                        <div class="col-12">
                          <label class="form-label small" for="{{ quick_add_form.note.id_for_label }}">{{ quick_add_form.note.label }} <span class="text-muted">(необязательно)</span></label>
                          {{ quick_add_form.note }}
                          {% if quick_add_form.note.errors %}
                            <div class="invalid-feedback d-block small">{{ quick_add_form.note.errors|join:', ' }}</div>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                    <div class="col-12 col-md-auto align-self-end">
                      <button class="btn btn-outline-primary btn-sm" type="submit">Добавить</button>
                    </div>
                  </div>
                </form>
            {% endif %}
          {% endif %}
          {% if edit_request_form %}
            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#bookEditRequestModal">
              Попросить правку
            </button>
          {% endif %}
        </div>

        {% if home_library_form %}
          <div class="card border-0 shadow-sm mb-3 home-library-form-desktop">
            <div class="card-body">
              <h2 class="h6 mb-3">Домашняя библиотека</h2>
              <form method="post" action="{% url 'book_detail' book.pk %}" class="row g-2 align-items-end">
                {% csrf_token %}
                <input type="hidden" name="action" value="home-library-add">
                <div class="col-sm-6 col-md-4 col-lg-4">
                  <label class="form-label small mb-1" for="{{ home_library_form.purchase_date.id_for_label }}">{{ home_library_form.purchase_date.label }}</label>
                  {{ home_library_form.purchase_date }}
                  {% if home_library_form.purchase_date.errors %}
                    <div class="invalid-feedback d-block small">{{ home_library_form.purchase_date.errors|join:", " }}</div>
                  {% elif home_library_form.purchase_date.help_text %}
                    <div class="form-text">{{ home_library_form.purchase_date.help_text }}</div>
                  {% endif %}
                </div>
                <div class="col-sm-6 col-md-4 col-lg-3">
                  <div class="form-check mt-3 mt-sm-4">
                    {{ home_library_form.mark_as_read }}
                    <label class="form-check-label small" for="{{ home_library_form.mark_as_read.id_for_label }}">{{ home_library_form.mark_as_read.label }}</label>
                  </div>
                  {% if home_library_form.mark_as_read.errors %}
                    <div class="invalid-feedback d-block small">{{ home_library_form.mark_as_read.errors|join:", " }}</div>
                  {% endif %}
                </div>
                <div class="col-sm-6 col-md-4 col-lg-4">
                  <label class="form-label small mb-1" for="{{ home_library_form.read_date.id_for_label }}">{{ home_library_form.read_date.label }}</label>
                  {{ home_library_form.read_date }}
                  {% if home_library_form.read_date.errors %}
                    <div class="invalid-feedback d-block small">{{ home_library_form.read_date.errors|join:", " }}</div>
                  {% elif home_library_form.read_date.help_text %}
                    <div class="form-text">{{ home_library_form.read_date.help_text }}</div>
                  {% endif %}
                </div>
                <div class="col-sm-auto">
                  <button class="btn btn-outline-primary btn-sm mt-3 mt-sm-0" type="submit">
                    {% if home_library_item %}Обновить на полке{% else %}Добавить на полку{% endif %}
                  </button>
                </div>
              </form>
              {% if home_library_item %}
                <div class="small text-muted mt-2">
                  Книга уже находится в полке «{{ home_library_item.shelf.name }}».
                  {% if home_library_entry and home_library_entry.acquired_at %}<br>Дата покупки: {{ home_library_entry.acquired_at|date:"d.m.Y" }}{% endif %}
                  {% if home_library_entry and home_library_entry.read_at %}<br>Дата прочтения: {{ home_library_entry.read_at|date:"d.m.Y" }}{% else %}<br>Книга ещё не отмечена как прочитанная.{% endif %}
                  {% if home_library_edit_url %}<br><a class="btn btn-link btn-sm" href="{{ home_library_edit_url }}">Редактировать сведения</a>{% endif %}
                </div>
              {% endif %}
            </div>
          </div>
        {% endif %}
      {% else %}
        <a class="btn btn-outline-primary" href="{% url 'login' %}?next={{ request.path }}">
          Войти, чтобы добавить в полку/марафон
        </a>
      {% endif %}

      {% if book_metadata %}
        <div class="card border-0 shadow-sm" aria-labelledby="book-metadata-title">
          <div class="card-body">
            <h2 class="h6 mb-3" id="book-metadata-title">Дополнительные сведения</h2>
            <dl class="book-detail-meta">
              {% for item in book_metadata %}
                <div class="book-detail-meta__item">
                  <dt>{{ item.label }}</dt>
                  <dd>{{ item.value }}</dd>
                </div>
              {% endfor %}
            </dl>
          </div>
        </div>
      {% endif %}

      {% if genre_shelves %}
        <section aria-labelledby="genre-shelf-heading">
          <div class="d-flex align-items-baseline justify-content-between flex-wrap gap-2 mb-3">
            <h2 class="h6 mb-0" id="genre-shelf-heading">Ещё книги в этих жанрах</h2>
            <span class="text-muted small">Подборка в стиле «12 забытых книг»</span>
          </div>
          <div class="genre-shelf-collection">
            {% for shelf in genre_shelves %}
              {% include "books/includes/genre_shelf.html" with shelf=shelf variant=shelf.variant %}
            {% endfor %}
          </div>
        </section>
      {% endif %}

      {% with overall=rating_summary.score %}
        <div class="book-detail-overall-rating d-flex flex-wrap align-items-baseline gap-2">
          <div class="d-flex align-items-baseline gap-2 text-warning">
            <i class="bi bi-star-fill"></i>
            <span class="fw-semibold fs-5">{% if overall.average %}{{ overall.average }}{% else %}—{% endif %}</span>
            {% if overall.average %}<span class="text-muted small">из 10</span>{% endif %}
          </div>
          <div class="text-muted small">
            {% if overall.count %}{{ overall.count }} оцен{{ overall.count|pluralize:"ка,ки,ок" }}{% else %}Пока нет оценок{% endif %}
          </div>
          {% if user.is_authenticated %}
            <a class="btn btn-primary btn-sm ms-auto" href="#write-review">Оставить отзыв</a>
          {% else %}
            <a class="btn btn-outline-primary btn-sm ms-auto" href="{% url 'login' %}?next={{ request.path }}">Войдите, чтобы оценить</a>
          {% endif %}
        </div>
      {% endwith %}

      {% if user.is_authenticated %}
        <div class="card border-0 shadow-sm" id="write-review" aria-labelledby="write-review-title">
          <div class="card-body">
            <h2 class="h6 mb-3" id="write-review-title">Оставить отзыв</h2>
            <form method="post" action="{% url 'rate_book' book.pk %}" class="row g-3">
              {% csrf_token %}
              {{ form.book }}
              {% if form.non_field_errors %}
                <div class="col-12"><div class="alert alert-danger mb-0">{{ form.non_field_errors|join:"<br>"|safe }}</div></div>
              {% endif %}
              <div class="col-12">
                <div class="d-flex flex-column gap-3">
                  <div>
                    <label class="form-label" for="{{ form.score.id_for_label }}">{{ form.score.label }}</label>
                    {% include "books/includes/star_rating_field.html" with field=form.score scale=rating_scale label_id=form.score.id_for_label %}
                    {% if form.score.errors %}<div class="invalid-feedback d-block">{{ form.score.errors|join:", " }}</div>{% endif %}
                  </div>
                  {% for field in rating_category_fields %}
                    <div>
                      <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                      {% include "books/includes/star_rating_field.html" with field=field scale=rating_scale label_id=field.id_for_label %}
                      {% if field.errors %}<div class="invalid-feedback d-block">{{ field.errors|join:", " }}</div>{% endif %}
                    </div>
                  {% endfor %}
                </div>
                <div class="form-text mt-1">Вы можете заполнить только те категории, которые вам важны.</div>
              </div>
              <div class="col-12">
                <label class="form-label" for="{{ form.review.id_for_label }}">{{ form.review.label }}</label>
                {{ form.review }}
                {% if form.review.errors %}<div class="invalid-feedback d-block">{{ form.review.errors|join:", " }}</div>{% endif %}
              </div>
              <div class="col-12 d-flex justify-content-end">
                <button class="btn btn-primary" type="submit">Отправить отзыв</button>
              </div>
            </form>
          </div>
        </div>
      {% else %}
        <div class="alert alert-light border d-flex flex-column justify-content-center">
          <p class="mb-2">Войдите, чтобы оставить свою оценку и отзыв.</p>
          <a class="btn btn-primary btn-sm align-self-start" href="{% url 'login' %}?next={{ request.path }}">Войти</a>
        </div>
      {% endif %}

      <section class="book-detail-reviews" aria-labelledby="reader-reviews-title">
        <h2 class="h6 mb-3" id="reader-reviews-title">Отзывы читателей</h2>
        {% if ratings %}
          <div class="list-group">
            {% for r in ratings %}
              <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <div class="fw-semibold">{{ r.user.get_username }}</div>
                    <div class="small text-muted">{{ r.created_at|date:"d.m.Y H:i" }}</div>
                  </div>
                  {% if r.score %}<span class="badge text-bg-warning">{{ r.score }} / 10</span>{% endif %}
                </div>
                {% with category_scores=r.get_category_scores %}
                  {% if category_scores %}
                    <ul class="list-inline small mt-2 mb-0">
                      {% for label, value in category_scores %}
                        <li class="list-inline-item me-3">{{ label }}: <strong>{{ value }}</strong></li>
                      {% endfor %}
                    </ul>
                  {% endif %}
                {% endwith %}
                {% if r.review %}<p class="mt-2 mb-0">{{ r.review|linebreaksbr }}</p>{% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="alert alert-light border mb-0">Пока нет отзывов — станьте первым!</div>
        {% endif %}
      </section>
    </div>
  </div>
</div>

<!-- Modal: Добавить в полку -->
<div class="modal fade shelf-modal" id="addToShelfModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" method="post" action="{% url 'book_detail' book.pk %}">
      <div class="modal-header">
        <h5 class="modal-title">Добавить «<span data-role="shelf-modal-book-title">{{ book.title }}</span>» на полку</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
      </div>
      <div class="modal-body">
        {% csrf_token %}
        <input type="hidden" name="action" value="quick-add-shelf">
        
        <div class="mb-3">
          <label class="form-label">Выберите полку</label>
          <select class="form-select" name="shelf" id="modalShelfSelect" required>
            <option value="" selected disabled>— выбрать —</option>
            {% for shelf in quick_add_form.shelf.field.queryset %}
              <option value="{{ shelf.id }}">{{ shelf.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label" for="modalShelfEditionSelect">Выберите издание</label>
          <select class="form-select" name="selected_edition" id="modalShelfEditionSelect" {% if quick_add_requires_edition_choice %}required{% endif %}>
            <option value=""{% if not quick_add_active_edition_id %} selected{% endif %}>Основное издание</option>
            {% for edition in quick_add_form.selected_edition.field.queryset %}
              <option value="{{ edition.id }}"{% if quick_add_active_edition_id and quick_add_active_edition_id == edition.id|stringformat:"s" %} selected{% endif %}>{{ edition.title|default:book.title }}{% if edition.binding %} · {{ edition.binding }}{% endif %}{% if edition.publish_date %} · {{ edition.publish_date }}{% endif %}</option>
            {% endfor %}
          </select>
          {% if quick_add_requires_edition_choice %}
            <div class="form-text">Вы открыли конкретное издание. Подтвердите выбор перед добавлением на полку.</div>
          {% endif %}
        </div>

        <!-- Дополнительные поля для полки "Прочитано" -->
        <div class="date-fields d-none" id="readShelfFields">
          <div class="mb-3">
            <label class="form-label small">Дата прочтения</label>
            <input type="date" class="form-control" name="read_at" id="modalReadAt">
          </div>
          <div class="mb-3">
            <label class="form-label small">Цитата <span class="text-muted">(необязательно)</span></label>
            <textarea class="form-control" name="quote" rows="2" placeholder="Запомнившаяся цитата из книги..."></textarea>
          </div>
          <div class="mb-0">
            <label class="form-label small">Заметка <span class="text-muted">(необязательно)</span></label>
            <textarea class="form-control" name="note" rows="2" placeholder="Ваши впечатления о книге..."></textarea>
          </div>
        </div>

        <!-- Дополнительные поля для полки "Моя домашняя библиотека" -->
        <div class="d-none" id="homeLibraryFields">
          <div class="mb-3">
            <label class="form-label small">Дата покупки</label>
            <input type="date" class="form-control" name="purchase_date" id="modalShelfPurchaseDate">
          </div>

          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" name="mark_as_read" id="modalShelfMarkAsRead">
            <label class="form-check-label small" for="modalShelfMarkAsRead">Книга прочитана</label>
          </div>

          <div class="mb-0 d-none" id="modalShelfReadDateField">
            <label class="form-label small">Дата прочтения</label>
            <input type="date" class="form-control" name="read_date" id="modalShelfReadDate" disabled>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">Закрыть</button>
        <button type="submit" class="btn btn-primary">Добавить</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Домашняя библиотека -->
<div class="modal fade shelf-modal" id="homeLibraryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" method="post" action="{% url 'book_detail' book.pk %}">
      <div class="modal-header">
        <h5 class="modal-title">Добавить в домашнюю библиотеку</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
      </div>
      <div class="modal-body">
        {% csrf_token %}
        <input type="hidden" name="action" value="home-library-add">
        
        <div class="mb-3">
          <label class="form-label small">Дата покупки</label>
          <input type="date" class="form-control" name="purchase_date" id="modalPurchaseDate">
        </div>
        
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" name="mark_as_read" id="modalMarkAsRead">
          <label class="form-check-label small" for="modalMarkAsRead">Отметить как прочитанную</label>
        </div>
        
        <div class="mb-0 d-none" id="modalReadDateField">
          <label class="form-label small">Дата прочтения</label>
          <input type="date" class="form-control" name="read_date" id="modalReadDate" disabled>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">Закрыть</button>
        <button type="submit" class="btn btn-primary">
          {% if home_library_item %}Обновить{% else %}Добавить{% endif %}
        </button>
      </div>
    </form>
  </div>
</div>

{% if edit_request_form %}
  <!-- Modal: Запрос на правку книги -->
  <div class="modal fade" id="bookEditRequestModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" method="post" action="{% url 'book_detail' book.pk %}">
        <div class="modal-header">
          <h5 class="modal-title">Попросить отредактировать книгу</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
        </div>
        <div class="modal-body">
          {% csrf_token %}
          <input type="hidden" name="action" value="book-edit-request">
          <div class="mb-3">
            <label class="form-label" for="{{ edit_request_form.comment.id_for_label }}">{{ edit_request_form.comment.label }}</label>
            {{ edit_request_form.comment }}
            {% if edit_request_form.comment.errors %}
              <div class="invalid-feedback d-block">{{ edit_request_form.comment.errors|join:", " }}</div>
            {% endif %}
            <div class="form-text">Мы отправим ваш комментарий суперпользователю для правок.</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">Закрыть</button>
          <button type="submit" class="btn btn-primary">Отправить</button>
        </div>
      </form>
    </div>
  </div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
  /* эффект «шапка прилипла» */
  (function(){
    const bar = document.getElementById('bookAppbar');
    if(!bar) return;
    const onScroll = () => (window.scrollY > 6 ? bar.classList.add('is-scrolled') : bar.classList.remove('is-scrolled'));
    onScroll();
    window.addEventListener('scroll', onScroll, { passive:true });
  })();
</script>

{% if edit_request_form and edit_request_form.errors %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const modalEl = document.getElementById('bookEditRequestModal');
    if (modalEl && window.bootstrap) {
      const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
      modal.show();
    }
  });
</script>
{% endif %}

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Обработка модального окна добавления на полку
    const shelfModal = document.getElementById('addToShelfModal');
    if (shelfModal) {
      const shelfForm = shelfModal.querySelector('form');
      const shelfSelect = document.getElementById('modalShelfSelect');
      const editionSelect = document.getElementById('modalShelfEditionSelect');
      const requiresEditionChoice = {{ quick_add_requires_edition_choice|yesno:'true,false' }};
      const activeEditionId = {{ quick_add_active_edition_id|default:'null'|safe }};
      const readFields = document.getElementById('readShelfFields');
      const homeLibraryFields = document.getElementById('homeLibraryFields');
      const homeLibraryShelfId = {{ home_library_shelf_id|default:'null' }};
      const homeLibraryMarkAsRead = document.getElementById('modalShelfMarkAsRead');
      const homeLibraryReadDateField = document.getElementById('modalShelfReadDateField');
      const homeLibraryReadDateInput = document.getElementById('modalShelfReadDate');
      const readAtInput = document.getElementById('modalReadAt');
      const quoteInput = shelfModal.querySelector('textarea[name="quote"]');
      const noteInput = shelfModal.querySelector('textarea[name="note"]');
      const readShelfIds = ({{ read_shelf_ids_str|default:'[]'|safe }} || []).map(String);

      const resetReadFields = () => {
        if (readAtInput) readAtInput.value = '';
        if (quoteInput) quoteInput.value = '';
        if (noteInput) noteInput.value = '';
      };

      const updateFieldVisibility = (selectedShelfId) => {
        const shelfIdStr = selectedShelfId != null ? String(selectedShelfId) : '';
        const isReadShelf = readShelfIds.includes(shelfIdStr);
        const isHomeLibrary = Boolean(homeLibraryShelfId) && String(homeLibraryShelfId) === shelfIdStr;

        if (readFields) {
          readFields.classList.toggle('d-none', !isReadShelf);
        }
        if (!isReadShelf) {
          resetReadFields();
        }

        if (homeLibraryFields) {
          homeLibraryFields.classList.toggle('d-none', !isHomeLibrary);
        }
        if (!isHomeLibrary && homeLibraryMarkAsRead) {
          homeLibraryMarkAsRead.checked = false;
        }

        if (homeLibraryReadDateField && homeLibraryReadDateInput) {
          const shouldShowReadDate = isHomeLibrary && homeLibraryMarkAsRead?.checked;
          homeLibraryReadDateField.classList.toggle('d-none', !shouldShowReadDate);
          homeLibraryReadDateInput.disabled = !shouldShowReadDate;
          if (shouldShowReadDate && !homeLibraryReadDateInput.value) {
            homeLibraryReadDateInput.value = new Date().toISOString().split('T')[0];
          }
          if (!shouldShowReadDate) {
            homeLibraryReadDateInput.value = '';
          }
        }
      };

      shelfSelect?.addEventListener('change', function() {
        updateFieldVisibility(this.value);
      });

      homeLibraryMarkAsRead?.addEventListener('change', function() {
        updateFieldVisibility(shelfSelect?.value);
      });

      document.querySelectorAll('[data-role="open-shelf-modal"]').forEach((button) => {
        button.addEventListener('click', () => {
          const modalTitleTarget = shelfModal.querySelector('[data-role="shelf-modal-book-title"]');
          const bookTitle = button.getAttribute('data-book-title') || 'книгу';
          if (modalTitleTarget) modalTitleTarget.textContent = bookTitle;

          const actionUrl = button.getAttribute('data-action-url');
          if (shelfForm && actionUrl) {
            shelfForm.action = actionUrl;
          }

          shelfForm?.reset();
          if (editionSelect) {
            const normalizedActiveEditionId = activeEditionId == null ? '' : String(activeEditionId);
            if (normalizedActiveEditionId) {
              editionSelect.value = normalizedActiveEditionId;
            } else if (!requiresEditionChoice) {
              editionSelect.value = '';
            }
          }
          if (homeLibraryReadDateInput) {
            homeLibraryReadDateInput.value = '';
          }

          updateFieldVisibility(shelfSelect?.value);

          const modalInstance = bootstrap.Modal.getOrCreateInstance(shelfModal);
          modalInstance.show();
        });
      });

      updateFieldVisibility(shelfSelect?.value);
    }

    // Обработка модального окна домашней библиотеки
    const homeLibraryModal = document.getElementById('homeLibraryModal');
    if (homeLibraryModal) {
      const markAsRead = document.getElementById('modalMarkAsRead');
      const readDateField = document.getElementById('modalReadDateField');
      const readDateInput = document.getElementById('modalReadDate');
      
      markAsRead?.addEventListener('change', function() {
        const shouldShow = this.checked;
        readDateField?.classList.toggle('d-none', !shouldShow);
        if (readDateInput) {
          readDateInput.disabled = !shouldShow;
          if (shouldShow && !readDateInput.value) {
            readDateInput.value = new Date().toISOString().split('T')[0];
          }
        }
      });
    }

    // Остальной существующий JavaScript код...
    const parseRatingValue = (value) => {
      if (value === null || value === undefined) return null;
      const numeric = Number.parseInt(value, 10);
      return Number.isNaN(numeric) ? null : numeric;
    };

    document.querySelectorAll('[data-rating-field]').forEach((root) => {
      const input = root.querySelector('input[data-role="rating-value"], input[type="hidden"]');
      const buttons = Array.from(root.querySelectorAll('[data-rating-value]'));
      if (!input || !buttons.length) return;

      const display = root.querySelector('[data-rating-display]');
      const clear = root.querySelector('[data-rating-clear]');
      const defaultDisplayText = display ? (display.dataset.defaultText || display.textContent || '').trim() : '';
      if (display && !display.dataset.defaultText) {
        display.dataset.defaultText = defaultDisplayText;
      }

      const maxValue = buttons.reduce((max, button) => {
        const buttonValue = parseRatingValue(button.dataset.ratingValue);
        return buttonValue !== null && buttonValue > max ? buttonValue : max;
      }, 0);

      let currentValue = parseRatingValue(input.value);

      const updateButtons = (highlightValue = null) => {
        const activeValue = highlightValue !== null ? highlightValue : currentValue;
        buttons.forEach((button) => {
          const buttonValue = parseRatingValue(button.dataset.ratingValue);
          const isHighlighted = activeValue !== null && buttonValue !== null && buttonValue <= activeValue;
          button.classList.toggle('is-active', Boolean(isHighlighted));
          button.setAttribute('aria-checked', currentValue !== null && buttonValue === currentValue ? 'true' : 'false');
        });
      };

      const updateDisplay = () => {
        if (!display) return;
        if (currentValue === null) {
          display.textContent = display.dataset.defaultText || 'Нет оценки';
        } else if (maxValue > 0) {
          display.textContent = `${currentValue} из ${maxValue}`;
        } else {
          display.textContent = `${currentValue}`;
        }
      };

      const commitValue = (value) => {
        currentValue = value;
        input.value = value === null ? '' : String(value);
        updateButtons();
        updateDisplay();
        input.dispatchEvent(new Event('change', { bubbles: true }));
        input.dispatchEvent(new Event('input', { bubbles: true }));
      };

      updateButtons();
      updateDisplay();

      const orderedButtons = buttons
        .map((btn) => ({ btn, value: parseRatingValue(btn.dataset.ratingValue) }))
        .filter((item) => item.value !== null)
        .sort((a, b) => a.value - b.value);

      buttons.forEach((button) => {
        const buttonValue = parseRatingValue(button.dataset.ratingValue);
        if (buttonValue === null) return;

        button.addEventListener('mouseenter', () => updateButtons(buttonValue));
        button.addEventListener('mouseleave', () => updateButtons());
        button.addEventListener('focus', () => updateButtons(buttonValue));
        button.addEventListener('blur', () => updateButtons());
        button.addEventListener('click', (event) => {
          event.preventDefault();
          if (currentValue !== buttonValue) {
            commitValue(buttonValue);
          }
        });
        button.addEventListener('keydown', (event) => {
          if (event.key !== 'ArrowLeft' && event.key !== 'ArrowRight' && event.key !== 'ArrowUp' && event.key !== 'ArrowDown') {
            return;
          }
          event.preventDefault();
          const direction = event.key === 'ArrowLeft' || event.key === 'ArrowDown' ? -1 : 1;
          const currentIndex = orderedButtons.findIndex((item) => item.value === (currentValue ?? buttonValue));
          const targetIndex = currentIndex === -1 ? (direction > 0 ? 0 : orderedButtons.length - 1) : Math.min(Math.max(currentIndex + direction, 0), orderedButtons.length - 1);
          const target = orderedButtons[targetIndex];
          if (target) {
            target.btn.focus();
            commitValue(target.value);
          }
        });
      });

      if (clear) {
        clear.addEventListener('click', (event) => {
          event.preventDefault();
          if (currentValue !== null) {
            commitValue(null);
          }
        });
      }

      input.addEventListener('change', () => {
        currentValue = parseRatingValue(input.value);
        updateButtons();
        updateDisplay();
      });
    });

    document.querySelectorAll('[data-role="book-shelf-form"]').forEach((form) => {
      const select = form.querySelector('[data-role="shelf-select"]') || form.querySelector('select[name="shelf"]');
      const extras = form.querySelector('[data-role="read-fields"]');
      if (!select || !extras) return;

      const readShelfIds = (form.dataset.readShelfIds || '')
        .split(',')
        .map((value) => value.trim())
        .filter((value) => value.length > 0);

      const readShelfNames = (form.dataset.readShelfNames || '')
        .split('|')
        .map((value) => value.trim())
        .filter((value) => value.length > 0);

      const getSelectedOptionText = () => {
        const option = select.options[select.selectedIndex];
        if (!option) return '';
        return (option.textContent || option.innerText || '').trim();
      };

      const isReadShelfByText = () => {
        const optionText = getSelectedOptionText();
        if (!optionText) return false;
        const normalized = optionText.toLowerCase();
        if (normalized.includes('прочит')) return true;
        return readShelfNames.some((name) => normalized.includes(name));
      };

      const toggleExtras = () => {
        const selectedShelfId = (select.value || '').trim();
        const matchesById = selectedShelfId && readShelfIds.includes(selectedShelfId);
        const shouldShow = Boolean(matchesById || isReadShelfByText());
        extras.classList.toggle('d-none', !shouldShow);
        if (shouldShow) {
          extras.removeAttribute('hidden');
          extras.setAttribute('aria-hidden', 'false');
        } else {
          extras.setAttribute('hidden', 'true');
          extras.setAttribute('aria-hidden', 'true');
        }
      };

      toggleExtras();
      select.addEventListener('change', toggleExtras);
    });

    const homeLibraryMarkRead = document.querySelector('[data-role="home-library-mark-read"]');
    const homeLibraryReadDate = document.querySelector('[data-role="home-library-read-date"]');
    if (homeLibraryMarkRead && homeLibraryReadDate) {
      const toggleReadDate = () => { homeLibraryReadDate.disabled = !homeLibraryMarkRead.checked; };
      toggleReadDate(); homeLibraryMarkRead.addEventListener('change', toggleReadDate);
    }

    document.querySelectorAll('[data-role="book-cover-thumbnails"]').forEach((root) => {
      const pages = Array.from(root.querySelectorAll('[data-role="book-cover-thumbnails-page"]'));
      if (!pages.length) return;
      const dots = Array.from(root.querySelectorAll('[data-role="book-cover-thumbnails-dot"]'));
      const prev = root.querySelector('[data-role="book-cover-thumbnails-prev"]');
      const next = root.querySelector('[data-role="book-cover-thumbnails-next"]');
      const parseIndex = (v) => Number.isFinite(Number(v)) ? Number(v) : 0;
      let idx = parseIndex(root.dataset.activePageIndex);
      if (idx < 0 || idx >= pages.length) idx = pages.findIndex(p => p.classList.contains('is-active'));
      if (idx < 0) idx = 0;
      const update = () => {
        pages.forEach((p,i)=>{const a=i===idx;p.classList.toggle('is-active',a);p.classList.toggle('d-none',!a);});
        dots.forEach((d,i)=>{const a=i===idx;d.classList.toggle('is-active',a);d.setAttribute('aria-current',a?'true':'false');});
        if (prev) prev.disabled = idx<=0; if (next) next.disabled = idx>=pages.length-1;
      };
      update();
      prev?.addEventListener('click',()=>{ if(idx>0){idx--;update();}});
      next?.addEventListener('click',()=>{ if(idx<pages.length-1){idx++;update();}});
      dots.forEach((d)=>d.addEventListener('click',()=>{const i=parseIndex(d.dataset.pageIndex); if(i>=0&&i<pages.length&&i!==idx){idx=i;update();}}));
    });
  });
</script>
{% endblock %}