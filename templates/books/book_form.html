{% extends "base.html" %}
{% load static %}

{% block title %}Новая книга · Калейдоскоп книг{% endblock %}

{% block extra_css %}
  {{ block.super }}
  <style>
    .rt-highlight {
      position: relative;
      border: 1px solid rgba(64,83,92,.25);
      background: linear-gradient(145deg, rgba(64,83,92,.06), rgba(64,83,92,.02));
      border-left: .5rem solid var(--rt-primary, #40535c);
      border-radius: 1rem;
      box-shadow: 0 18px 40px rgba(25, 35, 45, .08);
      padding: 1.25rem;
    }
    .rt-highlight-badge{
      position:absolute; top:-.75rem; left:.75rem;
      background: var(--rt-primary,#40535c); color:#fff;
      font-size:.75rem; line-height:1; padding:.4rem .6rem;
      border-radius:.5rem; box-shadow:0 6px 16px rgba(25,35,45,.15);
    }
    @keyframes rt-pulse {
      0%   { box-shadow:0 0 0 0 rgba(64,83,92,.35); }
      70%  { box-shadow:0 0 0 14px rgba(64,83,92,0); }
      100% { box-shadow:0 0 0 0 rgba(64,83,92,0); }
    }
    .rt-pulse-once { animation: rt-pulse 1.8s ease-out 1; }
  </style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-8 col-xl-7">

    <div class="d-flex align-items-center justify-content-between mb-4 flex-wrap gap-2">
      <h1 class="h4 mb-0">Добавление книги</h1>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-primary btn-sm" href="#book-lookup"><i class="bi bi-search"></i> К поиску</a>
        <a class="btn btn-outline-secondary" href="{% url 'book_list' %}"><i class="bi bi-arrow-left"></i> Ко всем книгам</a>
      </div>
    </div>

    <div class="card shadow-sm border-0">
      <div class="card-body">
        <p class="text-muted small">Заполните форму ниже, чтобы поделиться книгой с сообществом. Поля со звёздочкой обязательны.</p>

        <form method="post" enctype="multipart/form-data" autocomplete="off" novalidate>
          {% csrf_token %}
          {{ form.media }}
          {% if prefill_data %}
            {{ prefill_data|json_script:"book-prefill-data" }}
          {% endif %}

          {% if form.non_field_errors %}
            <div class="alert alert-danger">
              {{ form.non_field_errors }}
            </div>
          {% endif %}

          <!-- ПОИСК КНИГИ -->
          <div id="book-lookup" class="mb-4 rt-highlight rt-pulse-once" data-lookup-url="{% url 'book_lookup' %}">
            <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
              <h2 class="h5 mb-0">Поиск книги</h2>
              <span class="text-muted small">Сначала ищем на сайте, затем при необходимости через ISBNdb.</span>
            </div>
            <div class="row g-3 align-items-end">
              <div class="col-md-4">
                <label class="form-label" for="book-lookup-title">Название</label>
                <input type="text" class="form-control" id="book-lookup-title" placeholder="Например, Ведьмак">
              </div>
              <div class="col-md-4">
                <label class="form-label" for="book-lookup-author">Автор</label>
                <input type="text" class="form-control" id="book-lookup-author" placeholder="Анджей Сапковский">
              </div>
              <div class="col-md-3 col-sm-6">
                <label class="form-label" for="book-lookup-isbn">ISBN</label>
                <input type="text" class="form-control" id="book-lookup-isbn" placeholder="978-5-699-XXXXXX">
              </div>
              <div class="col-md-1 col-sm-6 d-grid">
                <button type="button" class="btn btn-outline-primary" id="book-lookup-submit">
                  <i class="bi bi-search"></i>
                  <span class="visually-hidden">Искать</span>
                </button>
              </div>
            </div>

            <div id="book-lookup-feedback" class="form-text mt-2 text-muted">
              Введите данные и нажмите поиск, чтобы убедиться, что книги ещё нет на сайте.
            </div>

            <div id="book-lookup-cover-preview" class="mt-3" hidden>
              <p class="text-muted small mb-2">Обложка найденного издания:</p>
              <div class="ratio ratio-3x4" style="max-width:160px;">
                <img src="" alt="Предпросмотр обложки" class="rounded shadow-sm object-fit-cover" data-role="preview-image">
              </div>
            </div>

            <div id="book-lookup-results" class="mt-4" hidden>
              <div class="mb-3" data-role="local-section" hidden>
                <h3 class="h6">Результаты на сайте</h3>
                <div class="vstack gap-3" data-role="local-results"></div>
              </div>

              <div id="book-lookup-external-suggestion" class="alert alert-warning d-flex justify-content-between align-items-center" hidden>
                <span>Не нашли нужное издание? Попробуйте поискать через ISBNdb.</span>
                <button type="button" class="btn btn-sm btn-outline-primary" id="book-lookup-load-external">Искать в ISBNdb</button>
              </div>

              <div class="mb-3" data-role="external-section" hidden>
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h3 class="h6 mb-0">Найдено через ISBNdb</h3>
                  <span class="text-muted small">Выберите подходящее издание, чтобы заполнить форму автоматически.</span>
                </div>
                <div class="vstack gap-3" data-role="external-results"></div>
              </div>
            </div>
          </div>
          <!-- /ПОИСК КНИГИ -->

          {% if duplicate_candidates %}
            <div class="alert alert-warning">
              <h2 class="h5 mb-3">Мы нашли похожие книги</h2>
              <p class="mb-3">На сайте уже есть книги с таким же названием и авторами. Выберите, что сделать с новым изданием.</p>
              <div class="vstack gap-3">
                {% for candidate in duplicate_candidates %}
                  <div class="border rounded p-3">
                    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                      <div>
                        <h3 class="h6 mb-1">{{ candidate.title }}</h3>
                        <p class="mb-2 text-muted small">Авторы: {{ candidate.authors.all|join:", " }}</p>
                        <p class="mb-0 text-muted small">Всего изданий: {{ candidate.isbn.count }}</p>
                      </div>
                      <a class="btn btn-sm btn-outline-secondary" href="{% url 'book_detail' candidate.pk %}" target="_blank" rel="noopener">Открыть страницу</a>
                    </div>
                    <div class="mt-3">
                      {% with same_value='same:'|add:candidate.pk|stringformat:"s" edition_value='edition:'|add:candidate.pk|stringformat:"s" %}
                        <div class="form-check">
                          <input class="form-check-input" type="radio" name="duplicate_resolution" id="duplicate-same-{{ candidate.pk }}" value="same:{{ candidate.pk }}" {% if duplicate_resolution == same_value %}checked{% endif %}>
                          <label class="form-check-label" for="duplicate-same-{{ candidate.pk }}">Это та же книга и то же издание. Перейти к существующей записи.</label>
                        </div>
                        <div class="form-check mt-2">
                          <input class="form-check-input" type="radio" name="duplicate_resolution" id="duplicate-edition-{{ candidate.pk }}" value="edition:{{ candidate.pk }}" {% if duplicate_resolution == edition_value %}checked{% endif %}>
                          <label class="form-check-label" for="duplicate-edition-{{ candidate.pk }}">Это та же книга, но другое издание. Добавить как дополнительное издание.</label>
                        </div>
                      {% endwith %}
                    </div>
                  </div>
                {% endfor %}
                <div class="border rounded p-3">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="duplicate_resolution" id="duplicate-new" value="new" {% if duplicate_resolution == 'new' %}checked{% endif %}>
                    <label class="form-check-label" for="duplicate-new">Это другая книга. Создать новую запись.</label>
                  </div>
                </div>
              </div>
            </div>
          {% endif %}

          {% for hidden_field in form.hidden_fields %}
            {{ hidden_field }}
          {% endfor %}

          {# ПОЛЯ ФОРМЫ. Чекбокс "Я автор" подсвечиваем отдельно #}
          {% for field in form.visible_fields %}
            {% if field.name == "is_author" %}
              <div class="mb-3 rt-highlight" id="author-confirm">
                <span class="rt-highlight-badge">Важно</span>
                <label class="form-label" id="id_{{ field.name }}_label" for="id_{{ field.name }}">
                  {{ field.label }}{% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                </label>
                {{ field }}
                {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
                {% for error in field.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>
              {% elif field.name == "confirm_authorship" %}
              <div class="mb-4 rt-highlight rt-pulse-once" id="confirm-authorship">
                <div class="form-check mb-2">
                  {{ field }}
                  <label class="form-check-label fw-semibold" for="id_{{ field.name }}">
                    {{ field.label }}{% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                  </label>
                </div>
                {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
                {% for error in field.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>
              {% elif field.name == "genres" %}
              <div class="mb-3" data-genre-field>
                <label class="form-label" id="id_{{ field.name }}_label" for="id_{{ field.name }}">
                  {{ field.label }}{% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                </label>
                {{ field }}
                {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
                {% if genre_suggestions %}
                  <div class="small text-muted mt-2">Выберите подходящие жанры из списка или введите свои вручную.</div>
                  <button type="button" class="btn btn-outline-secondary btn-sm mt-2" data-bs-toggle="collapse" data-bs-target="#genre-suggestions-panel" aria-expanded="false" aria-controls="genre-suggestions-panel">
                    <i class="bi bi-tags"></i>
                    Популярные жанры
                  </button>
                  <div class="collapse" id="genre-suggestions-panel">
                    <div class="border rounded mt-3 p-3 bg-light" data-genre-suggestions-panel>
                      <div class="small text-muted" data-genre-selection-counter>Отметьте жанры и добавьте их в поле выше. Уже внесённые жанры отмечены автоматически.</div>
                      <div class="d-flex flex-wrap gap-2 mt-3" data-genre-suggestions>
                        {% for genre in genre_suggestions %}
                          <input type="checkbox" class="btn-check" id="genre-suggestion-{{ forloop.counter }}" autocomplete="off" data-genre-checkbox value="{{ genre }}">
                          <label class="btn btn-outline-secondary btn-sm" for="genre-suggestion-{{ forloop.counter }}" data-genre-toggle data-genre-suggestion="{{ genre }}">{{ genre }}</label>
                        {% endfor %}
                      </div>
                      <div class="d-flex flex-wrap gap-2 justify-content-end mt-3">
                        <button type="button" class="btn btn-outline-secondary btn-sm" data-genre-clear>
                          <i class="bi bi-arrow-counterclockwise"></i>
                          Сбросить выбор
                        </button>
                        <button type="button" class="btn btn-primary btn-sm" data-genre-apply>
                          <i class="bi bi-plus-circle"></i>
                          Добавить выбранные
                        </button>
                      </div>
                    </div>
                  </div>
                {% endif %}
                {% for error in field.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>
            {% else %}
              <div class="mb-3">
                <label class="form-label" id="id_{{ field.name }}_label" for="id_{{ field.name }}">
                  {{ field.label }}{% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                </label>
                {{ field }}
                {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
                {% for error in field.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>
            {% endif %}
          {% endfor %}

          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg me-1"></i>Сохранить</button>
            <a class="btn btn-outline-secondary" href="{% url 'book_list' %}">Отмена</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Модалка для показа обложки из внешнего источника -->
<div class="modal fade" id="external-cover-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Обложка книги</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
      </div>
      <div class="modal-body text-center">
        <img src="" alt="Обложка книги" class="img-fluid rounded shadow-sm" data-role="external-cover-image">
      </div>
      <div class="modal-footer justify-content-between flex-wrap">
        <a href="#" class="btn btn-outline-secondary" target="_blank" rel="noopener" data-role="external-cover-original">Открыть в браузере</a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const lookupRoot = document.getElementById('book-lookup');
      if (!lookupRoot) return;

      const lookupUrl = lookupRoot.dataset.lookupUrl;
      const titleInput = document.getElementById('book-lookup-title');
      const authorInput = document.getElementById('book-lookup-author');
      const isbnInput = document.getElementById('book-lookup-isbn');
      const submitButton = document.getElementById('book-lookup-submit');
      const feedback = document.getElementById('book-lookup-feedback');
      const resultsRoot = document.getElementById('book-lookup-results');
      const localSection = resultsRoot?.querySelector('[data-role="local-section"]');
      const localResults = resultsRoot?.querySelector('[data-role="local-results"]');
      const externalSection = resultsRoot?.querySelector('[data-role="external-section"]');
      const externalResults = resultsRoot?.querySelector('[data-role="external-results"]');
      const externalButton = document.getElementById('book-lookup-load-external');
      const externalSuggestion = document.getElementById('book-lookup-external-suggestion');
      const coverPreview = document.getElementById('book-lookup-cover-preview');
      const coverPreviewImage = coverPreview?.querySelector('[data-role="preview-image"]');

      const titleField = document.getElementById('id_title');
      const authorsField = document.getElementById('id_authors');
      const genresField = document.getElementById('id_genres');
      const publisherField = document.getElementById('id_publisher');
      const languageField = document.getElementById('id_language');
      const synopsisField = document.getElementById('id_synopsis');
      const isbnField = document.getElementById('id_isbn');
      const metadataField = document.getElementById('id_isbn_metadata');
      const genreSuggestionsPanel = document.querySelector('[data-genre-suggestions-panel]');

      if (genreSuggestionsPanel && genresField) {
        const suggestionCheckboxes = Array.from(genreSuggestionsPanel.querySelectorAll('[data-genre-checkbox]'));
        const applyButton = genreSuggestionsPanel.querySelector('[data-genre-apply]');
        const clearButton = genreSuggestionsPanel.querySelector('[data-genre-clear]');
        const counterElement = genreSuggestionsPanel.querySelector('[data-genre-selection-counter]');

        const getCurrentGenres = () => genresField.value
          .split(',')
          .map((item) => item.trim())
          .filter(Boolean);

        const getCheckboxValue = (checkbox) => (checkbox.getAttribute('value') || checkbox.value || '').trim();

        const updateCounter = () => {
          const selectedCount = suggestionCheckboxes.filter((checkbox) => checkbox.checked).length;
          if (!counterElement) return;
          counterElement.textContent = selectedCount
            ? `Отмечено жанров: ${selectedCount}. Нажмите «Добавить», чтобы обновить поле.`
            : 'Отметьте жанры и добавьте их в поле выше. Уже внесённые жанры отмечены автоматически.';
        };

        const syncCheckboxesWithField = () => {
          const current = new Set(getCurrentGenres());
          suggestionCheckboxes.forEach((checkbox) => {
            const value = getCheckboxValue(checkbox);
            const shouldBeChecked = current.has(value);
            if (checkbox.checked !== shouldBeChecked) {
              checkbox.checked = shouldBeChecked;
            }
            const label = genreSuggestionsPanel.querySelector(`[for="${checkbox.id}"]`);
            if (label) {
              label.setAttribute('aria-pressed', shouldBeChecked ? 'true' : 'false');
              label.classList.toggle('btn-secondary', shouldBeChecked);
              label.classList.toggle('btn-outline-secondary', !shouldBeChecked);
            }
          });
          updateCounter();
        };

        suggestionCheckboxes.forEach((checkbox) => {
          const label = genreSuggestionsPanel.querySelector(`[for="${checkbox.id}"]`);
          if (label) {
            label.setAttribute('aria-pressed', checkbox.checked ? 'true' : 'false');
            label.classList.toggle('btn-secondary', checkbox.checked);
            label.classList.toggle('btn-outline-secondary', !checkbox.checked);
          }
          checkbox.addEventListener('change', () => {
            const associatedLabel = genreSuggestionsPanel.querySelector(`[for="${checkbox.id}"]`);
            if (associatedLabel) {
              associatedLabel.setAttribute('aria-pressed', checkbox.checked ? 'true' : 'false');
              associatedLabel.classList.toggle('btn-secondary', checkbox.checked);
              associatedLabel.classList.toggle('btn-outline-secondary', !checkbox.checked);
            }
            updateCounter();
          });
        });

        applyButton?.addEventListener('click', () => {
          const selected = suggestionCheckboxes
            .filter((checkbox) => checkbox.checked)
            .map((checkbox) => getCheckboxValue(checkbox))
            .filter(Boolean);

          if (!selected.length) return;

          const current = getCurrentGenres();
          selected.forEach((value) => {
            if (!current.includes(value)) {
              current.push(value);
            }
          });

          genresField.value = current.join(', ');
          genresField.dispatchEvent(new Event('input', { bubbles: true }));
          genresField.focus();
          syncCheckboxesWithField();
        });

        clearButton?.addEventListener('click', () => {
          suggestionCheckboxes.forEach((checkbox) => {
            if (!checkbox.checked) return;
            checkbox.checked = false;
            const label = genreSuggestionsPanel.querySelector(`[for="${checkbox.id}"]`);
            if (label) {
              label.setAttribute('aria-pressed', 'false');
              label.classList.add('btn-outline-secondary');
              label.classList.remove('btn-secondary');
            }
          });
          updateCounter();
        });

        genresField.addEventListener('input', syncCheckboxesWithField);
        syncCheckboxesWithField();
      }

      const userAgent = navigator.userAgent || '';
      const isAndroidWebView = /Android/i.test(userAgent) && /\bwv\b/i.test(userAgent);
      const externalCoverModalElement = document.getElementById('external-cover-modal');
      const externalCoverModalImage = externalCoverModalElement?.querySelector('[data-role="external-cover-image"]');
      const externalCoverModalLink = externalCoverModalElement?.querySelector('[data-role="external-cover-original"]');
      const externalCoverModal = externalCoverModalElement && window.bootstrap?.Modal
        ? bootstrap.Modal.getOrCreateInstance(externalCoverModalElement)
        : null;

      if (externalCoverModalElement) {
        externalCoverModalElement.addEventListener('hidden.bs.modal', () => {
          if (externalCoverModalImage) externalCoverModalImage.removeAttribute('src');
          if (externalCoverModalLink) externalCoverModalLink.removeAttribute('href');
        });
      }

      function setLoading(isLoading) {
        if (!submitButton) return;
        submitButton.disabled = isLoading;
        submitButton.innerHTML = isLoading
          ? '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>'
          : '<i class="bi bi-search"></i><span class="visually-hidden">Искать</span>';
      }

      function clearResults() {
        if (localResults) localResults.innerHTML = '';
        if (externalResults) externalResults.innerHTML = '';
        if (localSection) localSection.hidden = true;
        if (externalSection) externalSection.hidden = true;
        if (resultsRoot) resultsRoot.hidden = true;
        if (externalSuggestion) externalSuggestion.hidden = true;
        showCoverPreview('');
      }

      function openExternalCoverPreview(url) {
        if (!url) return;

        if (!isAndroidWebView) {
          let openedWindow = null;
          try { openedWindow = window.open(url, '_blank'); } catch (err) { openedWindow = null; }
          if (openedWindow && typeof openedWindow === 'object') {
            try { openedWindow.opener = null; } catch (err) {}
            return;
          }
        }
        if (externalCoverModal && externalCoverModalImage) {
          externalCoverModalImage.src = url;
          if (externalCoverModalLink) externalCoverModalLink.href = url;
          externalCoverModal.show();
          return;
        }
        window.location.href = url;
      }

      function renderLocal(results) {
        if (!localSection || !localResults) return;
        if (!results.length) { localSection.hidden = true; return; }
        localSection.hidden = false;
        localResults.innerHTML = '';
        results.forEach((item) => {
          const card = document.createElement('div');
          card.className = 'border rounded p-3 d-flex gap-3 align-items-start';

          if (item.cover_url) {
            const thumbWrapper = document.createElement('div');
            thumbWrapper.className = 'ratio ratio-3x4 flex-shrink-0';
            thumbWrapper.style.maxWidth = '72px';
            const img = document.createElement('img');
            img.src = item.cover_url;
            img.alt = `Обложка книги ${item.title}`;
            img.className = 'rounded object-fit-cover';
            thumbWrapper.appendChild(img);
            card.appendChild(thumbWrapper);
          }

          const body = document.createElement('div');
          const title = document.createElement('h4');
          title.className = 'h6 mb-1';
          title.textContent = item.title;
          body.appendChild(title);

          const authors = document.createElement('p');
          authors.className = 'text-muted small mb-2';
          authors.textContent = item.authors.length ? `Авторы: ${item.authors.join(', ')}` : 'Авторы не указаны';
          body.appendChild(authors);

          const editions = document.createElement('p');
          editions.className = 'text-muted small mb-2';
          editions.textContent = `Изданий на сайте: ${item.edition_count}`;
          body.appendChild(editions);

          const link = document.createElement('a');
          link.href = item.detail_url; link.target = '_blank'; link.rel = 'noopener';
          link.className = 'btn btn-sm btn-outline-secondary';
          link.textContent = 'Открыть страницу';

          body.appendChild(link);
          card.appendChild(body);
          localResults.appendChild(card);
        });
      }

      function applyMetadata(metadata) {
        if (!metadataField) return;
        try { metadataField.value = JSON.stringify(metadata || {}); }
        catch (err) { console.warn('Не удалось сохранить данные из API', err); }
      }

      function showCoverPreview(url) {
        if (!coverPreview) return;
        if (!url) {
          coverPreview.hidden = true;
          if (coverPreviewImage) coverPreviewImage.src = '';
          return;
        }
        coverPreview.hidden = false;
        if (coverPreviewImage) coverPreviewImage.src = url;
      }

      function applyExternalResult(item) {
        if (titleField && item.title) titleField.value = item.title;
        if (authorsField && item.authors?.length) authorsField.value = item.authors.join(', ');
        if (genresField && item.subjects?.length) genresField.value = item.subjects.join(', ');
        if (publisherField && item.publishers?.length) publisherField.value = item.publishers.join(', ');
        if (languageField && item.languages?.length) languageField.value = item.languages.join(', ');
        if (synopsisField && item.description && !synopsisField.value) synopsisField.value = item.description;
        if (isbnField && item.isbn_list?.length) isbnField.value = item.isbn_list.join(', ');
        applyMetadata(item.metadata || {});
        showCoverPreview(item.cover_url || '');

        if (feedback) {
          feedback.textContent = 'Данные заполнены из ISBNdb. Проверьте и дополните при необходимости.';
          feedback.classList.remove('text-muted');
        }
      }

      function renderExternal(results, errorMessage) {
        if (!externalSection || !externalResults) return;
        externalResults.innerHTML = '';
        if (errorMessage) {
          externalSection.hidden = false;
          const alert = document.createElement('div');
          alert.className = 'alert alert-danger mb-0';
          alert.textContent = errorMessage;
          externalResults.appendChild(alert);
          return;
        }
        if (!results.length) {
          externalSection.hidden = false;
          const alert = document.createElement('div');
          alert.className = 'alert alert-info mb-0';
          alert.textContent = 'Подходящих изданий не найдено. Попробуйте уточнить запрос.';
          externalResults.appendChild(alert);
          return;
        }
        externalSection.hidden = false;
        results.forEach((item) => {
          const card = document.createElement('div');
          card.className = 'border rounded p-3';

          const header = document.createElement('div');
          header.className = 'd-flex gap-3 align-items-start flex-wrap';

          if (item.cover_url) {
            const cover = document.createElement('div');
            cover.className = 'ratio ratio-3x4 flex-shrink-0';
            cover.style.maxWidth = '96px';
            const img = document.createElement('img');
            img.src = item.cover_url;
            img.alt = `Обложка книги ${item.title}`;
            img.className = 'rounded object-fit-cover shadow-sm';
            cover.appendChild(img);
            header.appendChild(cover);
          }

          const textContainer = document.createElement('div');

          const title = document.createElement('h4');
          title.className = 'h6 mb-1';
          title.textContent = item.title;
          textContainer.appendChild(title);

          if (item.subtitle) {
            const subtitle = document.createElement('p');
            subtitle.className = 'text-muted small mb-1';
            subtitle.textContent = item.subtitle;
            textContainer.appendChild(subtitle);
          }

          if (item.authors?.length) {
            const authors = document.createElement('p');
            authors.className = 'text-muted small mb-1';
            authors.textContent = `Авторы: ${item.authors.join(', ')}`;
            textContainer.appendChild(authors);
          }

          if (item.publish_date || item.physical_format || item.number_of_pages) {
            const meta = document.createElement('p');
            meta.className = 'text-muted small mb-1';
            const parts = [];
            if (item.publish_date) parts.push(`Дата: ${item.publish_date}`);
            if (item.number_of_pages) parts.push(`Страниц: ${item.number_of_pages}`);
            if (item.physical_format) parts.push(`Тип: ${item.physical_format}`);
            meta.textContent = parts.join(' · ');
            textContainer.appendChild(meta);
          }

          if (item.isbn_list?.length) {
            const isbnText = document.createElement('p');
            isbnText.className = 'text-muted small mb-1';
            isbnText.textContent = `ISBN: ${item.isbn_list.join(', ')}`;
            textContainer.appendChild(isbnText);
          }

          if (item.matching_editions?.length) {
            const alert = document.createElement('div');
            alert.className = 'alert alert-warning small mb-2';
            const alertTitle = document.createElement('p');
            alertTitle.className = 'mb-1';
            alertTitle.textContent = 'На сайте уже есть другие издания с таким ISBN:';
            alert.appendChild(alertTitle);
            const list = document.createElement('ul');
            list.className = 'm-0 ps-3';
            item.matching_editions.forEach((edition) => {
              const li = document.createElement('li');
              const link = document.createElement('a');
              link.href = edition.detail_url;
              link.target = '_blank';
              link.rel = 'noopener';
              link.textContent = `${edition.title} (изданий: ${edition.edition_count})`;
              li.appendChild(link);
              if (edition.matching_isbns?.length) {
                const isbnNote = document.createElement('div');
                isbnNote.className = 'text-muted';
                isbnNote.textContent = `Совпадающие ISBN: ${edition.matching_isbns.join(', ')}`;
                li.appendChild(isbnNote);
              }
              list.appendChild(li);
            });
            alert.appendChild(list);
            textContainer.appendChild(alert);
          }

          header.appendChild(textContainer);

          if (item.source_url) {
            const sourceLink = document.createElement('a');
            sourceLink.href = item.source_url;
            sourceLink.target = '_blank';
            sourceLink.rel = 'noopener';
            sourceLink.className = 'btn btn-sm btn-outline-secondary';
            sourceLink.textContent = 'Открыть в ISBNdb';
            header.appendChild(sourceLink);
          }

          card.appendChild(header);

          if (item.description) {
            const description = document.createElement('p');
            description.className = 'mt-2 mb-3 small';
            description.textContent = item.description.length > 320 ? `${item.description.slice(0, 317)}…` : item.description;
            card.appendChild(description);
          }

          const actions = document.createElement('div');
          actions.className = 'd-flex gap-2 flex-wrap';

          const applyButton = document.createElement('button');
          applyButton.type = 'button';
          applyButton.className = 'btn btn-primary btn-sm';
          applyButton.textContent = 'Использовать эти данные';
          applyButton.addEventListener('click', () => applyExternalResult(item));
          actions.appendChild(applyButton);

          if (item.cover_url) {
            const coverLink = document.createElement('a');
            coverLink.href = item.cover_url;
            coverLink.target = '_blank';
            coverLink.rel = 'noopener';
            coverLink.className = 'btn btn-outline-secondary btn-sm';
            coverLink.textContent = 'Открыть обложку';
            coverLink.addEventListener('click', (event) => {
              event.preventDefault();
              openExternalCoverPreview(item.cover_url);
            });
            actions.appendChild(coverLink);
          }

          card.appendChild(actions);
          externalResults.appendChild(card);
        });
      }

      async function performSearch(options = { forceExternal: false }) {
        if (!lookupUrl) return;
        const params = new URLSearchParams();
        const title = titleInput?.value.trim();
        const author = authorInput?.value.trim();
        const isbn = isbnInput?.value.trim();

        if (title) params.set('title', title);
        if (author) params.set('author', author);
        if (isbn) params.set('isbn', isbn);
        if (options.forceExternal) params.set('force_external', '1');

        clearResults();
        setLoading(true);
        applyMetadata({});

        try {
          const response = await fetch(`${lookupUrl}?${params.toString()}`, { headers: { 'Accept': 'application/json' } });
          if (!response.ok) {
            const payload = await response.json().catch(() => ({}));
            if (feedback) {
              feedback.textContent = payload.error || 'Не удалось выполнить поиск. Попробуйте позже.';
              feedback.classList.remove('text-muted');
            }
            return;
          }

          const data = await response.json();
          if (resultsRoot) resultsRoot.hidden = false;
          renderLocal(data.local_results || []);

          if (externalSuggestion) externalSuggestion.hidden = !!options.forceExternal;

          if (options.forceExternal || data.external_error || (data.external_results && data.external_results.length)) {
            if (externalSuggestion) externalSuggestion.hidden = true;
            renderExternal(data.external_results || [], data.external_error);
          } else if (!data.local_results?.length) {
            if (externalSuggestion) externalSuggestion.hidden = false;
          }

          if (feedback && data.local_results?.length) {
            feedback.textContent = 'Эти книги уже есть на сайте. Убедитесь, что вы добавляете другое издание или книгу.';
            feedback.classList.remove('text-muted');
          } else if (feedback) {
            feedback.textContent = 'Мы не нашли книгу на сайте. Можете добавить её вручную или воспользоваться данными из ISBNdb.';
            feedback.classList.remove('text-muted');
          }
        } catch (err) {
          console.error('Lookup failed', err);
          if (feedback) {
            feedback.textContent = 'Произошла ошибка при поиске. Проверьте подключение и повторите попытку.';
            feedback.classList.remove('text-muted');
          }
        } finally {
          setLoading(false);
        }
      }

      submitButton?.addEventListener('click', () => performSearch({ forceExternal: false }));
      externalButton?.addEventListener('click', () => performSearch({ forceExternal: true }));

      const prefillNode = document.getElementById('book-prefill-data');
      if (prefillNode) {
        try {
          const payload = JSON.parse(prefillNode.textContent || '{}');
          const query = payload.query || {};
          if (titleInput && query.title) titleInput.value = query.title;
          if (authorInput && query.author) authorInput.value = query.author;
          if (isbnInput && query.isbn) isbnInput.value = query.isbn;

          if (payload.external_result) {
            renderExternal([payload.external_result], null);
            if (resultsRoot) {
              resultsRoot.hidden = false;
              if (externalSuggestion) externalSuggestion.hidden = true;
            }
            applyExternalResult(payload.external_result);
          }
        } catch (err) {
          console.warn('Не удалось применить данные предварительного заполнения', err);
        }
      }
    });
  </script>
 {% if not user.profile.has_active_premium %}
<!-- Yandex.RTB R-A-17641153-1 -->
<script>
window.yaContextCb.push(() => {
    Ya.Context.AdvManager.render({
        "blockId": "R-A-17641153-1",
        "type": "floorAd",
        "platform": "desktop"
    })
})
</script>
<!-- Yandex.RTB R-A-17641153-4 -->
<script>
window.yaContextCb.push(() => {
    Ya.Context.AdvManager.render({
        "blockId": "R-A-17641153-4",
        "type": "floorAd",
        "platform": "touch"
    })
})
</script>
{% endif %}
{% endblock %}
