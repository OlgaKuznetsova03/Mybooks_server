{% extends "base.html" %}
{% load i18n %}

{% block title %}{{ page_title }} · {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
.blogger-request-form-theme {
  --br-accent: #d9a365;
  --br-accent-dark: #c48847;
  --br-soft: #fbe7b5;
  --br-soft-16: rgba(251, 231, 181, .16);
  --br-soft-32: rgba(251, 231, 181, .32);
}

.blogger-request-form-theme .page-title {
  display: inline-flex;
  align-items: center;
  gap: .5rem;
  padding: .4rem .75rem;
  border-radius: .75rem;
  background: var(--br-soft);
  border: 1px solid var(--br-soft-16);
  margin-bottom: .5rem;
}

.blogger-request-form-theme .card {
  border-color: var(--br-soft-16);
  box-shadow: 0 20px 40px rgba(0, 0, 0, .08);
}

.blogger-request-form-theme .card-body {
  background-image: radial-gradient(120% 120% at 100% 0%, var(--br-soft-16), transparent 60%);
}

.blogger-request-form-theme .form-label,
.blogger-request-form-theme .form-check-label {
  font-weight: 600;
}

.blogger-request-form-theme .form-control,
.blogger-request-form-theme .form-select {
  border-color: var(--br-soft-32);
}

.blogger-request-form-theme .form-control:focus,
.blogger-request-form-theme .form-select:focus {
  border-color: var(--br-accent);
  box-shadow: 0 0 0 .2rem rgba(217, 163, 101, .25);
}

.blogger-request-form-theme .btn-primary {
  background-color: var(--br-accent) !important;
  border-color: var(--br-accent) !important;
  color: #2a1a09 !important;
  font-weight: 600;
}

.blogger-request-form-theme .btn-primary:hover,
.blogger-request-form-theme .btn-primary:focus {
  background-color: var(--br-accent-dark) !important;
  border-color: var(--br-accent-dark) !important;
  color: #2a1a09 !important;
}

.blogger-request-form-theme .platform-form {
  background: rgba(255, 255, 255, .75);
  border: 1px solid var(--br-soft-16);
  border-radius: .75rem;
  padding: 1rem;
}

.blogger-request-form-theme .platform-form + .platform-form {
  margin-top: 1rem;
}

.blogger-request-form-theme .delete-checkbox {
  margin-top: 1.75rem;
}

.blogger-request-form-theme .audience-section {
  background: rgba(255, 255, 255, .75);
  border: 1px solid var(--br-soft-16);
  border-radius: .75rem;
  padding: 1.5rem 1.25rem;
}

.blogger-request-form-theme .audience-section + .audience-section {
  margin-top: 1.5rem;
}
</style>
{% endblock %}

{% block content %}
<div class="blogger-request-form-theme">
  <div class="row justify-content-center">
    <div class="col-lg-10 col-xl-8">
      <h1 class="h3 page-title">
        <i class="bi bi-stars text-warning"></i>
        {{ page_title }}
      </h1>
      {% if intro_text %}
        <p class="text-muted mb-4">
          {{ intro_text }}
        </p>
      {% endif %}

      <form method="post" class="card">
        <div class="card-body">
          {% csrf_token %}
          {{ form.non_field_errors }}

          <div class="mb-4">
            <h2 class="h5 mb-3">{% trans "Основная информация" %}</h2>
            {% include "collaborations/includes/form_field.html" with field=form.target_audience %}
            {% include "collaborations/includes/form_field.html" with field=form.title %}
            {% include "collaborations/includes/form_field.html" with field=form.collaboration_type %}
            {% include "collaborations/includes/form_field.html" with field=form.collaboration_terms %}
          </div>

          <div class="audience-section mb-4" data-audience="authors">
            <h2 class="h5 mb-3">{% trans "Что важно для авторов" %}</h2>
            <p class="text-muted small mb-3">
              {% trans "Поделитесь предпочтениями по книгам и форматам, чтобы авторы понимали, что вам интересно." %}
            </p>
            {% include "collaborations/includes/form_field.html" with field=form.preferred_genres %}
            <div class="row g-3">
              <div class="col-md-4">
                {% include "collaborations/includes/form_field.html" with field=form.accepts_paper %}
              </div>
              <div class="col-md-4">
                {% include "collaborations/includes/form_field.html" with field=form.accepts_electronic %}
              </div>
              <div class="col-md-4">
                {% include "collaborations/includes/form_field.html" with field=form.accepts_audio %}
              </div>

            {% include "collaborations/includes/form_field.html" with field=form.review_formats %}
            {% include "collaborations/includes/form_field.html" with field=form.review_platform_links %}
          </div>

          <div class="audience-section mb-4" data-audience="bloggers">
            <h2 class="h5 mb-3">{% trans "Что важно для блогеров" %}</h2>
            <p class="text-muted small mb-3">
              {% trans "Опишите формат совместной активности и площадки, на которых хотите сотрудничать." %}
            </p>
            {% include "collaborations/includes/form_field.html" with field=form.blogger_collaboration_platform %}
            {% include "collaborations/includes/form_field.html" with field=form.blogger_collaboration_platform_other %}
            {% include "collaborations/includes/form_field.html" with field=form.blogger_collaboration_goal %}
            {% include "collaborations/includes/form_field.html" with field=form.blogger_collaboration_goal_other %}
          </div>

          <div class="mb-4">
            {% include "collaborations/includes/form_field.html" with field=form.additional_info %}
            {% include "collaborations/includes/form_field.html" with field=form.is_active %}
          </div>

          <hr class="my-4">

          <h2 class="h5 mb-3">{% trans "Площадки и охват" %}</h2>
          <p class="text-muted small mb-3">
            {% trans "Расскажите, где вы публикуете отзывы, и укажите ориентировочное количество подписчиков." %}
          </p>

          {{ formset.management_form }}
          {{ formset.non_form_errors }}

    {% for platform_form in formset %}
            <div class="platform-form">
              {% for hidden in platform_form.hidden_fields %}
                {{ hidden }}
              {% endfor %}
              {{ platform_form.non_field_errors }}
              <div class="row g-3">
                {% for field in platform_form.visible_fields %}
                  {% if field.name == "DELETE" %}
                    <div class="col-md-2 delete-checkbox">
                      <div class="form-check">
                        {{ field }}
                        <label class="form-check-label" for="{{ field.id_for_label }}">{% trans "Удалить" %}</label>
                      </div>
                    </div>
                  {% else %}
                    {% if field.name == "followers_count" %}
                      <div class="col-md-4 col-lg-3">
                    {% else %}
                      <div class="col-md-6">
                    {% endif %}
                        <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                        {{ field }}
                        {% if field.help_text %}
                          <div class="form-text">{{ field.help_text }}</div>
                        {% endif %}
                        {% for error in field.errors %}
                          <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                      </div>
                  {% endif %}
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>
      <div class="card-footer text-end">
        {% if cancel_url %}
            <a href="{{ cancel_url }}" class="btn btn-outline-secondary me-2">
              <i class="bi bi-arrow-left-short me-1"></i>{% trans "Отмена" %}
            </a>
          {% endif %}
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-check2-circle me-1"></i>{{ submit_label }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const audienceField = document.getElementById('{{ form.target_audience.auto_id }}');
    if (!audienceField) {
      return;
    }

    const sections = document.querySelectorAll('.audience-section');

    function toggleSections() {
      const value = audienceField.value;
      sections.forEach(function (section) {
        const audience = section.getAttribute('data-audience');
        if (!audience) {
          return;
        }
        const hasErrors = section.querySelector('.invalid-feedback');
        const shouldShow = value === audience || Boolean(hasErrors);
        section.classList.toggle('d-none', !shouldShow);
      });
    }

    audienceField.addEventListener('change', toggleSections);
    toggleSections();
  });
</script>
{% endblock %}