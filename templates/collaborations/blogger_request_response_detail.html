{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Обсуждение отклика" %} · {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
/* ===== Палитра страницы (как на остальных экранах сотрудничества) ===== */
.collab-theme{
  --clb-accent:#d9a365;                /* основные кнопки */
  --clb-accent-dark:#c68845;           /* hover / active */
  --clb-soft:#fbe7b5;                  /* фон шапок/выделений */
  --clb-soft-12:rgba(251,231,181,.12);
  --clb-soft-24:rgba(251,231,181,.24);
  --clb-ink:#2a1a09;                   /* тёмный текст на тёплом фоне */
}

/* Кнопки под бренд */
.collab-theme .btn-primary{
  background-color:var(--clb-accent) !important;
  border-color:var(--clb-accent) !important;
  color:var(--clb-ink) !important;
  font-weight:600;
}
.collab-theme .btn-primary:hover,
.collab-theme .btn-primary:focus{
  background-color:var(--clb-accent-dark) !important;
  border-color:var(--clb-accent-dark) !important;
  color:var(--clb-ink) !important;
}
.collab-theme .btn-outline-primary{
  color:var(--clb-accent) !important;
  border-color:var(--clb-accent) !important;
  font-weight:600;
}
.collab-theme .btn-outline-primary:hover,
.collab-theme .btn-outline-primary:focus{
  background-color:var(--clb-accent) !important;
  border-color:var(--clb-accent) !important;
  color:var(--clb-ink) !important;
}

/* Ссылочная кнопка «Назад» — под акцент */
.collab-theme .btn-link{
  color:var(--clb-accent) !important;
}
.collab-theme .btn-link:hover,
.collab-theme .btn-link:focus{
  color:var(--clb-accent-dark) !important;
  text-decoration:none;
}

/* Карточки и шапки */
.collab-theme .card{
  border:1px solid var(--clb-soft-12);
  transition:transform .15s ease, box-shadow .15s ease;
}
.collab-theme .card.shadow-sm:hover{
  transform:translateY(-1px);
  box-shadow:0 16px 32px rgba(0,0,0,.10);
}
.collab-theme .card-header,
.collab-theme .card-footer.bg-soft{
  background:var(--clb-soft);
  border-color:var(--clb-soft-24);
}
.collab-theme .card-footer{
  border-top:1px solid var(--clb-soft-24);
}

/* Фокус инпутов/текстареа */
.collab-theme .form-control:focus,
.collab-theme .form-select:focus,
.collab-theme textarea:focus{
  border-color:var(--clb-accent);
  box-shadow:0 0 0 .25rem rgba(217,163,101,.25);
}

/* Бейджи ролей и светлые пилюли */
.collab-theme .badge.text-bg-primary,
.collab-theme .badge.text-bg-secondary{
  border-radius:999px;
  padding:.35rem .6rem;
}
.collab-theme .badge.text-bg-light{
  background:#fff9ea !important;
  border:1px solid var(--clb-soft-24) !important;
  color:#5b442c !important;
  border-radius:999px;
  padding:.35rem .6rem;
}

/* Пузырьки комментариев */
.collab-theme .comment-bubble{
  background:#fffdf5;
  border:1px solid var(--clb-soft-24);
  border-radius:.75rem;
}
.collab-theme .comment-bubble.is-author{
  background:#fff7e6; /* чуть теплее для автора */
}
.collab-theme .comment-bubble.is-blogger{
  background:#fff5ea; /* и для блогера */
}

/* Примечание под карточкой статуса */
.collab-theme .card .small.text-muted.note-soft{
  background:var(--clb-soft);
  border-top:1px solid var(--clb-soft-24);
  display:block;
  padding:.5rem .75rem;
}
</style>
{% endblock %}

{% block content %}
<div class="collab-theme">

  <div class="mb-4">
    <a href="{{ back_url }}" class="btn btn-link text-decoration-none ps-0">
      <i class="bi bi-arrow-left"></i> {% trans "Назад" %}
    </a>
  </div>

  <div class="row g-4">
    <div class="col-lg-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h1 class="h5 mb-3">{{ request_obj.title }}</h1>
          <dl class="row small text-muted mb-4">
            <dt class="col-6">{% trans "Статус отклика" %}</dt>
            <dd class="col-6">{{ response.get_status_display }}</dd>
            <dt class="col-6">{% trans "Отправлен" %}</dt>
            <dd class="col-6">{{ response.created_at|date:"j E Y, H:i" }}</dd>
          </dl>

          <div class="mb-4">
            <h2 class="h6">{% trans "Кто откликнулся" %}</h2>
            <p class="mb-1 fw-semibold">
              {{ response.responder.get_full_name|default:response.responder.username }}
            </p>
            <div class="small text-muted">
              {% if response.responder_type == response.ResponderType.AUTHOR %}
                {% trans "Автор" %}
              {% else %}
                {% trans "Блогер" %}
              {% endif %}
            </div>
          </div>

          {% if response.book %}
            <div class="mb-4">
              <h2 class="h6">{% trans "Предлагаемая книга" %}</h2>
              <p class="mb-0">{{ response.book.title }}</p>
            </div>
          {% endif %}

          {% if response.platform_link %}
            <div class="mb-4">
              <h2 class="h6">{% trans "Ссылка на площадку" %}</h2>
              <p class="mb-0">
                <a href="{{ response.platform_link }}" target="_blank" rel="noopener">{{ response.platform_link }}</a>
              </p>
            </div>
          {% endif %}

          <div class="mb-4">
            <h2 class="h6">{% trans "Сообщение отклика" %}</h2>
            {% if response.message %}
              <p class="mb-0">{{ response.message|linebreaks }}</p>
            {% else %}
              <p class="text-muted small mb-0">{% trans "Без дополнительного сообщения." %}</p>
            {% endif %}
          </div>
        </div>
        <div class="card-footer small text-muted">
          {% if can_comment %}
            {% trans "Обсуждение доступно, пока решение не принято." %}
          {% else %}
            {% trans "Отклик закрыт для новых комментариев." %}
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="h5 mb-4">{% trans "Комментарии" %}</h2>

          {% if comments %}
            <div class="d-flex flex-column gap-4">
              {% for comment in comments %}
                <div class="comment-bubble border rounded p-3 {% if comment.author_id == response.responder_id %}is-author{% elif comment.author_id == request_obj.blogger_id %}is-blogger{% endif %}">
                  <div class="d-flex justify-content-between align-items-start gap-3 mb-2">
                    <div>
                      <strong><a class="text-decoration-none link-dark" href="{% url 'profile' comment.author.username %}">{{ comment.author.get_full_name|default:comment.author.username }}</a></strong>
                      {% if comment.author_id == request_obj.blogger_id %}
                        <span class="badge text-bg-secondary ms-2">{% trans "Блогер" %}</span>
                      {% elif comment.author_id == response.responder_id %}
                        {% if response.responder_type == response.ResponderType.AUTHOR %}
                          <span class="badge text-bg-primary ms-2">{% trans "Автор" %}</span>
                        {% else %}
                          <span class="badge text-bg-secondary ms-2">{% trans "Блогер" %}</span>
                        {% endif %}
                      {% endif %}
                    </div>
                    <span class="text-muted small">{{ comment.created_at|date:"j E Y, H:i" }}</span>
                  </div>
                  <p class="mb-0">{{ comment.text|linebreaks }}</p>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-muted mb-0">{% trans "Пока нет комментариев. Начните обсуждение, чтобы уточнить детали." %}</p>
          {% endif %}
        </div>

        {% if can_comment %}
          <div class="card-footer bg-soft">
            <form method="post" class="d-flex flex-column gap-3">
              {% csrf_token %}
              <div>
                <label class="form-label" for="{{ form.text.id_for_label }}">{{ form.text.label }}</label>
                {{ form.text }}
                {% for error in form.text.errors %}
                  <div class="invalid-feedback d-block">{{ error }}</div>
                {% endfor %}
              </div>
              <div class="d-flex justify-content-end">
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-chat-dots me-1"></i>{% trans "Отправить" %}
                </button>
              </div>
            </form>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

</div>
{% if not user.profile.has_active_premium %}
<!-- Yandex.RTB R-A-17641153-1 -->
<script>
window.yaContextCb.push(() => {
    Ya.Context.AdvManager.render({
        "blockId": "R-A-17641153-1",
        "type": "floorAd",
        "platform": "desktop"
    })
})
</script>
<!-- Yandex.RTB R-A-17641153-4 -->
<script>
window.yaContextCb.push(() => {
    Ya.Context.AdvManager.render({
        "blockId": "R-A-17641153-4",
        "type": "floorAd",
        "platform": "touch"
    })
})
</script>
{% endif %}
{% endblock %}
