{% extends "base.html" %}
{% load i18n %}

{% block title %}{{ request_obj.title }} · {{ block.super }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-4">
  <div>
    <h1 class="h3 mb-1">{{ request_obj.title }}</h1>
    <p class="text-muted mb-0">{% trans "Заявка блогера" %}</p>
  </div>
  <span class="badge text-bg-info fs-6">{{ request_obj.blogger.get_full_name|default:request_obj.blogger.username }}</span>
</div>

<div class="row g-4">
  <div class="col-lg-8">
    <div class="card shadow-sm">
      <div class="card-body">
        {% if request_obj.additional_info %}
          <h2 class="h5">{% trans "О себе" %}</h2>
          <p>{{ request_obj.additional_info|linebreaks }}</p>
          <hr>
        {% endif %}

        <h2 class="h5">{% trans "Предпочтения" %}</h2>
        <dl class="row small text-muted">
          <dt class="col-sm-5">{% trans "Жанры" %}</dt>
          <dd class="col-sm-7">
            {% for genre in request_obj.preferred_genres.all %}
              <span class="badge text-bg-light border me-1">{{ genre.name }}</span>
            {% empty %}
              {% trans "Не указано" %}
            {% endfor %}
          </dd>

          <dt class="col-sm-5">{% trans "Форматы" %}</dt>
          <dd class="col-sm-7">
            {% for item in request_obj.get_format_display_list %}
              <span class="badge text-bg-light border me-1">{{ item }}</span>
            {% empty %}
              {% trans "Любые" %}
            {% endfor %}
          </dd>

          <dt class="col-sm-5">{% trans "Платформы" %}</dt>
          <dd class="col-sm-7">
            {% for platform in request_obj.review_formats.all %}
              <span class="badge text-bg-light border me-1">{{ platform.name }}</span>
            {% empty %}
              {% trans "Не указаны" %}
            {% endfor %}
          </dd>

          <dt class="col-sm-5">{% trans "Оплачиваемые проекты" %}</dt>
          <dd class="col-sm-7">
            {% if request_obj.open_for_paid_collaboration %}
              {% trans "Готов обсуждать оплату" %}
            {% else %}
              {% trans "Рассматриваю только бартер" %}
            {% endif %}
          </dd>
        </dl>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="card shadow-sm">
      <div class="card-header">{% trans "Охват" %}</div>
      <div class="card-body">
        {% with platforms=request_obj.platforms.all %}
          {% if platforms %}
            <ul class="list-unstyled mb-0">
              {% for platform in platforms %}
                <li class="mb-3">
                  <div class="fw-semibold">
                    {% if platform.display_name %}
                      {{ platform.display_name }}
                    {% else %}
                      {% trans "Платформа" %}
                    {% endif %}
                  </div>
                  <div class="text-muted small">
                    <i class="bi bi-people-fill me-1"></i>{{ platform.followers_count|default:0 }}
                    {% if platform.platform and platform.platform.url %}
                      · <a href="{{ platform.platform.url }}" class="text-muted" target="_blank" rel="noopener">{% trans "профиль" %}</a>
                    {% endif %}
                  </div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted mb-0">{% trans "Блогер не добавил информацию о подписчиках." %}</p>
          {% endif %}
        {% endwith %}
      </div>
    </div>

    {% if user.is_authenticated %}
      <div class="card shadow-sm mt-4">
        <div class="card-header">{% trans "Откликнуться" %}</div>
        <div class="card-body">
          {% if can_respond %}
            {% if existing_response %}
              <p class="text-muted small mb-3">{% trans "Вы уже откликались на заявку. Можно обновить сообщение." %}</p>
            {% endif %}
            <form method="post" action="{% url 'collaborations:blogger_request_respond' request_obj.pk %}">
              {% csrf_token %}
              {{ response_form.as_p }}
              <button type="submit" class="btn btn-primary w-100">
                <i class="bi bi-send me-1"></i>{% trans "Отправить предложение" %}
              </button>
            </form>
          {% else %}
            <p class="text-muted small mb-0">{% trans "На заявку могут откликаться только авторы." %}</p>
          {% endif %}
        </div>
      </div>
    {% else %}
      <div class="alert alert-info mt-4" role="alert">{% trans "Войдите, чтобы связаться с блогером." %}</div>
    {% endif %}
  </div>
</div>
{% endblock %}