{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Сотрудничества" %} · {{ block.super }}{% endblock %}

{% block content %}
<h1 class="h3 mb-4">{% trans "Мои сотрудничества" %}</h1>

{% if collaborations %}
  <div class="table-responsive">
    <table class="table align-middle">
      <thead class="table-light">
        <tr>
          <th>{% trans "Партнёр" %}</th>
          <th>{% trans "Книга/заявка" %}</th>
          <th>{% trans "Статус" %}</th>
          <th>{% trans "Дедлайн" %}</th>
          <th class="text-end">{% trans "Действия" %}</th>
        </tr>
      </thead>
      <tbody>
        {% for collaboration in collaborations %}
          <tr class="{% if collaboration.needs_attention %}table-warning{% endif %}">
            <td>
              {% if user == collaboration.author %}
                {{ collaboration.partner.get_full_name|default:collaboration.partner.username }}
              {% else %}
                {{ collaboration.author.get_full_name|default:collaboration.author.username }}
              {% endif %}
              {% with rating=collaboration.partner_rating %}
                {% if rating is not None %}
                  <div class="text-muted small">{% trans "Рейтинг" %}: {{ rating }}</div>
                {% endif %}
              {% endwith %}
            </td>
            <td>
              {% if collaboration.offer %}
                <a href="{% url 'collaborations:offer_detail' collaboration.offer.pk %}">{{ collaboration.offer.title }}</a>
              {% elif collaboration.request %}
                <a href="{% url 'collaborations:blogger_request_detail' collaboration.request.pk %}">{{ collaboration.request.title }}</a>
              {% else %}
                —
              {% endif %}
              <div class="text-muted small">{% trans "Создано" %}: {{ collaboration.created_at|date:"j E Y" }}</div>
            </td>
            <td>
              <span class="badge text-bg-secondary">{{ collaboration.get_status_display }}</span>
            </td>
            <td>
              {{ collaboration.deadline|date:"j E Y" }}
              {% if collaboration.status == collaboration.Status.FAILED %}
                <div class="text-danger small">{% trans "Просрочено" %}</div>
              {% endif %}
            </td>
            <td class="text-end">
              {% if user == collaboration.partner %}
                {% if collaboration.status == collaboration.Status.NEGOTIATION or collaboration.status == collaboration.Status.ACTIVE %}
                  <a href="{% url 'collaborations:collaboration_review' collaboration.pk %}" class="btn btn-sm btn-outline-primary me-2">
                    <i class="bi bi-upload me-1"></i>{% trans "Отправить ссылки" %}
                  </a>
                  {% endif %}
              {% endif %}
              {% if user == collaboration.author %}
                {% if collaboration.status == collaboration.Status.NEGOTIATION or collaboration.status == collaboration.Status.ACTIVE %}
                  <div class="btn-group">
                    <a href="{% url 'collaborations:collaboration_confirm' collaboration.pk %}" class="btn btn-sm btn-success">
                      <i class="bi bi-check-circle me-1"></i>{% trans "Подтвердить" %}
                    </a>
                    <a href="{% url 'collaborations:collaboration_fail' collaboration.pk %}" class="btn btn-sm btn-outline-danger">
                      <i class="bi bi-exclamation-octagon me-1"></i>{% trans "Просрочено" %}
                    </a>
                  </div>
                {% endif %}
                </div>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  <div class="alert alert-info" role="alert">
    {% trans "Вы ещё не участвуете в сотрудничествах." %}
  </div>
{% endif %}
{% endblock %}