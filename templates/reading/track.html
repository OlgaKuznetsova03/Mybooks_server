{% extends "base.html" %}
{% block title %}Чтение: {{ book.title }}{% endblock %}

{% block extra_css %}
<style>
  .reading-progress-page {
    color: #332c0f;
    background: linear-gradient(180deg, rgba(188, 184, 147, 0.2) 0%, rgba(255, 255, 255, 1) 220px);
    border-radius: 28px;
    padding: 0.5rem;
    animation: fadeInUp 0.8s ease-out;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .reading-progress-backdrop {
    background: linear-gradient(180deg, rgba(188, 184, 147, 0.45) 0%, rgba(255, 255, 255, 0.9) 45%, #ffffff 100%);
    border-radius: 32px;
    padding: 1.75rem 1.5rem;
    position: relative;
    overflow: hidden;
    transition: transform 0.1s ease-out;
  }

  .celebration-canvas {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 1055;
  }

  .reading-progress-backdrop::before {
    content: "";
    position: absolute;
    inset: 12% auto auto -28%;
    width: 240px;
    height: 240px;
    background: radial-gradient(circle at center, rgba(95, 92, 59, 0.25) 0%, rgba(95, 92, 59, 0) 70%);
    z-index: 0;
  }

  .reading-progress-backdrop::after {
    content: "";
    position: absolute;
    inset: auto -26% -20% auto;
    width: 260px;
    height: 260px;
    background: radial-gradient(circle at center, rgba(71, 67, 41, 0.2) 0%, rgba(71, 67, 41, 0) 70%);
    z-index: 0;
  }

  .reading-progress-hero {
    position: relative;
    z-index: 1;
    display: grid;
    gap: 1.25rem;
    align-items: stretch;
  }

  .reading-progress-hero::before {
    content: "";
    position: absolute;
    inset: -12px -14px -20px -14px;
    border-radius: 28px;
    background: linear-gradient(180deg,
        rgba(188, 184, 147, 0.15) 0%,
        rgba(188, 184, 147, 0.45) 35%,
        rgba(95, 92, 59, 0.55) 100%);
    z-index: -1;
    pointer-events: none;
  }

  .reading-progress-hero__cover {
    position: relative;
    border-radius: 22px;
    padding: 0.9rem;
    box-shadow: 0 12px 24px rgba(51, 44, 15, 0.08);
    overflow: visible;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    transform: perspective(1000px) rotateY(0deg);
    transition: all 0.5s ease;
  }

  .reading-progress-hero__cover:hover {
    transform: perspective(1000px) rotateY(-5deg) scale(1.02);
  }

  .reading-progress-hero__cover::before {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: inherit;
    background: rgba(255, 255, 255, 0.9);
    z-index: 0;
  }

  .reading-progress-hero__cover > * {
    position: relative;
    z-index: 1;
    width: 100%;
  }

  .reading-progress-hero__cover img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    transition: opacity 0.5s ease;
  }

  .reading-progress-hero__cover .bg-body-secondary {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .reading-progress-hero__meta {
    position: relative;
    background: rgba(255, 255, 255, 0.92);
    border-radius: 22px;
    padding: 1.25rem;
    box-shadow: 0 16px 30px rgba(51, 44, 15, 0.08);
    height: 100%;
    display: flex;
    flex-direction: column;
    z-index: 1;
  }

  .reading-progress-pills {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .reading-progress-pill {
    background: rgba(95, 92, 59, 0.1);
    border-radius: 999px;
    padding: 0.35rem 0.85rem;
    font-size: 0.85rem;
    color: #474329;
    animation: bounceIn 0.6s ease-out;
    animation-fill-mode: both;
  }

  .reading-progress-pill:nth-child(1) { animation-delay: 0.1s; }
  .reading-progress-pill:nth-child(2) { animation-delay: 0.2s; }
  .reading-progress-pill:nth-child(3) { animation-delay: 0.3s; }

  @keyframes bounceIn {
    0% {
      opacity: 0;
      transform: scale(0.3);
    }
    50% {
      opacity: 1;
      transform: scale(1.05);
    }
    70% {
      transform: scale(0.9);
    }
    100% {
      opacity: 1;
      transform: scale(1);
    }
  }

  .reading-progress-meter {
    background-color: rgba(95, 92, 59, 0.1);
    border-radius: 999px;
    height: 12px;
    overflow: hidden;
  }

  .reading-progress-meter__bar {
    background: linear-gradient(90deg, #5f5c3b 0%, #474329 55%, #332c0f 100%);
    border-radius: 999px;
    width: 0%;
    animation: fillProgress 1.5s ease-out forwards;
    animation-delay: 0.3s;
  }

  @keyframes fillProgress {
    to {
      width: {{ progress.percent|floatformat:-2 }}%;
    }
  }

  .reading-progress-summary {
    color: #5f5c3b;
    font-size: 0.95rem;
  }

  .reading-section {
    border-radius: 24px;
    background: rgba(255, 255, 255, 0.96);
    box-shadow: 0 18px 40px rgba(51, 44, 15, 0.07);
    padding: 1.5rem;
    margin-top: 1.5rem;
    opacity: 0;
    animation: slideInUp 0.6s ease-out forwards;
  }

  .reading-section:nth-child(1) { animation-delay: 0.1s; }
  .reading-section:nth-child(2) { animation-delay: 0.2s; }
  .reading-section:nth-child(3) { animation-delay: 0.3s; }
  .reading-section:nth-child(4) { animation-delay: 0.4s; }
  .reading-section:nth-child(5) { animation-delay: 0.5s; }

  .modern-chart-card {
    background: linear-gradient(135deg, #ffffff 0%, #fafafa 100%);
    border-radius: 20px;
    padding: 1.5rem;
    box-shadow:
      0 4px 20px rgba(0, 0, 0, 0.08),
      0 1px 4px rgba(0, 0, 0, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .modern-chart-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(
      90deg,
      #8b7355 0%,
      #a89276 25%,
      #c4b5a0 50%,
      #a89276 75%,
      #8b7355 100%
    );
    border-radius: 20px 20px 0 0;
  }

  .modern-chart-card:hover {
    transform: translateY(-2px);
    box-shadow:
      0 8px 30px rgba(0, 0, 0, 0.12),
      0 2px 8px rgba(0, 0, 0, 0.06);
  }

  .modern-chart-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .modern-chart-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #2d3748;
    margin: 0;
    background: linear-gradient(135deg, #4a5568, #2d3748);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .modern-chart-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    align-items: center;
  }

  .modern-legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0.75rem;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 12px;
    border: 1px solid rgba(139, 115, 85, 0.1);
    transition: all 0.2s ease;
  }

  .modern-legend-item:hover {
    background: rgba(139, 115, 85, 0.05);
    transform: translateY(-1px);
  }

  .modern-legend-color {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .modern-legend-label {
    font-size: 0.8rem;
    font-weight: 500;
    color: #4a5568;
    white-space: nowrap;
  }

  .modern-chart-container {
    position: relative;
    min-height: 280px;
    padding: 0.5rem;
  }

  :root {
    --color-paper: #92ada4;
    --color-ebook: #daa38f;
    --color-audio: #9b7d61;
    --color-default: #92ada4;

    --color-paper-light: rgba(146, 173, 164, 0.1);
    --color-ebook-light: rgba(218, 163, 143, 0.1);
    --color-audio-light: rgba(155, 125, 97, 0.1);

    --gradient-paper: linear-gradient(135deg, #92ada4, #b6cbc4);
    --gradient-ebook: linear-gradient(135deg, #daa38f, #e8c7b6);
    --gradient-audio: linear-gradient(135deg, #9b7d61, #b8a58c);
  }

  @media (max-width: 768px) {
    .modern-chart-header {
      flex-direction: column;
      align-items: stretch;
    }

    .modern-chart-legend {
      justify-content: center;
    }

    .modern-chart-container {
      min-height: 240px;
    }
  }
  .reading-section:nth-child(6) { animation-delay: 0.6s; }

  @keyframes slideInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .reading-progress-accordion {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .reading-progress-accordion__item {
    border-radius: 20px;
    background: rgba(188, 184, 147, 0.12);
    padding: 0.75rem 1rem;
    transition: all 0.3s ease;
  }

  .reading-progress-accordion__item:hover {
    background: rgba(188, 184, 147, 0.18);
    transform: translateX(5px);
  }

  .reading-progress-toggle {
    background: none;
    border: 0;
    color: #332c0f;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    font-size: 0.95rem;
    font-weight: 600;
    padding: 0.25rem 0;
    text-align: left;
    width: 100%;
    transition: all 0.3s ease;
  }

  .reading-progress-toggle:hover {
    color: #1f1a05;
    transform: translateX(3px);
  }

  .reading-progress-toggle:focus-visible {
    outline: 2px solid rgba(71, 67, 41, 0.45);
    outline-offset: 4px;
  }

  .reading-progress-toggle__icon {
    align-items: center;
    background: rgba(71, 67, 41, 0.12);
    border-radius: 999px;
    display: inline-flex;
    height: 2rem;
    justify-content: center;
    width: 2rem;
    transition: all 0.3s ease;
  }

  .reading-progress-toggle__icon::before {
    content: "▸";
    display: inline-block;
    font-size: 1rem;
    line-height: 1;
    transition: transform 0.2s ease;
  }

  .reading-progress-toggle:not(.collapsed) .reading-progress-toggle__icon::before {
    transform: rotate(90deg);
  }

  .reading-progress-toggle:not(.collapsed) .reading-progress-toggle__icon {
    background: rgba(71, 67, 41, 0.18);
  }

  .reading-progress-accordion__body {
    margin-top: 1rem;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.96);
    border-radius: 16px;
    box-shadow: inset 0 0 0 1px rgba(71, 67, 41, 0.12);
    animation: fadeIn 0.3s ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .reading-subsection {
    border-radius: 20px;
    background: rgba(188, 184, 147, 0.18);
    padding: 1.25rem;
    box-shadow: none;
  }

  .reading-section__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .reading-section__title {
    font-size: 1.05rem;
    font-weight: 700;
    color: #332c0f;
    margin: 0;
  }

  .reading-section__note {
    font-size: 0.85rem;
    color: #5f5c3b;
    margin: 0;
  }

  .reading-section .btn-primary,
  .reading-section .btn-success {
    background-color: #474329;
    border-color: #474329;
    transition: all 0.3s ease;
  }

  .reading-section .btn-primary:hover,
  .reading-section .btn-success:hover {
    background-color: #332c0f;
    border-color: #332c0f;
    transform: translateY(-2px);
  }

  .reading-section .btn-outline-primary,
  .reading-section .btn-outline-secondary {
    color: #474329;
    border-color: rgba(71, 67, 41, 0.35);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .reading-section .btn-outline-primary::before,
  .reading-section .btn-outline-secondary::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.5s;
  }

  .reading-section .btn-outline-primary:hover::before,
  .reading-section .btn-outline-secondary:hover::before {
    left: 100%;
  }

  .reading-section .btn-outline-primary:hover,
  .reading-section .btn-outline-secondary:hover {
    background-color: rgba(188, 184, 147, 0.3);
    border-color: #474329;
    color: #332c0f;
    transform: translateY(-1px);
  }

  .reading-section table thead th {
    background-color: rgba(188, 184, 147, 0.22);
    color: #332c0f;
    border-bottom-width: 0;
  }

  .reading-section table tbody tr:nth-child(even) {
    background-color: rgba(188, 184, 147, 0.12);
  }

  .reading-section table td,
  .reading-section table th {
    border-color: rgba(71, 67, 41, 0.12) !important;
  }

  .reading-note-area textarea,
  .reading-section textarea,
  .reading-section input,
  .reading-section select {
    border-radius: 14px !important;
    border-color: rgba(95, 92, 59, 0.35);
    transition: all 0.3s ease;
  }

  .reading-section textarea:focus,
  .reading-section input:focus,
  .reading-section select:focus {
    border-color: #474329;
    box-shadow: 0 0 0 0.2rem rgba(71, 67, 41, 0.25);
    transform: translateY(-1px);
  }

  .reading-section .form-text {
    color: #5f5c3b;
  }

  .reading-section .alert-danger {
    border-radius: 16px;
  }

  .reading-section + .reading-section {
    margin-top: 1.5rem;
  }

  .stat-card {
    transition: all 0.3s ease;
    position: relative;
  }

  .stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(51, 44, 15, 0.15);
  }

  @keyframes pulse-gentle {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
  }

  .reading-finished-button .btn {
    background-color: #5f5c3b;
    border-radius: 999px;
    border: none;
    padding: 0.65rem 1.6rem;
    animation: pulse-gentle 2s ease-in-out infinite;
    transition: all 0.3s ease;
  }

  .reading-finished-button .btn:hover {
    background-color: #474329;
    animation: none;
    transform: scale(1.05);
  }

  .reading-chart-card {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 24px;
    box-shadow: 0 18px 40px rgba(51, 44, 15, 0.07);
    transition: all 0.3s ease;
  }

  .reading-chart-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 25px 50px rgba(51, 44, 15, 0.1);
  }

  .reading-chart-card__canvas {
    min-height: 240px;
    padding: 1rem;
  }

  .reading-progress-page .table-responsive {
    border-radius: 18px;
    overflow: hidden;
  }

  .animated-number {
    display: inline-block;
  }

  .character-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }

  .btn-sm {
    padding: 0.25rem 0.75rem;
    font-size: 0.8rem;
  }

  .reading-section-table,
  .reading-section-list {
    display: block;
  }

  @media (max-width: 767.98px) {
    .reading-progress-page {
      padding: 0;
      border-radius: 18px;
    }

    .reading-progress-backdrop {
      padding: 1.5rem 1.1rem;
      border-radius: 24px;
    }

    .reading-progress-hero__cover {
      justify-self: center;
      width: min(72vw, 240px);
    }

    .reading-section {
      padding: 1.25rem;
    }

    .reading-section__title {
      font-size: 1rem;
    }

    .reading-section .row.g-3 {
      row-gap: 1rem !important;
    }

    .reading-section-table,
    .reading-section-list {
      display: none;
    }

    .mobile-accordion-section {
      margin-bottom: 1rem;
    }

    .mobile-accordion-header {
      background: rgba(188, 184, 147, 0.15);
      border: none;
      border-radius: 16px;
      padding: 1rem;
      width: 100%;
      text-align: left;
      font-weight: 600;
      color: #332c0f;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }

    .mobile-accordion-header:hover {
      background: rgba(188, 184, 147, 0.25);
    }

    .mobile-accordion-header:focus {
      outline: 2px solid rgba(71, 67, 41, 0.45);
      outline-offset: 2px;
    }

    .mobile-accordion-icon {
      transition: transform 0.3s ease;
    }

    .mobile-accordion-header[aria-expanded="true"] .mobile-accordion-icon {
      transform: rotate(180deg);
    }

    .mobile-accordion-content {
      padding: 1rem 0;
    }

    .character-card {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 16px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      border: 1px solid rgba(188, 184, 147, 0.3);
      transition: all 0.3s ease;
    }

    .character-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(51, 44, 15, 0.1);
    }

    .character-name {
      font-weight: 600;
      color: #332c0f;
      margin-bottom: 0.5rem;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .character-name::after {
      content: "▸";
      transition: transform 0.3s ease;
    }

    .character-name.expanded::after {
      transform: rotate(90deg);
    }

    .character-description {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      color: #5f5c3b;
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .character-description.expanded {
      max-height: 200px;
      margin-top: 0.5rem;
    }

    .compact-form {
      background: rgba(188, 184, 147, 0.1);
      border-radius: 16px;
      padding: 1rem;
      margin-top: 1rem;
    }

    .mobile-action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .mobile-action-button {
      flex: 1;
      min-width: 140px;
      background: rgba(188, 184, 147, 0.2);
      border: 1px solid rgba(95, 92, 59, 0.3);
      border-radius: 12px;
      padding: 0.75rem;
      font-size: 0.9rem;
      font-weight: 600;
      color: #332c0f;
      transition: all 0.3s ease;
    }

    .mobile-action-button:hover {
      background: rgba(188, 184, 147, 0.3);
      transform: translateY(-2px);
    }
  }

  @media (min-width: 768px) {
    .mobile-accordion-section {
      display: none;
    }

    .reading-section-table,
    .reading-section-list {
      display: block;
    }
  }

  @media (min-width: 768px) {
    .reading-progress-hero {
      grid-template-columns: minmax(200px, 220px) 1fr;
      align-items: start;
    }

    .reading-progress-backdrop {
      padding: 2rem 2.25rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="reading-progress-page">
  <section class="reading-progress-backdrop mb-4">
    <div class="reading-progress-hero">
      <div class="reading-progress-hero__cover">
        {% with cover_url=book.get_cover_url %}
          {% if cover_url %}
            <img src="{{ cover_url }}" class="img-fluid rounded" alt="Обложка книги {{ book.title }}" 
                 onload="this.style.opacity='1'" style="opacity:0; transition: opacity 0.5s ease">
          {% else %}
            <div class="bg-body-secondary border-0 rounded-4 d-flex align-items-center justify-content-center" style="height: 220px;">
              <span class="text-muted small text-center px-3">Нет обложки</span>
            </div>
          {% endif %}
        {% endwith %}
      </div>
      <div class="reading-progress-hero__meta">
        <h1 class="h4 fw-bold mb-3" id="book-title">{{ book.title }}</h1>
        <div class="reading-progress-pills mb-3">
          {% for medium in media_details %}
            <span class="reading-progress-pill">{{ medium.label }}</span>
          {% endfor %}
        </div>
        <div class="reading-progress-summary mb-3">
          <div class="mb-2 d-flex flex-wrap gap-2 align-items-center">
            <span class="fw-semibold">Прогресс:</span>
            <span class="fs-5 fw-bold animated-number" id="progress-percent">{{ progress.percent|floatformat:-2 }}%</span>
            {% if combined_pages is not None %}
              <span class="badge rounded-pill text-bg-light text-wrap">Эквивалент: <span class="animated-number">{{ combined_pages|floatformat:-2 }}</span> стр.</span>
            {% endif %}
          </div>
          {% if total_pages %}
            <p class="mb-1">Всего страниц: <strong class="animated-number">{{ total_pages }}</strong></p>
          {% endif %}
          <div class="small">
            {% for medium in media_details %}
              {% if medium.current_page is not None %}
                <div>
                  {{ medium.label }} · страница <strong class="animated-number">{{ medium.current_page|default:0 }}</strong>
                  {% if medium.total_pages %}
                    из <span class="animated-number">{{ medium.total_pages }}</span>
                  {% endif %}
                </div>
              {% else %}
                <div>
                  {{ medium.label }} ·
                  {% if medium.audio_position %}
                    прослушано {{ medium.audio_position }}
                  {% else %}
                    прогресс не указан
                  {% endif %}
                  {% if medium.audio_length %}
                    из {{ medium.audio_length }}
                  {% endif %}
                  {% if medium.audio_speed %}
                    · скорость {{ medium.audio_speed }}×
                  {% endif %}
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
        <div class="reading-progress-meter mb-3" aria-hidden="true">
          <div class="reading-progress-meter__bar h-100"></div>
        </div>
        <div class="d-flex flex-column flex-sm-row gap-2 small">
          {% if average_pages_per_day %}
            <div class="px-3 py-2 rounded-4 stat-card" style="background-color: rgba(188, 184, 147, 0.35);">
              Средняя скорость: <strong class="animated-number">{{ average_pages_per_day|floatformat:-2 }}</strong> стр./день
            </div>
          {% endif %}
          {% if estimated_days_remaining %}
            <div class="px-3 py-2 rounded-4 stat-card" style="background-color: rgba(95, 92, 59, 0.12);">
              До завершения ~ <strong class="animated-number">{{ estimated_days_remaining }}</strong> дн.
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </section>

  <section class="reading-section">
    <div class="reading-section__header">
      <h2 class="reading-section__title">Обновить прогресс</h2>
      <p class="reading-section__note">Отмечайте страницы и минуты — так история чтения остаётся живой.</p>
    </div>
    <div class="reading-progress-accordion">
      {% for medium in media_details %}
        {% with collapse_id='reading-progress-'|add:medium.code %}
          {% if medium.current_page is not None %}
            <div class="reading-progress-accordion__item">
              <button class="reading-progress-toggle collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#{{ collapse_id }}" aria-expanded="false" aria-controls="{{ collapse_id }}">
                <span>{{ medium.label }} — обновление страниц</span>
                <span class="reading-progress-toggle__icon" aria-hidden="true"></span>
              </button>
              <div class="collapse" id="{{ collapse_id }}">
                <div class="reading-progress-accordion__body">
                  <form method="post" action="{% url 'shelves:reading_set_page' progress.id %}" class="row g-2 align-items-end mb-3">
                    {% csrf_token %}
                    <input type="hidden" name="medium" value="{{ medium.code }}">
                    <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                      <label class="form-label mb-1" for="id_page_{{ medium.code }}">Указать страницу</label>
                      <input type="number" id="id_page_{{ medium.code }}" name="page" class="form-control"
                             min="0" {% if medium.total_pages %}max="{{ medium.total_pages }}"{% elif total_pages %}max="{{ total_pages }}"{% endif %}
                             value="{{ medium.current_page|default:0 }}">
                      {% if medium.total_pages %}
                        <div class="form-text">Всего в этом формате: {{ medium.total_pages }}</div>
                      {% endif %}
                    </div>
                    {% if medium.code == progress.FORMAT_EBOOK %}
                      <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                        <label class="form-label mb-1" for="id_percent_{{ medium.code }}">или прогресс в %</label>
                        <div class="input-group">
                          <input type="number" id="id_percent_{{ medium.code }}" name="percent" class="form-control"
                                 min="0" max="100" step="0.1" placeholder="Например, 25">
                          <span class="input-group-text">%</span>
                        </div>
                        <div class="form-text">Мы пересчитаем в страницы автоматически.</div>
                      </div>
                    {% endif %}
                    <div class="col-12 col-md-6 col-lg-5">
                      <label class="form-label mb-1" for="id_reaction_{{ medium.code }}">Реакция на момент</label>
                      <textarea id="id_reaction_{{ medium.code }}" name="reaction" rows="2" class="form-control"
                                placeholder="Что удивило, вдохновило или зацепило на этой странице?"></textarea>
                    </div>
                    <div class="col-12 col-md-3 col-lg-2">
                      <div class="form-check mt-md-4 pt-2">
                        <input class="form-check-input" type="checkbox" id="id_public_{{ medium.code }}" name="is_public">
                        <label class="form-check-label" for="id_public_{{ medium.code }}">Показать в ленте</label>
                      </div>
                    </div>
                    <div class="col-12 col-sm-auto">
                      <button type="submit" class="btn btn-primary px-4">Сохранить</button>
                    </div>
                  </form>
                  <div class="d-flex flex-wrap gap-2">
                    <form method="post" action="{% url 'shelves:reading_increment' progress.id 5 %}">
                      {% csrf_token %}
                      <input type="hidden" name="medium" value="{{ medium.code }}">
                      <button type="submit" class="btn btn-outline-secondary rounded-pill quick-add-btn">+5 стр.</button>
                    </form>
                    <form method="post" action="{% url 'shelves:reading_increment' progress.id 10 %}">
                      {% csrf_token %}
                      <input type="hidden" name="medium" value="{{ medium.code }}">
                      <button type="submit" class="btn btn-outline-secondary rounded-pill quick-add-btn">+10 стр.</button>
                    </form>
                    <form method="post" action="{% url 'shelves:reading_increment' progress.id 25 %}">
                      {% csrf_token %}
                      <input type="hidden" name="medium" value="{{ medium.code }}">
                      <button type="submit" class="btn btn-outline-secondary rounded-pill quick-add-btn">+25 стр.</button>
                    </form>
                  </div>
                </div>
              </div>
              </div>
          {% elif medium.code == progress.FORMAT_AUDIO %}
            <div class="reading-progress-accordion__item">
              <button class="reading-progress-toggle collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#{{ collapse_id }}" aria-expanded="false" aria-controls="{{ collapse_id }}">
                <span>{{ medium.label }} — учёт прослушивания</span>
                <span class="reading-progress-toggle__icon" aria-hidden="true"></span>
              </button>
              <div class="collapse" id="{{ collapse_id }}">
                <div class="reading-progress-accordion__body">
                  <form method="post" action="{% url 'shelves:reading_increment' progress.id 0 %}" class="row g-3 align-items-end">
                    {% csrf_token %}
                    <input type="hidden" name="medium" value="{{ medium.code }}">
                    <div class="col-12 col-md-4">
                      <label class="form-label mb-1" for="id_minutes">Прослушано минут</label>
                      <input type="number" class="form-control" id="id_minutes" name="minutes" min="0" step="1" placeholder="Например, 15">
                    </div>
                    <div class="col-12 col-md-4">
                      <label class="form-label mb-1" for="id_duration">или время (ЧЧ:ММ:СС)</label>
                      <input type="text" class="form-control" id="id_duration" name="duration" placeholder="00:30:00">
                    </div>
                    <div class="form-text">Мы пересчитаем в длительность автоматически.</div>
                    </div>
                    <div class="col-12 col-md-4">
                      <button type="submit" class="btn btn-outline-secondary w-100 rounded-pill">Добавить прослушанное</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
            {% endif %}
        {% endwith %}
      {% endfor %}
    </div>
    <div class="reading-finished-button mt-4">
      <form method="post" action="{% url 'shelves:reading_mark_finished' progress.id %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-success text-white fw-semibold">Отметить книгу завершённой</button>
      </form>
    </div>
  </section>

  <section class="reading-section">
    <div class="reading-section__header">
      <h2 class="reading-section__title">Формат чтения</h2>
      <p class="reading-section__note">Выберите, как вы читаете книгу, и уточните параметры.</p>
    </div>
   <div class="reading-progress-accordion">
      {% with format_collapse_id='reading-format-settings' %}
        <div class="reading-progress-accordion__item">
          <button class="reading-progress-toggle{% if not format_form.errors %} collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#{{ format_collapse_id }}" aria-expanded="{% if format_form.errors %}true{% else %}false{% endif %}" aria-controls="{{ format_collapse_id }}">
            <span>Настроить форматы чтения</span>
            <span class="reading-progress-toggle__icon" aria-hidden="true"></span>
          </button>
          <div class="collapse{% if format_form.errors %} show{% endif %}" id="{{ format_collapse_id }}">
            <div class="reading-progress-accordion__body">
              <form method="post" action="{% url 'shelves:reading_update_format' progress.id %}" class="row g-3">
                {% csrf_token %}
                <div class="col-12">
                  <label class="form-label">{{ format_form.formats.label }}</label>
                  <div class="d-flex flex-wrap gap-3">
                    {% for checkbox in format_form.formats %}
                      <div class="form-check">
                        {{ checkbox.tag }}
                        <label class="form-check-label" for="{{ checkbox.id_for_label }}">{{ checkbox.choice_label }}</label>
                      </div>
                    {% endfor %}
                  </div>
                  {% if format_form.formats.errors %}
                    <div class="invalid-feedback d-block">{{ format_form.formats.errors|join:", " }}</div>
                  {% endif %}
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label" for="{{ format_form.custom_total_pages.id_for_label }}">{{ format_form.custom_total_pages.label }}</label>
                  {{ format_form.custom_total_pages }}
                  <div class="form-text">Если у нас нет данных об объёме книги.</div>
                  {% if format_form.custom_total_pages.errors %}
                    <div class="invalid-feedback d-block">{{ format_form.custom_total_pages.errors|join:", " }}</div>
                  {% endif %}
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label" for="{{ format_form.paper_total_pages.id_for_label }}">{{ format_form.paper_total_pages.label }}</label>
                  {{ format_form.paper_total_pages }}
                  <div class="form-text">{{ format_form.paper_total_pages.help_text }}</div>
                  {% if format_form.paper_total_pages.errors %}
                    <div class="invalid-feedback d-block">{{ format_form.paper_total_pages.errors|join:", " }}</div>
                  {% endif %}
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label" for="{{ format_form.paper_current_page.id_for_label }}">{{ format_form.paper_current_page.label }}</label>
                  {{ format_form.paper_current_page }}
                  {% if format_form.paper_current_page.errors %}
                    <div class="invalid-feedback d-block">{{ format_form.paper_current_page.errors|join:", " }}</div>
                  {% endif %}
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label" for="{{ format_form.ebook_total_pages.id_for_label }}">{{ format_form.ebook_total_pages.label }}</label>
                  {{ format_form.ebook_total_pages }}
                  <div class="form-text">{{ format_form.ebook_total_pages.help_text }}</div>
                  {% if format_form.ebook_total_pages.errors %}
                    <div class="invalid-feedback d-block">{{ format_form.ebook_total_pages.errors|join:", " }}</div>
                  {% endif %}
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label" for="{{ format_form.ebook_current_page.id_for_label }}">{{ format_form.ebook_current_page.label }}</label>
                  {{ format_form.ebook_current_page }}
                  {% if format_form.ebook_current_page.errors %}
                    <div class="invalid-feedback d-block">{{ format_form.ebook_current_page.errors|join:", " }}</div>
                  {% endif %}
                </div>
                <div class="w-100 d-none d-md-block"></div>
                <div class="col-12 col-md-4">
                  <label class="form-label" for="{{ format_form.audio_length_input.id_for_label }}">{{ format_form.audio_length_input.label }}</label>
                  {{ format_form.audio_length_input }}
                  <div class="form-text">{{ format_form.audio_length_input.help_text }}</div>
                  {% if format_form.audio_length_input.errors %}
                    <div class="invalid-feedback d-block">{{ format_form.audio_length_input.errors|join:", " }}</div>
                  {% endif %}
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label" for="{{ format_form.audio_position_input.id_for_label }}">{{ format_form.audio_position_input.label }}</label>
                  {{ format_form.audio_position_input }}
                  <div class="form-text">{{ format_form.audio_position_input.help_text }}</div>
                  {% if format_form.audio_position_input.errors %}
                    <div class="invalid-feedback d-block">{{ format_form.audio_position_input.errors|join:", " }}</div>
                  {% endif %}
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label" for="{{ format_form.audio_playback_speed.id_for_label }}">{{ format_form.audio_playback_speed.label }}</label>
                  {{ format_form.audio_playback_speed }}
                  <div class="form-text">Допустимый диапазон от 0.5× до 3×.</div>
                  {% if format_form.audio_playback_speed.errors %}
                    <div class="invalid-feedback d-block">{{ format_form.audio_playback_speed.errors|join:", " }}</div>
                  {% endif %}
                </div>
                {% if format_form.non_field_errors %}
                  <div class="col-12">
                    <div class="alert alert-danger mb-0">{{ format_form.non_field_errors|join:"<br>"|safe }}</div>
                  </div>
                {% endif %}
                <div class="col-12 d-flex justify-content-end">
                  <button type="submit" class="btn btn-outline-primary rounded-pill px-4">Сохранить формат</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      {% endwith %}
    </div>
  </section>

  <!-- Остальные секции остаются без изменений в структуре, но с добавленными классами анимации -->
  <!-- Для экономии места оставлю остальные секции как есть, они уже имеют классы анимации -->
  

  <section class="reading-section">
    <div class="reading-section__header">
      <h2 class="reading-section__title">История чтения</h2>
      <p class="reading-section__note">Сколько вы прочитали по дням и в каком формате.</p>
    </div>

    {% if chart_labels or format_chart_labels %}
      <div class="row g-3 mb-4">
        {% if chart_labels %}
          <div class="col-12{% if format_chart_labels %} col-lg-8{% endif %}">
            <div class="modern-chart-card" role="img" aria-label="Диаграмма прочитанных страниц по дням">
              <div class="modern-chart-header">
                <h4 class="modern-chart-title">Прогресс по дням</h4>
                {% if chart_mediums %}
                  <div class="modern-chart-legend">
                    {% for medium in chart_mediums %}
                      <div class="modern-legend-item" data-medium="{{ medium.code }}">
                        <span class="modern-legend-color" style="background-color: var(--color-{{ medium.code|default:'default' }})"></span>
                        <span class="modern-legend-label">{{ medium.label }}</span>
                      </div>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
              <div class="modern-chart-container">
                <canvas id="readingHistoryChart" aria-label="Прочитанные страницы по дням"></canvas>
              </div>
            </div>
          </div>
        {% endif %}

        {% if format_chart_labels %}
          <div class="col-12 col-lg-4">
            <div class="modern-chart-card" role="img" aria-label="Диаграмма форматов чтения">
              <div class="modern-chart-header">
                <h4 class="modern-chart-title">Форматы чтения</h4>
              </div>
              <div class="modern-chart-container">
                <canvas id="readingFormatChart" aria-label="Распределение форматов чтения"></canvas>
              </div>
            </div>
          </div>
        {% endif %}
      </div>

      {% if chart_labels %}
        {{ chart_labels|json_script:"reading-chart-labels" }}
        {{ chart_pages|json_script:"reading-chart-pages" }}
        {{ chart_mediums|json_script:"reading-chart-mediums" }}
        {{ chart_medium_pages|json_script:"reading-chart-medium-pages" }}
      {% endif %}

      {% if format_chart_labels %}
        {{ format_chart_labels|json_script:"reading-format-chart-labels" }}
        {{ format_chart_values|json_script:"reading-format-chart-values" }}
        {{ format_chart_palette|json_script:"reading-format-chart-colors" }}
      {% endif %}

      <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" crossorigin="anonymous"></script>
      <script>
      (function () {
        if (typeof Chart === 'undefined') {
          return;
        }

        const modernPalette = {
          paper: {
            border: '#92ADA4',
            background: 'rgba(146, 173, 164, 0.8)',
            hover: 'rgba(146, 173, 164, 1)',
          },
          ebook: {
            border: '#DAA38F',
            background: 'rgba(218, 163, 143, 0.8)',
            hover: 'rgba(218, 163, 143, 1)',
          },
          audio: {
            border: '#9B7D61',
            background: 'rgba(155, 125, 97, 0.8)',
            hover: 'rgba(155, 125, 97, 1)',
          },
          default: {
            border: '#92ADA4',
            background: 'rgba(146, 173, 164, 0.6)',
            hover: 'rgba(146, 173, 164, 0.8)',
          }
        };

        const historyLabelsEl = document.getElementById('reading-chart-labels');
        const historyPagesEl = document.getElementById('reading-chart-pages');
        const historyMediumsEl = document.getElementById('reading-chart-mediums');
        const historyMediumPagesEl = document.getElementById('reading-chart-medium-pages');
        const historyCanvas = document.getElementById('readingHistoryChart');

        if (historyLabelsEl && historyPagesEl && historyMediumsEl && historyMediumPagesEl && historyCanvas) {
          const labels = JSON.parse(historyLabelsEl.textContent);
          const pages = JSON.parse(historyPagesEl.textContent);
          const mediums = JSON.parse(historyMediumsEl.textContent);
          const mediumPages = JSON.parse(historyMediumPagesEl.textContent);

          let chartInstance;

          const renderChart = () => {
            const mediumsWithData = Array.isArray(mediums)
              ? mediums.filter((medium) => {
                  const data = mediumPages?.[medium.code];
                  return Array.isArray(data) && data.some((value) => Number(value) > 0);
                })
              : [];

            const hasMediumData = mediumsWithData.length > 0;

            const datasets = hasMediumData
              ? mediumsWithData.map((medium) => {
                  const color = modernPalette[medium.code] || modernPalette.default;
                  const data = Array.isArray(mediumPages?.[medium.code])
                    ? mediumPages[medium.code]
                    : new Array(labels.length).fill(0);

                  return {
                    label: medium.label,
                    data,
                    borderWidth: 2,
                    borderRadius: 8,
                    borderColor: color.border,
                    backgroundColor: color.background,
                    hoverBackgroundColor: color.hover,
                    maxBarThickness: 40,
                    categoryPercentage: 0.8,
                    barPercentage: 0.9,
                  };
                })
              : [{
                  label: 'Прочитанные страницы',
                  data: pages,
                  borderWidth: 2,
                  borderRadius: 8,
                  borderColor: modernPalette.default.border,
                  backgroundColor: modernPalette.default.background,
                  hoverBackgroundColor: modernPalette.default.hover,
                  maxBarThickness: 40,
                  categoryPercentage: 0.8,
                  barPercentage: 0.9,
                }];

            if (chartInstance) {
              chartInstance.destroy();
            }

            chartInstance = new Chart(historyCanvas.getContext('2d'), {
              type: 'bar',
              data: {
                labels,
                datasets,
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                  intersect: false,
                  mode: 'index',
                },
                plugins: {
                  legend: {
                    display: false,
                  },
                  tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    titleColor: '#2D3748',
                    bodyColor: '#4A5568',
                    borderColor: 'rgba(139, 115, 85, 0.2)',
                    borderWidth: 1,
                    padding: 12,
                    cornerRadius: 8,
                    boxPadding: 6,
                    usePointStyle: true,
                    callbacks: {
                      title: (context) => context[0]?.label ?? '',
                      label: (context) => {
                        const value = context.parsed.y ?? 0;
                        if (context.dataset?.label) {
                          return `${context.dataset.label}: ${value} стр.`;
                        }
                        return `${value} стр.`;
                      },
                      footer: (items) => {
                        if (!items?.length) return '';
                        const total = items.reduce((sum, item) => sum + (item.parsed.y ?? 0), 0);
                        return `Итого: ${total} стр.`;
                      },
                    },
                  },
                },
                scales: {
                  x: {
                    grid: {
                      display: false,
                      drawBorder: false,
                    },
                    ticks: {
                      color: '#718096',
                      font: {
                        size: 11,
                      },
                      maxRotation: 45,
                    },
                  },
                  y: {
                    beginAtZero: true,
                    grid: {
                      color: 'rgba(0, 0, 0, 0.04)',
                      drawBorder: false,
                    },
                    ticks: {
                      color: '#718096',
                      padding: 8,
                      callback: (value) => `${value} стр.`,
                    },
                  },
                },
                animation: {
                  duration: 1000,
                  easing: 'easeOutQuart',
                },
              },
            });
          };

          renderChart();
        }

        const formatLabelsEl = document.getElementById('reading-format-chart-labels');
        const formatValuesEl = document.getElementById('reading-format-chart-values');
        const formatColorsEl = document.getElementById('reading-format-chart-colors');
        const formatCanvas = document.getElementById('readingFormatChart');

        if (formatLabelsEl && formatValuesEl && formatColorsEl && formatCanvas) {
          const labels = JSON.parse(formatLabelsEl.textContent);
          const values = JSON.parse(formatValuesEl.textContent);
          const colors = JSON.parse(formatColorsEl.textContent);

          const modernColors = labels.map((label, index) => {
            const lowerLabel = label.toLowerCase();
            if (lowerLabel.includes('бумаж')) return modernPalette.paper.background;
            if (lowerLabel.includes('электрон')) return modernPalette.ebook.background;
            if (lowerLabel.includes('аудио')) return modernPalette.audio.background;
            return modernPalette.default.background;
          });

          let formatChartInstance;

          const renderFormatChart = () => {
            if (formatChartInstance) {
              formatChartInstance.destroy();
            }

            formatChartInstance = new Chart(formatCanvas.getContext('2d'), {
              type: 'doughnut',
              data: {
                labels,
                datasets: [
                  {
                    data: values,
                    backgroundColor: modernColors,
                    borderColor: '#ffffff',
                    borderWidth: 3,
                    borderRadius: 6,
                    hoverBorderWidth: 4,
                    hoverOffset: 8,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%',
                plugins: {
                  legend: {
                    position: 'bottom',
                    labels: {
                      color: '#4A5568',
                      padding: 20,
                      usePointStyle: true,
                      pointStyle: 'circle',
                      font: {
                        size: 12,
                        weight: '500',
                      },
                    },
                  },
                  tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    titleColor: '#2D3748',
                    bodyColor: '#4A5568',
                    borderColor: 'rgba(139, 115, 85, 0.2)',
                    borderWidth: 1,
                    padding: 12,
                    cornerRadius: 8,
                    callbacks: {
                      label: (context) => {
                        const label = context.label ?? '';
                        const value = context.parsed ?? 0;
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = total ? ((value / total) * 100).toFixed(1) : '0.0';
                        return `${label}: ${value}% (${percentage}%)`;
                      },
                    },
                  },
                },
                animation: {
                  animateScale: true,
                  animateRotate: true,
                  duration: 1000,
                  easing: 'easeOutQuart',
                },
              },
            });
          };

          renderFormatChart();
        }
      })();
      </script>
    {% endif %}

    {% if audio_logs %}
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead>
            <tr>
              <th scope="col">Дата</th>
              <th scope="col">Формат</th>
              <th scope="col">Прогресс</th>
            </tr>
          </thead>
          <tbody>
            {% for log in audio_logs %}
              <tr>
                <td>{{ log.log_date|date:"d.m.Y" }}</td>
                <td>{{ log.get_medium_display }}</td>
                <td>
                  {% if log.audio_duration_display %}
                    {{ log.audio_duration_display }}
                  {% else %}
                    {{ log.pages_equivalent|floatformat:-2 }} стр.
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% elif chart_labels %}
      <p class="text-muted mb-0">Пока нет записей по аудиокниге.</p>
    {% else %}
      <p class="text-muted mb-0">Пока нет записей о прочитанных страницах.</p>
    {% endif %}
  </section>
  <!-- Остальные секции (герои, цитаты, заметки) остаются без изменений -->
  <!-- Для экономии места я их опущу, но они должны быть в вашем оригинальном файле -->
  <section class="reading-section">
    <div class="reading-section__header">
      <h2 class="reading-section__title">Герои книги</h2>
      <p class="reading-section__note">Записывайте персонажей, чтобы не потерять их истории.</p>
    </div>
    <div class="mobile-accordion-section d-md-none">
      {% if character_rows %}
        <div class="mb-3">
          {% for character, form in character_rows %}
            <div class="character-card">
              <div class="character-name" onclick="toggleCharacterDescription(this)">
                {{ character.name }}
              </div>
              <div class="character-description">
                {{ character.description|default:"—"|linebreaksbr }}
                <div class="character-actions">
                  <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#mobile-character-edit-{{ character.id }}">
                    Редактировать
                  </button>
                </div>
              </div>

              <div class="collapse mt-2" id="mobile-character-edit-{{ character.id }}">
                <form method="post" action="{% url 'shelves:reading_update_character' progress.id character.id %}" class="compact-form">
                  {% csrf_token %}
                  <div class="mb-2">
                    <label class="form-label small">Имя</label>
                    {{ form.name }}
                  </div>
                  <div class="mb-2">
                    <label class="form-label small">Описание</label>
                    {{ form.description }}
                  </div>
                  <button type="submit" class="btn btn-primary btn-sm w-100">Сохранить</button>
                </form>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-muted">Пока нет добавленных персонажей.</p>
      {% endif %}

      <button class="mobile-action-button" type="button" data-bs-toggle="collapse" data-bs-target="#mobile-add-character">
        ＋ Добавить героя
      </button>

      <div class="collapse mt-2" id="mobile-add-character">
        <form method="post" action="{% url 'shelves:reading_add_character' progress.id %}" class="compact-form">
          {% csrf_token %}
          <div class="mb-2">
            <label class="form-label small">Имя героя</label>
            {{ character_form.name }}
          </div>
          <div class="mb-2">
            <label class="form-label small">Описание</label>
            {{ character_form.description }}
          </div>
          <button type="submit" class="btn btn-outline-primary btn-sm w-100">Сохранить</button>
        </form>
      </div>
    </div>

    <div class="reading-section-table d-none d-md-block">
      {% if character_rows %}
        <div class="table-responsive mb-3">
          <table class="table table-sm align-middle mb-0">
            <thead>
              <tr>
                <th scope="col" style="width: 200px;">Имя</th>
                <th scope="col">Описание</th>
                <th scope="col" class="text-end">Действия</th>
              </tr>
            </thead>
            <tbody>
              {% for character, form in character_rows %}
                <tr>
                  <td class="fw-semibold">{{ character.name }}</td>
                  <td>{{ character.description|default:"—"|linebreaksbr }}</td>
                  <td class="text-end">
                    <button
                      class="btn btn-outline-secondary btn-sm d-inline-flex align-items-center justify-content-center"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#character-edit-{{ character.id }}"
                      aria-expanded="false"
                      aria-controls="character-edit-{{ character.id }}"
                      aria-label="Редактировать героя"
                    >
                      <i class="bi bi-pencil"></i>
                      <span class="visually-hidden">Редактировать</span>
                    </button>
                  </td>
                </tr>
                <tr class="collapse" id="character-edit-{{ character.id }}">
                  <td colspan="3">
                    <form
                      method="post"
                      action="{% url 'shelves:reading_update_character' progress.id character.id %}"
                      class="row g-3"
                    >
                      {% csrf_token %}
                      {% if form.non_field_errors %}
                        <div class="col-12">
                          <div class="alert alert-danger mb-0">
                            {{ form.non_field_errors|join:"<br>"|safe }}
                          </div>
                        </div>
                      {% endif %}
                      <div class="col-12 col-md-4">
                        <label class="form-label" for="{{ form.name.id_for_label }}">
                          {{ form.name.label }}
                        </label>
                        {{ form.name }}
                        {% if form.name.errors %}
                          <div class="invalid-feedback d-block">
                            {{ form.name.errors|join:", " }}
                          </div>
                        {% endif %}
                      </div>
                      <div class="col-12 col-md-8">
                        <label class="form-label" for="{{ form.description.id_for_label }}">
                          {{ form.description.label }}
                        </label>
                        {{ form.description }}
                        {% if form.description.errors %}
                          <div class="invalid-feedback d-block">
                            {{ form.description.errors|join:", " }}
                          </div>
                        {% endif %}
                      </div>
                      <div class="col-12 d-flex justify-content-end">
                        <button type="submit" class="btn btn-primary btn-sm rounded-pill px-4">Сохранить изменения</button>
                      </div>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-muted">Пока нет добавленных персонажей.</p>
      {% endif %}

      <div class="reading-subsection mt-3">
        <h3 class="h6 mb-3">Добавить героя</h3>
        <form method="post" action="{% url 'shelves:reading_add_character' progress.id %}" class="row g-3">
          {% csrf_token %}
          {% if character_form.non_field_errors %}
            <div class="col-12">
              <div class="alert alert-danger mb-0">
                {{ character_form.non_field_errors|join:"<br>"|safe }}
              </div>
            </div>
          {% endif %}
          <div class="col-12 col-md-4">
            <label class="form-label" for="{{ character_form.name.id_for_label }}">
              {{ character_form.name.label }}
            </label>
            {{ character_form.name }}
            {% if character_form.name.errors %}
              <div class="invalid-feedback d-block">
                {{ character_form.name.errors|join:", " }}
              </div>
            {% endif %}
          </div>
          <div class="col-12 col-md-8">
            <label class="form-label" for="{{ character_form.description.id_for_label }}">
              {{ character_form.description.label }}
            </label>
            {{ character_form.description }}
            {% if character_form.description.errors %}
              <div class="invalid-feedback d-block">
                {{ character_form.description.errors|join:", " }}
              </div>
            {% endif %}
          </div>
          <div class="col-12 d-flex justify-content-end">
            <button type="submit" class="btn btn-outline-primary rounded-pill">Добавить героя</button>
          </div>
        </form>
      </div>
    </div>
  </section>

  <section class="reading-section">
    <div class="reading-section__header">
      <h2 class="reading-section__title">Любимые цитаты</h2>
      <p class="reading-section__note">Сохраняйте фразы, к которым хочется возвращаться.</p>
    </div>
    <div class="mobile-accordion-section d-md-none">
      {% if quote_rows %}
        <div class="mb-3">
          {% for quote, form in quote_rows %}
            <div class="character-card">
              <div class="character-name" onclick="toggleQuoteDetails(this)">
                {% if quote.location %}
                  {{ quote.location }}
                {% else %}
                  Цитата {{ forloop.counter }}
                {% endif %}
              </div>
              <div class="character-description">
                <div class="mb-2">{{ quote.body|linebreaksbr }}</div>
                {% if quote.comment %}
                  <div class="text-muted small">{{ quote.comment|linebreaksbr }}</div>
                {% endif %}
                <div class="character-actions">
                  <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#mobile-quote-edit-{{ quote.id }}">
                    Редактировать
                  </button>
                </div>
              </div>

              <div class="collapse mt-2" id="mobile-quote-edit-{{ quote.id }}">
                <form method="post" action="{% url 'shelves:reading_update_quote' progress.id quote.id %}" class="compact-form">
                  {% csrf_token %}
                  <div class="mb-2">
                    <label class="form-label small">Местоположение</label>
                    {{ form.location }}
                  </div>
                  <div class="mb-2">
                    <label class="form-label small">Текст цитаты</label>
                    {{ form.body }}
                  </div>
                  <div class="mb-2">
                    <label class="form-label small">Комментарий</label>
                    {{ form.comment }}
                  </div>
                  <button type="submit" class="btn btn-primary btn-sm w-100">Сохранить</button>
                </form>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-muted">Пока нет сохранённых цитат.</p>
      {% endif %}

      <button class="mobile-action-button" type="button" data-bs-toggle="collapse" data-bs-target="#mobile-add-quote">
        ＋ Добавить цитату
      </button>

      <div class="collapse mt-2" id="mobile-add-quote">
        <form method="post" action="{% url 'shelves:reading_add_quote' progress.id %}" class="compact-form">
          {% csrf_token %}
          <div class="mb-2">
            <label class="form-label small">Местоположение</label>
            {{ quote_form.location }}
          </div>
          <div class="mb-2">
            <label class="form-label small">Текст цитаты</label>
            {{ quote_form.body }}
          </div>
          <div class="mb-2">
            <label class="form-label small">Комментарий</label>
            {{ quote_form.comment }}
          </div>
          <button type="submit" class="btn btn-outline-primary btn-sm w-100">Сохранить</button>
        </form>
      </div>
    </div>

    <div class="reading-section-list d-none d-md-block">
      {% if quote_rows %}
        <div class="list-group mb-3">
          {% for quote, form in quote_rows %}
            <div class="list-group-item">
              <div class="d-flex justify-content-between align-items-start gap-3">
                <div class="flex-grow-1">
                  {% if quote.location %}
                    <div class="text-muted small mb-1">{{ quote.location }}</div>
                  {% endif %}
                  <div>{{ quote.body|linebreaksbr }}</div>
                  {% if quote.comment %}
                    <div class="text-muted small mt-2">{{ quote.comment|linebreaksbr }}</div>
                  {% endif %}
                </div>
                <button
                  class="btn btn-outline-secondary btn-sm"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#quote-edit-{{ quote.id }}"
                  aria-expanded="false"
                  aria-controls="quote-edit-{{ quote.id }}"
                >
                  Редактировать
                </button>
              </div>
              <div class="collapse mt-3" id="quote-edit-{{ quote.id }}">
                <form
                  method="post"
                  action="{% url 'shelves:reading_update_quote' progress.id quote.id %}"
                  class="row g-3"
                >
                  {% csrf_token %}
                  {% if form.non_field_errors %}
                    <div class="col-12">
                      <div class="alert alert-danger mb-0">
                        {{ form.non_field_errors|join:"<br>"|safe }}
                      </div>
                    </div>
                  {% endif %}
                  <div class="col-12 col-md-4">
                    <label class="form-label" for="{{ form.location.id_for_label }}">{{ form.location.label }}</label>
                    {{ form.location }}
                    {% if form.location.errors %}
                      <div class="invalid-feedback d-block">{{ form.location.errors|join:", " }}</div>
                    {% endif %}
                  </div>
                  <div class="col-12">
                    <label class="form-label" for="{{ form.body.id_for_label }}">{{ form.body.label }}</label>
                    {{ form.body }}
                    {% if form.body.errors %}
                      <div class="invalid-feedback d-block">{{ form.body.errors|join:", " }}</div>
                    {% endif %}
                  </div>
                  <div class="col-12">
                    <label class="form-label" for="{{ form.comment.id_for_label }}">{{ form.comment.label }}</label>
                    {{ form.comment }}
                    {% if form.comment.errors %}
                      <div class="invalid-feedback d-block">{{ form.comment.errors|join:", " }}</div>
                    {% endif %}
                  </div>
                  <div class="col-12 d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary btn-sm rounded-pill px-4">Сохранить изменения</button>
                  </div>
                </form>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-muted">Пока нет сохранённых цитат.</p>
      {% endif %}

      <div class="reading-subsection mt-3">
        <h3 class="h6 mb-3">Добавить цитату</h3>
        <form method="post" action="{% url 'shelves:reading_add_quote' progress.id %}" class="row g-3">
          {% csrf_token %}
          {% if quote_form.non_field_errors %}
            <div class="col-12">
              <div class="alert alert-danger mb-0">
                {{ quote_form.non_field_errors|join:"<br>"|safe }}
              </div>
            </div>
          {% endif %}
          <div class="col-12 col-md-4">
            <label class="form-label" for="{{ quote_form.location.id_for_label }}">{{ quote_form.location.label }}</label>
            {{ quote_form.location }}
            {% if quote_form.location.errors %}
              <div class="invalid-feedback d-block">{{ quote_form.location.errors|join:", " }}</div>
            {% endif %}
          </div>
          <div class="col-12">
            <label class="form-label" for="{{ quote_form.body.id_for_label }}">{{ quote_form.body.label }}</label>
            {{ quote_form.body }}
            {% if quote_form.body.errors %}
              <div class="invalid-feedback d-block">{{ quote_form.body.errors|join:", " }}</div>
            {% endif %}
          </div>
          <div class="col-12">
            <label class="form-label" for="{{ quote_form.comment.id_for_label }}">{{ quote_form.comment.label }}</label>
            {{ quote_form.comment }}
            {% if quote_form.comment.errors %}
              <div class="invalid-feedback d-block">{{ quote_form.comment.errors|join:", " }}</div>
            {% endif %}
          </div>
          <div class="col-12 d-flex justify-content-end">
            <button type="submit" class="btn btn-outline-primary rounded-pill">Сохранить цитату</button>
          </div>
        </form>
      </div>
    </div>
  </section>

  <section class="reading-section reading-note-area">
    <div class="reading-section__header">
      <h2 class="reading-section__title">Личные заметки</h2>
      <p class="reading-section__note">Записывайте впечатления и любимые цитаты.</p>
    </div>
    <div class="mobile-accordion-section d-md-none">
      <div class="mobile-action-buttons">
        <button class="mobile-action-button" type="button" data-bs-toggle="collapse" data-bs-target="#mobile-notes-accordion">
          📝 Мои заметки
        </button>
        <button class="mobile-action-button" type="button" data-bs-toggle="collapse" data-bs-target="#mobile-add-note">
          ＋ Новая заметка
        </button>
      </div>

      <div class="collapse" id="mobile-notes-accordion">
        <div class="mobile-accordion-content">
          {% if note_rows %}
            {% for note, form in note_rows %}
              <div class="character-card">
                <div class="character-name" onclick="toggleNoteDetails(this)">
                  {% if note.location %}
                    {{ note.location }}
                  {% else %}
                    Заметка {{ forloop.counter }}
                  {% endif %}
                </div>
                <div class="character-description">
                  <div class="mb-2">{{ note.body|linebreaksbr }}</div>
                  {% if note.comment %}
                    <div class="text-muted small">{{ note.comment|linebreaksbr }}</div>
                  {% endif %}
                  <div class="character-actions">
                    <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#mobile-note-edit-{{ note.id }}">
                      Редактировать
                    </button>
                  </div>
                </div>

                <div class="collapse mt-2" id="mobile-note-edit-{{ note.id }}">
                  <form method="post" action="{% url 'shelves:reading_update_note_entry' progress.id note.id %}" class="compact-form">
                    {% csrf_token %}
                    <div class="mb-2">
                      <label class="form-label small">Местоположение</label>
                      {{ form.location }}
                    </div>
                    <div class="mb-2">
                      <label class="form-label small">Текст заметки</label>
                      {{ form.body }}
                    </div>
                    <div class="mb-2">
                      <label class="form-label small">Комментарий</label>
                      {{ form.comment }}
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm w-100">Сохранить</button>
                  </form>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <p class="text-muted">Пока нет коротких заметок.</p>
          {% endif %}
        </div>
      </div>

      <div class="collapse" id="mobile-add-note">
        <form method="post" action="{% url 'shelves:reading_add_note_entry' progress.id %}" class="compact-form">
          {% csrf_token %}
          <div class="mb-2">
            <label class="form-label small">Местоположение</label>
            {{ note_entry_form.location }}
          </div>
          <div class="mb-2">
            <label class="form-label small">Текст заметки</label>
            {{ note_entry_form.body }}
          </div>
          <div class="mb-2">
            <label class="form-label small">Комментарий</label>
            {{ note_entry_form.comment }}
          </div>
          <button type="submit" class="btn btn-outline-primary btn-sm w-100">Сохранить</button>
        </form>
      </div>

      <div class="mt-3">
        <button class="mobile-action-button w-100" type="button" data-bs-toggle="collapse" data-bs-target="#mobile-general-notes">
          📖 Общие заметки
        </button>
        <div class="collapse mt-2" id="mobile-general-notes">
          <form method="post" action="{% url 'shelves:reading_update_notes' progress.id %}" class="compact-form">
            {% csrf_token %}
            <div class="mb-2">
              <label class="form-label small">Общие заметки о книге</label>
              {{ notes_form.reading_notes }}
            </div>
            <button type="submit" class="btn btn-primary btn-sm w-100">Сохранить</button>
          </form>
        </div>
      </div>
    </div>

    <div class="d-none d-md-block">
      {% if note_rows %}
        <div class="list-group mb-3">
          {% for note, form in note_rows %}
            <div class="list-group-item">
              <div class="d-flex justify-content-between align-items-start gap-3">
                <div class="flex-grow-1">
                  {% if note.location %}
                    <div class="text-muted small mb-1">{{ note.location }}</div>
                  {% endif %}
                  <div>{{ note.body|linebreaksbr }}</div>
                  {% if note.comment %}
                    <div class="text-muted small mt-2">{{ note.comment|linebreaksbr }}</div>
                  {% endif %}
                </div>
                <button
                  class="btn btn-outline-secondary btn-sm d-inline-flex align-items-center justify-content-center"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#note-edit-{{ note.id }}"
                  aria-expanded="false"
                  aria-controls="note-edit-{{ note.id }}"
                  aria-label="Редактировать заметку"
                >
                  <i class="bi bi-pencil"></i>
                  <span class="visually-hidden">Редактировать</span>
                </button>
              </div>
              <div class="collapse mt-3" id="note-edit-{{ note.id }}">
                <form
                  method="post"
                  action="{% url 'shelves:reading_update_note_entry' progress.id note.id %}"
                  class="row g-3"
                >
                  {% csrf_token %}
                  {% if form.non_field_errors %}
                    <div class="col-12">
                      <div class="alert alert-danger mb-0">
                        {{ form.non_field_errors|join:"<br>"|safe }}
                      </div>
                    </div>
                  {% endif %}
                  <div class="col-12 col-md-4">
                    <label class="form-label" for="{{ form.location.id_for_label }}">{{ form.location.label }}</label>
                    {{ form.location }}
                    {% if form.location.errors %}
                      <div class="invalid-feedback d-block">{{ form.location.errors|join:", " }}</div>
                    {% endif %}
                  </div>
                  <div class="col-12">
                    <label class="form-label" for="{{ form.body.id_for_label }}">{{ form.body.label }}</label>
                    {{ form.body }}
                    {% if form.body.errors %}
                      <div class="invalid-feedback d-block">{{ form.body.errors|join:", " }}</div>
                    {% endif %}
                  </div>
                  <div class="col-12">
                    <label class="form-label" for="{{ form.comment.id_for_label }}">{{ form.comment.label }}</label>
                    {{ form.comment }}
                    {% if form.comment.errors %}
                      <div class="invalid-feedback d-block">{{ form.comment.errors|join:", " }}</div>
                    {% endif %}
                  </div>
                  <div class="col-12 d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary btn-sm rounded-pill px-4">Сохранить изменения</button>
                  </div>
                </form>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-muted">Пока нет коротких заметок.</p>
      {% endif %}

      <div class="reading-subsection mt-3">
        <h3 class="h6 mb-3">Добавить заметку</h3>
        <form method="post" action="{% url 'shelves:reading_add_note_entry' progress.id %}" class="row g-3">
          {% csrf_token %}
          {% if note_entry_form.non_field_errors %}
            <div class="col-12">
              <div class="alert alert-danger mb-0">
                {{ note_entry_form.non_field_errors|join:"<br>"|safe }}
              </div>
            </div>
            {% endif %}
          <div class="col-12 col-md-4">
            <label class="form-label" for="{{ note_entry_form.location.id_for_label }}">{{ note_entry_form.location.label }}</label>
            {{ note_entry_form.location }}
            {% if note_entry_form.location.errors %}
              <div class="invalid-feedback d-block">{{ note_entry_form.location.errors|join:", " }}</div>
            {% endif %}
          </div>
          <div class="col-12">
            <label class="form-label" for="{{ note_entry_form.body.id_for_label }}">{{ note_entry_form.body.label }}</label>
            {{ note_entry_form.body }}
            {% if note_entry_form.body.errors %}
              <div class="invalid-feedback d-block">{{ note_entry_form.body.errors|join:", " }}</div>
            {% endif %}
          </div>
        <div class="col-12">
            <label class="form-label" for="{{ note_entry_form.comment.id_for_label }}">{{ note_entry_form.comment.label }}</label>
            {{ note_entry_form.comment }}
            {% if note_entry_form.comment.errors %}
              <div class="invalid-feedback d-block">{{ note_entry_form.comment.errors|join:", " }}</div>
            {% endif %}
          </div>
          <div class="col-12 d-flex justify-content-end">
            <button type="submit" class="btn btn-outline-primary rounded-pill">Сохранить заметку</button>
          </div>
        </form>
      </div>

      <div class="reading-subsection mt-4">
        <h3 class="h6 mb-3">Общие заметки</h3>
        <form method="post" action="{% url 'shelves:reading_update_notes' progress.id %}" class="row g-3">
          {% csrf_token %}
          {% if notes_form.non_field_errors %}
            <div class="col-12">
              <div class="alert alert-danger mb-0">
                {{ notes_form.non_field_errors|join:"<br>"|safe }}
              </div>
            </div>
          {% endif %}
        <div class="col-12">
            <label class="form-label" for="{{ notes_form.reading_notes.id_for_label }}">
              {{ notes_form.reading_notes.label }}
            </label>
            {{ notes_form.reading_notes }}
            {% if notes_form.reading_notes.errors %}
              <div class="invalid-feedback d-block">
                {{ notes_form.reading_notes.errors|join:", " }}
              </div>
            {% endif %}
          </div>
          <div class="col-12 d-flex justify-content-end">
            <button type="submit" class="btn btn-primary rounded-pill px-4">Сохранить заметки</button>
          </div>
        </form>
      </div>
    </div>
  </section>
</div>

<!-- JavaScript для мобильных взаимодействий -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  window.toggleCharacterDescription = function(element) {
    const description = element.nextElementSibling;
    element.classList.toggle('expanded');
    description.classList.toggle('expanded');
  };

  window.toggleQuoteDetails = function(element) {
    const details = element.nextElementSibling;
    element.classList.toggle('expanded');
    details.classList.toggle('expanded');
  };

  window.toggleNoteDetails = function(element) {
    const details = element.nextElementSibling;
    element.classList.toggle('expanded');
    details.classList.toggle('expanded');
  };

  const accordionHeaders = document.querySelectorAll('.mobile-accordion-header');
  accordionHeaders.forEach(header => {
    header.addEventListener('click', function() {
      const targetId = this.getAttribute('data-bs-target');
      accordionHeaders.forEach(otherHeader => {
        if (otherHeader !== this) {
          const otherTargetId = otherHeader.getAttribute('data-bs-target');
          const otherTarget = document.querySelector(otherTargetId);
          if (otherTarget && otherTarget.classList.contains('show')) {
            otherHeader.setAttribute('aria-expanded', 'false');
            otherTarget.classList.remove('show');
          }
        }
      });
    });
  });

  if (window.innerWidth < 768) {
    initializeMobileCharts();
  }
});

function initializeMobileCharts() {
  if (typeof Chart === 'undefined') {
    return;
  }

  const historyLabelsEl = document.getElementById('reading-chart-labels');
  const historyPagesEl = document.getElementById('reading-chart-pages');
  const mobileHistoryCanvas = document.getElementById('mobileReadingHistoryChart');

  if (historyLabelsEl && historyPagesEl && mobileHistoryCanvas) {
    const labels = JSON.parse(historyLabelsEl.textContent);
    const pages = JSON.parse(historyPagesEl.textContent);

    new Chart(mobileHistoryCanvas, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          data: pages,
          backgroundColor: 'rgba(188, 184, 147, 0.6)',
          borderColor: 'rgba(95, 92, 59, 0.8)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { mode: 'index', intersect: false }
        },
        scales: {
          x: { display: true },
          y: { beginAtZero: true }
        }
      }
    });
  }

  const formatLabelsEl = document.getElementById('reading-format-chart-labels');
  const formatValuesEl = document.getElementById('reading-format-chart-values');
  const formatColorsEl = document.getElementById('reading-format-chart-colors');
  const mobileFormatCanvas = document.getElementById('mobileReadingFormatChart');

  if (formatLabelsEl && formatValuesEl && formatColorsEl && mobileFormatCanvas) {
    const labels = JSON.parse(formatLabelsEl.textContent);
    const values = JSON.parse(formatValuesEl.textContent);
    const colors = JSON.parse(formatColorsEl.textContent);

    new Chart(mobileFormatCanvas, {
      type: 'doughnut',
      data: {
        labels,
        datasets: [{ data: values, backgroundColor: colors, borderColor: '#fff', borderWidth: 2 }],
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' },
          tooltip: {
            callbacks: {
              label: (context) => {
                const label = context.label ?? '';
                const value = context.parsed ?? 0;
                return `${label}: ${value}%`;
              },
            },
          },
        },
      },
    });
  }
}
</script>

<!-- JavaScript для анимаций -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Анимация чисел счетчика
  function animateNumbers() {
    const numberElements = document.querySelectorAll('.animated-number');
    
    numberElements.forEach(element => {
      const originalText = element.textContent;
      const number = parseFloat(originalText.replace('%', '').replace(' стр.', ''));
      
      if (!isNaN(number)) {
        let start = 0;
        const duration = 2000;
        const startTime = performance.now();
        
        function updateNumber(currentTime) {
          const elapsed = currentTime - startTime;
          const progress = Math.min(elapsed / duration, 1);
          
          // easing function
          const easeOutQuart = 1 - Math.pow(1 - progress, 4);
          const currentValue = start + (number - start) * easeOutQuart;
          
          if (originalText.includes('%')) {
            element.textContent = currentValue.toFixed(2) + '%';
          } else if (originalText.includes(' стр.')) {
            element.textContent = currentValue.toFixed(2) + ' стр.';
          } else {
            element.textContent = Math.round(currentValue);
          }
          
          if (progress < 1) {
            requestAnimationFrame(updateNumber);
          }
        }
        
        requestAnimationFrame(updateNumber);
      }
    });
  }

  // Запуск анимации после загрузки страницы
  setTimeout(animateNumbers, 500);

  // Параллакс эффект для фона
  document.addEventListener('mousemove', function(e) {
    const backdrop = document.querySelector('.reading-progress-backdrop');
    if (!backdrop) return;
    
    const x = (e.clientX / window.innerWidth - 0.5) * 10;
    const y = (e.clientY / window.innerHeight - 0.5) * 10;
    
    backdrop.style.transform = `translate(${x}px, ${y}px)`;
  });

  // Анимация появления элементов при скролле
  const observerOptions = {
    threshold: 0.1,
    rootMargin: '0px 0px -50px 0px'
  };

  const observer = new IntersectionObserver(function(entries) {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.style.animationPlayState = 'running';
        observer.unobserve(entry.target);
      }
    });
  }, observerOptions);

  // Наблюдаем за всеми секциями
  document.querySelectorAll('.reading-section').forEach(section => {
    section.style.animationPlayState = 'paused';
    observer.observe(section);
  });

  // Микро-взаимодействие для кнопок быстрого добавления страниц
  const quickAddButtons = document.querySelectorAll('.quick-add-btn');
  
  quickAddButtons.forEach(button => {
    button.addEventListener('click', function(e) {
      // Создаем эффект "пульсации"
      this.style.transform = 'scale(0.95)';
      setTimeout(() => {
        this.style.transform = 'scale(1)';
      }, 150);
    });
  });

  // Динамическое обновление прогресс-бара при вводе данных
  const progressInputs = document.querySelectorAll('input[name="page"], input[name="percent"]');
  
  progressInputs.forEach(input => {
    input.addEventListener('input', function() {
      const progressBar = document.querySelector('.reading-progress-meter__bar');
      if (progressBar && this.name === 'percent') {
        const newWidth = Math.min(Math.max(this.value, 0), 100);
        progressBar.style.width = newWidth + '%';
      }
    });
  });

  // Празднование завершения книги
  {% if progress.percent >= 100 %}
  setTimeout(() => {
    if (typeof confetti === 'function') {
      confetti({
        particleCount: 260,
        spread: 140,
        origin: { y: 0.55 },
        colors: ['#ffd700', '#f6e05e', '#ffe9a3', '#fff7d6', '#f4c430'],
        shapes: ['star'],
        drift: 0.75,
        gravity: 0.16,
        decay: 0.975,
        duration: 6000,
      });
    }
  }, 1000);
  {% endif %}
});

// Функция для конфетти (если библиотека подключена)
function confetti(options = {}) {
  const settings = {
    particleCount: 150,
    spread: 75,
    origin: { x: 0.5, y: 0.6 },
    colors: ['#f6e05e', '#ffd166', '#ffe9a3', '#f4c430', '#fff6c2'],
    decay: 0.97,
    gravity: 0.16,
    drift: 0.6,
    duration: 5500,
    ...options,
  };

  const canvas = document.createElement('canvas');
  canvas.className = 'celebration-canvas';
  document.body.appendChild(canvas);

  const ctx = canvas.getContext('2d');
  const ratio = Math.min(window.devicePixelRatio || 1, 2);

  const resizeCanvas = () => {
    canvas.width = window.innerWidth * ratio;
    canvas.height = window.innerHeight * ratio;
    canvas.style.width = `${window.innerWidth}px`;
    canvas.style.height = `${window.innerHeight}px`;
  };

  resizeCanvas();
  window.addEventListener('resize', resizeCanvas, { once: true });

  const convertSpreadToRadians = (degrees) => (degrees * Math.PI) / 180;
  const launchAngle = convertSpreadToRadians(settings.spread);
  const startTime = performance.now();
  const availableShapes = (settings.shapes || []).length
    ? settings.shapes
    : ['star', 'circle'];
  const targetCount = Math.max(120, settings.particleCount);

  const createParticle = () => {
    const angle = (Math.random() - 0.5) * launchAngle;
    const speed = 7 + Math.random() * 4;
    return {
      x: (settings.origin?.x ?? 0.5) * canvas.width,
      y: (settings.origin?.y ?? 0.5) * canvas.height,
      tilt: Math.random() * 2 * Math.PI,
      tiltSpeed: (Math.random() - 0.5) * 0.15,
      angle,
      speed,
      radius: 4 + Math.random() * 3,
      alpha: 1,
      decay: settings.decay - Math.random() * 0.03,
      hue: settings.colors[Math.floor(Math.random() * settings.colors.length)],
      shape: availableShapes[Math.floor(Math.random() * availableShapes.length)],
      drift: (Math.random() - 0.5) * settings.drift,
      wobbleSpeed: 0.02 + Math.random() * 0.03,
      wobblePhase: Math.random() * Math.PI * 2,
      wobbleAmplitude: 1.5 + Math.random() * 1.5,
    };
  };

  const particles = Array.from({ length: targetCount }, createParticle);

  const drawStar = (context, { x, y, radius, tilt, alpha, hue }) => {
    const spikes = 5;
    const innerRadius = radius * 0.45;
    context.save();
    context.translate(x, y);
    context.rotate(tilt);
    context.beginPath();
    for (let i = 0; i < spikes * 2; i += 1) {
      const r = i % 2 === 0 ? radius : innerRadius;
      const angle = (i * Math.PI) / spikes;
      context.lineTo(Math.cos(angle) * r, Math.sin(angle) * r);
    }
    context.closePath();
    context.fillStyle = hue;
    context.globalAlpha = Math.max(alpha, 0);
    context.shadowColor = 'rgba(244, 196, 48, 0.7)';
    context.shadowBlur = 12;
    context.fill();
    context.restore();
  };

  const drawCircle = (context, { x, y, radius, tilt, alpha, hue }) => {
    context.save();
    context.translate(x, y);
    context.rotate(tilt);
    context.fillStyle = hue;
    context.globalAlpha = Math.max(alpha, 0);
    context.beginPath();
    context.ellipse(0, 0, radius * 1.1, radius * 0.8, 0, 0, Math.PI * 2);
    context.shadowColor = 'rgba(248, 222, 126, 0.6)';
    context.shadowBlur = 8;
    context.fill();
    context.restore();
  };

  const drawParticle = (particle) => {
    if (particle.shape === 'star') {
      drawStar(ctx, particle);
    } else {
      drawCircle(ctx, particle);
    }
  };

  let frame;
  const animate = () => {
    const elapsed = performance.now() - startTime;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (let i = particles.length - 1; i >= 0; i -= 1) {
      const p = particles[i];
      p.tilt += p.tiltSpeed;
      p.wobblePhase += p.wobbleSpeed;
      p.x +=
        Math.cos(p.angle) * p.speed +
        p.drift +
        Math.cos(p.wobblePhase) * p.wobbleAmplitude;
      p.y += Math.sin(p.angle) * p.speed + settings.gravity * i * 0.001 * ratio;
      p.speed *= 0.992;
      p.alpha *= p.decay;

      drawParticle(p);

      if (p.alpha <= 0 || p.y > canvas.height + 120) {
        particles.splice(i, 1);
      }
    }

    if (elapsed < settings.duration && particles.length < targetCount * 0.8) {
      const replenishCount = Math.min(4, targetCount - particles.length);
      for (let i = 0; i < replenishCount; i += 1) {
        particles.push(createParticle());
      }
    }

    if (particles.length || elapsed < settings.duration) {
      frame = requestAnimationFrame(animate);
    } else {
      cancelAnimationFrame(frame);
      if (canvas.parentNode) {
        canvas.parentNode.removeChild(canvas);
      }
    }
  };

  animate();
}
  // Сообщаем мобильному приложению о завершении книги для показа анимации
  {% if finish_celebration_api_url %}
  (function() {
    const pointsValue = Number.parseInt('{{ finish_reward_points }}', 10);
    const payload = {
      type: 'book_finished',
      event: 'book_finished',
      api_url: '{{ finish_celebration_api_url }}',
      apiUrl: '{{ finish_celebration_api_url }}',
      bookTitle: '{{ book.title|escapejs }}',
      title: '{{ book.title|escapejs }}',
      cover: '{{ book.get_cover_url|default_if_none:""|escapejs }}',
      rewardText: '+{{ finish_reward_points }} к книжному пути',
      celebrationEffect: 'golden_stars',
      celebrationPalette: ['#ffd700', '#f6e05e', '#ffe9a3', '#fff7d6', '#f4c430'],
      celebrationShapes: ['star'],
    };

    if (!Number.isNaN(pointsValue)) {
      payload.points = pointsValue;
      payload.reward = pointsValue;
      payload.coins = pointsValue;
    }

    const message = JSON.stringify(payload);
    const channel = window.ReadTogetherApp || window.ReactNativeWebView;
    if (channel && typeof channel.postMessage === 'function') {
      channel.postMessage(message);
    }
  })();
  {% endif %}
</script>

{% endblock %}