{% extends "base.html" %}
{% block title %}Чтение: {{ book.title }}{% endblock %}

{% block extra_css %}
<style>
  .reading-progress-page {
    color: #332c0f;
    background: linear-gradient(180deg, rgba(188, 184, 147, 0.2) 0%, rgba(255, 255, 255, 1) 220px);
    border-radius: 28px;
    padding: 0.5rem;
  }

  .reading-progress-backdrop {
    background: linear-gradient(180deg, rgba(188, 184, 147, 0.45) 0%, rgba(255, 255, 255, 0.9) 45%, #ffffff 100%);
    border-radius: 32px;
    padding: 1.75rem 1.5rem;
    position: relative;
    overflow: hidden;
  }

  .reading-progress-backdrop::before {
    content: "";
    position: absolute;
    inset: 12% auto auto -28%;
    width: 240px;
    height: 240px;
    background: radial-gradient(circle at center, rgba(95, 92, 59, 0.25) 0%, rgba(95, 92, 59, 0) 70%);
    z-index: 0;
  }

  .reading-progress-backdrop::after {
    content: "";
    position: absolute;
    inset: auto -26% -20% auto;
    width: 260px;
    height: 260px;
    background: radial-gradient(circle at center, rgba(71, 67, 41, 0.2) 0%, rgba(71, 67, 41, 0) 70%);
    z-index: 0;
  }

  .reading-progress-hero {
    position: relative;
    z-index: 1;
    display: grid;
    gap: 1.25rem;
    align-items: stretch;
  }

  .reading-progress-hero::before {
    content: "";
    position: absolute;
    inset: -12px -14px -20px -14px;
    border-radius: 28px;
    background: linear-gradient(180deg,
        rgba(188, 184, 147, 0.15) 0%,
        rgba(188, 184, 147, 0.45) 35%,
        rgba(95, 92, 59, 0.55) 100%);
    z-index: -1;
    pointer-events: none;
  }

  .reading-progress-hero__cover {
    position: relative;
    border-radius: 22px;
    padding: 0.9rem;
    box-shadow: 0 12px 24px rgba(51, 44, 15, 0.08);
    overflow: visible;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
  }

  .reading-progress-hero__cover::before {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: inherit;
    background: rgba(255, 255, 255, 0.9);
    z-index: 0;
  }

  .reading-progress-hero__cover > * {
    position: relative;
    z-index: 1;
    width: 100%;
  }

  .reading-progress-hero__cover img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .reading-progress-hero__cover .bg-body-secondary {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .reading-progress-hero__meta {
    position: relative;
    background: rgba(255, 255, 255, 0.92);
    border-radius: 22px;
    padding: 1.25rem;
    box-shadow: 0 16px 30px rgba(51, 44, 15, 0.08);
    height: 100%;
    display: flex;
    flex-direction: column;
    z-index: 1;
  }

  .reading-progress-pills {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .reading-progress-pill {
    background: rgba(95, 92, 59, 0.1);
    border-radius: 999px;
    padding: 0.35rem 0.85rem;
    font-size: 0.85rem;
    color: #474329;
  }

  .reading-progress-meter {
    background-color: rgba(95, 92, 59, 0.1);
    border-radius: 999px;
    height: 12px;
    overflow: hidden;
  }

  .reading-progress-meter__bar {
    background: linear-gradient(90deg, #5f5c3b 0%, #474329 55%, #332c0f 100%);
    border-radius: 999px;
  }

  .reading-progress-summary {
    color: #5f5c3b;
    font-size: 0.95rem;
  }

  .reading-section {
    border-radius: 24px;
    background: rgba(255, 255, 255, 0.96);
    box-shadow: 0 18px 40px rgba(51, 44, 15, 0.07);
    padding: 1.5rem;
    margin-top: 1.5rem;
  }

  .reading-progress-accordion {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .reading-progress-accordion__item {
    border-radius: 20px;
    background: rgba(188, 184, 147, 0.12);
    padding: 0.75rem 1rem;
  }

  .reading-progress-toggle {
    background: none;
    border: 0;
    color: #332c0f;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    font-size: 0.95rem;
    font-weight: 600;
    padding: 0.25rem 0;
    text-align: left;
    width: 100%;
  }

  .reading-progress-toggle:hover {
    color: #1f1a05;
  }

  .reading-progress-toggle:focus-visible {
    outline: 2px solid rgba(71, 67, 41, 0.45);
    outline-offset: 4px;
  }

  .reading-progress-toggle__icon {
    align-items: center;
    background: rgba(71, 67, 41, 0.12);
    border-radius: 999px;
    display: inline-flex;
    height: 2rem;
    justify-content: center;
    width: 2rem;
  }

  .reading-progress-toggle__icon::before {
    content: "▸";
    display: inline-block;
    font-size: 1rem;
    line-height: 1;
    transition: transform 0.2s ease;
  }

  .reading-progress-toggle:not(.collapsed) .reading-progress-toggle__icon::before {
    transform: rotate(90deg);
  }

  .reading-progress-toggle:not(.collapsed) .reading-progress-toggle__icon {
    background: rgba(71, 67, 41, 0.18);
  }

  .reading-progress-accordion__body {
    margin-top: 1rem;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.96);
    border-radius: 16px;
    box-shadow: inset 0 0 0 1px rgba(71, 67, 41, 0.12);
  }

  .reading-subsection {
    border-radius: 20px;
    background: rgba(188, 184, 147, 0.18);
    padding: 1.25rem;
    box-shadow: none;
  }

  .reading-section__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .reading-section__title {
    font-size: 1.05rem;
    font-weight: 700;
    color: #332c0f;
    margin: 0;
  }

  .reading-section__note {
    font-size: 0.85rem;
    color: #5f5c3b;
    margin: 0;
  }

  .reading-section .btn-primary,
  .reading-section .btn-success {
    background-color: #474329;
    border-color: #474329;
  }

  .reading-section .btn-primary:hover,
  .reading-section .btn-success:hover {
    background-color: #332c0f;
    border-color: #332c0f;
  }

  .reading-section .btn-outline-primary,
  .reading-section .btn-outline-secondary {
    color: #474329;
    border-color: rgba(71, 67, 41, 0.35);
  }

  .reading-section .btn-outline-primary:hover,
  .reading-section .btn-outline-secondary:hover {
    background-color: rgba(188, 184, 147, 0.3);
    border-color: #474329;
    color: #332c0f;
  }

  .reading-section table thead th {
    background-color: rgba(188, 184, 147, 0.22);
    color: #332c0f;
    border-bottom-width: 0;
  }

  .reading-section table tbody tr:nth-child(even) {
    background-color: rgba(188, 184, 147, 0.12);
  }

  .reading-section table td,
  .reading-section table th {
    border-color: rgba(71, 67, 41, 0.12) !important;
  }

  .reading-note-area textarea,
  .reading-section textarea,
  .reading-section input,
  .reading-section select {
    border-radius: 14px !important;
    border-color: rgba(95, 92, 59, 0.35);
  }

  .reading-section .form-text {
    color: #5f5c3b;
  }

  .reading-section .alert-danger {
    border-radius: 16px;
  }

  .reading-section + .reading-section {
    margin-top: 1.5rem;
  }

  @media (max-width: 576px) {
    .reading-progress-accordion__item {
      padding: 0.5rem 0.75rem;
    }

    .reading-progress-accordion__body {
      padding: 0.75rem;
    }
  }

  .reading-finished-button .btn {
    background-color: #5f5c3b;
    border-radius: 999px;
    border: none;
    padding: 0.65rem 1.6rem;
  }

  .reading-finished-button .btn:hover {
    background-color: #474329;
  }

  .reading-chart-card {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 24px;
    box-shadow: 0 18px 40px rgba(51, 44, 15, 0.07);
  }

  .reading-chart-card__canvas {
    min-height: 240px;
    padding: 1rem;
  }

  .reading-progress-page .table-responsive {
    border-radius: 18px;
    overflow: hidden;
  }

  @media (max-width: 767.98px) {
    .reading-progress-page {
      padding: 0;
      border-radius: 18px;
    }

    .reading-progress-backdrop {
      padding: 1.5rem 1.1rem;
      border-radius: 24px;
    }

    .reading-progress-hero__cover {
      justify-self: center;
      width: min(72vw, 240px);
    }

    .reading-section {
      padding: 1.25rem;
    }

    .reading-section__title {
      font-size: 1rem;
    }

    .reading-section .row.g-3 {
      row-gap: 1rem !important;
    }
  }

  @media (min-width: 768px) {
    .reading-progress-hero {
      grid-template-columns: minmax(200px, 220px) 1fr;
      align-items: start;
    }

    .reading-progress-backdrop {
      padding: 2rem 2.25rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="reading-progress-page">
  <section class="reading-progress-backdrop mb-4">
    <div class="reading-progress-hero">
      <div class="reading-progress-hero__cover">
        {% with cover_url=book.get_cover_url %}
          {% if cover_url %}
            <img src="{{ cover_url }}" class="img-fluid rounded" alt="Обложка книги {{ book.title }}">
          {% else %}
            <div class="bg-body-secondary border-0 rounded-4 d-flex align-items-center justify-content-center" style="height: 220px;">
              <span class="text-muted small text-center px-3">Нет обложки</span>
            </div>
          {% endif %}
        {% endwith %}
      </div>
      <div class="reading-progress-hero__meta">
        <h1 class="h4 fw-bold mb-3">{{ book.title }}</h1>
        <div class="reading-progress-pills mb-3">
          {% for medium in media_details %}
            <span class="reading-progress-pill">{{ medium.label }}</span>
          {% endfor %}
        </div>
        <div class="reading-progress-summary mb-3">
          <div class="mb-2 d-flex flex-wrap gap-2 align-items-center">
            <span class="fw-semibold">Прогресс:</span>
            <span class="fs-5 fw-bold">{{ progress.percent|floatformat:-2 }}%</span>
            {% if combined_pages is not None %}
              <span class="badge rounded-pill text-bg-light text-wrap">Эквивалент: {{ combined_pages|floatformat:-2 }} стр.</span>
            {% endif %}
          </div>
          {% if total_pages %}
            <p class="mb-1">Всего страниц: <strong>{{ total_pages }}</strong></p>
          {% endif %}
          <div class="small">
            {% for medium in media_details %}
              {% if medium.current_page is not None %}
                <div>
                  {{ medium.label }} · страница <strong>{{ medium.current_page|default:0 }}</strong>
                  {% if medium.total_pages %}
                    из {{ medium.total_pages }}
                  {% endif %}
                </div>
              {% else %}
                <div>
                  {{ medium.label }} ·
                  {% if medium.audio_position %}
                    прослушано {{ medium.audio_position }}
                  {% else %}
                    прогресс не указан
                  {% endif %}
                  {% if medium.audio_length %}
                    из {{ medium.audio_length }}
                  {% endif %}
                  {% if medium.audio_speed %}
                    · скорость {{ medium.audio_speed }}×
                  {% endif %}
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
        <div class="reading-progress-meter mb-3" aria-hidden="true">
          <div class="reading-progress-meter__bar h-100" style="width: {{ progress.percent|floatformat:-2 }}%;"></div>
        </div>
        <div class="d-flex flex-column flex-sm-row gap-2 small">
          {% if average_pages_per_day %}
            <div class="px-3 py-2 rounded-4" style="background-color: rgba(188, 184, 147, 0.35);">
              Средняя скорость: <strong>{{ average_pages_per_day|floatformat:-2 }}</strong> стр./день
            </div>
          {% endif %}
          {% if estimated_days_remaining %}
            <div class="px-3 py-2 rounded-4" style="background-color: rgba(95, 92, 59, 0.12);">
              До завершения ~ <strong>{{ estimated_days_remaining }}</strong> дн.
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </section>

  <section class="reading-section">
    <div class="reading-section__header">
      <h2 class="reading-section__title">Обновить прогресс</h2>
      <p class="reading-section__note">Отмечайте страницы и минуты — так история чтения остаётся живой.</p>
    </div>
    <div class="reading-progress-accordion">
      {% for medium in media_details %}
        {% with collapse_id='reading-progress-'|add:medium.code %}
          {% if medium.current_page is not None %}
            <div class="reading-progress-accordion__item">
              <button class="reading-progress-toggle collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#{{ collapse_id }}" aria-expanded="false" aria-controls="{{ collapse_id }}">
                <span>{{ medium.label }} — обновление страниц</span>
                <span class="reading-progress-toggle__icon" aria-hidden="true"></span>
              </button>
              <div class="collapse" id="{{ collapse_id }}">
                <div class="reading-progress-accordion__body">
                  <form method="post" action="{% url 'shelves:reading_set_page' progress.id %}" class="row g-2 align-items-end mb-3">
                    {% csrf_token %}
                    <input type="hidden" name="medium" value="{{ medium.code }}">
                    <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                      <label class="form-label mb-1" for="id_page_{{ medium.code }}">Указать страницу</label>
                      <input type="number" id="id_page_{{ medium.code }}" name="page" class="form-control"
                             min="0" {% if medium.total_pages %}max="{{ medium.total_pages }}"{% elif total_pages %}max="{{ total_pages }}"{% endif %}
                             value="{{ medium.current_page|default:0 }}">
                      {% if medium.total_pages %}
                        <div class="form-text">Всего в этом формате: {{ medium.total_pages }}</div>
                      {% endif %}
                    </div>
                    {% if medium.code == progress.FORMAT_EBOOK %}
                      <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                        <label class="form-label mb-1" for="id_percent_{{ medium.code }}">или прогресс в %</label>
                        <div class="input-group">
                          <input type="number" id="id_percent_{{ medium.code }}" name="percent" class="form-control"
                                 min="0" max="100" step="0.1" placeholder="Например, 25">
                          <span class="input-group-text">%</span>
                        </div>
                        <div class="form-text">Мы пересчитаем в страницы автоматически.</div>
                      </div>
                    {% endif %}
                    <div class="col-12 col-md-6 col-lg-5">
                      <label class="form-label mb-1" for="id_reaction_{{ medium.code }}">Реакция на момент</label>
                      <textarea id="id_reaction_{{ medium.code }}" name="reaction" rows="2" class="form-control"
                                placeholder="Что удивило, вдохновило или зацепило на этой странице?"></textarea>
                    </div>
                    <div class="col-12 col-md-3 col-lg-2">
                      <div class="form-check mt-md-4 pt-2">
                        <input class="form-check-input" type="checkbox" id="id_public_{{ medium.code }}" name="is_public">
                        <label class="form-check-label" for="id_public_{{ medium.code }}">Показать в ленте</label>
                      </div>
                    </div>
                    <div class="col-12 col-sm-auto">
                      <button type="submit" class="btn btn-primary px-4">Сохранить</button>
                    </div>
                  </form>
                  <div class="d-flex flex-wrap gap-2">
                    <form method="post" action="{% url 'shelves:reading_increment' progress.id 5 %}">
                      {% csrf_token %}
                      <input type="hidden" name="medium" value="{{ medium.code }}">
                      <button type="submit" class="btn btn-outline-secondary rounded-pill">+5 стр.</button>
                    </form>
                    <form method="post" action="{% url 'shelves:reading_increment' progress.id 10 %}">
                      {% csrf_token %}
                      <input type="hidden" name="medium" value="{{ medium.code }}">
                      <button type="submit" class="btn btn-outline-secondary rounded-pill">+10 стр.</button>
                    </form>
                    <form method="post" action="{% url 'shelves:reading_increment' progress.id 25 %}">
                      {% csrf_token %}
                      <input type="hidden" name="medium" value="{{ medium.code }}">
                      <button type="submit" class="btn btn-outline-secondary rounded-pill">+25 стр.</button>
                    </form>
                  </div>
                </div>
              </div>
              </div>
          {% elif medium.code == progress.FORMAT_AUDIO %}
            <div class="reading-progress-accordion__item">
              <button class="reading-progress-toggle collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#{{ collapse_id }}" aria-expanded="false" aria-controls="{{ collapse_id }}">
                <span>{{ medium.label }} — учёт прослушивания</span>
                <span class="reading-progress-toggle__icon" aria-hidden="true"></span>
              </button>
              <div class="collapse" id="{{ collapse_id }}">
                <div class="reading-progress-accordion__body">
                  <form method="post" action="{% url 'shelves:reading_increment' progress.id 0 %}" class="row g-3 align-items-end">
                    {% csrf_token %}
                    <input type="hidden" name="medium" value="{{ medium.code }}">
                    <div class="col-12 col-md-4">
                      <label class="form-label mb-1" for="id_minutes">Прослушано минут</label>
                      <input type="number" class="form-control" id="id_minutes" name="minutes" min="0" step="1" placeholder="Например, 15">
                    </div>
                    <div class="col-12 col-md-4">
                      <label class="form-label mb-1" for="id_duration">или время (ЧЧ:ММ:СС)</label>
                      <input type="text" class="form-control" id="id_duration" name="duration" placeholder="00:30:00">
                    </div>
                    <div class="col-12 col-md-4">
                      <button type="submit" class="btn btn-outline-secondary w-100 rounded-pill">Добавить прослушанное</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
            {% endif %}
        {% endwith %}
      {% endfor %}
    </div>
    <div class="reading-finished-button mt-4">
      <form method="post" action="{% url 'shelves:reading_mark_finished' progress.id %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-success text-white fw-semibold">Отметить книгу завершённой</button>
      </form>
    </div>
  </section>

  <section class="reading-section">
    <div class="reading-section__header">
      <h2 class="reading-section__title">Формат чтения</h2>
      <p class="reading-section__note">Выберите, как вы читаете книгу, и уточните параметры.</p>
    </div>
   <div class="reading-progress-accordion">
      {% with format_collapse_id='reading-format-settings' %}
        <div class="reading-progress-accordion__item">
          <button class="reading-progress-toggle{% if not format_form.errors %} collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#{{ format_collapse_id }}" aria-expanded="{% if format_form.errors %}true{% else %}false{% endif %}" aria-controls="{{ format_collapse_id }}">
            <span>Настроить форматы чтения</span>
            <span class="reading-progress-toggle__icon" aria-hidden="true"></span>
          </button>
          <div class="collapse{% if format_form.errors %} show{% endif %}" id="{{ format_collapse_id }}">
            <div class="reading-progress-accordion__body">
              <form method="post" action="{% url 'shelves:reading_update_format' progress.id %}" class="row g-3">
                {% csrf_token %}
                <div class="col-12">
                  <label class="form-label">{{ format_form.formats.label }}</label>
                  <div class="d-flex flex-wrap gap-3">
                    {% for checkbox in format_form.formats %}
                      <div class="form-check">
                        {{ checkbox.tag }}
                        <label class="form-check-label" for="{{ checkbox.id_for_label }}">{{ checkbox.choice_label }}</label>
                      </div>
                    {% endfor %}
                  </div>
                  {% if format_form.formats.errors %}
                    <div class="invalid-feedback d-block">{{ format_form.formats.errors|join:", " }}</div>
                  {% endif %}
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label" for="{{ format_form.custom_total_pages.id_for_label }}">{{ format_form.custom_total_pages.label }}</label>
                  {{ format_form.custom_total_pages }}
                  <div class="form-text">Если у нас нет данных об объёме книги.</div>
                  {% if format_form.custom_total_pages.errors %}
                    <div class="invalid-feedback d-block">{{ format_form.custom_total_pages.errors|join:", " }}</div>
                  {% endif %}
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label" for="{{ format_form.paper_total_pages.id_for_label }}">{{ format_form.paper_total_pages.label }}</label>
                  {{ format_form.paper_total_pages }}
                  <div class="form-text">{{ format_form.paper_total_pages.help_text }}</div>
                  {% if format_form.paper_total_pages.errors %}
                    <div class="invalid-feedback d-block">{{ format_form.paper_total_pages.errors|join:", " }}</div>
                  {% endif %}
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label" for="{{ format_form.paper_current_page.id_for_label }}">{{ format_form.paper_current_page.label }}</label>
                  {{ format_form.paper_current_page }}
                  {% if format_form.paper_current_page.errors %}
                    <div class="invalid-feedback d-block">{{ format_form.paper_current_page.errors|join:", " }}</div>
                  {% endif %}
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label" for="{{ format_form.ebook_total_pages.id_for_label }}">{{ format_form.ebook_total_pages.label }}</label>
                  {{ format_form.ebook_total_pages }}
                  <div class="form-text">{{ format_form.ebook_total_pages.help_text }}</div>
                  {% if format_form.ebook_total_pages.errors %}
                    <div class="invalid-feedback d-block">{{ format_form.ebook_total_pages.errors|join:", " }}</div>
                  {% endif %}
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label" for="{{ format_form.ebook_current_page.id_for_label }}">{{ format_form.ebook_current_page.label }}</label>
                  {{ format_form.ebook_current_page }}
                  {% if format_form.ebook_current_page.errors %}
                    <div class="invalid-feedback d-block">{{ format_form.ebook_current_page.errors|join:", " }}</div>
                  {% endif %}
                </div>
                <div class="w-100 d-none d-md-block"></div>
                <div class="col-12 col-md-4">
                  <label class="form-label" for="{{ format_form.audio_length_input.id_for_label }}">{{ format_form.audio_length_input.label }}</label>
                  {{ format_form.audio_length_input }}
                  <div class="form-text">{{ format_form.audio_length_input.help_text }}</div>
                  {% if format_form.audio_length_input.errors %}
                    <div class="invalid-feedback d-block">{{ format_form.audio_length_input.errors|join:", " }}</div>
                  {% endif %}
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label" for="{{ format_form.audio_position_input.id_for_label }}">{{ format_form.audio_position_input.label }}</label>
                  {{ format_form.audio_position_input }}
                  <div class="form-text">{{ format_form.audio_position_input.help_text }}</div>
                  {% if format_form.audio_position_input.errors %}
                    <div class="invalid-feedback d-block">{{ format_form.audio_position_input.errors|join:", " }}</div>
                  {% endif %}
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label" for="{{ format_form.audio_playback_speed.id_for_label }}">{{ format_form.audio_playback_speed.label }}</label>
                  {{ format_form.audio_playback_speed }}
                  <div class="form-text">Допустимый диапазон от 0.5× до 3×.</div>
                  {% if format_form.audio_playback_speed.errors %}
                    <div class="invalid-feedback d-block">{{ format_form.audio_playback_speed.errors|join:", " }}</div>
                  {% endif %}
                </div>
                {% if format_form.non_field_errors %}
                  <div class="col-12">
                    <div class="alert alert-danger mb-0">{{ format_form.non_field_errors|join:"<br>"|safe }}</div>
                  </div>
                {% endif %}
                <div class="col-12 d-flex justify-content-end">
                  <button type="submit" class="btn btn-outline-primary rounded-pill px-4">Сохранить формат</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      {% endwith %}
    </div>
  </section>

  <section class="reading-section">
    <div class="reading-section__header">
      <h2 class="reading-section__title">История чтения</h2>
      <p class="reading-section__note">Сколько вы прочитали по дням и в каком формате.</p>
    </div>
    {% if chart_labels or format_chart_labels %}
      <div class="row g-3 mb-3">
        {% if chart_labels %}
          <div class="col-12{% if format_chart_labels %} col-lg-8{% endif %}">
            <div class="reading-chart-card" role="img" aria-label="Диаграмма прочитанных страниц по дням">
              <div class="reading-chart-card__canvas">
                <canvas id="readingHistoryChart" aria-label="Прочитанные страницы по дням"></canvas>
              </div>
            </div>
          </div>
        {% endif %}
        {% if format_chart_labels %}
          <div class="col-12 col-lg-4">
            <div class="reading-chart-card" role="img" aria-label="Диаграмма форматов чтения">
              <div class="reading-chart-card__canvas">
                <canvas id="readingFormatChart" aria-label="Распределение форматов чтения"></canvas>
              </div>
            </div>
          </div>
        {% endif %}
      </div>

      {% if chart_labels %}
        {{ chart_labels|json_script:"reading-chart-labels" }}
        {{ chart_pages|json_script:"reading-chart-pages" }}
        {{ chart_mediums|json_script:"reading-chart-mediums" }}
        {{ chart_medium_pages|json_script:"reading-chart-medium-pages" }}
      {% endif %}
      {% if format_chart_labels %}
        {{ format_chart_labels|json_script:"reading-format-chart-labels" }}
        {{ format_chart_values|json_script:"reading-format-chart-values" }}
        {{ format_chart_palette|json_script:"reading-format-chart-colors" }}
      {% endif %}

      <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" crossorigin="anonymous"></script>
      <script>
      (function () {
        if (typeof Chart === 'undefined') {
          return;
        }

        const historyLabelsEl = document.getElementById('reading-chart-labels');
        const historyPagesEl = document.getElementById('reading-chart-pages');
        const historyMediumsEl = document.getElementById('reading-chart-mediums');
        const historyMediumPagesEl = document.getElementById('reading-chart-medium-pages');
        const historyCanvas = document.getElementById('readingHistoryChart');

        if (historyLabelsEl && historyPagesEl && historyMediumsEl && historyMediumPagesEl && historyCanvas) {
          const labels = JSON.parse(historyLabelsEl.textContent);
          const pages = JSON.parse(historyPagesEl.textContent);
          const mediums = JSON.parse(historyMediumsEl.textContent);
          const mediumPages = JSON.parse(historyMediumPagesEl.textContent);

          const getPalette = () => {
            const root = getComputedStyle(document.documentElement);
            const parseCssColor = (value, fallbackRgb) => {
              const trimmed = (value || '').trim();
              if (trimmed.startsWith('#')) {
                let hex = trimmed.slice(1);
                if (hex.length === 3) {
                  hex = hex.split('').map((char) => char + char).join('');
                }
                if (hex.length === 6) {
                  const intValue = parseInt(hex, 16);
                  if (!Number.isNaN(intValue)) {
                    return [
                      (intValue >> 16) & 255,
                      (intValue >> 8) & 255,
                      intValue & 255,
                    ];
                  }
                }
              }
            const rgbMatch = trimmed.match(/rgba?\(([^)]+)\)/i);
              if (rgbMatch) {
                const parts = rgbMatch[1].split(',').map((part) => Number.parseFloat(part.trim()));
                if (parts.length >= 3 && parts.slice(0, 3).every((num) => !Number.isNaN(num))) {
                  return parts.slice(0, 3);
                }
              }
              return fallbackRgb;
            };

          const buildScheme = (rgb, { backgroundAlpha = 0.35, hoverAlpha = 0.45, borderAlpha = 0.9 } = {}) => {
              const [r, g, b] = rgb;
              return {
                borderColor: `rgba(${r}, ${g}, ${b}, ${borderAlpha})`,
                backgroundColor: `rgba(${r}, ${g}, ${b}, ${backgroundAlpha})`,
                hoverBackgroundColor: `rgba(${r}, ${g}, ${b}, ${hoverAlpha})`,
              };
            };

          const primaryRgbRaw = (root.getPropertyValue('--bs-primary-rgb') || '108,92,231').trim();
            const primaryRgb = primaryRgbRaw.split(',').map((num) => Number.parseFloat(num.trim()));
            const defaultRgb = primaryRgb.length === 3 && primaryRgb.every((num) => !Number.isNaN(num))
              ? primaryRgb
              : [108, 92, 231];

            const palette = {
              bodyColor: (root.getPropertyValue('--bs-body-color') || '#212529').trim(),
              border: (root.getPropertyValue('--bs-border-color') || 'rgba(0,0,0,0.1)').trim(),
              defaultBar: buildScheme(defaultRgb, { backgroundAlpha: 0.25, hoverAlpha: 0.35, borderAlpha: 0.85 }),
              mediums: {},
            };

            palette.mediums.paper = buildScheme(
              parseCssColor(root.getPropertyValue('--journey-fern'), [123, 119, 82])
            );
            palette.mediums.ebook = buildScheme(
              parseCssColor(root.getPropertyValue('--journey-gold'), [188, 184, 147])
            );

            return palette;
          };

          let chartInstance;

          const renderChart = () => {
            const palette = getPalette();
            if (chartInstance) {
              chartInstance.destroy();
            }
            const mediumsWithData = Array.isArray(mediums)
              ? mediums.filter((medium) => {
                  const data = mediumPages?.[medium.code];
                  return Array.isArray(data) && data.some((value) => Number(value) > 0);
                })
              : [];
            const hasMediumData = mediumsWithData.length > 0;
            const datasets = hasMediumData
              ? mediumsWithData.map((medium) => {
                  const scheme = palette.mediums?.[medium.code] || palette.defaultBar;
                  const data = Array.isArray(mediumPages?.[medium.code])
                    ? mediumPages[medium.code]
                    : new Array(labels.length).fill(0);
                  return {
                    label: medium.label,
                    data,
                    borderWidth: 1.5,
                    borderRadius: 10,
                    borderColor: scheme.borderColor,
                    backgroundColor: scheme.backgroundColor,
                    hoverBackgroundColor: scheme.hoverBackgroundColor,
                    maxBarThickness: 48,
                  };
                })
              : [{
                  data: pages,
                  borderWidth: 1.5,
                  borderRadius: 10,
                  borderColor: palette.defaultBar.borderColor,
                  backgroundColor: palette.defaultBar.backgroundColor,
                  hoverBackgroundColor: palette.defaultBar.hoverBackgroundColor,
                  maxBarThickness: 48,
                }];
            chartInstance = new Chart(historyCanvas.getContext('2d'), {
              type: 'bar',
              data: {
                labels,
                datasets,
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: hasMediumData,
                    labels: {
                      color: palette.bodyColor,
                      usePointStyle: true,
                    },
                  },
                  tooltip: {
                    callbacks: {
                      title: (context) => context[0]?.label ?? '',
                      label: (context) => {
                        const value = context.parsed.y ?? 0;
                        if (context.dataset?.label) {
                          return `${context.dataset.label}: ${value} стр.`;
                        }
                        return `${value} стр.`;
                      },
                      footer: (items) => {
                        if (!items?.length) {
                          return '';
                        }
                        const total = items.reduce((sum, item) => sum + (item.parsed.y ?? 0), 0);
                        return `Итого: ${total} стр.`;
                      },
                    },
                  },
                },
                layout: {
                  padding: { top: 12, right: 12, bottom: 0, left: 12 },
                },
                scales: {
                  x: {
                    stacked: false,
                    grid: { display: false },
                    ticks: {
                      color: palette.bodyColor,
                      autoSkip: true,
                      maxRotation: 0,
                      minRotation: 0,
                    },
                    },
                  y: {
                    stacked: false,
                    beginAtZero: true,
                    grid: {
                      color: palette.border,
                      drawBorder: false,
                    },
                    ticks: {
                      color: palette.bodyColor,
                      precision: 0,
                      callback: (value) => `${value} стр.`,
                    },
                  },
                },
              },
              });
          };

          renderChart();
          document.getElementById('themeToggle')?.addEventListener('click', () => {
            requestAnimationFrame(renderChart);
          });
        }

        const formatLabelsEl = document.getElementById('reading-format-chart-labels');
        const formatValuesEl = document.getElementById('reading-format-chart-values');
        const formatColorsEl = document.getElementById('reading-format-chart-colors');
        const formatCanvas = document.getElementById('readingFormatChart');

        if (formatLabelsEl && formatValuesEl && formatColorsEl && formatCanvas) {
          const labels = JSON.parse(formatLabelsEl.textContent);
          const values = JSON.parse(formatValuesEl.textContent);
          const colors = JSON.parse(formatColorsEl.textContent);
          let formatChartInstance;

          const renderFormatChart = () => {
            const root = getComputedStyle(document.documentElement);
            const bodyColor = (root.getPropertyValue('--bs-body-color') || '#212529').trim();
            if (formatChartInstance) {
              formatChartInstance.destroy();
            }
            formatChartInstance = new Chart(formatCanvas.getContext('2d'), {
              type: 'doughnut',
              data: {
                labels,
                datasets: [
                  {
                    data: values,
                    backgroundColor: colors,
                    borderColor: '#fff',
                    borderWidth: 2,
                  },
                ],
              },
              options: {
                responsive: true,
                plugins: {
                  legend: {
                    position: 'bottom',
                    labels: {
                      color: bodyColor,
                    },
                  },
                  tooltip: {
                    callbacks: {
                      label: (context) => {
                        const label = context.label ?? '';
                        const value = context.parsed ?? 0;
                        return `${label}: ${value}%`;
                      },
                    },
                  },
                },
              },
            });
          };

          renderFormatChart();
          document.getElementById('themeToggle')?.addEventListener('click', () => {
            requestAnimationFrame(renderFormatChart);
          });
        }
      })();
    </script>
    {% endif %}

    {% if audio_logs %}
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead>
            <tr>
              <th scope="col">Дата</th>
              <th scope="col">Формат</th>
              <th scope="col">Прогресс</th>
            </tr>
          </thead>
          <tbody>
            {% for log in audio_logs %}
              <tr>
                <td>{{ log.log_date|date:"d.m.Y" }}</td>
                <td>{{ log.get_medium_display }}</td>
                <td>
                  {% if log.audio_duration_display %}
                    {{ log.audio_duration_display }}
                  {% else %}
                    {{ log.pages_equivalent|floatformat:-2 }} стр.
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% elif chart_labels %}
      <p class="text-muted mb-0">Пока нет записей по аудиокниге.</p>
    {% else %}
      <p class="text-muted mb-0">Пока нет записей о прочитанных страницах.</p>
    {% endif %}
  </section>

  <section class="reading-section">
    <div class="reading-section__header">
      <h2 class="reading-section__title">Герои книги</h2>
      <p class="reading-section__note">Записывайте персонажей, чтобы не потерять их истории.</p>
    </div>
    {% if character_rows %}
      <div class="table-responsive mb-3">
        <table class="table table-sm align-middle mb-0">
          <thead>
            <tr>
              <th scope="col" style="width: 200px;">Имя</th>
              <th scope="col">Описание</th>
              <th scope="col" class="text-end">Действия</th>
            </tr>
          </thead>
          <tbody>
            {% for character, form in character_rows %}
              <tr>
                <td class="fw-semibold">{{ character.name }}</td>
                <td>{{ character.description|default:"—"|linebreaksbr }}</td>
                <td class="text-end">
                  <button
                    class="btn btn-outline-secondary btn-sm"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#character-edit-{{ character.id }}"
                    aria-expanded="false"
                    aria-controls="character-edit-{{ character.id }}"
                  >
                    Редактировать
                  </button>
                </td>
              </tr>
              <tr class="collapse" id="character-edit-{{ character.id }}">
                <td colspan="3">
                  <form
                    method="post"
                    action="{% url 'shelves:reading_update_character' progress.id character.id %}"
                    class="row g-3"
                  >
                    {% csrf_token %}
                    {% if form.non_field_errors %}
                      <div class="col-12">
                        <div class="alert alert-danger mb-0">
                          {{ form.non_field_errors|join:"<br>"|safe }}
                        </div>
                      </div>
                    {% endif %}
                    <div class="col-12 col-md-4">
                      <label class="form-label" for="{{ form.name.id_for_label }}">
                        {{ form.name.label }}
                      </label>
                      {{ form.name }}
                      {% if form.name.errors %}
                        <div class="invalid-feedback d-block">
                          {{ form.name.errors|join:", " }}
                        </div>
                      {% endif %}
                    </div>
                    <div class="col-12 col-md-8">
                      <label class="form-label" for="{{ form.description.id_for_label }}">
                        {{ form.description.label }}
                      </label>
                      {{ form.description }}
                      {% if form.description.errors %}
                        <div class="invalid-feedback d-block">
                          {{ form.description.errors|join:", " }}
                        </div>
                      {% endif %}
                    </div>
                    <div class="col-12 d-flex justify-content-end">
                      <button type="submit" class="btn btn-primary btn-sm rounded-pill px-4">Сохранить изменения</button>
                    </div>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-muted">Пока нет добавленных персонажей.</p>
    {% endif %}

    <div class="reading-subsection mt-3">
      <h3 class="h6 mb-3">Добавить героя</h3>
      <form method="post" action="{% url 'shelves:reading_add_character' progress.id %}" class="row g-3">
        {% csrf_token %}
        {% if character_form.non_field_errors %}
          <div class="col-12">
            <div class="alert alert-danger mb-0">
              {{ character_form.non_field_errors|join:"<br>"|safe }}
            </div>
          </div>
        {% endif %}
        <div class="col-12 col-md-4">
          <label class="form-label" for="{{ character_form.name.id_for_label }}">
            {{ character_form.name.label }}
          </label>
          {{ character_form.name }}
          {% if character_form.name.errors %}
            <div class="invalid-feedback d-block">
              {{ character_form.name.errors|join:", " }}
            </div>
          {% endif %}
        </div>
        <div class="col-12 col-md-8">
          <label class="form-label" for="{{ character_form.description.id_for_label }}">
            {{ character_form.description.label }}
          </label>
          {{ character_form.description }}
          {% if character_form.description.errors %}
            <div class="invalid-feedback d-block">
              {{ character_form.description.errors|join:", " }}
            </div>
          {% endif %}
        </div>
        <div class="col-12 d-flex justify-content-end">
          <button type="submit" class="btn btn-outline-primary rounded-pill">Добавить героя</button>
        </div>
      </form>
    </div>
  </section>

  <section class="reading-section">
    <div class="reading-section__header">
      <h2 class="reading-section__title">Любимые цитаты</h2>
      <p class="reading-section__note">Сохраняйте фразы, к которым хочется возвращаться.</p>
    </div>
    {% if quote_rows %}
      <div class="list-group mb-3">
        {% for quote, form in quote_rows %}
          <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-start gap-3">
              <div class="flex-grow-1">
                {% if quote.location %}
                  <div class="text-muted small mb-1">{{ quote.location }}</div>
                {% endif %}
                <div>{{ quote.body|linebreaksbr }}</div>
                {% if quote.comment %}
                  <div class="text-muted small mt-2">{{ quote.comment|linebreaksbr }}</div>
                {% endif %}
              </div>
              <button
                class="btn btn-outline-secondary btn-sm"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#quote-edit-{{ quote.id }}"
                aria-expanded="false"
                aria-controls="quote-edit-{{ quote.id }}"
              >
                Редактировать
              </button>
            </div>
            <div class="collapse mt-3" id="quote-edit-{{ quote.id }}">
              <form
                method="post"
                action="{% url 'shelves:reading_update_quote' progress.id quote.id %}"
                class="row g-3"
              >
                {% csrf_token %}
                {% if form.non_field_errors %}
                  <div class="col-12">
                    <div class="alert alert-danger mb-0">
                      {{ form.non_field_errors|join:"<br>"|safe }}
                    </div>
                  </div>
                {% endif %}
                <div class="col-12 col-md-4">
                  <label class="form-label" for="{{ form.location.id_for_label }}">{{ form.location.label }}</label>
                  {{ form.location }}
                  {% if form.location.errors %}
                    <div class="invalid-feedback d-block">{{ form.location.errors|join:", " }}</div>
                  {% endif %}
                </div>
                <div class="col-12">
                  <label class="form-label" for="{{ form.body.id_for_label }}">{{ form.body.label }}</label>
                  {{ form.body }}
                  {% if form.body.errors %}
                    <div class="invalid-feedback d-block">{{ form.body.errors|join:", " }}</div>
                  {% endif %}
                </div>
                <div class="col-12">
                  <label class="form-label" for="{{ form.comment.id_for_label }}">{{ form.comment.label }}</label>
                  {{ form.comment }}
                  {% if form.comment.errors %}
                    <div class="invalid-feedback d-block">{{ form.comment.errors|join:", " }}</div>
                  {% endif %}
                </div>
                <div class="col-12 d-flex justify-content-end">
                  <button type="submit" class="btn btn-primary btn-sm rounded-pill px-4">Сохранить изменения</button>
                </div>
              </form>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted">Пока нет сохранённых цитат.</p>
    {% endif %}

    <div class="reading-subsection mt-3">
      <h3 class="h6 mb-3">Добавить цитату</h3>
      <form method="post" action="{% url 'shelves:reading_add_quote' progress.id %}" class="row g-3">
        {% csrf_token %}
        {% if quote_form.non_field_errors %}
          <div class="col-12">
            <div class="alert alert-danger mb-0">
              {{ quote_form.non_field_errors|join:"<br>"|safe }}
            </div>
          </div>
        {% endif %}
        <div class="col-12 col-md-4">
          <label class="form-label" for="{{ quote_form.location.id_for_label }}">{{ quote_form.location.label }}</label>
          {{ quote_form.location }}
          {% if quote_form.location.errors %}
            <div class="invalid-feedback d-block">{{ quote_form.location.errors|join:", " }}</div>
          {% endif %}
        </div>
        <div class="col-12">
          <label class="form-label" for="{{ quote_form.body.id_for_label }}">{{ quote_form.body.label }}</label>
          {{ quote_form.body }}
          {% if quote_form.body.errors %}
            <div class="invalid-feedback d-block">{{ quote_form.body.errors|join:", " }}</div>
          {% endif %}
        </div>
        <div class="col-12">
          <label class="form-label" for="{{ quote_form.comment.id_for_label }}">{{ quote_form.comment.label }}</label>
          {{ quote_form.comment }}
          {% if quote_form.comment.errors %}
            <div class="invalid-feedback d-block">{{ quote_form.comment.errors|join:", " }}</div>
          {% endif %}
        </div>
        <div class="col-12 d-flex justify-content-end">
          <button type="submit" class="btn btn-outline-primary rounded-pill">Сохранить цитату</button>
        </div>
      </form>
    </div>
  </section>

  <section class="reading-section reading-note-area">
    <div class="reading-section__header">
      <h2 class="reading-section__title">Личные заметки</h2>
      <p class="reading-section__note">Записывайте впечатления и любимые цитаты.</p>
    </div>
    {% if note_rows %}
      <div class="list-group mb-3">
        {% for note, form in note_rows %}
          <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-start gap-3">
              <div class="flex-grow-1">
                {% if note.location %}
                  <div class="text-muted small mb-1">{{ note.location }}</div>
                {% endif %}
                <div>{{ note.body|linebreaksbr }}</div>
                {% if note.comment %}
                  <div class="text-muted small mt-2">{{ note.comment|linebreaksbr }}</div>
                {% endif %}
              </div>
              <button
                class="btn btn-outline-secondary btn-sm"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#note-edit-{{ note.id }}"
                aria-expanded="false"
                aria-controls="note-edit-{{ note.id }}"
              >
                Редактировать
              </button>
            </div>
            <div class="collapse mt-3" id="note-edit-{{ note.id }}">
              <form
                method="post"
                action="{% url 'shelves:reading_update_note_entry' progress.id note.id %}"
                class="row g-3"
              >
                {% csrf_token %}
                {% if form.non_field_errors %}
                  <div class="col-12">
                    <div class="alert alert-danger mb-0">
                      {{ form.non_field_errors|join:"<br>"|safe }}
                    </div>
                  </div>
                {% endif %}
                <div class="col-12 col-md-4">
                  <label class="form-label" for="{{ form.location.id_for_label }}">{{ form.location.label }}</label>
                  {{ form.location }}
                  {% if form.location.errors %}
                    <div class="invalid-feedback d-block">{{ form.location.errors|join:", " }}</div>
                  {% endif %}
                </div>
                <div class="col-12">
                  <label class="form-label" for="{{ form.body.id_for_label }}">{{ form.body.label }}</label>
                  {{ form.body }}
                  {% if form.body.errors %}
                    <div class="invalid-feedback d-block">{{ form.body.errors|join:", " }}</div>
                  {% endif %}
                </div>
                <div class="col-12">
                  <label class="form-label" for="{{ form.comment.id_for_label }}">{{ form.comment.label }}</label>
                  {{ form.comment }}
                  {% if form.comment.errors %}
                    <div class="invalid-feedback d-block">{{ form.comment.errors|join:", " }}</div>
                  {% endif %}
                </div>
                <div class="col-12 d-flex justify-content-end">
                  <button type="submit" class="btn btn-primary btn-sm rounded-pill px-4">Сохранить изменения</button>
                </div>
              </form>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted">Пока нет коротких заметок.</p>
    {% endif %}

    <div class="reading-subsection mt-3">
      <h3 class="h6 mb-3">Добавить заметку</h3>
      <form method="post" action="{% url 'shelves:reading_add_note_entry' progress.id %}" class="row g-3">
        {% csrf_token %}
        {% if note_entry_form.non_field_errors %}
          <div class="col-12">
            <div class="alert alert-danger mb-0">
              {{ note_entry_form.non_field_errors|join:"<br>"|safe }}
            </div>
          </div>
          {% endif %}
        <div class="col-12 col-md-4">
          <label class="form-label" for="{{ note_entry_form.location.id_for_label }}">{{ note_entry_form.location.label }}</label>
          {{ note_entry_form.location }}
          {% if note_entry_form.location.errors %}
            <div class="invalid-feedback d-block">{{ note_entry_form.location.errors|join:", " }}</div>
          {% endif %}
        </div>
        <div class="col-12">
          <label class="form-label" for="{{ note_entry_form.body.id_for_label }}">{{ note_entry_form.body.label }}</label>
          {{ note_entry_form.body }}
          {% if note_entry_form.body.errors %}
            <div class="invalid-feedback d-block">{{ note_entry_form.body.errors|join:", " }}</div>
          {% endif %}
        </div>
      <div class="col-12">
          <label class="form-label" for="{{ note_entry_form.comment.id_for_label }}">{{ note_entry_form.comment.label }}</label>
          {{ note_entry_form.comment }}
          {% if note_entry_form.comment.errors %}
            <div class="invalid-feedback d-block">{{ note_entry_form.comment.errors|join:", " }}</div>
          {% endif %}
        </div>
        <div class="col-12 d-flex justify-content-end">
          <button type="submit" class="btn btn-outline-primary rounded-pill">Сохранить заметку</button>
        </div>
      </form>
    </div>

    <div class="reading-subsection mt-4">
      <h3 class="h6 mb-3">Общие заметки</h3>
      <form method="post" action="{% url 'shelves:reading_update_notes' progress.id %}" class="row g-3">
        {% csrf_token %}
        {% if notes_form.non_field_errors %}
          <div class="col-12">
            <div class="alert alert-danger mb-0">
              {{ notes_form.non_field_errors|join:"<br>"|safe }}
            </div>
          </div>
        {% endif %}
      <div class="col-12">
          <label class="form-label" for="{{ notes_form.reading_notes.id_for_label }}">
            {{ notes_form.reading_notes.label }}
          </label>
          {{ notes_form.reading_notes }}
          {% if notes_form.reading_notes.errors %}
            <div class="invalid-feedback d-block">
              {{ notes_form.reading_notes.errors|join:", " }}
            </div>
          {% endif %}
        </div>
        <div class="col-12 d-flex justify-content-end">
          <button type="submit" class="btn btn-primary rounded-pill px-4">Сохранить заметки</button>
        </div>
      </form>
    </div>
  </section>
</div>
<div class="cb-toast" id="closingBookToast" aria-live="polite">
  <div class="cb-card">
    <div class="cb-scene">
      <a id="closingBookLink" href="#" tabindex="-1" aria-hidden="true">
        <div class="cb-book" id="closingBook">
          <div class="cb-book__back"></div>
          <div class="cb-book__pages"></div>
          <div class="cb-book__cover"></div>
          <div class="cb-book__spine"></div>
          <div class="cb-gloss"></div>
          <div class="cb-shadow"></div>
        </div>
      </a>
    </div>
    <div class="cb-info">
      <h4 id="closingBookTitle">Книга завершена!</h4>
      <p>Отличная работа — продолжаем?</p>
    </div>
    <div class="cb-actions">
      <a class="btn btn-sm btn-light" id="closingBookAction" href="#">Открыть</a>
      <button class="btn btn-sm btn-outline-light" id="closingBookClose" type="button">Скрыть</button>
    </div>
  </div>
</div>
{% endblock %}
