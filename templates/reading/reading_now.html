{% extends "base.html" %}
{% load static %}
{% block title %}–ß–∏—Ç–∞—é —Å–µ–π—á–∞—Å ¬∑ ReadTogether{% endblock %}
{% block body_class %} reading-now-page{% endblock %}

{% block extra_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'books/genre-shelf.css' %}">
  <style>
    .reading-now-page{
      --rn-hero-bg: #f2d9c7;
      --rn-shelf-texture: var(--books-shelf-texture, url('{{ MEDIA_URL }}book_list/bookshelfhell.PNG'));
      --rn-accent: #5d768b;
      --rn-accent-rgb: 93,118,139;
      --rn-muted: var(--bs-secondary-color, #6c757d);
      --bs-primary: var(--rn-accent);
      --bs-primary-rgb: var(--rn-accent-rgb);
    }

    .reading-hero{
      background: var(--rn-hero-bg);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 1rem;
      padding: 1.5rem 1.25rem;
      box-shadow: 0 12px 28px rgba(154,104,82,.18);
      color: #2b1a0f;
    }
    .reading-hero__title{ margin:0 0 .25rem; color:#2b1a0f; }
    .reading-hero__subtitle{ margin:0; color: rgba(43,26,15,.85); }

    .btn-accent{
      background-color: var(--rn-accent) !important;
      border-color: var(--rn-accent) !important;
      color:#fff !important;
      border-radius:.85rem;
    }
    .btn-accent:hover{
      background-color: color-mix(in oklab, var(--rn-accent) 92%, white) !important;
      border-color: color-mix(in oklab, var(--rn-accent) 92%, white) !important;
      color:#fff !important;
    }

    .reading-shelf-card{ border:0; border-radius:1rem; box-shadow:0 12px 28px rgba(0,0,0,.06); background:#fff; }
    .reading-shelf-card__body{
      padding: 1rem 0 1.25rem;
      background:
        linear-gradient(0deg, rgba(0,0,0,.03), rgba(0,0,0,.03)) top/100% 60px no-repeat,
        var(--rn-shelf-texture) center/contain repeat-y;
      border-radius: 1rem;
      overflow: hidden;
    }

    .book-shelf-wrapper{ position:relative; }
    .book-shelf{
      display:grid; grid-auto-flow:column; grid-auto-columns:minmax(170px, 200px);
      gap: 1rem 1.25rem; overflow-x:auto; padding:1rem 3.25rem; scroll-snap-type:x proximity;
    }
    .book-shelf::-webkit-scrollbar{ height:10px; }
    .book-shelf::-webkit-scrollbar-thumb{ background:rgba(0,0,0,.15); border-radius:6px; }

    .book-shelf__nav{
      position:absolute; top:50%; transform:translateY(-50%);
      width:40px; height:40px; border-radius:50%;
      border:1px solid rgba(0,0,0,.15); background:#fff; box-shadow:0 6px 16px rgba(0,0,0,.12);
      display:inline-flex; align-items:center; justify-content:center; z-index:2;
    }
    .book-shelf__nav[disabled]{ opacity:.4; pointer-events:none; }
    .book-shelf__nav--prev{ left:.75rem; }
    .book-shelf__nav--next{ right:.75rem; }

    .book-item{
      width:100%;
      scroll-snap-align:start;
      display:flex; flex-direction:column;
      position: relative; /* –í–ê–ñ–ù–û: –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è stretched-link */
    }

    .book-item__media{ position:relative; }
    .book-item__ratio{
      aspect-ratio: 2 / 3;
      width: 100%;
      border-radius: .75rem;
      background: #f5f6fa;
      box-shadow: 0 8px 20px rgba(0,0,0,.18);
      position: relative;
      overflow: hidden;
    }
    .book-item__ratio > img{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit: contain;
      display:block;
      background:#fff;
      border-radius: inherit;
    }

    .reading-badge{
      position:absolute; top:.5rem; left:.5rem;
      background: rgba(0,0,0,.72); color:#fff; border-radius:999px;
      padding:.25rem .6rem; font-weight:600; z-index:1;
    }

    .book-item__shelf-shadow{
      height:10px; margin-top:.45rem; border-radius:6px;
      background: radial-gradient(closest-side, rgba(0,0,0,.16), rgba(0,0,0,0)) center/100% 100% no-repeat;
      opacity:.35;
    }

    .book-item__content{ padding:.5rem .25rem 0; display:flex; flex-direction:column; }
    .book-item__title{ font-size:.98rem; margin:0; }
    .book-item__title a{ text-decoration:none; }
    .book-item__authors{ color:var(--rn-muted); font-size:.9rem; }

    /* –†–µ–∑–µ—Ä–≤ –ø–æ–¥ 2 —Å—Ç—Ä–æ–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏ 1 —Å—Ç—Ä–æ–∫—É –∞–≤—Ç–æ—Ä–æ–≤ ‚Äî –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ */
    .book-item__title{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; min-height: calc(1.2em * 2); }
    .book-item__authors{ display:-webkit-box; -webkit-line-clamp:1; -webkit-box-orient:vertical; overflow:hidden; min-height: 1.2em; }

    .book-item__progress{ margin-top:.4rem; }
    .book-item__progress .progress{
      height:8px; border-radius:999px; overflow:hidden; background:#ececec; border:1px solid rgba(0,0,0,.06);
    }
    .book-item__progress .progress-bar{ border-radius:999px; }

    .book-item__actions{
      margin-top:.6rem;
      position: relative;   /* –í–ê–ñ–ù–û: –∫–Ω–æ–ø–∫–∏ –≤—ã—à–µ —Ä–∞—Å—Ç—è–Ω—É—Ç–æ–π —Å—Å—ã–ª–∫–∏ */
      z-index: 2;
    }
    .book-item__actions .btn{ width:100%; padding:.5rem .75rem; border-radius:.75rem; }

    @media (max-width: 576px){
      .book-shelf{ grid-auto-columns: minmax(140px, 170px); }
    }
  </style>
{% endblock %}

{% block content %}

<section class="reading-hero mb-4">
  <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between gap-2">
    <div>
      <h1 class="reading-hero__title">–ß–∏—Ç–∞—é —Å–µ–π—á–∞—Å</h1>
      <p class="reading-hero__subtitle">–í–∞—à–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–∏–≥–∏ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º –∏ —Ñ–æ—Ä–º–∞—Ç–æ–º —á—Ç–µ–Ω–∏—è.</p>
    </div>
    <a class="btn btn-accent" href="{% url 'shelves:reading_feed' %}"><i class="bi bi-activity me-2"></i>–õ–µ–Ω—Ç–∞ —á—Ç–µ–Ω–∏—è</a>
  </div>
</section>

{% if not shelf or not items %}
  <div class="reading-empty d-flex align-items-center gap-3">
    <div class="flex-shrink-0 bg-light text-primary rounded-circle d-flex align-items-center justify-content-center" style="width:48px;height:48px;">
      <span class="fs-4" aria-hidden="true">üìö</span>
      <span class="visually-hidden">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–Ω–∏–≥</span>
    </div>
    <div>
      <h2 class="h6 mb-1">–ü–æ–∫–∞ –∑–¥–µ—Å—å –ø—É—Å—Ç–æ</h2>
      <p class="mb-0 text-muted">–î–æ–±–∞–≤—å—Ç–µ –∫–Ω–∏–≥–∏ –Ω–∞ –ø–æ–ª–∫—É ¬´–ß–∏—Ç–∞—é¬ª, —á—Ç–æ–±—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å.</p>
    </div>
  </div>
{% else %}
  <section class="reading-shelf-card">
    <div class="reading-shelf-card__body" style="--books-shelf-texture: url('{{ MEDIA_URL }}book_list/bookshelfhell.PNG')">
      <div class="book-shelf-wrapper">
        <button class="book-shelf__nav book-shelf__nav--prev" type="button" aria-label="–ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –Ω–∞–∑–∞–¥">
          <span class="visually-hidden">–ù–∞–∑–∞–¥</span><i class="bi bi-chevron-left"></i>
        </button>

        <div class="book-shelf">
          {% for it in items %}
            <article class="book-item">
              <div class="book-item__media">
                <span class="reading-badge">–ß–∏—Ç–∞—é</span>
                <a class="book-item__cover-link" href="{% url 'book_detail' it.book.id %}">
                  <div class="book-item__ratio">
                    {% with cover_url=it.book.get_cover_url %}
                      {% if cover_url %}
                        <img src="{{ cover_url }}" alt="–û–±–ª–æ–∂–∫–∞ {{ it.book.title }}" loading="lazy">
                      {% else %}
                        <img src="{% static 'books/cover-placeholder-2x3.png' %}" alt="–ù–µ—Ç –æ–±–ª–æ–∂–∫–∏">
                      {% endif %}
                    {% endwith %}
                  </div>
                </a>
              </div>

              <div class="book-item__shelf-shadow" aria-hidden="true"></div>

              <div class="book-item__content">
                <h2 class="book-item__title">
                  <a class="stretched-link" href="{% url 'book_detail' it.book.id %}">{{ it.book.title }}</a>
                </h2>
                {% with authors=it.book.authors.all %}
                  {% if authors %}<div class="book-item__authors">{{ authors|join:", " }}</div>{% endif %}
                {% endwith %}

                {% if it.progress %}
                  <div class="book-item__progress">
                    <div class="progress">
                      <div class="progress-bar bg-primary" style="width: {{ it.progress_percent|floatformat:'0' }}%" role="progressbar"
                           aria-valuenow="{{ it.progress_percent|floatformat:'0' }}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div class="d-flex justify-content-between small text-muted mt-1">
                      <span>{{ it.progress_percent|floatformat:"0" }}%</span>
                      {% if it.progress_current_page %}
                        <span>{{ it.progress_current_page }} —Å—Ç—Ä.</span>
                      {% elif it.progress_total_pages %}
                        <span>{{ it.progress_total_pages }} —Å—Ç—Ä.</span>
                      {% endif %}
                    </div>
                  </div>
                {% endif %}

                <div class="book-item__actions">
                  <a class="btn btn-accent" href="{% url 'shelves:reading_track' it.book.id %}">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —á—Ç–µ–Ω–∏–µ</a>
                </div>
              </div>
            </article>
          {% endfor %}
        </div>

        <button class="book-shelf__nav book-shelf__nav--next" type="button" aria-label="–ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –≤–ø–µ—Ä—ë–¥">
          <span class="visually-hidden">–í–ø–µ—Ä—ë–¥</span><i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>
  </section>
{% endif %}

{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script>
    (function(){
      document.querySelectorAll('.book-shelf-wrapper').forEach((wrapper) => {
        if (wrapper.dataset.shelfNavBound === 'true') return;
        const shelf = wrapper.querySelector('.book-shelf');
        const prev  = wrapper.querySelector('.book-shelf__nav--prev');
        const next  = wrapper.querySelector('.book-shelf__nav--next');
        if (!shelf || !prev || !next) return;
        wrapper.dataset.shelfNavBound = 'true';

        const update = () => {
          const max = Math.max(shelf.scrollWidth - shelf.clientWidth, 0);
          prev.disabled = shelf.scrollLeft <= 1;
          next.disabled = shelf.scrollLeft >= max - 1;
        };
        const jump = (dir) => {
          const dist = Math.max(shelf.clientWidth * 0.8, 220) * dir;
          try { shelf.scrollBy({ left: dist, behavior: 'smooth' }); }
          catch { shelf.scrollLeft += dist; }
          requestAnimationFrame(update);
        };

        prev.addEventListener('click', (e)=>{ e.preventDefault(); jump(-1); });
        next.addEventListener('click', (e)=>{ e.preventDefault(); jump(1);  });
        shelf.addEventListener('scroll', ()=>requestAnimationFrame(update), { passive:true });

        if (typeof ResizeObserver !== 'undefined'){
          new ResizeObserver(update).observe(shelf);
        } else {
          window.addEventListener('resize', update);
        }
        shelf.querySelectorAll('img').forEach(img => {
          if (!img.complete) img.addEventListener('load', update, { once:true });
        });

        update();
      });
    })();
  </script>
{% endblock %}
