{% extends "base.html" %}

{% block title %}{{ marathon.title }} ‚Äî –ö–Ω–∏–∂–Ω—ã–π –º–∞—Ä–∞—Ñ–æ–Ω{% endblock %}

{% block content %}
<div class="card mb-4 overflow-hidden">
  <div class="row g-0 align-items-stretch" style="background-color:#62769a; color:#fff;">
    <div class="col-md-4">
      {% if marathon.cover %}
        <img class="marathon-detail__cover w-100 h-100 object-fit-cover" src="{{ marathon.cover.url }}" alt="–û–±–ª–æ–∂–∫–∞ –º–∞—Ä–∞—Ñ–æ–Ω–∞ {{ marathon.title }}">
      {% else %}
        <div class="h-100 d-flex align-items-center justify-content-center p-5">
          <span class="display-6">üìö</span>
        </div>
      {% endif %}
    </div>
    <div class="col-md-8">
      <div class="p-4 h-100 d-flex flex-column gap-3">
        <div>
          <h1 class="h3 mb-2">{{ marathon.title }}</h1>
          <p class="mb-0">{{ marathon.description|default:"–°–æ–∑–¥–∞—Ç–µ–ª—å –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–∏–ª –æ–ø–∏—Å–∞–Ω–∏–µ." }}</p>
        </div>
        {% with themes=marathon.themes.all %}
          {% if themes %}
            <div>
              <h2 class="h6 text-uppercase text-white-50 mb-2">–ó–∞–¥–∞–Ω–∏—è –º–∞—Ä–∞—Ñ–æ–Ω–∞</h2>
              <ol class="mb-0 ps-3 d-flex flex-column gap-2">
                {% for theme in themes %}
                  <li>
                    <div class="fw-semibold">{{ theme.title }}</div>
                    {% if theme.description %}
                      <div class="small text-white-50">{{ theme.description }}</div>
                    {% endif %}
                  </li>
                {% endfor %}
              </ol>
            </div>
          {% else %}
            <div class="alert alert-light text-dark mb-0">–°–æ–∑–¥–∞—Ç–µ–ª—å –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–∏–ª –∑–∞–¥–∞–Ω–∏—è.</div>
          {% endif %}
        {% endwith %}
        <div class="d-flex flex-wrap gap-3 small">
          <span><i class="bi bi-calendar-event me-1"></i>–°—Ç–∞—Ä—Ç: {{ marathon.start_date }}</span>
          {% if marathon.end_date %}
            <span><i class="bi bi-flag-checkered me-1"></i>–§–∏–Ω–∏—à: {{ marathon.end_date }}</span>
          {% endif %}
          <span><i class="bi bi-people me-1"></i>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: {{ participants|length }}</span>
          <span><i class="bi bi-person-badge me-1"></i>–°–æ–∑–¥–∞—Ç–µ–ª—å: {{ marathon.creator }}</span>
        </div>
        <div class="mt-auto d-flex flex-wrap gap-2">
          {% if participant %}
            {% if participant.is_approved %}
              <a class="btn btn-light" href="#add-book"><i class="bi bi-plus-lg me-2"></i>–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É</a>
            {% else %}
              <span class="badge bg-warning text-dark">–û–∂–∏–¥–∞–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É—á–∞—Å—Ç–∏—è</span>
            {% endif %}
          {% else %}
            <a class="btn btn-outline-light" href="{% url 'reading_marathons:join' marathon.slug %}"><i class="bi bi-door-open me-2"></i>–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</a>
          {% endif %}
          {% if marathon.book_submission_policy == marathon.BookSubmissionPolicy.APPROVAL %}
            <span class="badge bg-light text-dark">–ö–Ω–∏–≥–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</span>
          {% else %}
            <span class="badge bg-light text-dark">–ö–Ω–∏–≥–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è —Å—Ä–∞–∑—É</span>
          {% endif %}
          {% if marathon.completion_policy == marathon.CompletionPolicy.APPROVAL %}
            <span class="badge bg-light text-dark">–°–æ–∑–¥–∞—Ç–µ–ª—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —ç—Ç–∞–ø–æ–≤</span>
          {% else %}
            <span class="badge bg-light text-dark">–≠—Ç–∞–ø –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –æ—Ç–∑—ã–≤–∞</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

{% if participant and participant.is_approved %}
  <section id="add-book" class="mb-5">
    <div class="card">
      <div class="card-header" style="background-color:#62769a; color:#fff;">
        <h2 class="h5 mb-0">–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É –≤ –º–∞—Ä–∞—Ñ–æ–Ω</h2>
      </div>
      <div class="card-body">
        <form action="{% url 'reading_marathons:entry_add' marathon.slug %}" method="post">
          {% csrf_token %}
          {% if entry_form.non_field_errors %}
            <div class="alert alert-danger" role="alert">
              {{ entry_form.non_field_errors|join:" " }}
            </div>
          {% endif %}
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label" for="{{ entry_form.theme.id_for_label }}">–ó–∞–¥–∞–Ω–∏–µ –º–∞—Ä–∞—Ñ–æ–Ω–∞</label>
              {{ entry_form.theme }}
              {% if entry_form.theme.help_text %}
                <div class="form-text">{{ entry_form.theme.help_text }}</div>
              {% endif %}
              {% if entry_form.theme.errors %}
                <div class="invalid-feedback d-block">{{ entry_form.theme.errors|join:", " }}</div>
              {% else %}
                <div class="form-text">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É, –∫–æ—Ç–æ—Ä—É—é —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–π—Ç–∏.</div>
              {% endif %}
            </div>
            <div class="col-md-4">
              <label class="form-label" for="{{ entry_form.book.id_for_label }}">–ö–Ω–∏–≥–∞ –¥–ª—è –∑–∞–¥–∞–Ω–∏—è</label>
              {{ entry_form.book }}
              {% if entry_form.book.help_text %}
                <div class="form-text">{{ entry_form.book.help_text }}</div>
              {% endif %}
              {% if entry_form.book.errors %}
                <div class="invalid-feedback d-block">{{ entry_form.book.errors|join:", " }}</div>
              {% else %}
                <div class="form-text">–í—ã–±–µ—Ä–∏—Ç–µ –∫–Ω–∏–≥—É –∏–∑ —Å–≤–æ–µ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∏–ª–∏ –ø–æ–ª–æ–∫.</div>
              {% endif %}
            </div>
            <div class="col-md-2">
              <label class="form-label" for="{{ entry_form.status.id_for_label }}">–°—Ç–∞—Ç—É—Å —á—Ç–µ–Ω–∏—è</label>
              {{ entry_form.status }}
              {% if entry_form.status.help_text %}
                <div class="form-text">{{ entry_form.status.help_text }}</div>
              {% endif %}
              {% if entry_form.status.errors %}
                <div class="invalid-feedback d-block">{{ entry_form.status.errors|join:", " }}</div>
              {% endif %}
            </div>
            <div class="col-md-2">
              <label class="form-label" for="{{ entry_form.progress.id_for_label }}">–ü—Ä–æ–≥—Ä–µ—Å—Å, %</label>
              {{ entry_form.progress }}
              {% if entry_form.progress.help_text %}
                <div class="form-text">{{ entry_form.progress.help_text }}</div>
              {% endif %}
              {% if entry_form.progress.errors %}
                <div class="invalid-feedback d-block">{{ entry_form.progress.errors|join:", " }}</div>
              {% endif %}
            </div>
            <div class="col-12">
              <label class="form-label" for="{{ entry_form.notes.id_for_label }}">–ó–∞–º–µ—Ç–∫–∏</label>
              {{ entry_form.notes }}
              {% if entry_form.notes.help_text %}
                <div class="form-text">{{ entry_form.notes.help_text }}</div>
              {% endif %}
              {% if entry_form.notes.errors %}
                <div class="invalid-feedback d-block">{{ entry_form.notes.errors|join:", " }}</div>
              {% endif %}
            </div>
          </div>
          <button class="btn btn-primary mt-3" type="submit">–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É</button>
        </form>
      </div>
    </div>
  </section>
{% endif %}

<section>
  <h2 class="h4 mb-3">–ú–∏–Ω–∏-–ø–æ–ª–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h2>
  <div class="row g-4">
    {% for participant_obj, entries in participant_entries %}
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header d-flex justify-content-between align-items-center" style="background-color:#62769a; color:#fff;">
            <div>
              <h3 class="h6 mb-0">{{ participant_obj.user.get_full_name|default:participant_obj.user.username }}</h3>
              {% if not participant_obj.is_approved %}
                <small class="text-warning">–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É—á–∞—Å—Ç–∏—è</small>
              {% endif %}
            </div>
            {% if marathon.creator == request.user and participant_obj.status == participant_obj.Status.PENDING %}
              <a class="btn btn-sm btn-outline-light" href="{% url 'reading_marathons:participant_approve' participant_obj.pk %}">–û–¥–æ–±—Ä–∏—Ç—å</a>
            {% endif %}
          </div>
          <div class="card-body">
              {% if entries %}
                <div class="marathon-entry-list">
                  {% for entry in entries %}
                    <div class="marathon-entry">
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="small text-uppercase text-muted">{{ entry.theme.title }}</div>
                        {% if entry.status == entry_status.COMPLETED and entry.completion_status == completion_status.CONFIRMED %}
                          <span class="badge bg-success"><i class="bi bi-check2 me-1"></i>–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
                        {% elif entry.status == entry_status.COMPLETED %}
                          <span class="badge bg-warning text-dark">–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</span>
                        {% elif entry.status == entry_status.READING %}
                          <span class="badge bg-info text-dark">–ß–∏—Ç–∞—é</span>
                        {% else %}
                          <span class="badge bg-light text-dark">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</span>
                        {% endif %}
                      </div>
                      <div class="d-flex align-items-center justify-content-between mt-2">
                        <div>
                          <div class="fw-semibold">{{ entry.book.title }}</div>
                          <div class="marathon-entry__progress">
                          {% if not entry.book_approved %}
                              –û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∫–Ω–∏–≥–∏.
                            {% elif entry.status == entry_status.COMPLETED %}
                              –ü—Ä–æ—á–∏—Ç–∞–Ω–æ. –û—Ç–∑—ã–≤: {% if entry.has_review %}–µ—Å—Ç—å{% else %}–µ—â—ë –Ω–µ—Ç{% endif %}.
                              {% if marathon.completion_policy == marathon.CompletionPolicy.AUTO and entry.completion_status == completion_status.AWAITING_REVIEW %}
                                –î–æ–±–∞–≤—å—Ç–µ –æ—Ç–∑—ã–≤, —á—Ç–æ–±—ã —ç—Ç–∞–ø –∑–∞—Å—á–∏—Ç–∞–ª—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
                              {% endif %}
                            {% elif entry.status == entry_status.READING %}
                              –ü—Ä–æ–≥—Ä–µ—Å—Å: {{ entry.progress }}%
                            {% else %}
                              –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –∫ —á—Ç–µ–Ω–∏—é
                            {% endif %}
                          </div>
                        </div>
                        {% if participant and participant.pk == participant_obj.pk %}
                          <a class="btn btn-sm btn-outline-primary" href="{% url 'reading_marathons:entry_update' entry.pk %}">–û–±–Ω–æ–≤–∏—Ç—å</a>
                        {% endif %}
                      </div>
                      {% if marathon.creator == request.user %}
                        <div class="mt-3 d-flex flex-wrap gap-2">
                          {% if not entry.book_approved and marathon.book_submission_policy == marathon.BookSubmissionPolicy.APPROVAL %}
                            <a class="btn btn-sm btn-outline-success" href="{% url 'reading_marathons:entry_approve' entry.pk %}">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–Ω–∏–≥—É</a>
                          {% endif %}
                          {% if entry.status == entry_status.COMPLETED and entry.completion_status == completion_status.AWAITING_REVIEW %}
                            <a class="btn btn-sm btn-success" href="{% url 'reading_marathons:entry_confirm' entry.pk %}">–ó–∞—á–µ—Å—Ç—å —ç—Ç–∞–ø</a>
                          {% endif %}
                        </div>
                      {% endif %}
                    </div>
                  {% endfor %}
                </div>
              {% else %}
                <div class="alert alert-light border mb-0">–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∫–Ω–∏–≥.</div>
              {% endif %}
          </div>
        </div>
      </div>
    {% empty %}
      <div class="col-12">
        <div class="alert alert-light border">–ü–æ–∫–∞ –Ω–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.</div>
      </div>
    {% endfor %}
  </div>
</section>
{% endblock %}