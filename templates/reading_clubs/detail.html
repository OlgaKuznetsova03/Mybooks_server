{% extends "base.html" %}
{% load static %}

{% block title %}{{ reading.title }} · Совместные чтения{% endblock %}

{% block extra_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'reading_clubs/style.css' %}">
  <style>
    /* ===== Палитра страницы ===== */
    .reading-detail-theme{
      --page-primary:#9d6f51;                 /* кнопки/активы */
      --page-primary-rgb:157,111,81;
      --header-bg:#e1b797;                    /* фон шапки блока */

      --card-bg:#f3e6dd;                      /* мягкие карточки (темы) */
      --card-bg-hover:#efe0d5;
      --card-border:rgba(157,111,81,.25);
      --card-shadow:0 10px 24px rgba(157,111,81,.10);

      --bs-primary:var(--page-primary);
      --bs-primary-rgb:var(--page-primary-rgb);
    }

    /* ===== Верхний блок (заголовок чтения) ===== */
    .reading-detail-theme .reading-detail-header{
      background:var(--header-bg);
      color:#000;
      border:1px solid rgba(0,0,0,.08);
      border-radius:1rem;
      box-shadow:0 18px 40px rgba(0,0,0,.10);
      padding:1.25rem 1rem 1.5rem;
      margin-bottom:1.5rem;
    }
    .reading-detail-theme .reading-detail-header .text-muted{ color:#000; opacity:.8; }

    /* ===== Кнопки ===== */
    .reading-detail-theme .btn-reading,
    .reading-detail-theme .btn-primary{
      --bs-btn-bg:var(--page-primary);
      --bs-btn-border-color:var(--page-primary);
      --bs-btn-hover-bg:#b48264;
      --bs-btn-hover-border-color:#b48264;
      --bs-btn-active-bg:var(--page-primary);
      --bs-btn-active-border-color:var(--page-primary);
      color:#fff !important;
      background-color:var(--bs-btn-bg);
      border-color:var(--bs-btn-border-color);
    }
    .reading-detail-theme .btn-outline-secondary{
      --bs-btn-color:#2b1d17;
      --bs-btn-border-color:rgba(0,0,0,.25);
    }

    /* ===== Обложка: уменьшить и сделать аккуратно ===== */
    .reading-detail-theme .reading-detail-book__cover{
      width:110px;                            /* было больше — теперь компактнее */
      flex:0 0 110px;
      border-radius:.75rem;
      overflow:hidden;
      box-shadow:0 6px 18px rgba(0,0,0,.12);
      border:1px solid rgba(0,0,0,.06);
    }
    .reading-detail-theme .reading-detail-book__cover-image{
      display:block; width:100%; height:100%; object-fit:cover;
    }
    @media (max-width:575.98px){
      .reading-detail-theme .reading-detail-book__cover{ width:88px; flex-basis:88px; }
    }

    /* ===== Карточки «Нормы и обсуждения» ===== */
    .reading-detail-theme .topic-card{
      background:var(--card-bg);
      border:1px solid var(--card-border);
      border-radius:1rem;
      padding:1rem;
      box-shadow:var(--card-shadow);
      transition:transform .15s, box-shadow .15s, background-color .15s;
    }
    .reading-detail-theme .topic-card:hover{
      transform:translateY(-2px);
      box-shadow:0 14px 36px rgba(157,111,81,.16);
      background:var(--card-bg-hover);
    }
    .reading-detail-theme .topic-card--locked{
      opacity:.85;
      background:linear-gradient(0deg, rgba(0,0,0,.02), rgba(0,0,0,.02)), var(--card-bg);
    }

    .reading-detail-theme .reading-section-title{ color:#2b1d17; }

    /* ===== Боковая панель участников ===== */
    .reading-detail-theme .reading-participants{
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      border-radius:1rem;
      padding:1rem;
      box-shadow:0 8px 20px rgba(0,0,0,.06);
    }
    .reading-detail-theme .participant-badge{
      display:flex; align-items:flex-start; gap:.5rem;
      padding:.6rem .75rem;
      border:1px solid rgba(157,111,81,.25);
      border-radius:.9rem;
      background:rgba(157,111,81,.08);
      color:#5a3c2b;
    }
    .reading-detail-theme .participant-badge__info{
      flex:1 1 auto;
    }
    .reading-detail-theme .participant-badge__name{
      font-weight:600;
      display:block;
    }
    .reading-detail-theme .participant-progress{
      margin-top:.35rem;
      display:flex;
      align-items:center;
      gap:.5rem;
    }
    .reading-detail-theme .participant-progress .progress{
      flex:1 1 auto;
      height:6px;
      border-radius:999px;
      background:rgba(0,0,0,.08);
    }
    .reading-detail-theme .participant-progress .progress-bar{
      background:var(--page-primary);
      border-radius:999px;
    }
    .reading-detail-theme .participant-progress__label{
      font-size:.85rem;
      font-weight:600;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="reading-detail-theme">
    <div class="reading-detail-header">
      <div class="d-flex flex-column flex-md-row justify-content-between gap-3">
        <div class="reading-detail-book d-flex flex-column flex-sm-row align-items-start gap-3">
          {% with cover=reading.book.get_cover_url %}
            {% if cover %}
              <div class="reading-detail-book__cover">
                <img src="{{ cover }}" alt="Обложка {{ reading.book.title }}" class="reading-detail-book__cover-image">
              </div>
            {% endif %}
          {% endwith %}
          <div class="reading-detail-book__info">
            <h1 class="h2 mb-2">{{ reading.title }}</h1>
            <div class="reading-detail-header__meta">
              <div class="mb-1"><i class="bi bi-book me-1"></i> {{ reading.book.title }}</div>
              <div class="mb-1">Старт: {{ reading.start_date|date:"d E Y" }}{% if reading.end_date %} · Завершение: {{ reading.end_date|date:"d E Y" }}{% endif %}</div>
              <div class="mb-1">Создатель: {{ reading.creator.get_full_name|default:reading.creator.username }}</div>
              <div class="mb-1">Присоединение: {{ reading.get_join_policy_display }}</div>
              <div class="text-muted">Сообщений: {{ reading.message_count }} · Участников: {{ approved_participants|length }}</div>
            </div>
          </div>
        </div>
        <div class="d-flex flex-column align-items-start gap-2">
          {% if user.is_authenticated %}
            {% if user == reading.creator %}
              <a class="btn btn-outline-secondary" href="{% url 'reading_clubs:topic_add' reading.slug %}">
                <i class="bi bi-list-check me-1"></i> Добавить норму
              </a>
            {% elif is_participant %}
              <span class="badge text-bg-success">Вы участвуете</span>
            {% else %}
              <form action="{% url 'reading_clubs:join' reading.slug %}" method="post">
                {% csrf_token %}
                <button class="btn btn-reading" type="submit"><i class="bi bi-person-plus me-1"></i> Присоединиться</button>
              </form>
            {% endif %}
          {% else %}
            <a class="btn btn-reading" href="{% url 'login' %}?next={{ request.path }}">Войти, чтобы присоединиться</a>
          {% endif %}
        </div>
      </div>
      {% if reading.description %}
        <p class="mt-3 mb-0 text-muted">{{ reading.description|linebreaksbr }}</p>
      {% endif %}
    </div>

    <div class="row g-4">
      <div class="col-lg-8">
        <h2 class="reading-section-title">Нормы и обсуждения</h2>
        {% if topics %}
          <div class="vstack gap-3">
            {% for topic in topics %}
              <article class="topic-card{% if not topic.is_open %} topic-card--locked{% endif %}">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <h3 class="h5 topic-card__title mb-1">
                      {% if topic.is_open %}
                        <a href="{% url 'reading_clubs:topic_detail' reading.slug topic.pk %}">{{ topic.title }}</a>
                      {% else %}
                        {{ topic.title }}
                      {% endif %}
                    </h3>
                    <div class="topic-card__meta mb-2">
                      Открытие обсуждения: {{ topic.discussion_opens_at|date:"d E Y" }}
                      {% if not topic.is_open %}
                        <span class="badge text-bg-secondary ms-2">Откроется позже</span>
                      {% endif %}
                    </div>
                    {% if topic.description %}
                      <p class="text-muted small mb-0">{{ topic.description|linebreaksbr }}</p>
                    {% endif %}
                  </div>
                  <div class="text-end text-muted small">
                    <div><i class="bi bi-chat-left-text me-1"></i> {{ topic.post_count }} сообщений</div>
                  </div>
                </div>
                {% if user == reading.creator %}
                  <div class="topic-card__actions mt-3 d-flex justify-content-end">
                    <a class="btn btn-sm btn-outline-secondary" href="{% url 'reading_clubs:topic_edit' reading.slug topic.pk %}">
                      <i class="bi bi-pencil"></i>
                      <span class="ms-1">Редактировать</span>
                    </a>
                  </div>
                {% endif %}
              </article>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted">Создатель ещё не добавил нормы. Загляните позже!</p>
        {% endif %}
      </div>
      <div class="col-lg-4">
        <aside class="reading-participants">
          <h2 class="h5 reading-section-title mb-3">Участники</h2>
          {% if approved_participants %}
            <div class="vstack gap-2 mb-3">
              {% for participant in approved_participants %}
                <div class="participant-badge">
                  <i class="bi bi-person-circle"></i>
                  <div class="participant-badge__info">
                    <span class="participant-badge__name">{{ participant.user.get_full_name|default:participant.user.username }}</span>
                    {% if participant.reading_progress_percent is not None %}
                      <div class="participant-progress" aria-label="Прогресс чтения участника">
                        <div class="progress" role="progressbar" aria-valuenow="{{ participant.reading_progress_percent }}" aria-valuemin="0" aria-valuemax="100">
                          <div class="progress-bar" style="width: {{ participant.reading_progress_percent }}%"></div>
                        </div>
                        <span class="participant-progress__label">{{ participant.reading_progress_percent }}%</span>
                      </div>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-muted">Пока нет участников. Присоединяйтесь первым!</p>
          {% endif %}

          {% if pending_participants and user == reading.creator %}
            <hr>
            <h3 class="h6 reading-section-title">Заявки</h3>
            <div class="vstack gap-2">
              {% for participant in pending_participants %}
                <div class="d-flex justify-content-between align-items-center">
                  <span>{{ participant.user.get_full_name|default:participant.user.username }}</span>
                  <form action="{% url 'reading_clubs:approve_participant' reading.slug participant.pk %}" method="post">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-reading" type="submit">Одобрить</button>
                  </form>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        </aside>
      </div>
    </div>
  </div>
{% endblock %}
