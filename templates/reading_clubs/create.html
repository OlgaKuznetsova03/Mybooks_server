{% extends "base.html" %}
{% load static %}

{% block title %}Создать совместное чтение{% endblock %}

{% block extra_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'reading_clubs/style.css?v=1762270644' %}">
  <style>
    .reading-auth{
      background:linear-gradient(180deg, rgba(231,221,213,.5), rgba(231,221,213,0));
      padding-top:1rem;
      padding-bottom:2rem;
    }
    .reading-auth .auth-wrap{
      max-width:920px;
      margin:0 auto;
    }
    .reading-auth .auth-card{
      max-width:560px;
      margin:1.5rem auto 2.5rem;
      border:1px solid rgba(0,0,0,.06);
      border-radius:18px;
      box-shadow:0 22px 48px rgba(0,0,0,.08);
      background:#fff;
      overflow:hidden;
    }
    .reading-auth .auth-card__header{
      padding:1.5rem 1.5rem 1rem;
      border-bottom:1px solid rgba(0,0,0,.06);
      background:linear-gradient(135deg, rgba(157,111,81,.12), rgba(157,111,81,.04));
    }
    .reading-auth .auth-card__body{ padding:1.5rem; }
    .reading-auth .form-label{ font-weight:600; margin-bottom:.35rem; }
    .reading-auth .invalid-feedback.d-block{ margin-top:.35rem; }
    .reading-auth .btn-pill{ border-radius:999px; padding-left:1.2rem; padding-right:1.2rem; }
  </style>
{% endblock %}

{% block content %}
  <div class="reading-auth">
    <div class="auth-wrap">
      <div class="auth-card">
        <div class="auth-card__header">
          <h1 class="h4 mb-1">Создать совместное чтение</h1>
          <p class="text-muted mb-0">Выберите книгу, задайте даты и пригласите читателей разделить впечатления.</p>
        </div>
        <div class="auth-card__body">
          <form method="post" novalidate class="needs-validation">
            {% csrf_token %}

            {% if form.non_field_errors %}
              <div class="alert alert-danger" role="alert">
                {% for err in form.non_field_errors %}
                  {{ err }}{% if not forloop.last %}<br>{% endif %}
                {% endfor %}
              </div>
            {% endif %}

            {% for field in form %}
              <div class="mb-3">
                <label class="form-label" for="id_{{ field.name }}">{{ field.label }}</label>

                {% if field.name == "book" %}
                  <div class="mb-2">
                    <input
                      type="search"
                      class="form-control form-control-sm"
                      placeholder="Начните вводить название книги"
                      aria-label="Поиск книги по названию"
                      data-reading-book-search
                    >
                  </div>
                {% endif %}

                {{ field }} {# классы и is-invalid проставляются в форме #}

                {% if field.help_text %}
                  <div class="form-text">{{ field.help_text }}</div>
                {% endif %}
                {% for error in field.errors %}
                  <div class="invalid-feedback d-block">{{ error }}</div>
                {% endfor %}
              </div>
            {% endfor %}

            <button class="btn btn-reading btn-pill" type="submit">Создать совместное чтение</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      'use strict';
      var forms = document.querySelectorAll('.needs-validation');
      Array.prototype.slice.call(forms).forEach(function (form) {
        form.addEventListener('submit', function (event) {
          if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
          }
          form.classList.add('was-validated');
        }, false);
      });
    })();

    document.addEventListener('DOMContentLoaded', function () {
      var searchInput = document.querySelector('[data-reading-book-search]');
      var select = document.getElementById('id_book');

      if (!searchInput || !select) {
        return;
      }

      var originalOptions = Array.prototype.slice.call(select.options).map(function (option) {
        return {
          value: option.value,
          text: option.text.toLowerCase(),
          html: option.innerHTML,
          disabled: option.disabled
        };
      });

      function renderOptions(query) {
        var normalizedQuery = (query || '').trim().toLowerCase();
        var currentValue = select.value;
        var selectionPreserved = false;

        select.innerHTML = '';

        originalOptions.forEach(function (optionData) {
          var matchesQuery = !normalizedQuery || optionData.value === '' || optionData.text.indexOf(normalizedQuery) !== -1;

          if (!matchesQuery) {
            return;
          }

          var option = document.createElement('option');
          option.value = optionData.value;
          option.innerHTML = optionData.html;

          if (optionData.disabled) {
            option.disabled = true;
          }

          if (optionData.value === currentValue) {
            option.selected = true;
            selectionPreserved = true;
          }

          select.appendChild(option);
        });

        if (!selectionPreserved) {
          var firstAvailable = null;
          for (var i = 0; i < select.options.length; i += 1) {
            var option = select.options[i];
            if (option.value && !option.disabled) {
              firstAvailable = option;
              break;
            }
          }

          if (firstAvailable) {
            firstAvailable.selected = true;
          } else if (select.options.length) {
            select.selectedIndex = 0;
          }
        }
      }

      renderOptions(searchInput.value);

      searchInput.addEventListener('input', function (event) {
        renderOptions(event.target.value);
      });

      searchInput.addEventListener('keydown', function (event) {
        if (event.key === 'Enter') {
          event.preventDefault();
        }
      });
    });
  </script>
  {% if not user.profile.has_active_premium %}
<!-- Yandex.RTB R-A-17641153-1 -->
<script>
window.yaContextCb.push(() => {
    Ya.Context.AdvManager.render({
        "blockId": "R-A-17641153-1",
        "type": "floorAd",
        "platform": "desktop"
    })
})
</script>
<!-- Yandex.RTB R-A-17641153-4 -->
<script>
window.yaContextCb.push(() => {
    Ya.Context.AdvManager.render({
        "blockId": "R-A-17641153-4",
        "type": "floorAd",
        "platform": "touch"
    })
})
</script>
{% endif %}
{% endblock %}