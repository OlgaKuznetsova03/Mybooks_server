{% extends "base.html" %}
{% block title %}Полка «Хочу прочитать»{% endblock %}
{% block content %}
<div class="container py-4">
  <!-- Заголовок -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3">{{ shelf.name }}</h1>
    <a class="btn btn-outline-secondary" href="{% url 'my_profile' %}">← Назад</a>
  </div>

  <!-- Интерактивная сортировка -->
  <div class="mb-3">
    <label class="form-label fw-semibold">Сортировка</label>
    <select name="sort" class="form-select" onchange="this.form.submit()">
      <option value="added_desc" {% if sort == 'added_desc' %}selected{% endif %}>Сначала новые</option>
      <option value="added_asc" {% if sort == 'added_asc' %}selected{% endif %}>Сначала старые</option>
    </select>
  </div>

  <!-- Контейнер с книгами -->
  <div class="row g-3" id="shelf-books">
    {% for it in page_obj.object_list %}
      <div class="col-6 col-md-4 col-lg-3 col-xl-2" data-book-id="{{ it.book.pk }}">
        <div class="card h-100 shelf-book">
          <img src="{{ it.book.get_cover_url }}" class="card-img-top" alt="{{ it.book.title }}" style="height:240px;object-fit:cover;">
          <div class="card-body d-flex flex-column p-2">
            <div class="small fw-semibold mb-2">{{ it.book.title|truncatechars:50 }}</div>
            <div class="mt-auto">
              <form method="post" action="{% url 'shelves:move_book_to_reading' it.book.pk %}">
                {% csrf_token %}
                <button class="btn btn-sm btn-outline-primary w-100" type="submit">Начать читать</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    {% empty %}
      <p class="text-muted">Полка пока пустая.</p>
    {% endfor %}
  </div>

  {% include 'shelves/shelf_pagination.html' %}
</div>

<script>
// Добавляем drag & drop для переупорядочивания
document.addEventListener('DOMContentLoaded', function() {
  const shelf = document.getElementById('shelf-books');
  if (!shelf) return;
  
  let draggedItem = null;
  
  shelf.addEventListener('dragstart', function(e) {
    const card = e.target.closest('.col-6');
    if (card) {
      draggedItem = card;
      card.classList.add('dragging');
    }
  });
  
  shelf.addEventListener('dragend', function(e) {
    const card = e.target.closest('.col-6');
    if (card) {
      card.classList.remove('dragging');
    }
  });
  
  shelf.addEventListener('dragover', function(e) {
    e.preventDefault();
    const afterElement = getDragAfterElement(shelf, e.clientY);
    const dragging = document.querySelector('.dragging');
    if (afterElement == null) {
      shelf.appendChild(dragging);
    } else {
      shelf.insertBefore(dragging, afterElement);
    }
  });
  
  function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.col-6:not(.dragging)')];
    
    return draggableElements.reduce((closest, child) => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;
      if (offset < 0 && offset > closest.offset) {
        return { offset: offset, element: child };
      } else {
        return closest;
      }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
  }
});
</script>

<style>
.shelf-book {
  cursor: grab;
  transition: transform 0.2s;
}
.shelf-book:active {
  cursor: grabbing;
}
.dragging {
  opacity: 0.5;
  transform: scale(0.95);
}
</style>
{% endblock %}