{% extends "base.html" %}
{% load shelf_extras %}
{% block title %}–ú–æ—è –¥–æ–º–∞—à–Ω—è—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞{% endblock %}

{% block extra_css %}
<style>
  :root{
    --home-hero-gradient: linear-gradient(130deg,#7f9aaf 0%,#5d7283 42%,#38444e 100%);
    --home-card-bg: rgba(57,69,79,.96);
    --home-card-border: rgba(152,175,192,.45);
    --home-card-shadow: 0 22px 48px rgba(33,42,49,.55);
    --home-text-soft: rgba(244,249,255,.85);
    --home-accent:#c2e0ef;
    --home-accent-strong:#f6c8a2;
    --home-surface: rgba(49,60,69,.95);
    --home-surface-alt: rgba(70,85,97,.82);
    --home-divider: rgba(158,182,201,.35);
  }

  /* –ê–Ω–∏–º–∞—Ü–∏–∏ –ø–æ—è–≤–ª–µ–Ω–∏—è */
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  @keyframes pulseGlow {
    0%, 100% { box-shadow: 0 0 20px rgba(194, 224, 239, 0.3); }
    50% { box-shadow: 0 0 30px rgba(194, 224, 239, 0.6); }
  }

  .animate-fade-in {
    animation: fadeInUp 0.6s ease-out forwards;
  }

  .home-hero{
    position:relative;border-radius:24px;overflow:hidden;
    background:var(--home-hero-gradient);color:#f5f7ff;
    padding:2.5rem 2rem;box-shadow:0 25px 55px rgba(24,32,39,.45);
    opacity: 0;
    animation: fadeInUp 0.8s ease-out 0.2s forwards;
  }
  .home-hero::before,.home-hero::after{
    content:"";position:absolute;border-radius:100%;filter:blur(65px);opacity:.8;z-index:0;
  }
  .home-hero::before{width:360px;height:360px;top:-120px;right:-140px;background:rgba(216,232,242,.45);}
  .home-hero::after{width:280px;height:280px;bottom:-140px;left:-110px;background:rgba(247,209,176,.4);}
  .home-hero__content,.home-hero__actions{position:relative;z-index:1;}
  .home-hero__title{font-family:"Montserrat","Segoe UI",system-ui,sans-serif;font-weight:700;letter-spacing:.02em;}
  .home-hero__subtitle{max-width:520px;color:var(--home-text-soft);}
  .home-hero__actions{display:flex;flex-wrap:wrap;gap:.75rem;}
  .home-hero__btn{
    border-radius:999px;font-weight:600;box-shadow:0 12px 28px rgba(8,10,44,.45);border:none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative; overflow: hidden;
  }
  .home-hero__btn::before {
    content: ''; position: absolute; top: 0; left: -100%;
    width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
  }
  .home-hero__btn:hover::before { left: 100%; }
  .home-hero__btn:hover,.home-hero__btn:focus{
    transform:translateY(-3px) scale(1.02);
    box-shadow:0 18px 32px rgba(8,10,44,.55);
  }
  .home-hero__btn.btn-outline-light{border:1px solid rgba(255,255,255,.55);background:rgba(46,58,68,.55);color:#fff;}
  .home-hero__btn.btn-light{color:#1c242b;}
  .home-hero__btn.btn-outline-light:hover,.home-hero__btn.btn-outline-light:focus{background:rgba(255,255,255,.15);}
  .home-hero__btn.btn-light:hover,.home-hero__btn.btn-light:focus{background:linear-gradient(130deg,#d3e6f1 0%,#f1f6fa 100%);color:#11171c;}

  /* –ö–∞—Ä—Ç–æ—á–∫–∞ —Å –¥–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω–æ–π —Ä–∞–º–∫–æ–π */
  .home-glow-card{
    background:var(--home-card-bg);
    border:1px solid var(--home-card-border);
    border-radius:20px;
    box-shadow:var(--home-card-shadow);
    color:#f8faff;
    padding:1.5rem;
    position:relative;
    overflow:hidden;
    z-index:0;
    opacity: 0;
    animation: fadeInUp 0.6s ease-out forwards;
  }
  .home-glow-card:nth-child(1) { animation-delay: 0.3s; }
  .home-glow-card:nth-child(2) { animation-delay: 0.4s; }
  .home-glow-card:nth-child(3) { animation-delay: 0.5s; }
  .home-glow-card:nth-child(4) { animation-delay: 0.6s; }
  
  .home-glow-card::after{
    content:"";position:absolute;inset:0;border-radius:inherit;padding:1px;
    background:linear-gradient(135deg,rgba(194,224,239,.35),rgba(246,200,162,.18));
    -webkit-mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);
    -webkit-mask-composite:xor;mask-composite:exclude;
    pointer-events:none;z-index:0;
  }
  .home-glow-card>*{position:relative;z-index:1;}

  .home-stats-button{
    padding:0;border:none;background:none;color:inherit;font:inherit;font-weight:600;cursor:pointer;
    transition: all 0.3s ease; display:inline-flex;align-items:baseline;gap:.35rem;
    position: relative;
  }
  .home-stats-button:hover,.home-stats-button:focus{
    color:var(--home-accent-strong);
    transform: scale(1.05);
  }
  .home-stats-button:focus-visible{outline:2px solid rgba(255,255,255,.45);outline-offset:2px;}
  .home-stats-button--block{display:flex;width:100%;justify-content:flex-start;}
  .home-stats-button--inline{display:inline;font-weight:inherit;}
  .home-stats-button--inline:hover,.home-stats-button--inline:focus{text-decoration:underline;}
  .home-stats-button--compact{font-size:.95rem;font-weight:700;}

  .home-glow-card .badge[data-summary-trigger]{
    cursor:pointer;transition:all 0.3s ease;
  }
  .home-glow-card .badge[data-summary-trigger]:hover,.home-glow-card .badge[data-summary-trigger]:focus{
    background:rgba(194,224,239,.35)!important;
    color:var(--home-accent-strong);
    transform: scale(1.1);
  }

  .home-progress-card{--home-progress-bought:#38bdf8;--home-progress-read:#f97316;}

  .home-progress-controls{display:flex;flex-wrap:wrap;gap:.75rem;}
  .home-progress-controls .form-select,.home-progress-controls .form-label{font-size:.85rem;}

  .home-progress-stats{display:flex;align-items:center;gap:1.25rem;min-width:0;}
  .home-progress-side{min-width:120px;}
  .home-progress-value{font-size:2.25rem;line-height:1;display:inline-flex;align-items:center;gap:.25rem;}
  .home-progress-value .home-progress-number{font-variant-numeric:tabular-nums;}

  /* –õ–∏–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ */
  .home-progress-line{
    --bar-h: 10px;
    position:relative;flex:1 1 auto;min-width:160px;height:var(--bar-h);border-radius:999px;
    background:rgba(255,255,255,.16);overflow:hidden;z-index:1;
  }
  .home-progress-fill-left,
  .home-progress-fill-right{
    position:absolute;top:0;bottom:0;width:0%;
  }
  .home-progress-fill-left{
    left:0;border-top-left-radius:999px;border-bottom-left-radius:999px;
    background:var(--home-progress-bought);
    transition:width 900ms ease;
  }
  .home-progress-fill-right{
    right:0;border-top-right-radius:999px;border-bottom-right-radius:999px;
    background:var(--home-progress-read);
    transition:width 900ms ease;
  }

  /* –°–≤–µ—á–µ–Ω–∏–µ */
  .home-progress-fill-left::after,
  .home-progress-fill-right::after{
    content:"";position:absolute;left:-6px;right:-6px;top:-6px;bottom:-6px;
    background:inherit;opacity:.55;filter:blur(8px);
    pointer-events:none;z-index:-1;
    animation:glow-pulse 3.2s ease-in-out infinite;
  }
  @keyframes glow-pulse{
    0%,100%{opacity:.45;filter:blur(7px)}
    50%    {opacity:.75;filter:blur(10px)}
  }

  .home-progress-line::before{
    content:"";position:absolute;inset:0;
    background:linear-gradient(120deg, transparent 0%, rgba(255,255,255,.14) 30%, transparent 60%) 0 0 / 160% 100% no-repeat;
    opacity:0;pointer-events:none;z-index:2;
  }
  .home-progress-line.is-animating::before{
    opacity:1;animation:home-shimmer 1.2s ease-in-out;
  }
  @keyframes home-shimmer{
    0%{background-position:-60% 0;opacity:0}
    25%{opacity:.6}
    100%{background-position:100% 0;opacity:0}
  }

  .home-progress-label{
    position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
    font-size:.75rem;font-weight:600;letter-spacing:.05em;text-transform:uppercase;
    color:#0f172a;text-shadow:0 1px 2px rgba(255,255,255,.8);z-index:3;
    will-change: transform;
  }
  .home-progress-label.pop{
    animation:label-pop .38s cubic-bezier(.2,1.4,.2,1) 1;
  }
  @keyframes label-pop{
    0%{transform:translate(-50%,-50%) scale(1)}
    60%{transform:translate(-50%,-52%) scale(1.18)}
    100%{transform:translate(-50%,-50%) scale(1)}
  }

  .home-progress-lightning{
    --size: calc(var(--bar-h) * 2.2);
    position:absolute;top:50%;
    width:var(--size);height:var(--size);
    transform:translate(-50%,-50%) scale(.6);
    background:radial-gradient(circle at center,#ffffffd0,#ffffff40 60%,transparent 80%);
    clip-path:polygon(45% 0,60% 40%,88% 40%,56% 100%,45% 62%,18% 62%);
    filter:drop-shadow(0 0 6px #fff) drop-shadow(0 0 12px #ffcc70);
    opacity:0;pointer-events:none;z-index:4;
  }
  .home-progress-lightning.reflash{
    animation:
      lightning-flash .9s ease-out forwards,
      lightning-jitter .18s ease-in-out 2;
  }
  @keyframes lightning-flash{
    0%  {opacity:0;transform:translate(-50%,-50%) scale(.5)}
    25% {opacity:1;transform:translate(-50%,-50%) scale(1.12)}
    60% {opacity:.95;transform:translate(-50%,-50%) scale(.95)}
    100%{opacity:1;transform:translate(-50%,-50%) scale(.9)}
  }
  @keyframes lightning-jitter{
    0%,100%{ transform:translate(-50%,-50%) scale(1); }
    50%    { transform:translate(calc(-50% + .6px), calc(-50% - .6px)) scale(1.02); }
  }
  .home-progress-lightning.is-static{
    opacity:1;transform:translate(-50%,-50%) scale(.9);
    animation: bolt-breathe 3s ease-in-out infinite;
  }
  @keyframes bolt-breathe{
    0%,100%{ filter:drop-shadow(0 0 6px #fff) drop-shadow(0 0 12px #ffcc70); }
    50%    { filter:drop-shadow(0 0 10px #fff) drop-shadow(0 0 18px #ffd892); }
  }

  .home-progress-spark{
    position:absolute; top:50%;
    width:6px;height:6px;border-radius:50%;
    background: radial-gradient(circle, #fff, #ffd27a 60%, transparent 70%);
    box-shadow: 0 0 6px #ffe6b0, 0 0 10px #ffd27a;
    transform: translate(-50%,-50%) scale(.6);
    opacity:0;pointer-events:none;z-index:4;
    animation: spark-fly .7s ease-out forwards;
  }
  @keyframes spark-fly{
    0%   { opacity:.95; transform:translate(-50%,-50%) scale(.6); }
    100% { opacity:0;   transform:translate(var(--dx,6px), calc(-50% + var(--dy,-8px))) scale(.2); }
  }

  .home-glow-card h2,.home-glow-card h3{color:#fff;text-transform:none;letter-spacing:.05em;font-weight:700;}
  .home-glow-card .text-muted,.home-glow-card .small,.home-glow-card .badge.text-bg-light{color:var(--home-text-soft)!important;}
  .home-glow-card ul li span:first-child{color:var(--home-text-soft);}
  .home-glow-card .badge{border-radius:12px;background:rgba(194,224,239,.22)!important;color:var(--home-accent);border:1px solid rgba(194,224,239,.5);}

  /* –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
  .stats-compact {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .stat-item {
    background: rgba(255,255,255,0.05);
    border-radius: 16px;
    padding: 1rem;
    text-align: center;
    transition: all 0.3s ease;
    border: 1px solid rgba(255,255,255,0.1);
    cursor: pointer;
  }

  .stat-item:hover {
    transform: translateY(-3px);
    background: rgba(255,255,255,0.08);
    border-color: var(--home-accent);
  }

  .stat-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--home-accent);
    line-height: 1;
    margin-bottom: 0.25rem;
  }

  .stat-label {
    font-size: 0.75rem;
    color: var(--home-text-soft);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .stat-details {
    font-size: 0.7rem;
    color: rgba(255,255,255,0.6);
    margin-top: 0.25rem;
  }

  /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
  .action-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .action-btn {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 1.25rem;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 16px;
    color: var(--home-text-soft);
    text-decoration: none;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .action-btn:hover {
    background: rgba(255,255,255,0.08);
    border-color: var(--home-accent);
    transform: translateY(-2px);
    color: var(--home-accent);
    text-decoration: none;
  }

  .action-icon {
    font-size: 1.25rem;
    color: var(--home-accent);
  }

  .action-text {
    flex: 1;
  }

  .action-title {
    font-weight: 600;
    font-size: 0.9rem;
  }

  .action-desc {
    font-size: 0.75rem;
    opacity: 0.8;
    margin-top: 0.1rem;
  }

  /* –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã */
  .search-box {
    margin-bottom: 1.5rem;
  }

  .search-box .input-group {
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  .filter-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
  }

  .filter-chip {
    padding: 0.5rem 1rem;
    background: var(--home-surface);
    border: 1px solid var(--home-divider);
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.875rem;
    color: var(--home-text-soft);
  }

  .filter-chip:hover {
    background: var(--home-surface-alt);
    transform: translateY(-2px);
  }

  .filter-chip.active {
    background: var(--home-accent);
    color: #1c242b;
    border-color: var(--home-accent);
    animation: pulseGlow 2s infinite;
  }

  /* –¢–∞–±–ª–∏—Ü–∞ - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ü–≤–µ—Ç–∞ –¥–ª—è –±–µ–ª–æ–≥–æ —Ñ–æ–Ω–∞ */
  .home-library-table{background:#fff;border-radius:24px;border:1px solid #dbe3f0;box-shadow:0 18px 40px rgba(15,23,42,.12);overflow:hidden;color:#1e293b !important;}
  .home-library-table .table{color:#1e293b !important;margin-bottom:0;border-color:#e2e8f0;}
  .home-library-table .table thead{background:#f8fafc;}
  .home-library-table .table thead th{border-color:#e2e8f0;font-weight:600;letter-spacing:.08em;text-transform:uppercase;font-size:.7rem;color:#0f172a !important;cursor:pointer;transition:background 0.3s ease;}
  .home-library-table .table thead th:hover{background:#e2e8f0;}
  .home-library-table .table tbody td{border-color:#e2e8f0;vertical-align:top;background:#fff;color:#1e293b !important;transition:all 0.3s ease;}
  .home-library-table .table tbody tr:hover td{background:#f1f5f9;transform:translateY(-2px);}
  .home-table-actions .btn{border-radius:12px;transition:all 0.3s ease;}
  .home-table-actions .btn-outline-secondary{color:#475569 !important;border-color:rgba(194,224,239,.55);background:rgba(82,106,122,.65);}
  .home-table-actions .btn-outline-secondary:hover,.home-table-actions .btn-outline-secondary:focus{background:rgba(194,224,239,.2);color:#1c242b;border-color:rgba(194,224,239,.85);transform:scale(1.05);}
  .home-table-actions .btn-outline-danger{color:#dc2626 !important;border-color:rgba(248,113,113,.55);background:rgba(244,63,94,.12);}
  .home-table-actions .btn-outline-danger:hover,.home-table-actions .btn-outline-danger:focus{background:rgba(244,63,94,.25);color:#dc2626;border-color:rgba(244,63,94,.65);transform:scale(1.05);}
  .tag-chip{display:inline-flex;align-items:center;padding:.25rem .6rem;border-radius:999px;background:rgba(194,224,239,.18);color:#0d2744 !important;font-size:.75rem;margin-right:.35rem;margin-bottom:.35rem;border:1px solid rgba(255,255,255,.28);transition:all 0.3s ease;}
  .tag-chip:hover{transform:scale(1.05);background:rgba(194,224,239,.3);}

  /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
  .library-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--home-card-bg);
    border: 1px solid var(--home-card-border);
    border-radius: 12px;
    padding: 1rem;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    z-index: 1060;
    transform: translateX(400px);
    opacity: 0;
    transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    max-width: 300px;
  }
  
  .library-notification.show {
    transform: translateX(0);
    opacity: 1;
  }
  
  .notification-content {
    display: flex;
    align-items: center;
    color: var(--home-text-soft);
  }
  
  .notification-close {
    background: none;
    border: none;
    color: var(--home-text-soft);
    font-size: 1.2rem;
    cursor: pointer;
    margin-left: 1rem;
  }

  /* –°—Ç–∏–ª–∏ –º–æ–¥–∞–ª–æ–∫ */
  .home-library-modal .modal-content,
  .home-summary-modal .modal-content {
    background: radial-gradient(circle at top right, rgba(194, 224, 239, 0.18), transparent 55%),
                linear-gradient(160deg, rgba(248, 250, 252, 0.96), rgba(226, 232, 240, 0.92));
    color: #0f172a;
    border-radius: 24px;
    border: none;
    box-shadow: 0 24px 65px rgba(15, 23, 42, 0.28);
    overflow: hidden;
  }

  .home-library-modal .modal-header,
  .home-summary-modal .modal-header {
    border: none;
    background: linear-gradient(135deg, rgba(127, 154, 175, 0.95), rgba(93, 114, 131, 0.95));
    color: #fff;
    padding: 1.5rem 1.75rem;
  }

  .home-library-modal .modal-header {
    border-bottom: 1px solid rgba(194, 224, 239, 0.35);
  }

  .home-summary-modal .modal-header {
    border-bottom: 1px solid rgba(194, 224, 239, 0.28);
  }

  .home-library-modal .modal-title,
  .home-summary-modal .modal-title {
    color: inherit;
    font-weight: 700;
    letter-spacing: 0.01em;
  }

  .home-library-modal .modal-body,
  .home-summary-modal .modal-body {
    padding: 2rem 1.75rem 2.25rem;
    background: transparent;
    color: #1e293b;
  }

  .home-library-modal .badge {
    background: rgba(194, 224, 239, 0.22);
    color: #1d4ed8;
    border-radius: 999px;
    font-weight: 600;
  }

  .home-library-modal .btn-close,
  .home-summary-modal .btn-close {
    filter: brightness(0) invert(1);
    opacity: 0.8;
  }

  .home-library-modal .btn-close:hover,
  .home-summary-modal .btn-close:hover {
    opacity: 1;
  }

  /* –°–ø–∏—Å–∫–∏ –≤ –º–æ–¥–∞–ª–∫–∞—Ö */
  .book-list-item {
    display: flex;
    justify-content: between;
    align-items: flex-start;
    padding: 1rem 1.25rem;
    margin-bottom: 0.75rem;
    border-radius: 18px;
    background: rgba(148, 163, 184, 0.12);
    border: 1px solid rgba(148, 163, 184, 0.2);
    transition: transform 0.3s ease, background 0.3s ease, box-shadow 0.3s ease;
  }

  .book-list-item:hover {
    background: rgba(148, 163, 184, 0.2);
    transform: translateY(-3px);
    box-shadow: 0 12px 30px rgba(15, 23, 42, 0.15);
  }

  .book-list-item:last-child {
    margin-bottom: 0;
  }

  .book-info {
    flex: 1;
  }

  .book-title {
    font-weight: 600;
    color: #0f172a;
    margin-bottom: 0.25rem;
  }

  .book-authors {
    font-size: 0.8rem;
    color: #475569;
  }

  .book-meta {
    font-size: 0.75rem;
    color: #64748b;
    margin-top: 0.25rem;
  }

  /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
  @media (max-width: 768px) {
    .stats-compact {
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
    }

    .stat-item {
      padding: 0.75rem;
    }

    .stat-value {
      font-size: 1.5rem;
    }

    .action-buttons {
      grid-template-columns: 1fr;
    }

    .filter-chips {
      justify-content: center;
    }

    .filter-chip {
      padding: 0.75rem 1.25rem;
    }

    .home-progress-stats{flex-direction:column;align-items:stretch;gap:.75rem}
    .home-progress-side{min-width:0;display:flex;align-items:center;justify-content:space-between;text-align:left}
    .home-progress-side.text-end{text-align:left!important}
    .home-progress-value{font-size:1.875rem}
  }

  @media (max-width: 480px) {
    .stats-compact {
      grid-template-columns: 1fr;
    }

    .home-hero {
      padding: 1.5rem 1rem;
    }

    .home-hero__title {
      font-size: 1.75rem;
    }
  }

  /* Reduce motion */
  @media (prefers-reduced-motion: reduce){
    .home-progress-line::before,
    .home-progress-fill-left,.home-progress-fill-right,
    .home-progress-lightning,
    .home-progress-label,.home-hero__btn,.home-stats-button,
    .table-hover tbody tr,.tag-chip,.filter-chip{animation:none!important;transition:none!important}
    .home-progress-lightning.is-static{animation:none!important}
  }
</style>
{% endblock %}

{% block content %}
<section class="home-hero mb-5">
  <div class="row g-4 align-items-stretch">
    <div class="col-12 col-lg-7 home-hero__content">
      <p class="home-section-title mb-2">–î–æ–º–∞—à–Ω—è—è –∫–æ–ª–ª–µ–∫—Ü–∏—è</p>
      <h1 class="home-hero__title display-5 mb-3">–ú–æ—è –¥–æ–º–∞—à–Ω—è—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞</h1>
      <p class="home-hero__subtitle mb-4">–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –±—É–º–∞–∂–Ω—ã–µ –∏ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–µ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã, —Ä–∞—Å—Å—Ç–∞–≤–ª—è–π—Ç–µ –∏—Ö –ø–æ –ø–æ–ª–∫–∞–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ –ª—é–±–∏–º—ã–º —Å–µ—Ä–∏—è–º.</p>
      <div class="home-hero__actions mb-3">
        <a class="btn btn-light home-hero__btn" href="{% url 'book_list' %}"><i class="bi bi-plus-circle me-2"></i> –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É</a>
        <a class="btn btn-outline-light home-hero__btn" href="{% url 'shelves:my_shelves' %}"><i class="bi bi-card-list me-2"></i> –ö –ø–æ–ª–∫–∞–º</a>
      </div>
    </div>

    <div class="col-12 col-lg-5 d-flex">
      <div class="home-glow-card home-progress-card w-100 h-100">
        <h2 class="h6 text-uppercase text-muted mb-3">–ö—É–ø–ª–µ–Ω–æ –ø—Ä–æ—Ç–∏–≤ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ</h2>

        <div class="home-progress-controls mb-3">
          <div class="flex-grow-1">
            <label class="form-label text-uppercase text-muted small" for="homePeriodType">–¢–∏–ø –ø–µ—Ä–∏–æ–¥–∞</label>
            <select class="form-select form-select-sm" id="homePeriodType" data-role="period-type">
              <option value="year" {% if default_period_type == "year" %}selected{% endif %}>–ì–æ–¥</option>
              <option value="month" {% if default_period_type == "month" %}selected{% endif %}>–ú–µ—Å—è—Ü</option>
            </select>
          </div>
          <div class="flex-grow-1">
            <label class="form-label text-uppercase text-muted small" for="homePeriodValue">–ü–µ—Ä–∏–æ–¥</label>
            <select class="form-select form-select-sm" id="homePeriodValue" data-role="period-value">
              {% if initial_period_options %}
                {% for option in initial_period_options %}
                  <option value="{{ option.value }}" {% if option.value == default_period_value %}selected{% endif %}>{{ option.label }}</option>
                {% endfor %}
              {% else %}
                <option value="" selected>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</option>
              {% endif %}
            </select>
          </div>
        </div>

        <div class="home-progress-stats">
          <div class="home-progress-side">
            <div class="small text-uppercase text-muted">–ö—É–ø–ª–µ–Ω–æ</div>
            <button class="home-stats-button home-progress-value summary-trigger" type="button"
                    data-summary-trigger data-summary-category="period"
                    data-period-kind="bought"
                    data-period-type="{{ default_period_type }}"
                    data-period-value="{{ default_period_value }}"
                    data-summary-title="–ö—É–ø–ª–µ–Ω–æ">
              <span class="home-progress-number" data-role="period-bought-count">{{ default_period_stats.bought_count }}</span>
            </button>
          </div>

          <div class="home-progress-line">
            <div class="home-progress-fill-left"  data-role="fill-left"></div>
            <div class="home-progress-fill-right" data-role="fill-right"></div>
            <div class="home-progress-label"      data-role="period-progress-label">0%</div>
          </div>

          <div class="home-progress-side text-end">
            <div class="small text-uppercase text-muted">–ü—Ä–æ—á–∏—Ç–∞–Ω–æ</div>
            <button class="home-stats-button home-progress-value summary-trigger" type="button"
                    data-summary-trigger data-summary-category="period"
                    data-period-kind="read"
                    data-period-type="{{ default_period_type }}"
                    data-period-value="{{ default_period_value }}"
                    data-summary-title="–ü—Ä–æ—á–∏—Ç–∞–Ω–æ">
              <span class="home-progress-number" data-role="period-read-count">{{ default_period_stats.read_count }}</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–¥ –≥–µ—Ä–æ–µ–º -->
<div class="home-glow-card mb-5">
  <h2 class="h6 text-uppercase text-muted mb-3">–û–±–∑–æ—Ä –±–∏–±–ª–∏–æ—Ç–µ–∫–∏</h2>
  
  <div class="stats-compact">
    <div class="stat-item" onclick="showAllBooks()">
      <div class="stat-value" data-target="{{ summary.total|default:0 }}">{{ summary.total|default:0 }}</div>
      <div class="stat-label">–í—Å–µ–≥–æ –∫–Ω–∏–≥</div>
      <div class="stat-details">–≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ</div>
    </div>

    <div class="stat-item" onclick="showReadBooks()">
      <div class="stat-value" data-target="{{ summary.read_count|default:0 }}">{{ summary.read_count|default:0 }}</div>
      <div class="stat-label">–ü—Ä–æ—á–∏—Ç–∞–Ω–æ</div>
      <div class="stat-details">–∫–Ω–∏–≥</div>
    </div>

    <div class="stat-item" onclick="showGenres()">
      <div class="stat-value" data-target="{{ summary.genre_total|default:0 }}">{{ summary.genre_total|default:0 }}</div>
      <div class="stat-label">–ñ–∞–Ω—Ä–æ–≤</div>
      <div class="stat-details">–≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏</div>
    </div>

    <div class="stat-item" onclick="showSeries()">
      <div class="stat-value" data-target="{{ summary.series_total|default:0 }}">{{ summary.series_total|default:0 }}</div>
      <div class="stat-label">–°–µ—Ä–∏–π</div>
      <div class="stat-details">–Ω–∞—á–∞—Ç–æ</div>
    </div>
  </div>

  <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
  <div class="action-buttons">
    <a href="{% url 'book_list' %}" class="action-btn">
      <div class="action-icon"><i class="bi bi-search"></i></div>
      <div class="action-text">
        <div class="action-title">–ù–∞–π—Ç–∏ –∫–Ω–∏–≥—É</div>
        <div class="action-desc">–ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–∞–ª–æ–≥—É</div>
      </div>
    </a>
    
    <a href="{% url 'shelves:my_shelves' %}" class="action-btn">
      <div class="action-icon"><i class="bi bi-collection"></i></div>
      <div class="action-text">
        <div class="action-title">–ú–æ–∏ –ø–æ–ª–∫–∏</div>
        <div class="action-desc">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–µ–π</div>
      </div>
    </a>
  </div>
</div>

<!-- –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ -->
<div class="search-box">
  <div class="input-group">
    <span class="input-group-text"><i class="bi bi-search"></i></span>
    <input type="text" class="form-control" id="bookSearch" 
           placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –∞–≤—Ç–æ—Ä—É –∏–ª–∏ –∂–∞–Ω—Ä—É...">
    <button class="btn btn-outline-secondary" type="button" id="clearSearch">
      <i class="bi bi-x"></i>
    </button>
  </div>
</div>

<!-- –ë—ã—Å—Ç—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
<div class="filter-chips">
  <div class="filter-chip active" data-filter="all">–í—Å–µ –∫–Ω–∏–≥–∏</div>
  <div class="filter-chip" data-filter="reading">–ß–∏—Ç–∞—é —Å–µ–π—á–∞—Å</div>
  <div class="filter-chip" data-filter="unread">–ù–µ –Ω–∞—á–∞—Ç—ã</div>
  <div class="filter-chip" data-filter="classic">–ö–ª–∞—Å—Å–∏–∫–∞</div>
  <div class="filter-chip" data-filter="modern">–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ</div>
</div>

<!-- –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ -->
{% if entries %}
  <div class="home-library-table mb-4">
    <div class="table-responsive">
      <table class="table align-middle table-hover" id="booksTable">
        <thead>
          <tr>
            <th data-sort="title">–ö–Ω–∏–≥–∞</th>
            <th data-sort="format">–§–æ—Ä–º–∞—Ç</th>
            <th data-sort="status">–°—Ç–∞—Ç—É—Å</th>
            <th data-sort="location">–•—Ä–∞–Ω–µ–Ω–∏–µ</th>
            <th data-sort="classic">–ö–ª–∞—Å—Å–∏–∫–∞</th>
            <th data-sort="series">–°–µ—Ä–∏—è</th>
            <th data-sort="genres">–ñ–∞–Ω—Ä—ã</th>
            <th data-sort="acquired">–ü—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∞</th>
            <th data-sort="notes">–ó–∞–º–µ—Ç–∫–∏</th>
            <th class="text-end">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody>
          {% default_shelf_status_map entries request.user as default_status_map %}
          {% for entry in entries %}
            {% with shelf_status=default_status_map|dict_get:entry.book.pk %}
            <tr data-book-id="{{ entry.book.pk }}"
                data-title="{{ entry.book.title|lower }}"
                data-authors="{{ entry.book.authors.all|join:', '|lower }}"
                data-genres="{% for genre in entry.custom_genres.all %}{{ genre.name|lower }} {% endfor %}"
                data-status="{{ entry.status|default:''|lower }}"
                data-classic="{% if entry.is_classic %}classic{% else %}modern{% endif %}"
                data-reading="{% if entry.is_read %}read{% elif shelf_status and shelf_status.code == 'read' %}read{% elif shelf_status and shelf_status.code == 'reading' %}reading{% else %}unread{% endif %}">
              <td data-label="–ö–Ω–∏–≥–∞" style="min-width:200px;">
                <div class="fw-semibold"><a class="text-decoration-none text-reset" href="{% url 'book_detail' entry.book.pk %}">{{ entry.book.title }}</a></div>
                <div class="small text-muted" style="color: #64748b !important;">{{ entry.book.authors.all|join:", "|default:"–ê–≤—Ç–æ—Ä –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω" }}</div>
                <div class="mt-2">
                  {% if entry.is_read %}
                    <div class="small text-muted fw-semibold" style="color: #64748b !important;">–ü—Ä–æ—á–∏—Ç–∞–Ω–æ{% if entry.date_read %} {{ entry.date_read|date:"d.m.Y" }}{% endif %}</div>
                  {% elif shelf_status and shelf_status.code == 'read' %}
                    {% with read_date=shelf_status.added_at %}
                      <div class="small text-muted fw-semibold" style="color: #64748b !important;">–ü—Ä–æ—á–∏—Ç–∞–Ω–æ{% if read_date %} {{ read_date|date:"d.m.Y" }}{% endif %}</div>
                    {% endwith %}
                  {% elif shelf_status and shelf_status.code == 'reading' %}
                    <div class="small text-muted fw-semibold" style="color: #64748b !important;">–ù–∞ –ø–æ–ª–∫–µ ¬´{{ shelf_status.label|default:default_reading_shelf_name|default:'–ß–∏—Ç–∞—é' }}¬ª</div>
                  {% else %}
                    <form method="post" action="{% url 'shelves:move_book_to_reading' entry.book.pk %}">
                      {% csrf_token %}
                      <input type="hidden" name="next" value="{{ request.get_full_path }}">
                      <button type="submit" class="btn btn-sm btn-outline-primary mt-1"><i class="bi bi-book-half" aria-hidden="true"></i><span>–ù–∞—á–∞—Ç—å —á–∏—Ç–∞—Ç—å</span></button>
                    </form>
                  {% endif %}
                </div>
              </td>
              <td data-label="–§–æ—Ä–º–∞—Ç">{{ entry.get_format_display }}</td>
              <td data-label="–°—Ç–∞—Ç—É—Å">{{ entry.status|default:"‚Äî" }}</td>
              <td data-label="–•—Ä–∞–Ω–µ–Ω–∏–µ">
                {% if entry.location %}{{ entry.location }}<br>{% endif %}
                {% if entry.shelf_section %}<span class="text-muted small" style="color: #64748b !important;">{{ entry.shelf_section }}</span>{% endif %}
                {% if not entry.location and not entry.shelf_section %}‚Äî{% endif %}
              </td>
              <td data-label="–ö–ª–∞—Å—Å–∏–∫–∞">{% if entry.is_classic %}<span class="badge text-bg-success">–î–∞</span>{% else %}<span class="text-muted" style="color: #64748b !important;">–ù–µ—Ç</span>{% endif %}</td>
              <td data-label="–°–µ—Ä–∏—è">{{ entry.series_name|default:"‚Äî" }}</td>
              <td data-label="–ñ–∞–Ω—Ä—ã">
                {% with entry.custom_genres.all as entry_genres %}
                  {% if entry_genres %}{% for genre in entry_genres %}<span class="tag-chip">{{ genre }}</span>{% endfor %}{% else %}‚Äî{% endif %}
                {% endwith %}
              </td>
              <td data-label="–ü—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∞">{% if entry.acquired_at %}{{ entry.acquired_at|date:"d.m.Y" }}{% else %}‚Äî{% endif %}</td>
              <td data-label="–ó–∞–º–µ—Ç–∫–∏" style="max-width:240px;white-space:pre-wrap;">{{ entry.notes|default:"‚Äî" }}</td>
              <td data-label="–î–µ–π—Å—Ç–≤–∏—è" class="text-end">
                <div class="btn-group btn-group-sm home-table-actions">
                  <a class="btn btn-outline-secondary" href="{% url 'shelves:home_library_edit' entry.shelf_item_id %}?next={{ request.get_full_path|urlencode }}"><i class="bi bi-pencil"></i></a>
                  <a class="btn btn-outline-danger" href="{% url 'shelves:remove_book_from_shelf' shelf.id entry.book.id %}?next={{ request.get_full_path|urlencode }}" title="–£–¥–∞–ª–∏—Ç—å –∏–∑ –ø–æ–ª–∫–∏" aria-label="–£–¥–∞–ª–∏—Ç—å –∫–Ω–∏–≥—É"><i class="bi bi-trash"></i></a>
                </div>
              </td>
            </tr>
            {% endwith %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% else %}
  <div class="alert alert-light border text-center py-5">
    <i class="bi bi-book display-1 text-muted mb-3 d-block"></i>
    <h3>–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—É—Å—Ç–∞</h3>
    <p class="text-muted">–ù–∞—á–Ω–∏—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å –∫–Ω–∏–≥–∏ –≤ —Å–≤–æ—é –∫–æ–ª–ª–µ–∫—Ü–∏—é</p>
    <a href="{% url 'book_list' %}" class="btn btn-primary mt-2">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é –∫–Ω–∏–≥—É</a>
  </div>
{% endif %}

<!-- –ú–æ–¥–∞–ª–∫–∏ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
<div class="modal fade home-library-modal" id="readBooksModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">üìñ –ü—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ –∫–Ω–∏–≥–∏ ({{ summary.read_count }})</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
      </div>
      <div class="modal-body">
        <div id="readBooksList">
          {% for entry in entries %}
            {% if entry.is_read %}
              <div class="book-list-item">
                <div class="book-info">
                  <div class="book-title">{{ entry.book.title }}</div>
                  <div class="book-authors">{{ entry.book.authors.all|join:", "|default:"–ê–≤—Ç–æ—Ä –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω" }}</div>
                  {% if entry.date_read %}
                    <div class="book-meta">–ü—Ä–æ—á–∏—Ç–∞–Ω–æ: {{ entry.date_read|date:"d.m.Y" }}</div>
                  {% endif %}
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade home-library-modal" id="genresModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">üé≠ –ñ–∞–Ω—Ä—ã –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          {% for genre in summary.genre_counts %}
            <div class="col-md-6 mb-3">
              <div class="d-flex justify-content-between align-items-center p-3 border rounded">
                <span>{{ genre.name }}</span>
                <span class="badge bg-primary">{{ genre.total }}</span>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade home-library-modal" id="seriesModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">üìö –°–µ—Ä–∏–∏ –∫–Ω–∏–≥</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          {% for series in summary.series_counts %}
            <div class="col-md-6 mb-3">
              <div class="d-flex justify-content-between align-items-center p-3 border rounded">
                <span>{{ series.series_name }}</span>
                <span class="badge bg-primary">{{ series.total }}</span>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade home-library-modal" id="allBooksModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">üìö –í—Å–µ –∫–Ω–∏–≥–∏ ({{ summary.total }})</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
      </div>
      <div class="modal-body">
        <div id="allBooksList">
          {% for entry in entries %}
            <div class="book-list-item">
              <div class="book-info">
                <div class="book-title">{{ entry.book.title }}</div>
                <div class="book-authors">{{ entry.book.authors.all|join:", "|default:"–ê–≤—Ç–æ—Ä –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω" }}</div>
                <div class="book-meta">
                  {% if entry.is_read %}
                    <span class="text-success">–ü—Ä–æ—á–∏—Ç–∞–Ω–æ</span>
                  {% else %}
                    <span class="text-warning">–í –ø–ª–∞–Ω–∞—Ö</span>
                  {% endif %}
                  ‚Ä¢ {{ entry.get_format_display }}
                  {% if entry.acquired_at %}‚Ä¢ –ü—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∞: {{ entry.acquired_at|date:"d.m.Y" }}{% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –º–æ–¥–∞–ª–∫–∞ –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ -->
<div class="modal fade home-summary-modal" id="homeLibrarySummaryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" data-role="summary-title">–°–ø–∏—Å–æ–∫ –∫–Ω–∏–≥</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-0" data-role="summary-empty">–î–ª—è —ç—Ç–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞ –ø–æ–∫–∞ –Ω–µ—Ç –∫–Ω–∏–≥.</p>
        <div data-role="summary-list" class="list-group list-group-flush d-none"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ summary_data|json_script:"homeLibrarySummaryData" }}
<script>
(function() {
  // –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  function showLibraryNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `library-notification library-notification-${type}`;
    const icons = { info: 'info-circle', success: 'check-circle', warning: 'exclamation-triangle', error: 'x-circle' };
    notification.innerHTML = `
      <div class="notification-content">
        <i class="bi bi-${icons[type]} me-2"></i>
        ${message}
      </div>
      <button class="notification-close">&times;</button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => notification.classList.add('show'), 100);
    
    setTimeout(() => hideNotification(notification), 5000);
    
    notification.querySelector('.notification-close').addEventListener('click', () => {
      hideNotification(notification);
    });
  }

  function hideNotification(notification) {
    notification.classList.remove('show');
    setTimeout(() => notification.remove(), 300);
  }

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª–æ–∫
  window.showReadBooks = function() {
    const modal = new bootstrap.Modal(document.getElementById('readBooksModal'));
    modal.show();
  };

  window.showGenres = function() {
    const modal = new bootstrap.Modal(document.getElementById('genresModal'));
    modal.show();
  };

  window.showSeries = function() {
    const modal = new bootstrap.Modal(document.getElementById('seriesModal'));
    modal.show();
  };

  window.showAllBooks = function() {
    const modal = new bootstrap.Modal(document.getElementById('allBooksModal'));
    modal.show();
  };

  // –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (—Å–æ—Ö—Ä–∞–Ω–µ–Ω)
  const dataElement = document.getElementById('homeLibrarySummaryData');
  if (!dataElement) return;

  let summaryData = {};
  try { summaryData = JSON.parse(dataElement.textContent || '{}'); }
  catch (e) { console.error('Failed to parse home library summary data', e); summaryData = {}; }

  const modalEl = document.getElementById('homeLibrarySummaryModal');
  const titleEl = modalEl ? modalEl.querySelector('[data-role="summary-title"]') : null;
  const listWrapper = modalEl ? modalEl.querySelector('[data-role="summary-list"]') : null;
  const emptyEl = modalEl ? modalEl.querySelector('[data-role="summary-empty"]') : null;
  let modalInstance = null;

  function ensureModal(){
    if (!modalEl) return null;
    if (!modalInstance && window.bootstrap?.Modal) modalInstance = new bootstrap.Modal(modalEl);
    return modalInstance;
  }

  function renderBooks(items){
    if (!listWrapper || !emptyEl) return;
    if (!Array.isArray(items) || !items.length){
      listWrapper.innerHTML=''; listWrapper.classList.add('d-none');
      emptyEl.classList.remove('d-none'); emptyEl.textContent='–î–ª—è —ç—Ç–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞ –ø–æ–∫–∞ –Ω–µ—Ç –∫–Ω–∏–≥.'; return;
    }
    const frag = document.createDocumentFragment();
    items.forEach(book=>{
      const item = document.createElement('div'); item.className='list-group-item home-summary-item';
      const link = document.createElement('a'); link.href=book.url; link.textContent=book.title;
      const sub = document.createElement('div'); sub.className='text-muted small mt-1'; sub.textContent=book.authors || '–ê–≤—Ç–æ—Ä –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω';
      item.appendChild(link); item.appendChild(sub); frag.appendChild(item);
    });
    listWrapper.innerHTML=''; listWrapper.appendChild(frag);
    emptyEl.classList.add('d-none'); listWrapper.classList.remove('d-none');
  }

  function openModal(title, items){
    if (titleEl) titleEl.textContent = title || '–°–ø–∏—Å–æ–∫ –∫–Ω–∏–≥';
    renderBooks(items);
    const m = ensureModal(); if (m) m.show();
  }

  function getSummaryItems(trigger){
    const category = trigger.dataset.summaryCategory; if (!category) return [];
    if (['classic','modern','active','disposed'].includes(category)) return summaryData[category] || [];
    if (['series','genres','locations','statuses'].includes(category)){
      const key = trigger.dataset.summaryKey; const bucket = summaryData[category] || {};
      return key ? (bucket[key] || []) : [];
    }
    if (category === 'period'){
      const kind = trigger.dataset.periodKind, type = trigger.dataset.periodType, value = trigger.dataset.periodValue;
      const periods = summaryData.periods || {}; const typeBucket = periods[type] || {}; const stats = typeBucket[value] || {};
      if (kind === 'bought') return stats.bought_books || [];
      if (kind === 'read')   return stats.read_books || [];
      return [];
    }
    return [];
  }

  function getPeriodOptions(type){
    const options = summaryData.periodOptions || {}; return options[type] || [];
  }
  function getPeriodLabel(type, value){
    const opts = getPeriodOptions(type); const found = opts.find(o=>o.value===value); return found ? found.label : '';
  }

  document.querySelectorAll('[data-summary-trigger]').forEach(trigger=>{
    trigger.addEventListener('click', ()=>{
      const title = trigger.dataset.summaryTitle || trigger.textContent.trim();
      const items = getSummaryItems(trigger);
      openModal(title, items);
    });
  });

  const periodTypeSelect  = document.querySelector('[data-role="period-type"]');
  const periodValueSelect = document.querySelector('[data-role="period-value"]');
  const boughtCountEl     = document.querySelector('[data-role="period-bought-count"]');
  const readCountEl       = document.querySelector('[data-role="period-read-count"]');
  const fillLeftEl        = document.querySelector('[data-role="fill-left"]');
  const fillRightEl       = document.querySelector('[data-role="fill-right"]');
  const labelEl           = document.querySelector('[data-role="period-progress-label"]');
  const lineEl            = fillLeftEl?.parentElement;
  const PERIOD_STORAGE_KEY = 'homeLibraryPeriodSelection';

  function getStorage(){ try { return window.localStorage; } catch(e){ return null; } }

  function loadSavedPeriod(){
    const storage = getStorage(); if (!storage) return null;
    try{
      const raw = storage.getItem(PERIOD_STORAGE_KEY); if (!raw) return null;
      const parsed = JSON.parse(raw); if (!parsed || typeof parsed!=='object') return null;
      const values = typeof parsed.values==='object' && parsed.values ? parsed.values : {};
      const type = (parsed.type==='year' || parsed.type==='month') ? parsed.type : null;
      const value = type && values[type] ? values[type] : (typeof parsed.value==='string' ? parsed.value : '');
      return { type, value, values };
    }catch(e){ console.warn('Failed to read saved period', e); return null; }
  }
  function savePeriodSelection(type, value){
    const storage = getStorage(); if (!storage) return;
    try{
      const existing = loadSavedPeriod(); const values = existing?.values ? { ...existing.values } : {};
      if (type==='year' || type==='month'){ value ? values[type]=value : delete values[type]; }
      const payload = JSON.stringify({ type, value: value || '', values });
      storage.setItem(PERIOD_STORAGE_KEY, payload);
    }catch(e){ console.warn('Failed to save period', e); }
  }

  const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  function animateNumber(el, to){
    const from = parseInt(el.textContent || '0', 10) || 0;
    if (prefersReduced || from === to){ el.textContent = to; return; }
    const dur = 700; const start = performance.now();
    const step = (t)=>{
      const p = Math.min(1, (t - start) / dur);
      const eased = 1 - Math.pow(1 - p, 3);
      el.textContent = Math.round(from + (to - from) * eased);
      if (p < 1) requestAnimationFrame(step);
    };
    requestAnimationFrame(step);
  }

  document.querySelectorAll('.stat-value[data-target]').forEach((el)=>{
    const targetRaw = el.dataset.target;
    if (typeof targetRaw !== 'string' || !targetRaw.trim()) return;
    const targetValue = parseInt(targetRaw, 10);
    if (Number.isNaN(targetValue)) return;
    if (!prefersReduced){
      el.textContent = '0';
      requestAnimationFrame(()=> animateNumber(el, targetValue));
    } else {
      el.textContent = targetValue;
    }
  });

  function placeLightningAt(percent){
    if (!lineEl) return;
    let bolt = lineEl.querySelector('.home-progress-lightning');
    if (!bolt){
      bolt = document.createElement('div');
      bolt.className = 'home-progress-lightning';
      lineEl.appendChild(bolt);
    }
    bolt.style.left = percent + '%';
    bolt.classList.remove('reflash','is-static'); void bolt.offsetWidth;
    bolt.classList.add('reflash');
    setTimeout(()=> bolt.classList.add('is-static'), 900);
  }

  function spawnSparksAt(percent){
    if (!lineEl || prefersReduced) return;
    const sparks = 6;
    for (let i=0;i<sparks;i++){
      const s = document.createElement('div');
      s.className = 'home-progress-spark';
      s.style.left = percent + '%';
      const angle = (Math.random()*70 - 35) * (Math.PI/180);
      const dist  = 16 + Math.random()*18;
      s.style.setProperty('--dx', `${Math.cos(angle)*dist}px`);
      s.style.setProperty('--dy', `${Math.sin(angle)*dist - 8}px`);
      lineEl.appendChild(s);
      setTimeout(()=>s.remove(), 700);
    }
  }

  function updatePeriodTriggers(type, value, label){
    document.querySelectorAll('[data-summary-category="period"]').forEach((trigger)=>{
      trigger.dataset.periodType = type;
      trigger.dataset.periodValue = value || '';
      const kind = trigger.dataset.periodKind;
      if (label && kind){
        const prefix = kind === 'bought' ? '–ö—É–ø–ª–µ–Ω–æ ‚Äî ' : '–ü—Ä–æ—á–∏—Ç–∞–Ω–æ ‚Äî ';
        trigger.dataset.summaryTitle = prefix + label;
      } else if (kind){
        trigger.dataset.summaryTitle = kind === 'bought' ? '–ö—É–ø–ª–µ–Ω–æ' : '–ü—Ä–æ—á–∏—Ç–∞–Ω–æ';
      }
    });
  }

  function updatePeriodCard(){
    if (!fillLeftEl || !fillRightEl) return;

    const type = periodTypeSelect?.value || 'year';
    const options = getPeriodOptions(type);
    let value = '';
    if (options.length){
      value = periodValueSelect?.value || options[0].value;
      if (periodValueSelect && !options.some(o=>o.value===value)){
        periodValueSelect.value = options[0].value;
        value = periodValueSelect.value;
      }
    }

    const periods = summaryData.periods || {};
    const stats = (periods[type] && periods[type][value]) || {};
    const boughtCount = stats.bought_count || 0;
    const readCount   = stats.read_count   || 0;

    animateNumber(boughtCountEl, boughtCount);
    animateNumber(readCountEl,   readCount);

    const total = boughtCount + readCount;
    const boughtPercent = total ? Math.round((boughtCount / total) * 100) : 0;
    const readPercent   = 100 - boughtPercent;

    lineEl?.classList.add('is-animating');
    setTimeout(()=> lineEl?.classList.remove('is-animating'), 1200);

    fillLeftEl.style.transition = 'none';
    fillRightEl.style.transition = 'none';
    fillLeftEl.style.width  = '0%';
    fillRightEl.style.width = '0%';
    void fillLeftEl.offsetWidth;
    fillLeftEl.style.transition  = 'width 900ms ease';
    fillRightEl.style.transition = 'width 900ms ease';
    fillLeftEl.style.width  = boughtPercent + '%';
    fillRightEl.style.width = readPercent   + '%';

    placeLightningAt(boughtPercent);
    spawnSparksAt(boughtPercent);

    if (labelEl){
      labelEl.classList.remove('pop');
      labelEl.textContent = `${boughtPercent}% / ${readPercent}%`;
      setTimeout(()=> labelEl.classList.add('pop'), 920);
    }

    const label = getPeriodLabel(type, value);
    updatePeriodTriggers(type, value, label);
    savePeriodSelection(type, value);
  }

  function populatePeriodOptions(type, preferredValue){
    if (!periodValueSelect) return;
    const options = getPeriodOptions(type);
    periodValueSelect.innerHTML = '';
    if (!options.length){
      const opt = document.createElement('option'); opt.value=''; opt.textContent='–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'; opt.selected=true;
      periodValueSelect.appendChild(opt); periodValueSelect.disabled = true;
      if (labelEl) labelEl.textContent = '0% / 0%';
      if (fillLeftEl && fillRightEl){
        fillLeftEl.style.width = '0%'; fillRightEl.style.width = '0%';
      }
      return;
    }
    periodValueSelect.disabled = false;
    let selectedDone = false;
    options.forEach(o=>{
      const el = document.createElement('option'); el.value=o.value; el.textContent=o.label;
      if (!selectedDone && preferredValue && o.value===preferredValue){ el.selected=true; selectedDone=true; }
      periodValueSelect.appendChild(el);
    });
    if (!selectedDone && summaryData?.defaultPeriod?.type===type){
      const def = summaryData.defaultPeriod.value;
      const opt = Array.from(periodValueSelect.options).find(x=>x.value===def);
      if (opt) opt.selected = true;
    }
    if (!Array.from(periodValueSelect.options).some(x=>x.selected) && periodValueSelect.options.length){
      periodValueSelect.options[0].selected = true;
    }
  }

  periodTypeSelect?.addEventListener('change', ()=>{
    const t = periodTypeSelect.value || 'year';
    const saved = loadSavedPeriod(); const preferred = saved?.values ? saved.values[t] : undefined;
    populatePeriodOptions(t, preferred); updatePeriodCard();
  });
  periodValueSelect?.addEventListener('change', updatePeriodCard);

  let initialType = periodTypeSelect?.value || 'year';
  let initialValue;
  const saved = loadSavedPeriod();
  if (saved){
    if (saved.type && getPeriodOptions(saved.type).length){
      initialType = saved.type; if (periodTypeSelect) periodTypeSelect.value = saved.type;
    }
    initialValue = saved.values?.[initialType] || saved.value;
  }
  populatePeriodOptions(initialType, initialValue);
  updatePeriodCard();

  // –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫
  const searchInput = document.getElementById('bookSearch');
  const clearSearch = document.getElementById('clearSearch');
  
  if (searchInput) {
    searchInput.addEventListener('input', function(e) {
      const searchTerm = e.target.value.toLowerCase();
      const rows = document.querySelectorAll('#booksTable tbody tr');
      let visibleCount = 0;
      
      rows.forEach(row => {
        const title = row.dataset.title || '';
        const authors = row.dataset.authors || '';
        const genres = row.dataset.genres || '';
        const text = title + ' ' + authors + ' ' + genres;
        const isVisible = text.includes(searchTerm);
        
        row.style.display = isVisible ? '' : 'none';
        if (isVisible) visibleCount++;
      });
      
      if (searchTerm && visibleCount === 0) {
        showLibraryNotification('–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'warning');
      }
    });
    
    clearSearch.addEventListener('click', function() {
      searchInput.value = '';
      const rows = document.querySelectorAll('#booksTable tbody tr');
      rows.forEach(row => row.style.display = '');
      showLibraryNotification('–ü–æ–∏—Å–∫ –æ—á–∏—â–µ–Ω', 'info');
    });
  }

  // –ë—ã—Å—Ç—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
  const filterChips = document.querySelectorAll('.filter-chip');
  filterChips.forEach(chip => {
    chip.addEventListener('click', function() {
      const filter = this.dataset.filter;
      
      // –û–±–Ω–æ–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π —á–∏–ø
      filterChips.forEach(c => c.classList.remove('active'));
      this.classList.add('active');
      
      // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä
      const rows = document.querySelectorAll('#booksTable tbody tr');
      rows.forEach(row => {
        let matchesFilter = true;
        switch (filter) {
          case 'reading':
            matchesFilter = row.dataset.reading === 'reading';
            break;
          case 'unread':
            matchesFilter = row.dataset.reading === 'unread';
            break;
          case 'classic':
            matchesFilter = row.dataset.classic === 'classic';
            break;
          case 'modern':
            matchesFilter = row.dataset.classic === 'modern';
            break;
          default:
            matchesFilter = true;
        }
        row.style.display = (filter === 'all' || matchesFilter) ? '' : 'none';
      });
      
      showLibraryNotification(`–ü–æ–∫–∞–∑–∞–Ω—ã: ${this.textContent}`, 'info');
    });
  });

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  document.addEventListener('DOMContentLoaded', function() {
    // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    setTimeout(() => {
      showLibraryNotification('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –≤–∞—à—É –±–∏–±–ª–∏–æ—Ç–µ–∫—É! –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ª—é–±—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.', 'info');
    }, 1000);
  });

})();
{% if not user.profile.has_active_premium %}
<!-- Yandex.RTB R-A-17641153-1 -->
<script>
window.yaContextCb.push(() => {
    Ya.Context.AdvManager.render({
        "blockId": "R-A-17641153-1",
        "type": "floorAd",
        "platform": "desktop"
    })
})
</script>
<!-- Yandex.RTB R-A-17641153-4 -->
<script>
window.yaContextCb.push(() => {
    Ya.Context.AdvManager.render({
        "blockId": "R-A-17641153-4",
        "type": "floorAd",
        "platform": "touch"
    })
})
</script>
{% endif %}
{% endblock %}