{% extends "base.html" %}
{% load shelf_extras %}
{% block title %}Моя домашняя библиотека{% endblock %}
{% block extra_css %}
<style>
  :root {
    --home-hero-gradient: linear-gradient(130deg, #7f9aaf 0%, #5d7283 42%, #38444e 100%);
    --home-card-bg: rgba(57, 69, 79, 0.96);
    --home-card-border: rgba(152, 175, 192, 0.45);
    --home-card-shadow: 0 22px 48px rgba(33, 42, 49, 0.55);
    --home-text-soft: rgba(244, 249, 255, 0.85);
    --home-accent: #c2e0ef;
    --home-accent-strong: #f6c8a2;
    --home-surface: rgba(49, 60, 69, 0.95);
    --home-surface-alt: rgba(70, 85, 97, 0.82);
    --home-divider: rgba(158, 182, 201, 0.35);
  }

  .home-hero {
    position: relative;
    border-radius: 24px;
    overflow: hidden;
    background: var(--home-hero-gradient);
    color: #f5f7ff;
    padding: 2.5rem 2rem;
    box-shadow: 0 25px 55px rgba(24, 32, 39, 0.45);
  }

  .home-hero::before,
  .home-hero::after {
    content: "";
    position: absolute;
    border-radius: 100%;
    filter: blur(65px);
    opacity: 0.8;
    z-index: 0;
  }

  .home-hero::before {
    width: 360px;
    height: 360px;
    top: -120px;
    right: -140px;
    bbackground: rgba(216, 232, 242, 0.45);
  }

  .home-hero::after {
    width: 280px;
    height: 280px;
    bottom: -140px;
    left: -110px;
    background: rgba(247, 209, 176, 0.4);
  }

  .home-hero__content,
  .home-hero__actions {
    position: relative;
    z-index: 1;
  }

  .home-hero__title {
    font-family: "Montserrat", "Segoe UI", system-ui, sans-serif;
    font-weight: 700;
    letter-spacing: 0.02em;
  }

  .home-hero__subtitle {
    max-width: 520px;
    color: var(--home-text-soft);
  }

  .home-hero__actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .home-hero__btn {
    border-radius: 999px;
    font-weight: 600;
    box-shadow: 0 12px 28px rgba(8, 10, 44, 0.45);
    border: none;
    transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease, color 0.15s ease;
  }

  .home-hero__btn:hover,
  .home-hero__btn:focus {
    transform: translateY(-2px);
    box-shadow: 0 18px 32px rgba(8, 10, 44, 0.55);
  }

  .home-hero__btn.btn-outline-light {
    border: 1px solid rgba(255, 255, 255, 0.55);
    background: rgba(46, 58, 68, 0.55);
    color: #ffffff;
  }

  .home-hero__btn.btn-light {
    color: #1c242b;
  }

  .home-hero__btn.btn-outline-light:hover,
  .home-hero__btn.btn-outline-light:focus {
    background: rgba(255, 255, 255, 0.15);
  }

  .home-hero__btn.btn-light:hover,
  .home-hero__btn.btn-light:focus {
    background: linear-gradient(130deg, #d3e6f1 0%, #f1f6fa 100%);
    color: #11171c;
  }

  .home-glow-card {
    background: var(--home-card-bg);
    border: 1px solid var(--home-card-border);
    border-radius: 20px;
    box-shadow: var(--home-card-shadow);
    color: #f8faff;
    padding: 1.5rem;
    position: relative;
    overflow: hidden;
  }

  .home-stats-button {
    padding: 0;
    border: none;
    background: none;
    color: inherit;
    font: inherit;
    font-weight: 600;
    cursor: pointer;
    transition: color 0.2s ease;
  }

  .home-stats-button:hover,
  .home-stats-button:focus {
    color: var(--home-accent-strong);
  }

  .home-stats-button:focus-visible {
    outline: 2px solid rgba(255, 255, 255, 0.45);
    outline-offset: 2px;
  }

  .home-stats-button--compact {
    font-size: 0.95rem;
    font-weight: 700;
  }

  .home-progress-card {
    --home-progress-bought: #38bdf8;
    --home-progress-read: #f97316;
  }

  .home-progress-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .home-progress-controls .form-select,
  .home-progress-controls .form-label {
    font-size: 0.85rem;
  }

  .home-progress-stats {
    display: flex;
    align-items: center;
    gap: 1.25rem;
  }

  .home-progress-side {
    min-width: 120px;
  }

  .home-progress-value {
    font-size: 2.25rem;
    line-height: 1;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
  }

  .home-progress-value .home-progress-number {
    font-variant-numeric: tabular-nums;
  }

  .home-progress-line {
    position: relative;
    flex: 1;
    height: 8px;
    border-radius: 999px;
    background: rgba(255, 255, 255, 0.16);
    overflow: hidden;
  }

  .home-progress-fill {
    position: absolute;
    inset: 0;
    background: linear-gradient(
      90deg,
      var(--home-progress-bought) 0%,
      var(--home-progress-bought) var(--home-progress-split, 50%),
      var(--home-progress-read) var(--home-progress-split, 50%),
      var(--home-progress-read) 100%
    );
    transition: background 0.3s ease;
  }

  .home-progress-label {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    color: #0f172a;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
  }

  .home-summary-modal .modal-content {
    border-radius: 18px;
    border: none;
  }

  .home-summary-modal .modal-header {
    border-bottom: 1px solid rgba(148, 163, 184, 0.35);
  }

  .home-summary-modal .modal-body {
    max-height: 60vh;
    overflow-y: auto;
  }

  .home-summary-item {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid rgba(226, 232, 240, 0.7);
  }

  .home-summary-item:last-child {
    border-bottom: none;
  }

  .home-summary-item a {
    color: inherit;
    text-decoration: none;
  }

  .home-summary-item a:hover,
  .home-summary-item a:focus {
    text-decoration: underline;
  }

  .home-glow-card::after {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: inherit;
    padding: 1px;
    background: linear-gradient(135deg, rgba(194, 224, 239, 0.35), rgba(246, 200, 162, 0.18));
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
            mask-composite: exclude;
  }

  .home-glow-card h2,
  .home-glow-card h3 {
    color: #ffffff;
    text-transform: none;
    letter-spacing: 0.05em;
    font-weight: 700;
  }

  .home-glow-card .text-muted,
  .home-glow-card .small,
  .home-glow-card .badge.text-bg-light {
    color: var(--home-text-soft) !important;
  }

  .home-glow-card ul li span:first-child {
    color: var(--home-text-soft);
  }

  .home-glow-card .badge {
    border-radius: 12px;
    background: rgba(194, 224, 239, 0.22) !important;
    color: var(--home-accent);
    border: 1px solid rgba(194, 224, 239, 0.5);
  }

  .home-stats-grid {
    display: grid;
    gap: 1.25rem;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  }

  .home-stats-primary {
    font-size: clamp(2.25rem, 4vw, 3.5rem);
    font-weight: 700;
    color: var(--home-accent);
  }

  .home-filters-card {
    background: var(--home-surface);
    border-radius: 20px;
    border: 1px solid var(--home-divider);
    box-shadow: 0 16px 32px rgba(20, 27, 33, 0.5);
  }

  .home-filters-toggle {
    border-radius: 14px;
    border: 1px solid rgba(255, 255, 255, 0.28);
    bbackground: rgba(61, 81, 96, 0.8);
    color: #f8f9ff;
    font-weight: 600;
    letter-spacing: 0.05em;
  }

  .home-section-title {
    font-size: 0.75rem;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: rgba(210, 226, 241, 0.82);
  }

  .home-activity {
    display: grid;
    gap: 1.25rem;
  }

  .home-library-table {
    background: #ffffff;
    border-radius: 24px;
    border: 1px solid #dbe3f0;
    box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
    overflow: hidden;
    color: #0f172a;
  }

  .home-library-table .table {
    color: inherit;
    margin-bottom: 0;
    border-color: #e2e8f0;
  }

  .home-library-table .table thead {
    background: #f8fafc;
  }

  .home-library-table .table thead th {
    border-color: #e2e8f0;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    font-size: 0.7rem;
    color: #0f172a;
  }

  .home-library-table .table tbody td {
    border-color: #e2e8f0;
    vertical-align: top;
    background: #ffffff;
    color: inherit;
  }

  .home-library-table .table tbody tr:nth-of-type(odd) td {
    background: #ffffff;
  }

  .home-library-table .table tbody tr:nth-of-type(even) td {
    background: #ffffff;
  }

  .home-library-table .table tbody tr:hover td {
    background: #f1f5f9;
  }

  .home-library-table .table tbody td .text-muted {
    color: #64748b !important;
  }

  .home-table-actions .btn {
    border-radius: 12px;
  }

  .home-table-actions .btn-outline-secondary {
    color: rgba(61, 81, 96, 0.9);
    border-color: rgba(194, 224, 239, 0.55);
    background: rgba(82, 106, 122, 0.65);
  }

  .home-table-actions .btn-outline-secondary:hover,
  .home-table-actions .btn-outline-secondary:focus {
    background: rgba(194, 224, 239, 0.2);
    color: #1c242b;
    border-color: rgba(194, 224, 239, 0.85);
  }

  .home-table-actions .btn-outline-danger {
    color: #fca5a5;
    border-color: rgba(248, 113, 113, 0.55);
    background: rgba(244, 63, 94, 0.12);
  }

  .home-table-actions .btn-outline-danger:hover,
  .home-table-actions .btn-outline-danger:focus {
    background: rgba(244, 63, 94, 0.25);
    color: #fee2e2;
    border-color: rgba(244, 63, 94, 0.65);
  }

  .tag-chip {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.6rem;
    border-radius: 999px;
    background: rgba(194, 224, 239, 0.18);
    color: #0d2744;
    font-size: 0.75rem;
    margin-right: 0.35rem;
    margin-bottom: 0.35rem;
    border: 1px solid rgba(255, 255, 255, 0.28);
  }

  @media (max-width: 991.98px) {
    .home-hero {
      padding: 2rem 1.5rem;
    }

    .home-activity {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 767.98px) {
    .home-hero {
      padding: 1.75rem 1.25rem;
    }

    .home-hero__title {
      font-size: 1.875rem;
    }

    .home-hero__subtitle {
      font-size: 0.95rem;
    }

    .home-stats-grid {
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
    }

    .home-progress-stats {
      flex-direction: column;
      align-items: stretch;
      gap: 0.75rem;
    }

    .home-progress-side {
      min-width: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      text-align: left;
    }

    .home-progress-side.text-end {
      text-align: left !important;
    }

    .home-progress-value {
      font-size: 1.875rem;
    }

    .home-library-table .table thead {
      display: none;
    }

    .home-library-table table,
    .home-library-table tbody,
    .home-library-table tr,
    .home-library-table td {
      display: block;
      width: 100%;
    }

    .home-library-table tr {
      background: #ffffff;
      border-radius: 20px;
      margin-bottom: 1rem;
      padding: 1rem 1.25rem;
      box-shadow: 0 18px 35px rgba(15, 23, 42, 0.12);
    }

    .home-library-table td {
      border: none;
      padding: 0.25rem 0;
      background: transparent;
    }

    .home-library-table td::before {
      content: attr(data-label);
      display: block;
      font-size: 0.7rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: #64748b;
      margin-bottom: 0.15rem;
    }

    .home-library-table td[data-label="Действия"] {
      text-align: left;
      margin-top: 0.5rem;
    }

    .home-table-actions {
      justify-content: flex-start !important;
    }

    .home-filters-toggle {
      width: 100%;
    }

    .home-disposed-card .table thead {
      display: none;
    }

    .home-disposed-card .table,
    .home-disposed-card tbody,
    .home-disposed-card tr,
    .home-disposed-card td {
      display: block;
      width: 100%;
    }

    .home-disposed-card tr {
      background: #ffffff;
      border-radius: 20px;
      margin-bottom: 1rem;
      padding: 1rem 1.25rem;
      box-shadow: 0 18px 35px rgba(15, 23, 42, 0.12);
    }

    .home-disposed-card td {
      border: none;
      padding: 0.3rem 0;
      background: transparent;
    }

    .home-disposed-card td::before {
      content: attr(data-label);
      display: block;
      font-size: 0.7rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: #64748b;
      margin-bottom: 0.1rem;
    }
  }

  @media (min-width: 768px) {
    #homeLibraryFilters {
      display: block !important;
      height: auto !important;
      visibility: visible !important;
    }
  }
</style>
{% endblock %}
{% block content %}
<section class="home-hero mb-5">
  <div class="row g-4 align-items-center">
    <div class="col-12 col-lg-7 home-hero__content">
      <p class="home-section-title mb-2">Домашняя коллекция</p>
      <h1 class="home-hero__title display-5 mb-3">Моя домашняя библиотека</h1>
      <p class="home-hero__subtitle mb-4">Отслеживайте бумажные и электронные экземпляры, расставляйте их по полкам и возвращайтесь к любимым сериям с атмосферой ретро-игры.</p>
      <div class="home-hero__actions">
        <a class="btn btn-light home-hero__btn" href="{% url 'book_list' %}">
          <i class="bi bi-plus-circle me-2"></i>
          Добавить книгу
        </a>
        <a class="btn btn-outline-light home-hero__btn" href="{% url 'shelves:my_shelves' %}">
          <i class="bi bi-card-list me-2"></i>
          К полкам
        </a>
      </div>
    </div>
    <div class="col-12 col-lg-5 home-hero__actions">
      <div class="home-glow-card h-100">
        <h2 class="h6 text-uppercase text-muted mb-3">Быстрые действия</h2>
        <div class="d-flex flex-wrap gap-3">
          <div class="flex-fill">
            <div class="small text-uppercase text-muted mb-1">Текущие книги</div>
            <div class="home-stats-primary">{{ summary.total }}</div>
          </div>
          <div class="flex-fill">
            <div class="small text-uppercase text-muted mb-1">Передано</div>
            <div class="display-6 mb-0">{{ summary.disposed_total }}</div>
          </div>
        </div>
        <p class="small text-muted mt-3 mb-0">Следите за движением коллекции, присваивайте статусы и делитесь историями прямо со смартфона.</p>
      </div>
    </div>
  </div>
</section>

{% if not entries %}
  <div class="alert alert-light border">На полке пока нет книг. Найдите книгу в каталоге и добавьте её в полку «{{ shelf.name }}» на странице книги.</div>
{% else %}
  <div class="home-stats-grid mb-5">
    <div class="home-glow-card">
      <h2 class="h6 text-uppercase text-muted mb-3">Всего активных книг</h2>
      <div class="home-stats-primary">{{ summary.total }}</div>
      <p class="small text-muted mb-0">Передано: {{ summary.disposed_total }} {{ summary.disposed_total|ru_pluralize:"книга,книги,книг" }}</p>
    </div>
    <div class="home-glow-card">
      <h2 class="h6 text-uppercase text-muted mb-3">Классика против современности</h2>
      <div class="d-flex gap-4 align-items-end">
        <div>
          <div class="small text-uppercase text-muted">Классика</div>
          <button class="home-stats-button display-6 mb-0 summary-trigger" type="button" data-summary-category="classic" data-summary-title="Классические книги">
            <span class="home-progress-number">{{ summary.classic_count }}</span>
          </button>
        </div>
        <div>
          <div class="small text-uppercase text-muted">Современные</div>
          <button class="home-stats-button display-6 mb-0 text-info summary-trigger" type="button" data-summary-category="modern" data-summary-title="Современные книги">
            <span class="home-progress-number">{{ summary.modern_count }}</span>
          </button>
        </div>
      </div>
    </div>
    <div class="home-glow-card home-progress-card">
      <h2 class="h6 text-uppercase text-muted mb-3">Куплено против прочитано</h2>
      <div class="home-progress-controls mb-3">
        <div class="flex-grow-1">
          <label class="form-label text-uppercase text-muted small" for="homePeriodType">Тип периода</label>
          <select class="form-select form-select-sm" id="homePeriodType" data-role="period-type">
            <option value="year" {% if default_period_type == "year" %}selected{% endif %}>Год</option>
            <option value="month" {% if default_period_type == "month" %}selected{% endif %}>Месяц</option>
          </select>
        </div>
        <div class="flex-grow-1">
          <label class="form-label text-uppercase text-muted small" for="homePeriodValue">Период</label>
          <select class="form-select form-select-sm" id="homePeriodValue" data-role="period-value">
            {% if initial_period_options %}
              {% for option in initial_period_options %}
                <option value="{{ option.value }}" {% if option.value == default_period_value %}selected{% endif %}>{{ option.label }}</option>
              {% endfor %}
            {% else %}
              <option value="" selected>Нет данных</option>
            {% endif %}
          </select>
        </div>
      </div>
      <div class="home-progress-stats">
        <div class="home-progress-side">
          <div class="small text-uppercase text-muted">Куплено</div>
          <button class="home-stats-button home-progress-value summary-trigger" type="button" data-summary-category="period" data-period-kind="bought" data-period-type="{{ default_period_type }}" data-period-value="{{ default_period_value }}" data-summary-title="Куплено">
            <span class="home-progress-number" data-role="period-bought-count">{{ default_period_stats.bought_count }}</span>
          </button>
        </div>
        <div class="home-progress-line">
          <div class="home-progress-fill" data-role="period-progress-fill"></div>
          <div class="home-progress-label" data-role="period-progress-label">0%</div>
        </div>
        <div class="home-progress-side text-end">
          <div class="small text-uppercase text-muted">Прочитано</div>
          <button class="home-stats-button home-progress-value summary-trigger" type="button" data-summary-category="period" data-period-kind="read" data-period-type="{{ default_period_type }}" data-period-value="{{ default_period_value }}" data-summary-title="Прочитано">
            <span class="home-progress-number" data-role="period-read-count">{{ default_period_stats.read_count }}</span>
          </button>
        </div>
      </div>
    </div>
    <div class="home-glow-card">
      <h2 class="h6 text-uppercase text-muted mb-3">Популярные серии</h2>
      {% if summary.series_counts %}
        <ul class="list-unstyled mb-0 small">
          {% for series in summary.series_counts %}
            <li class="d-flex justify-content-between">
              <span>{{ series.series_name }}</span>
              <button class="home-stats-button home-stats-button--compact summary-trigger" type="button" data-summary-category="series" data-summary-key="{{ series.series_name }}" data-summary-title="Серия «{{ series.series_name }}»">
                {{ series.total }}
              </button>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted mb-0">Добавьте серию для экземпляров.</p>
      {% endif %}
    </div>
    <div class="home-glow-card">
      <h2 class="h6 text-uppercase text-muted mb-3">Популярные жанры</h2>
      {% if summary.genre_counts %}
        <ul class="list-unstyled mb-0 small">
          {% for genre in summary.genre_counts %}
            <li class="d-flex justify-content-between">
              <span>{{ genre.name }}</span>
              <button class="home-stats-button home-stats-button--compact summary-trigger" type="button" data-summary-category="genres" data-summary-key="{{ genre.name }}" data-summary-title="Жанр «{{ genre.name }}»">
                {{ genre.total }}
              </button>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted mb-0">Заполните жанры, чтобы увидеть статистику.</p>
      {% endif %}
    </div>
  </div>

  <div class="home-filters-card p-4 mb-5">
    <div class="d-flex align-items-center justify-content-between gap-3 mb-3">
      <h2 class="h6 text-uppercase text-muted mb-0">Фильтры</h2>
      <button class="btn home-filters-toggle d-md-none" type="button" data-bs-toggle="collapse" data-bs-target="#homeLibraryFilters" aria-expanded="false" aria-controls="homeLibraryFilters">
        <i class="bi bi-sliders me-2"></i>Показать фильтры
      </button>
    </div>
    <div id="homeLibraryFilters" class="collapse">
      <form method="get" class="row g-3">
        {% if filter_form.non_field_errors %}
          <div class="col-12">
            <div class="alert alert-danger">{{ filter_form.non_field_errors }}</div>
          </div>
        {% endif %}
        <div class="col-12 col-md-4">
          <label class="form-label" for="id_is_classic">{{ filter_form.is_classic.label }}</label>
          {{ filter_form.is_classic }}
          {{ filter_form.is_classic.errors }}
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label" for="id_series">{{ filter_form.series.label }}</label>
          {{ filter_form.series }}
          {{ filter_form.series.errors }}
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label" for="id_genres">{{ filter_form.genres.label }}</label>
          {{ filter_form.genres }}
          {{ filter_form.genres.errors }}
        </div>
        <div class="col-12 d-flex flex-column flex-md-row gap-2 mt-2">
          <button class="btn btn-primary flex-fill" type="submit">Применить</button>
          {% if filters_applied %}
            <a class="btn btn-outline-secondary flex-fill flex-md-grow-0" href="{% url 'shelves:home_library' %}">Сбросить</a>
          {% endif %}
        </div>
      </form>
    </div>
  </div>

  <div class="home-activity mb-5">
    <div class="home-glow-card h-100">
      <h2 class="h6 text-uppercase text-muted mb-3">Последние обновления</h2>
      {% if summary.recent_entries %}
        <ul class="list-unstyled mb-0">
          {% for entry in summary.recent_entries %}
            <li class="mb-3 pb-3 border-bottom border-secondary-subtle">
              <div class="fw-semibold">{{ entry.book.title }}</div>
              <div class="small text-muted">
                {% if entry.book.authors.all %}
                  {{ entry.book.authors.all|join:", " }} ·
                {% endif %}
                {% if entry.acquired_at %}
                  получена {{ entry.acquired_at|date:"d.m.Y" }}
                {% else %}
                  добавлена {{ entry.shelf_item.added_at|date:"d.m.Y" }}
                {% endif %}
                {% if entry.location %}
                  · хранится: {{ entry.location }}
                {% endif %}
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted mb-0">Пока нет активности. Заполните информацию о нескольких книгах.</p>
      {% endif %}
    </div>
    <div class="home-glow-card h-100">
      <h2 class="h6 text-uppercase text-muted mb-3">Статусы экземпляров</h2>
      {% if summary.statuses %}
        <ul class="list-unstyled mb-3">
          {% for status in summary.statuses %}
            <li class="d-flex justify-content-between align-items-center mb-2">
              <span>{{ status.status }}</span>
              <span class="badge text-bg-light">{{ status.total }}</span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted mb-3">Используйте поле «Статус», чтобы отслеживать движение книг.</p>
      {% endif %}
      <div class="border-top border-secondary pt-3">
        <h3 class="h6 text-uppercase text-muted mb-2">Где лежат книги</h3>
        {% if summary.locations %}
          <ul class="list-unstyled mb-0 small">
            {% for loc in summary.locations %}
              <li class="d-flex justify-content-between">
                <span>{{ loc.location }}</span>
                <span class="fw-semibold">{{ loc.total }}</span>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted mb-0 small">Добавьте информацию о хранении, чтобы ничего не потерялось.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="home-library-table mb-4">
    <div class="table-responsive">
      <table class="table align-middle">
        <thead>
          <tr>
            <th>Книга</th>
            <th>Формат</th>
            <th>Статус</th>
            <th>Хранение</th>
            <th>Классика</th>
            <th>Серия</th>
            <th>Жанры</th>
            <th>Приобретена</th>
            <th>Заметки</th>
            <th class="text-end">Действия</th>
          </tr>
        </thead>
        <tbody>
          {% default_shelf_status_map entries request.user as default_status_map %}
          {% if entries %}
            {% for entry in entries %}
              <tr>
                <td data-label="Книга" style="min-width: 200px;">
                  <div class="fw-semibold"><a class="text-decoration-none text-reset" href="{% url 'book_detail' entry.book.pk %}">{{ entry.book.title }}</a></div>
                  <div class="small text-muted">{{ entry.book.authors.all|join:", "|default:"Автор неизвестен" }}</div>
                  {% with status=default_status_map|dict_get:entry.book.pk %}
                    <div class="mt-2">
                      {% if entry.is_read %}
                        <div class="small text-muted fw-semibold">Прочитано{% if entry.date_read %} {{ entry.date_read|date:"d.m.Y" }}{% endif %}</div>
                      {% elif status and status.code == 'read' %}
                        {% with read_date=status.added_at %}
                          <div class="small text-muted fw-semibold">Прочитано{% if read_date %} {{ read_date|date:"d.m.Y" }}{% endif %}</div>
                        {% endwith %}
                      {% elif status and status.code == 'reading' %}
                        <div class="small text-muted fw-semibold">На полке «{{ status.label|default:default_reading_shelf_name|default:'Читаю' }}»</div>
                      {% else %}
                        <form method="post" action="{% url 'shelves:move_book_to_reading' entry.book.pk %}">
                          {% csrf_token %}
                          <input type="hidden" name="next" value="{{ request.get_full_path }}">
                          <button type="submit" class="btn btn-sm btn-outline-primary mt-1">
                            <i class="bi bi-book-half" aria-hidden="true"></i>
                            <span>Начать читать</span>
                          </button>
                        </form>
                      {% endif %}
                    </div>
                  {% endwith %}
                </td>
                <td data-label="Формат">{{ entry.get_format_display }}</td>
                <td data-label="Статус">{{ entry.status|default:"—" }}</td>
                <td data-label="Хранение">
                  {% if entry.location %}
                    {{ entry.location }}<br>
                  {% endif %}
                  {% if entry.shelf_section %}
                    <span class="text-muted small">{{ entry.shelf_section }}</span>
                  {% endif %}
                  {% if not entry.location and not entry.shelf_section %}
                    —
                  {% endif %}
                </td>
                <td data-label="Классика">
                  {% if entry.is_classic %}
                    <span class="badge text-bg-success">Да</span>
                  {% else %}
                    <span class="text-muted">Нет</span>
                  {% endif %}
                </td>
                <td data-label="Серия">{{ entry.series_name|default:"—" }}</td>
                <td data-label="Жанры">
                  {% with entry.custom_genres.all as entry_genres %}
                    {% if entry_genres %}
                      {% for genre in entry_genres %}
                        <span class="tag-chip">{{ genre }}</span>
                      {% endfor %}
                    {% else %}
                      —
                    {% endif %}
                    {% endwith %}
                </td>
                <td data-label="Приобретена">
                  {% if entry.acquired_at %}
                    {{ entry.acquired_at|date:"d.m.Y" }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td data-label="Заметки" style="max-width: 240px; white-space: pre-wrap;">{{ entry.notes|default:"—" }}</td>
                <td data-label="Действия" class="text-end">
                  <div class="btn-group btn-group-sm home-table-actions">
                    <a class="btn btn-outline-secondary" href="{% url 'shelves:home_library_edit' entry.shelf_item_id %}?next={{ request.get_full_path|urlencode }}">
                      <i class="bi bi-pencil"></i>
                    </a>
                    <a class="btn btn-outline-danger" href="{% url 'shelves:remove_book_from_shelf' shelf.id entry.book.id %}?next={{ request.get_full_path|urlencode }}" title="Удалить из полки" aria-label="Удалить книгу">
                      <i class="bi bi-trash"></i>
                    </a>
                  </div>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="10" class="text-center text-muted py-4">По выбранным условиям книги не найдены.</td>
            </tr>
          {% endif %}
          </tbody>
      </table>
    </div>
  </div>

  {% if disposed_entries %}
    <div class="home-glow-card home-disposed-card mt-4">
      <h2 class="h6 text-uppercase text-muted mb-3">Проданные и отданные книги</h2>
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead>
            <tr>
              <th>Книга</th>
              <th>Статус</th>
              <th>Комментарий</th>
              <th>Обновлено</th>
              <th class="text-end">Действия</th>
            </tr>
          </thead>
          <tbody>
            {% default_shelf_status_map disposed_entries request.user as disposed_status_map %}
            {% for entry in disposed_entries %}
            <tr>
              <td data-label="Книга" style="min-width: 200px;">
                  <div class="fw-semibold"><a class="text-decoration-none text-reset" href="{% url 'book_detail' entry.book.pk %}">{{ entry.book.title }}</a></div>
                  <div class="small text-muted">{{ entry.book.authors.all|join:", "|default:"Автор неизвестен" }}</div>
                  {% with status=disposed_status_map|dict_get:entry.book.pk %}
                    {% if entry.is_read %}
                      <div class="small text-muted fw-semibold mt-2">Прочитано{% if entry.date_read %} {{ entry.date_read|date:"d.m.Y" }}{% endif %}</div>
                    {% elif status and status.code == 'read' %}
                      {% with read_date=status.added_at %}
                        <div class="small text-muted fw-semibold mt-2">Прочитано{% if read_date %} {{ read_date|date:"d.m.Y" }}{% endif %}</div>
                      {% endwith %}
                    {% elif status and status.code == 'reading' %}
                      <div class="small text-muted fw-semibold mt-2">На полке «{{ status.label|default:default_reading_shelf_name|default:'Читаю' }}»</div>
                    {% endif %}
                  {% endwith %}
                </td>
                <td data-label="Статус">{{ entry.status|default:"—" }}</td>
                <td data-label="Комментарий" style="max-width: 280px; white-space: pre-wrap;">{{ entry.disposition_note|default:"—" }}</td>
                <td data-label="Обновлено">{{ entry.updated_at|date:"d.m.Y H:i" }}</td>
                <td data-label="Действия" class="text-end">
                  <div class="btn-group btn-group-sm home-table-actions">
                    <a class="btn btn-outline-secondary" href="{% url 'shelves:home_library_edit' entry.shelf_item_id %}?next={{ request.get_full_path|urlencode }}">
                      <i class="bi bi-pencil"></i>
                    </a>
                    <a class="btn btn-outline-danger" href="{% url 'shelves:remove_book_from_shelf' shelf.id entry.book.id %}?next={{ request.get_full_path|urlencode }}" title="Удалить из полки" aria-label="Удалить книгу">
                      <i class="bi bi-trash"></i>
                    </a>
                  </div>
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
      </div>
    </div>
  {% endif %}
{% endif %}
<div class="modal fade home-summary-modal" id="homeLibrarySummaryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" data-role="summary-title">Список книг</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted mb-0" data-role="summary-empty">Для этого раздела пока нет книг.</p>
          <div data-role="summary-list" class="list-group list-group-flush d-none"></div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  {{ summary_data|json_script:"homeLibrarySummaryData" }}
  <script>
    (function () {
      const dataElement = document.getElementById('homeLibrarySummaryData');
      if (!dataElement) {
        return;
      }
      const summaryData = JSON.parse(dataElement.textContent || '{}');
      const modalEl = document.getElementById('homeLibrarySummaryModal');
      if (!modalEl) {
        return;
      }

      const titleEl = modalEl.querySelector('[data-role="summary-title"]');
      const listWrapper = modalEl.querySelector('[data-role="summary-list"]');
      const emptyEl = modalEl.querySelector('[data-role="summary-empty"]');
      let modalInstance = null;

      function ensureModal() {
        if (!modalInstance && window.bootstrap && window.bootstrap.Modal) {
          modalInstance = new window.bootstrap.Modal(modalEl);
        }
        return modalInstance;
      }

      function renderBooks(items) {
        if (!Array.isArray(items) || !items.length) {
          listWrapper.innerHTML = '';
          listWrapper.classList.add('d-none');
          emptyEl.classList.remove('d-none');
          emptyEl.textContent = 'Для этого раздела пока нет книг.';
          return;
        }
        const fragment = document.createDocumentFragment();
        items.forEach((book) => {
          const item = document.createElement('div');
          item.className = 'list-group-item home-summary-item';
          const link = document.createElement('a');
          link.href = book.url;
          link.textContent = book.title;
          const subtitle = document.createElement('div');
          subtitle.className = 'text-muted small mt-1';
          subtitle.textContent = book.authors || 'Автор неизвестен';
          item.appendChild(link);
          item.appendChild(subtitle);
          fragment.appendChild(item);
        });
        listWrapper.innerHTML = '';
        listWrapper.appendChild(fragment);
        emptyEl.classList.add('d-none');
        listWrapper.classList.remove('d-none');
      }

      function openModal(title, items) {
        titleEl.textContent = title || 'Список книг';
        renderBooks(items);
        const modal = ensureModal();
        if (modal) {
          modal.show();
        }
      }

      function getSummaryItems(trigger) {
        const category = trigger.dataset.summaryCategory;
        if (!category) {
          return [];
        }
        if (category === 'classic' || category === 'modern') {
          return summaryData[category] || [];
        }
        if (category === 'series' || category === 'genres' || category === 'locations' || category === 'statuses') {
          const key = trigger.dataset.summaryKey;
          const bucket = summaryData[category] || {};
          return key ? bucket[key] || [] : [];
        }
        if (category === 'period') {
          const kind = trigger.dataset.periodKind;
          const type = trigger.dataset.periodType;
          const value = trigger.dataset.periodValue;
          if (!kind || !type) {
            return [];
          }
          const periods = summaryData.periods || {};
          const typeBucket = periods[type] || {};
          const stats = typeBucket[value] || {};
          if (kind === 'bought') {
            return stats.bought_books || [];
          }
          if (kind === 'read') {
            return stats.read_books || [];
          }
          return [];
        }
        return [];
      }

      function getPeriodOptions(type) {
        const options = summaryData.periodOptions || {};
        return options[type] || [];
      }

      function getPeriodLabel(type, value) {
        const options = getPeriodOptions(type);
        const found = options.find((option) => option.value === value);
        return found ? found.label : '';
      }

      const triggers = document.querySelectorAll('[data-summary-trigger]');
      triggers.forEach((trigger) => {
        trigger.addEventListener('click', () => {
          const title = trigger.dataset.summaryTitle || trigger.textContent.trim();
          const items = getSummaryItems(trigger);
          openModal(title, items);
        });
      });

      const periodTypeSelect = document.querySelector('[data-role="period-type"]');
      const periodValueSelect = document.querySelector('[data-role="period-value"]');
      const boughtCountEl = document.querySelector('[data-role="period-bought-count"]');
      const readCountEl = document.querySelector('[data-role="period-read-count"]');
      const progressFillEl = document.querySelector('[data-role="period-progress-fill"]');
      const progressLabelEl = document.querySelector('[data-role="period-progress-label"]');

      function updatePeriodTriggers(type, value, label) {
        document.querySelectorAll('[data-summary-category="period"]').forEach((trigger) => {
          trigger.dataset.periodType = type;
          trigger.dataset.periodValue = value || '';
          const kind = trigger.dataset.periodKind;
          if (label && kind) {
            const prefix = kind === 'bought' ? 'Куплено — ' : 'Прочитано — ';
            trigger.dataset.summaryTitle = prefix + label;
          } else if (kind) {
            trigger.dataset.summaryTitle = kind === 'bought' ? 'Куплено' : 'Прочитано';
          }
        });
      }

      function updatePeriodCard() {
        if (!periodTypeSelect || !periodValueSelect || !boughtCountEl || !readCountEl) {
          return;
        }
        const type = periodTypeSelect.value || 'year';
        const options = getPeriodOptions(type);
        if (!options.length) {
          periodValueSelect.innerHTML = '<option value="">Нет данных</option>';
          periodValueSelect.disabled = true;
          boughtCountEl.textContent = '0';
          readCountEl.textContent = '0';
          if (progressFillEl) {
            progressFillEl.style.setProperty('--home-progress-split', '50%');
          }
          if (progressLabelEl) {
            progressLabelEl.textContent = '0% / 0%';
          }
          updatePeriodTriggers(type, '', '');
          return;
        }
        periodValueSelect.disabled = false;
        const currentValue = periodValueSelect.value;
        if (!options.some((option) => option.value === currentValue)) {
          periodValueSelect.value = options[0].value;
        }
        const value = periodValueSelect.value || options[0].value;
        if (value !== periodValueSelect.value) {
          periodValueSelect.value = value;
        }
        const periods = summaryData.periods || {};
        const stats = (periods[type] && periods[type][value]) || {};
        const boughtCount = stats.bought_count || 0;
        const readCount = stats.read_count || 0;
        boughtCountEl.textContent = boughtCount;
        readCountEl.textContent = readCount;
        const total = boughtCount + readCount;
        const boughtPercent = total ? Math.round((boughtCount / total) * 100) : 0;
        const readPercent = total ? 100 - boughtPercent : 0;
        if (progressFillEl) {
          progressFillEl.style.setProperty('--home-progress-split', `${boughtPercent}%`);
        }
        if (progressLabelEl) {
          progressLabelEl.textContent = `${boughtPercent}% / ${readPercent}%`;
        }
        const label = getPeriodLabel(type, value);
        updatePeriodTriggers(type, value, label);
      }

      function populatePeriodOptions(type) {
        if (!periodValueSelect) {
          return;
        }
        const options = getPeriodOptions(type);
        periodValueSelect.innerHTML = '';
        if (!options.length) {
          const optionEl = document.createElement('option');
          optionEl.value = '';
          optionEl.textContent = 'Нет данных';
          optionEl.selected = true;
          periodValueSelect.appendChild(optionEl);
          periodValueSelect.disabled = true;
          updatePeriodCard();
          return;
        }
        let hasSelected = false;
        options.forEach((option) => {
          const optionEl = document.createElement('option');
          optionEl.value = option.value;
          optionEl.textContent = option.label;
          if (summaryData.defaultPeriod && summaryData.defaultPeriod.type === type && summaryData.defaultPeriod.value === option.value) {
            optionEl.selected = true;
            hasSelected = true;
          }
          periodValueSelect.appendChild(optionEl);
        });
        if (!hasSelected && periodValueSelect.options.length) {
          periodValueSelect.options[0].selected = true;
        }
        periodValueSelect.disabled = false;
      }

      if (periodTypeSelect) {
        periodTypeSelect.addEventListener('change', () => {
          populatePeriodOptions(periodTypeSelect.value || 'year');
          updatePeriodCard();
        });
      }

      if (periodValueSelect) {
        periodValueSelect.addEventListener('change', updatePeriodCard);
      }

      if (periodTypeSelect) {
        populatePeriodOptions(periodTypeSelect.value || 'year');
      }
      updatePeriodCard();
    })();
  </script>
{% endblock %}