{% load shelf_extras %}
{% with return_path=next_url|default:request.get_full_path %}
<style>
  .shelf-page__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    gap: 1rem;
  }

  .shelf-page__title {
    margin: 0;
  }

  .shelf-card {
    background: var(--bs-body-bg);
    border-radius: 1rem;
    border: 1px solid rgba(0, 0, 0, 0.05);
    box-shadow: 0 0.75rem 1.5rem rgba(33, 37, 41, 0.08);
    overflow: hidden;
  }

  .shelf-card + .shelf-card {
    margin-top: 1.5rem;
  }

  .shelf-card__header {
    padding: 1.25rem 1.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
  }

  .shelf-card__title {
    margin: 0;
    font-weight: 600;
  }

  .shelf-card__badges {
    display: inline-flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .shelf-card__body {
    position: relative;
    padding: 2.5rem 1.75rem 2rem;
    background: linear-gradient(160deg, rgba(241, 225, 206, 0.35), rgba(214, 197, 178, 0.55));
  }

  .shelf-card__body::after {
    content: "";
    position: absolute;
    left: 1.25rem;
    right: 1.25rem;
    bottom: 1.25rem;
    height: 0.85rem;
    border-radius: 999px;
    background: linear-gradient(90deg, #9c6b3f, #c58d54, #9c6b3f);
    box-shadow: 0 0.45rem 1.2rem rgba(108, 63, 28, 0.4);
  }

  .book-shelf {
    display: flex;
    gap: 1.5rem;
    overflow-x: auto;
    padding-bottom: 2.5rem;
    scroll-snap-type: x mandatory;
  }

  .book-shelf::-webkit-scrollbar {
    height: 8px;
  }

  .book-shelf::-webkit-scrollbar-thumb {
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 999px;
  }

  .book-item {
    position: relative;
    width: 120px;
    flex: 0 0 auto;
    text-align: center;
    scroll-snap-align: start;
  }

  .book-cover {
    display: block;
    width: 120px;
    height: 180px;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 1.25rem 1.75rem rgba(33, 37, 41, 0.18);
    border: 3px solid rgba(255, 255, 255, 0.5);
    background: linear-gradient(130deg, rgba(255, 255, 255, 0.6), rgba(255, 255, 255, 0.2));
  }

  .book-cover img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .book-cover__placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(160deg, #4f46e5, #818cf8);
    color: white;
    font-size: 2.5rem;
    font-weight: 700;
  }

  .book-title {
    margin-top: 0.75rem;
    font-size: 0.9rem;
    font-weight: 600;
    line-height: 1.3;
  }

  .book-author {
    font-size: 0.75rem;
    color: rgba(33, 37, 41, 0.6);
  }

  .book-remove {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    opacity: 0;
    transform: translateY(-0.25rem);
    transition: all 0.2s ease;
  }

  .book-item:hover .book-remove {
    opacity: 1;
    transform: translateY(0);
  }

  .shelf-empty {
    padding: 2rem;
    text-align: center;
    color: rgba(33, 37, 41, 0.6);
    font-style: italic;
  }

  @media (max-width: 575.98px) {
    .book-item {
      width: 96px;
    }

    .book-cover {
      width: 96px;
      height: 150px;
    }

    .shelf-card__body {
      padding: 2rem 1.25rem 1.75rem;
    }

    .shelf-card__body::after {
      left: 1rem;
      right: 1rem;
      bottom: 1rem;
    }
  }
</style>

{% for shelf in shelves %}
  {% with shelf.items.all as shelf_books %}
  <section class="shelf-card">
    <div class="shelf-card__header">
      <div>
        <h2 class="h6 shelf-card__title mb-0">{{ shelf.name }}</h2>
        {% with shelf_books|length as shelf_count %}
          <div class="small text-muted">{{ shelf_count }} {{ shelf_count|ru_pluralize:"книга,книги,книг" }}</div>
        {% endwith %}
      </div>
      <div class="shelf-card__badges">
        {% if shelf.is_default %}
          <span class="badge text-bg-light"><i class="bi bi-stars me-1"></i>системная</span>
        {% endif %}
        {% if not shelf.is_public %}
          <span class="badge text-bg-secondary"><i class="bi bi-lock-fill me-1"></i>приватная</span>
        {% else %}
          <span class="badge text-bg-success"><i class="bi bi-people-fill me-1"></i>публичная</span>
        {% endif %}
      </div>
    </div>

    {% with shelf_books|length as shelf_count %}
      {% if shelf_count %}
        <div class="shelf-card__body">
          <div class="book-shelf">
            {% for it in shelf_books %}
              <div class="book-item">
                <a class="book-cover" href="{% url 'book_detail' it.book.pk %}">
                  {% if it.book.cover %}
                    <img src="{{ it.book.cover.url }}" alt="Обложка {{ it.book.title }}">
                  {% else %}
                    <div class="book-cover__placeholder">{{ it.book.title|default_if_none:"?"|slice:":1"|upper }}</div>
                  {% endif %}
                </a>
                {% if allow_manage %}
                  <div class="book-remove">
                    <a class="btn btn-sm btn-danger"
                       href="{% url 'remove_book_from_shelf' shelf.id it.book.id %}{% if return_path %}?next={{ return_path|urlencode }}{% endif %}"
                       aria-label="Удалить {{ it.book.title }} с полки {{ shelf.name }}"
                       title="Удалить с полки">
                      <i class="bi bi-trash"></i>
                    </a>
                  </div>
                {% endif %}
                <div class="book-title">{{ it.book.title }}</div>
                <div class="book-author">{{ it.book.authors.all|join:", "|default:"Автор неизвестен" }}</div>
              </div>
            {% endfor %}
          </div>
        </div>
      {% else %}
        <div class="shelf-empty">Пока нет книг. Добавьте первую книгу на эту полку!</div>
      {% endif %}
    {% endwith %}
  </section>
  {% endwith %}
{% empty %}
  <div class="alert alert-light border">{{ empty_message|default:"Пока нет полок." }}</div>
{% endfor %}
{% endwith %}