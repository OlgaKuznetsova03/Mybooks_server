{% extends "base.html" %}
{% load role_filters shelf_extras %}

{% block title %}Профиль {{ u.username }}{% endblock %}

{% block content %}

<div class="d-flex flex-column flex-md-row gap-4 align-items-start">
  <!-- Аватар -->
  <div>
    {% if u.profile.avatar %}
      <img src="{{ u.profile.avatar.url }}"
           class="rounded-circle shadow-sm"
           style="width:140px;height:140px;object-fit:cover"
           alt="Аватар {{ u.username }}">
    {% else %}
      <div class="rounded-circle bg-secondary-subtle d-flex align-items-center justify-content-center shadow-sm"
           style="width:140px;height:140px">
        <span class="text-muted small">Нет аватара</span>
      </div>
    {% endif %}
  </div>

  <!-- Основная информация -->
  <div class="flex-grow-1">
    <h1 class="h4 mb-1">@{{ u.username }}</h1>
    {% if u.get_full_name %}
      <div class="text-muted mb-2">{{ u.get_full_name }}</div>
    {% endif %}

    <!-- Роли -->
    <div class="mt-2 mb-3">
      {% for g in u.groups.all %}
        <span class="badge text-bg-light me-1">{{ g.name|role_display }}</span>
      {% empty %}
        <span class="badge text-bg-light">Без роли</span>
      {% endfor %}
    </div>

    <!-- Био и сайт -->
    <div class="mb-3">
      <p class="mb-1">{{ u.profile.bio|default:"Пока без описания." }}</p>
      {% if u.profile.website %}
        <p class="mb-0">
          <i class="bi bi-link-45deg"></i>
          <a href="{{ u.profile.website }}" target="_blank" rel="noopener">{{ u.profile.website }}</a>
        </p>
      {% endif %}
    </div>

    <!-- Кнопки действий -->
    <div class="d-flex gap-2">
      {% if request.user == u %}
        <a class="btn btn-outline-primary btn-sm" href="{% url 'profile_edit' %}">
          <i class="bi bi-pencil me-1"></i>Редактировать
        </a>
      {% endif %}
      <a class="btn btn-outline-secondary btn-sm" href="{% url 'book_list' %}">
        К книгам
      </a>
    </div>
  </div>
</div>

<!-- Вкладки -->
 {% with current_tab=active_tab|default:"overview" %}
<ul class="nav nav-tabs mt-4" id="profileTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link{% if current_tab == 'overview' %} active{% endif %}" id="overview-tab" data-bs-toggle="tab"
            data-bs-target="#overview" type="button" role="tab" aria-selected="{% if current_tab == 'overview' %}true{% else %}false{% endif %}">
      Обзор
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link{% if current_tab == 'stats' %} active{% endif %}" id="stats-tab" data-bs-toggle="tab"
            data-bs-target="#stats" type="button" role="tab" aria-selected="{% if current_tab == 'stats' %}true{% else %}false{% endif %}">
      Статистика
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link{% if current_tab == 'books' %} active{% endif %}" id="books-tab" data-bs-toggle="tab"
            data-bs-target="#books" type="button" role="tab" aria-selected="{% if current_tab == 'books' %}true{% else %}false{% endif %}">
      Мои книги
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link{% if current_tab == 'reviews' %} active{% endif %}" id="reviews-tab" data-bs-toggle="tab"
            data-bs-target="#reviews" type="button" role="tab" aria-selected="{% if current_tab == 'reviews' %}true{% else %}false{% endif %}">
      Обзоры
    </button>
  </li>
</ul>

<div class="tab-content mt-3" id="profileTabsContent">
  <!-- Обзор -->
  <div class="tab-pane fade{% if current_tab == 'overview' %} show active{% endif %}" id="overview" role="tabpanel">
    <p class="text-muted">Здесь отображается основная информация пользователя.</p>

    <!-- Соцсети блогера -->
    {% if is_blogger %}
      <hr>
      <h5>Мои соцсети</h5>
      <ul class="list-unstyled">
        {% if u.profile.link1 %}<li><a href="{{ u.profile.link1 }}" target="_blank" rel="noopener">{{ u.profile.link1 }}</a></li>{% endif %}
        {% if u.profile.link2 %}<li><a href="{{ u.profile.link2 }}" target="_blank" rel="noopener">{{ u.profile.link2 }}</a></li>{% endif %}
        {% if u.profile.link3 %}<li><a href="{{ u.profile.link3 }}" target="_blank" rel="noopener">{{ u.profile.link3 }}</a></li>{% endif %}
        {% if u.profile.link4 %}<li><a href="{{ u.profile.link4 }}" target="_blank" rel="noopener">{{ u.profile.link4 }}</a></li>{% endif %}
      </ul>
    {% endif %}

    <div class="shelf-page__header mt-4">
      <h2 class="h5 shelf-page__title mb-0">Книжные полки</h2>
      {% if request.user == u %}
        <a class="btn btn-outline-primary btn-sm" href="{% url 'shelf_create' %}">
          <i class="bi bi-plus-lg me-1"></i>Добавить полку
        </a>
      {% endif %}
    </div>
    {% include "shelves/_shelf_cards.html" with shelves=user_shelves allow_manage=allow_shelf_management empty_message=allow_shelf_management|yesno:"У вас пока нет полок.,Пока нет полок.,Пока нет полок." next_url=request.get_full_path %}
  </div>

  <!-- Статистика -->
  <div class="tab-pane fade{% if current_tab == 'stats' %} show active{% endif %}" id="stats" role="tabpanel">
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
          <input type="hidden" name="tab" value="stats">
          <div class="col-12 col-md-4">
            <label class="form-label" for="id_period">Период</label>
            <select class="form-select" id="id_period" name="period">
              <option value="week"{% if stats_period.period == 'week' %} selected{% endif %}>Последние 7 дней</option>
              <option value="month"{% if stats_period.period == 'month' %} selected{% endif %}>Месяц</option>
              <option value="year"{% if stats_period.period == 'year' %} selected{% endif %}>Год</option>
            </select>
          </div>
          {% if stats_period.available_years %}
            <div class="col-6 col-md-4">
              <label class="form-label" for="id_year">Год</label>
              <select class="form-select" id="id_year" name="year">
                {% for year in stats_period.available_years %}
                  <option value="{{ year }}"{% if year == stats_period.selected_year %} selected{% endif %}>{{ year }}</option>
                {% endfor %}
              </select>
            </div>
          {% endif %}
          {% if stats_period.period == 'month' and stats_period.available_months %}
            <div class="col-6 col-md-4">
              <label class="form-label" for="id_month">Месяц</label>
              <select class="form-select" id="id_month" name="month">
                {% for month_value, month_name in stats_period.available_months %}
                  <option value="{{ month_value }}"{% if month_value == stats_period.selected_month %} selected{% endif %}>{{ month_name }}</option>
                {% endfor %}
              </select>
            </div>
          {% endif %}
          <div class="col-12 col-md-auto">
            <button type="submit" class="btn btn-primary">Показать</button>
          </div>
        </form>
      </div>
    </div>

    <p class="text-muted">Период: {{ stats_period.label }} ({{ stats_period.start|date:"d.m.Y" }} — {{ stats_period.end|date:"d.m.Y" }})</p>

    <div class="row g-3 mb-4">
      <div class="col-12 col-md-4">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <h3 class="h6 mb-2">Прочитано страниц</h3>
            <p class="display-6 mb-0">{{ stats.pages_total }}</p>
            {% if stats.pages_average %}
              <p class="text-muted mb-0">В среднем {{ stats.pages_average }} стр./день</p>
            {% else %}
              <p class="text-muted mb-0">Нет данных о страницах в выбранный период.</p>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="col-12 col-md-4">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <h3 class="h6 mb-2">Аудиокниги</h3>
            {% if stats.audio_total_display %}
              <p class="mb-1">Общая длительность: <strong>{{ stats.audio_total_display }}</strong></p>
              <p class="text-muted mb-0">С учётом скорости: {{ stats.audio_adjusted_display }}</p>
            {% else %}
              <p class="text-muted mb-0">Аудиокниги в этот период не учитывались.</p>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="col-12 col-md-4">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <h3 class="h6 mb-2">Жанры</h3>
            {% if stats.genre_labels %}
              <div class="ratio ratio-1x1">
                <canvas id="genreChart"></canvas>
              </div>
            {% else %}
              <p class="text-muted mb-0">Пока нет данных для диаграммы.</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    {% with home=stats.home_library %}
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
          <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mb-3">
            <div>
              <h3 class="h6 mb-1">Домашняя библиотека</h3>
              <p class="text-muted mb-0">Отражает книги на полке «Моя домашняя библиотека».</p>
            </div>
            <a class="btn btn-outline-primary btn-sm" href="{% url 'home_library' %}">
              <i class="bi bi-box-seam me-1"></i>Открыть полку
            </a>
          </div>
          {% if home.total %}
            <div class="row g-3">
              <div class="col-12 col-md-3">
                <div class="border rounded-3 p-3 h-100 bg-body-tertiary">
                  <p class="text-muted text-uppercase small mb-1">Всего экземпляров</p>
                  <p class="fs-3 fw-semibold mb-1">{{ home.total }}</p>
                  <p class="small text-muted mb-0">{{ home.gift_count }} {{ home.gift_count|ru_pluralize:"подарок,подарка,подарков" }}</p>
                </div>
              </div>
              <div class="col-12 col-md-3">
                <div class="border rounded-3 p-3 h-100 bg-body-tertiary">
                  <p class="text-muted text-uppercase small mb-1">Оценочная стоимость</p>
                  {% if home.estimated_value %}
                    <p class="fs-3 fw-semibold mb-1">{{ home.estimated_value }} ₽</p>
                    <p class="small text-muted mb-0">Сумма по заполненным ценам.</p>
                  {% else %}
                    <p class="text-muted mb-0">Укажите стоимость книг, чтобы увидеть оценку коллекции.</p>
                  {% endif %}
                </div>
              </div>
              <div class="col-12 col-md-3">
                <div class="border rounded-3 p-3 h-100 bg-body-tertiary">
                  <p class="text-muted text-uppercase small mb-2">Популярные форматы</p>
                  {% if home.format_counts %}
                    <ul class="list-unstyled mb-0 small">
                      {% for fmt in home.format_counts %}
                        <li class="d-flex justify-content-between">
                          <span>{{ fmt.label }}</span>
                          <span class="fw-semibold">{{ fmt.count }}</span>
                        </li>
                      {% endfor %}
                    </ul>
                  {% else %}
                    <p class="text-muted mb-0 small">Пока нет данных.</p>
                  {% endif %}
                </div>
              </div>
              <div class="col-12 col-md-3">
                <div class="border rounded-3 p-3 h-100 bg-body-tertiary">
                  <p class="text-muted text-uppercase small mb-2">Где хранятся</p>
                  {% if home.top_locations %}
                    <ul class="list-unstyled mb-0 small">
                      {% for loc in home.top_locations %}
                        <li class="d-flex justify-content-between">
                          <span>{{ loc.location }}</span>
                          <span class="fw-semibold">{{ loc.total }}</span>
                        </li>
                      {% endfor %}
                    </ul>
                  {% else %}
                    <p class="text-muted mb-0 small">Заполните поле «Где хранится».</p>
                  {% endif %}
                </div>
              </div>
            </div>
            {% if home.top_statuses %}
              <div class="mt-4">
                <h4 class="h6 mb-2">Статусы экземпляров</h4>
                <div class="d-flex flex-wrap gap-2">
                  {% for status in home.top_statuses %}
                    <span class="badge text-bg-light">{{ status.status }} — {{ status.total }}</span>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
          {% else %}
            <p class="text-muted mb-0">Добавьте книги в полку «Моя домашняя библиотека», чтобы отслеживать их состояние.</p>
          {% endif %}
        </div>
      </div>
    {% endwith %}


    <div class="mb-4">
      <h3 class="h6 mb-3">Прочитанные книги</h3>
      {% if stats.books %}
        <div class="row g-3">
          {% for entry in stats.books %}
            <div class="col-6 col-md-4 col-lg-3">
              <div class="card h-100 border-0 shadow-sm">
                {% if entry.cover_url %}
                  <img src="{{ entry.cover_url }}" class="card-img-top" style="height:180px;object-fit:cover" alt="Обложка книги {{ entry.book.title }}">
                {% else %}
                  <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height:180px;">
                    <span class="text-muted small">Нет обложки</span>
                  </div>
                {% endif %}
                <div class="card-body d-flex flex-column">
                  <h6 class="card-title mb-1">
                    <a class="text-decoration-none" href="{% url 'book_detail' entry.book.pk %}">{{ entry.book.title }}</a>
                  </h6>
                  <p class="small text-muted flex-grow-1 mb-2">{{ entry.format|default:"Формат не выбран" }}</p>
                  {% if entry.has_review %}
                    <a class="btn btn-outline-primary btn-sm mt-auto" href="{{ entry.review_url }}">Читать отзыв</a>
                  {% elif request.user == u %}
                    <a class="btn btn-primary btn-sm mt-auto" href="{{ entry.review_url }}">Написать отзыв</a>
                  {% else %}
                    <span class="badge text-bg-light mt-auto align-self-start">Отзыв ещё не написан</span>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-muted mb-0">За выбранный период прочитанных книг нет.</p>
      {% endif %}
    </div>

    {% if stats.genre_labels %}
      {{ stats.genre_labels|json_script:"genre-chart-labels" }}
      {{ stats.genre_values|json_script:"genre-chart-values" }}
      <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" crossorigin="anonymous"></script>
      <script>
        (function () {
          const labelsEl = document.getElementById('genre-chart-labels');
          const valuesEl = document.getElementById('genre-chart-values');
          const canvas = document.getElementById('genreChart');
          if (!labelsEl || !valuesEl || !canvas || typeof Chart === 'undefined') {
            return;
          }
          const labels = JSON.parse(labelsEl.textContent);
          const values = JSON.parse(valuesEl.textContent);
          const palette = labels.map((_, index) => {
            const hue = (index * 57) % 360;
            return `hsl(${hue}, 70%, 55%)`;
          });
          new Chart(canvas.getContext('2d'), {
            type: 'doughnut',
            data: {
              labels,
              datasets: [{
                data: values,
                backgroundColor: palette,
                borderColor: '#ffffff',
                borderWidth: 2,
              }],
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: 'bottom',
                },
              },
            },
          });
        })();
      </script>
    {% endif %}
  </div>

  <!-- Мои книги -->
  <div class="tab-pane fade{% if current_tab == 'books' %} show active{% endif %}" id="books" role="tabpanel">
    <p>Если пользователь автор — здесь появится список его книг.</p>
  </div>

  <!-- Обзоры -->
  <div class="tab-pane fade{% if current_tab == 'reviews' %} show active{% endif %}" id="reviews" role="tabpanel">
    {% if user_reviews %}
      <div class="d-flex flex-column gap-3">
        {% for review in user_reviews %}
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <div class="d-flex flex-column flex-md-row gap-3 align-items-start">
                <div id="review-print-{{ review.id }}" class="flex-grow-1">
                  <div class="d-flex flex-wrap align-items-baseline gap-2 mb-1">
                    <h3 class="h6 mb-0">
                      <a class="text-decoration-none" href="{% url 'book_detail' review.book.pk %}">{{ review.book.title }}</a>
                    </h3>
                    {% with authors=review.book.authors.all %}
                      {% if authors %}
                        <span class="text-muted small">{{ authors|join:", " }}</span>
                      {% endif %}
                    {% endwith %}
                    {% if review.score %}
                      <span class="badge text-bg-warning ms-md-auto">{{ review.score }} / 10</span>
                    {% endif %}
                  </div>
                  <div class="small text-muted mb-2">Опубликован {{ review.created_at|date:"d.m.Y H:i" }}</div>
                  {% with category_scores=review.get_category_scores %}
                    {% if category_scores %}
                      <ul class="list-inline small text-muted mb-2">
                        {% for label, value in category_scores %}
                          <li class="list-inline-item me-3">{{ label }}: <strong>{{ value }}</strong></li>
                        {% endfor %}
                      </ul>
                    {% endif %}
                  {% endwith %}
                  {% if review.review %}
                    <div class="mt-2">{{ review.review|linebreaksbr }}</div>
                  {% endif %}
                </div>
                <div class="ms-md-auto">
                  <button type="button" class="btn btn-outline-secondary btn-sm" onclick="printReview('review-print-{{ review.id }}')">
                    <i class="bi bi-printer me-1"></i>Распечатать
                  </button>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="alert alert-light border mb-0">Пока нет написанных отзывов.</div>
    {% endif %}
  </div>
</div>
{% endwith %}

{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script>
    (function () {
      if (window.printReview) {
        return;
      }
      window.printReview = function (elementId) {
        const sourceEl = document.getElementById(elementId);
        if (!sourceEl) {
          return;
        }
        const printWindow = window.open('', '', 'width=900,height=650');
        if (!printWindow) {
          return;
        }
        const doc = printWindow.document;
        doc.write('<!doctype html><html lang="ru"><head><title>Печать отзыва</title>');
        document.querySelectorAll('link[rel="stylesheet"]').forEach((link) => {
          doc.write(link.outerHTML);
        });
        doc.write('<style>body{margin:1.5rem;font-family:system-ui,-apple-system,"Segoe UI",sans-serif;}</style>');
        doc.write('</head><body>');
        doc.write(sourceEl.innerHTML);
        doc.write('</body></html>');
        doc.close();
        printWindow.focus();
        setTimeout(() => {
          printWindow.print();
        }, 200);
        if (printWindow.addEventListener) {
          printWindow.addEventListener('afterprint', () => {
            printWindow.close();
          }, { once: true });
        }
      };
    })();
  </script>
{% endblock %}