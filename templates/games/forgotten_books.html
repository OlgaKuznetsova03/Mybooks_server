{% extends "base.html" %}
{% load static %}
{% block title %}{{ game.title }} ‚Äî –∏–≥—Ä—ã{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'games/forgotten-books.css' %}">
{% endblock %}
{% block content %}
<section class="forgotten-books-hero card border-0 shadow-sm mb-4">
  <div class="card-body">
    <div class="d-flex flex-column flex-lg-row gap-4 align-items-start justify-content-between">
      <div>
        <h1 class="fb-hero-heading mb-2">{{ game.title }}</h1>
        <p class="fb-hero-description mb-0">{{ game.description }}</p>
      </div>
      <div class="ms-lg-auto text-lg-end">
        {% if remaining_slots %}
          <div class="small text-white-50">–û—Å—Ç–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å {{ remaining_slots }} –∫–Ω–∏–≥ –¥–æ –ø–æ–ª–Ω–æ–≥–æ –Ω–∞–±–æ—Ä–∞.</div>
        {% else %}
          <div class="small text-white-50">–ü–æ–ª–∫–∞ —Å–æ–±—Ä–∞–Ω–∞! –ö–∞–∂–¥—ã–π –º–µ—Å—è—Ü –ø–æ—è–≤–∏—Ç—Å—è –Ω–æ–≤–∞—è –∫–Ω–∏–≥–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è.</div>
        {% endif %}
      </div>
    </div>
    <div class="fb-hero-stats">
      <div class="fb-hero-stat">
        <span class="label">–î–æ–±–∞–≤–ª–µ–Ω–æ –∫–Ω–∏–≥</span>
        <span class="value">{{ added_books_count }}</span>
        <span class="small">–∏–∑ {{ max_books }}</span>
      </div>
      <div class="fb-hero-stat">
        <span class="label">–û—Å—Ç–∞–ª–æ—Å—å –≤—ã–±—Ä–∞—Ç—å</span>
        <span class="value">{{ remaining_slots }}</span>
        <span class="small">–≤ –æ–∂–∏–¥–∞–Ω–∏–∏ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è</span>
      </div>
      <div class="fb-hero-stat">
        <span class="label">–¢–µ–∫—É—â–∞—è –∫–Ω–∏–≥–∞</span>
        <span class="value fs-5">{% if selection %}{{ selection.entry.book.title }}{% else %}–í –æ–∂–∏–¥–∞–Ω–∏–∏{% endif %}</span>
        {% if selection %}
          <span class="small">–¥–æ {{ selection.deadline|date:"d E" }}</span>
        {% else %}
          <span class="small">–ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –∫–æ–º–ø–ª–µ–∫—Ç–∞</span>
        {% endif %}
      </div>
    </div>
    <div class="fb-progress">
      <div class="fb-progress-bar" style="width: {% widthratio added_books_count max_books 100 %}%"></div>
    </div>
  </div>
  </section>

<section class="fb-shelf card shadow-sm border-0 mb-4">
  <div class="card-body">
    <div class="fb-shelf-header">
      <h2>–ü–æ–ª–∫–∞ –∑–∞–±—ã—Ç—ã—Ö –∫–Ω–∏–≥</h2>
      <span class="badge rounded-pill text-bg-light text-dark-emphasis">–í –æ–∂–∏–¥–∞–Ω–∏–∏: {{ pending_entries|length }}</span>
    </div>
    <div class="mt-3">
      {% if pending_entries %}
        <div class="fb-shelf-list">
          {% for entry in pending_entries %}
          <article class="fb-book-card">
            <div class="fb-book-cover">
              <form method="post" class="fb-remove-form">
                {% csrf_token %}
                <input type="hidden" name="action" value="remove">
                <input type="hidden" name="entry_id" value="{{ entry.id }}">
                <button class="btn btn-light btn-sm" type="submit" title="–£–±—Ä–∞—Ç—å —Å –ø–æ–ª–∫–∏" aria-label="–£–±—Ä–∞—Ç—å ¬´{{ entry.book.title }}¬ª">
                  <i class="bi bi-x-lg"></i>
                </button>
              </form>
              {% with cover_url=entry.book.get_cover_url %}
                {% if cover_url %}
                  <img src="{{ cover_url }}" alt="–û–±–ª–æ–∂–∫–∞ ¬´{{ entry.book.title }}¬ª">
                {% else %}
                  <div class="fb-book-placeholder" aria-hidden="true">üìñ</div>
                {% endif %}
              {% endwith %}
            </div>
            <div class="fb-book-meta">
              <div class="title">{{ entry.book.title }}</div>
              <div class="date">–î–æ–±–∞–≤–ª–µ–Ω–∞ {{ entry.added_at|date:"d.m.Y" }}</div>
            </div>
          </article>
          {% endfor %}
        </div>
        <p class="small text-muted mt-3 mb-0">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –ø—Ä–æ–ª–∏—Å—Ç—ã–≤–∞–π—Ç–µ –ø–æ–ª–∫—É –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–Ω–∏–≥–∏.</p>
      {% else %}
        <p class="text-muted mb-0">–ü–æ–∫–∞ –Ω–∞ –ø–æ–ª–∫–µ –ø—É—Å—Ç–æ ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –∫–Ω–∏–≥–∏ –∏–∑ –¥–æ–º–∞—à–Ω–µ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏, —á—Ç–æ–±—ã –≤–¥–æ—Ö–Ω—É—Ç—å –≤ –Ω–∏—Ö –Ω–æ–≤—É—é –∂–∏–∑–Ω—å.</p>
      {% endif %}
    </div>
  </div>
</section>

<div class="row g-4">
  <div class="col-lg-5 order-lg-1 order-2">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <h2 class="h5 mb-3">–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É –≤ —á–µ–ª–ª–µ–Ω–¥–∂</h2>
        {% if remaining_slots %}
        <p class="small text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ç–æ–º—è—Ç—Å—è –Ω–∞ –ø–æ–ª–∫–µ ¬´–î–æ–º–∞—à–Ω—è—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞¬ª. –í—Å–µ–≥–æ –Ω—É–∂–Ω–æ {{ max_books }} –∫–Ω–∏–≥ ‚Äî –≤—ã —É–∂–µ –±–ª–∏–∂–µ, —á–µ–º –∫–∞–∂–µ—Ç—Å—è!</p>
          <form method="post" class="vstack gap-3">
            {% csrf_token %}
            <input type="hidden" name="action" value="add">
            <div>
              {{ add_form.book.label_tag }}
              {{ add_form.book }}
              {% if add_form.book.errors %}
                <div class="invalid-feedback d-block">{{ add_form.book.errors|join:", " }}</div>
              {% endif %}
            </div>
            <button class="btn btn-primary" type="submit">
              <i class="bi bi-plus-lg me-1"></i>–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –ø–æ–ª–∫—É
            </button>
          </form>
        {% else %}
          <div class="alert alert-success mb-0">
            –í—ã —Å–æ–±—Ä–∞–ª–∏ –≤—Å–µ {{ max_books }} –∫–Ω–∏–≥. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –Ω–æ–≤—ã–º–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è–º–∏ –∫–∞–∂–¥—ã–π –º–µ—Å—è—Ü!
          </div>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-lg-7 order-lg-2 order-1">
    <div class="fb-current-month card shadow-sm border-0 mb-4">
      <div class="card-body">
        <h2 class="h5 mb-3">–ö–Ω–∏–≥–∞ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞</h2>
        {% if selection %}
          {% with entry=selection.entry %}
          <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center gap-4">
            <div class="flex-grow-1">
              <div class="fb-book-title">{{ entry.book.title }}</div>
              <div class="fb-current-meta mt-2">
                <span><i class="bi bi-calendar-week me-1"></i>–°—Ç–∞—Ä—Ç {{ selection.month_start|date:"d E Y" }}</span>
                <span><i class="bi bi-flag me-1"></i>–î–µ–¥–ª–∞–π–Ω {{ selection.deadline|date:"d E" }}</span>
              </div>
            </div>
            <div class="text-md-end">
              <div class="fb-current-status {% if entry.is_completed %}fb-current-status--success{% elif entry.review_submitted_at %}fb-current-status--warning{% endif %}">
                {% if entry.is_completed %}
                  <i class="bi bi-stars"></i> –û—Ç–∑—ã–≤ –≥–æ—Ç–æ–≤
                {% elif entry.review_submitted_at %}
                  <i class="bi bi-chat-square-text"></i> –ñ–¥—ë—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                {% else %}
                  <i class="bi bi-bookmark-heart"></i> –í –ø—Ä–æ—Ü–µ—Å—Å–µ —á—Ç–µ–Ω–∏—è
                {% endif %}
              </div>
              {% if entry.review_submitted_at %}
              <div class="small text-muted mt-2">–û—Ç–∑—ã–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω {{ entry.review_submitted_at|date:"d.m.Y" }}</div>
              {% endif %}
              {% if entry.finished_at %}
                <div class="small text-muted">–ü—Ä–æ—á–∏—Ç–∞–Ω–∞ {{ entry.finished_at|date:"d.m.Y" }}</div>
              {% endif %}
            </div>
          </div>
          {% if not entry.finished_at and not entry.review_submitted_at %}
            <p class="text-muted small mb-0 mt-3">–û—Ç–º–µ—á–∞–π—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –¥–µ–ª–∏—Ç–µ—Å—å –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è–º–∏ –ø—Ä—è–º–æ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –∫–Ω–∏–≥–∏.</p>
          {% endif %}
          {% endwith %}
        {% else %}
          <p class="text-muted mb-0">–ö–∞–∫ —Ç–æ–ª—å–∫–æ –≤—ã –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–∫—É –∏–∑ {{ max_books }} –∫–Ω–∏–≥, –≤ –Ω–∞—á–∞–ª–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–µ—Å—è—Ü–∞ –ø–æ—è–≤–∏—Ç—Å—è –ø–µ—Ä–≤–∞—è –∫–Ω–∏–≥–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è.</p>
        {% endif %}
      </div>
    </div>
    <div class="card shadow-sm border-0 fb-history-table">
      <div class="card-body">
        <h2 class="h5 mb-3">–ò—Å—Ç–æ—Ä–∏—è –≤—ã–±–æ—Ä–æ–≤</h2>
        {% if selected_entries %}
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead>
              <tr>
                <th scope="col">–ú–µ—Å—è—Ü</th>
                <th scope="col">–ö–Ω–∏–≥–∞</th>
                <th scope="col" class="text-center">–°—Ç–∞—Ç—É—Å</th>
              </tr>
            </thead>
            <tbody>
              {% for entry in selected_entries %}
              <tr class="{% if entry.is_completed %}table-success{% elif entry.review_submitted_at %}table-warning{% endif %}">
                <td>
                  {% if entry.selected_month %}
                    {{ entry.selected_month|date:"F Y" }}<br>
                    <small class="text-muted">–¥–æ {{ entry.get_deadline|date:"d.m" }}</small>
                  {% else %}
                    ‚Äî
                  {% endif %}
                </td>
                <td>{{ entry.book.title }}</td>
                <td class="text-center">
                  {% if entry.is_completed %}
                    <span class="badge text-bg-success">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
                  {% elif entry.review_submitted_at %}
                    <span class="badge text-bg-warning">–ñ–¥—ë—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</span>
                  {% else %}
                    <span class="badge text-bg-secondary">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
          <p class="text-muted mb-0">–ó–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è –∫–Ω–∏–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –ø–æ–±—ã–≤–∞–ª–∏ –≤ –µ–∂–µ–º–µ—Å—è—á–Ω–æ–º —Ñ–æ–∫—É—Å–µ.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
