{% extends "base.html" %}
{% load static %}
{% block title %}{{ game.title }} — игры{% endblock %}
{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'games/game-pages.css' %}">
{% endblock %}
{% block content %}
<section class="game-hero card border-0 shadow-sm mb-4">
  <div class="card-body">
    <div class="d-flex flex-column flex-lg-row gap-4 align-items-start justify-content-between">
      <div>
        <h1 class="game-hero-heading mb-2">{{ game.title }}</h1>
        <p class="game-hero-description mb-0">{{ game.description }}</p>
      </div>
      <div class="ms-lg-auto text-lg-end game-hero-meta">
        <div class="small text-white-50 text-uppercase mb-1">Стоимость новой книги</div>
        <div class="fs-4 fw-semibold">{{ purchase_cost }} баллов</div>
        {% if shelf_count %}
          <div class="small text-white-50">Подключено полок: {{ shelf_count }}</div>
        {% else %}
          <div class="small text-white-50">Подключите «Домашнюю библиотеку», чтобы начать.</div>
        {% endif %}
        <div class="game-hero-actions mt-3">
          <a class="btn btn-journey-outline btn-sm" href="#enroll-form">
            <i class="bi bi-plus-lg me-1"></i>Подключить полку
          </a>
          <a class="btn btn-journey-soft btn-sm" href="{% url 'games:book_journey_map' %}">
            <i class="bi bi-map me-1"></i>Литературное путешествие
          </a>
        </div>
      </div>
    </div>
    <div class="game-hero-stats">
      <div class="game-hero-stat">
        <span class="label">Баланс</span>
        <span class="value">{{ overall.points_balance }}</span>
        <span class="hint">Накопленные баллы</span>
      </div>
      <div class="game-hero-stat">
        <span class="label">Отзывы</span>
        <span class="value">{{ overall.books_reviewed }}</span>
        <span class="hint">Прочитанные и оценённые книги</span>
      </div>
      <div class="game-hero-stat">
        <span class="label">Покупки</span>
        <span class="value">{{ overall.books_purchased }}</span>
        <span class="hint">Книги, купленные за баллы</span>
      </div>
      <div class="game-hero-stat">
        <span class="label">На полках</span>
        <span class="value">{{ overall.total_books }}</span>
        <span class="hint">Истории в «Домашней библиотеке»</span>
      </div>
    </div>
    <div
      class="game-progress"
      role="progressbar"
      aria-valuenow="{{ overall.progress_percent }}"
      aria-valuemin="0"
      aria-valuemax="100"
      aria-label="Прогресс до следующей покупки"
    >
      <div class="game-progress-bar" style="width: {{ overall.progress_percent }}%;"></div>
    </div>
    <div class="small text-white-50 mt-2">
      {% if overall.available_purchases %}
        Можно приобрести {{ overall.available_purchases }} книг за накопленные баллы.
      {% elif overall.next_purchase_points %}
        Осталось {{ overall.next_purchase_points }} баллов до следующей покупки.
      {% else %}
        Подключите полку, чтобы начать получать баллы за отзывы.
      {% endif %}
    </div>
  </div>
</section>

<section class="card border-0 game-promo mb-4">
  <div class="card-body d-flex flex-wrap gap-3 align-items-center justify-content-between">
    <div>
      <div class="fw-semibold text-uppercase small text-muted">Новое приключение</div>
      <div class="h5 mb-1">«Литературное путешествие»</div>
      <p class="small mb-0">Исследуйте карту с 15 этапами: подбирайте книги, отмечайте прогресс и открывайте новые острова.</p>
    </div>
    <a class="btn btn-journey-outline btn-sm" href="{% url 'games:book_journey_map' %}">
      <i class="bi bi-compass me-1"></i>Открыть карту
    </a>
  </div>
</section>

<div class="row g-4">
  <div class="col-xl-4">
    <section id="enroll-form" class="card read-before-buy-card h-100">
      <div class="card-body">
        <div class="game-panel-title">Подключить полку «Домашняя библиотека»</div>
        <p class="small text-muted mb-3">Баллы начисляются за отзывы о книгах на выбранной полке.</p>
        {% if enroll_form.fields.shelf.queryset %}
      <form method="post" class="vstack gap-3">
          {% csrf_token %}
          <input type="hidden" name="action" value="enroll">
          <div>
            {{ enroll_form.shelf.label_tag }}
            {{ enroll_form.shelf }}
            {% if enroll_form.shelf.errors %}
              <div class="invalid-feedback d-block">{{ enroll_form.shelf.errors|join:", " }}</div>
            {% endif %}
          </div>
          <button class="btn btn-primary" type="submit">
            <i class="bi bi-plus-lg me-1"></i>Добавить полку
          </button>
        </form>
        {% else %}
          <div class="game-hint p-3 small mb-0" role="status">
            <strong>Полка уже подключена.</strong>
            Добавляйте новые книги и продолжайте зарабатывать баллы.
          </div>
        {% endif %}
      </div>
    </section>
  </div>
  <div class="col-xl-8">
    {% if states %}
      <div class="read-before-buy-grid">
        {% for item in states %}
          {% with state=item.state %}
          <article class="card read-before-buy-card shelf-card">
              <div class="card-body">
                <div class="d-flex justify-content-between flex-wrap gap-3 align-items-start">
                  <div>
                    <div class="game-panel-title mb-1">{{ state.shelf.name }}</div>
                    <div class="small text-muted">Баланс: {{ state.points_balance }} · Всего заработано: {{ state.total_points_earned }}</div>
                  </div>
                  <div class="text-end">
                    {% if item.points_needed > 0 %}
                      <span class="badge rounded-pill text-bg-warning">До покупки: {{ item.points_needed }}</span>
                    {% else %}
                      <span class="badge rounded-pill text-bg-success">Можно купить книгу!</span>
                    {% endif %}
                    <div class="small text-muted mt-1">Цена книги: {{ purchase_cost }}</div>
                  </div>
                </div>
                <div class="shelf-card__meta mt-4">
                  <div>
                    <div class="value">{{ item.total_books }}</div>
                    <div class="small text-muted">Книг на полке</div>
                  </div>
                  <div>
                    <div class="value">{{ state.books_reviewed }}</div>
                    <div class="small text-muted">Написано отзывов</div>
                  </div>
                  <div>
                    <div class="value">{{ state.books_purchased }}</div>
                    <div class="small text-muted">Куплено книг</div>
                  </div>
                  <div>
                    <div class="value">{{ item.available_purchases }}</div>
                    <div class="small text-muted">Доступных покупок</div>
                  </div>
                </div>
                <div
                  class="game-progress"
                  role="progressbar"
                  aria-valuenow="{{ item.progress_percent }}"
                  aria-valuemin="0"
                  aria-valuemax="100"
                  aria-label="Прогресс до покупки книги"
                >
                  <div class="game-progress-bar" style="width: {{ item.progress_percent }}%;"></div>
                </div>
                <div class="small text-muted mt-2">
                  {% if item.points_needed > 0 %}
                    Осталось {{ item.points_needed }} баллов до следующей покупки.
                  {% else %}
                    Баллов достаточно, чтобы выбрать новую книгу.
                  {% endif %}
                </div>
                <form method="post" class="shelf-card__actions mt-4">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="bulk_purchase">
                  <input type="hidden" name="state_id" value="{{ state.id }}">
                  <div class="input-group input-group-sm" style="max-width: 240px;">
                    <span class="input-group-text">Куплено книг</span>
                    <input
                      type="number"
                      name="count"
                      min="1"
                      value="1"
                      class="form-control"
                      {% if item.available_purchases %}max="{{ item.available_purchases }}"{% else %}disabled{% endif %}
                    >
                  </div>
                  <button class="btn btn-sm btn-outline-primary" type="submit" {% if not item.available_purchases %}disabled{% endif %}>
                    <i class="bi bi-bag-check me-1"></i>Списать баллы
                  </button>
                  {% if not item.available_purchases %}
                    <div class="small text-muted">Недостаточно баллов для покупки.</div>
                  {% endif %}
                </form>
                {% if state.purchases.all %}
                  <div class="shelf-card__list">
                    <div class="shelf-card__list-title">Последние покупки</div>
                    <ul class="list-unstyled mb-0 small">
                      {% for purchase in state.purchases.all|slice:":3" %}
                        <li class="mb-1">
                          {% if purchase.book %}
                            {{ purchase.book.title }}
                          {% else %}
                            Покупка без указания книги
                          {% endif %}
                          — {{ purchase.points_spent }} баллов ({{ purchase.created_at|date:"d.m.Y" }})
                        </li>
                      {% endfor %}
                    </ul>
                  </div>
                {% endif %}
              </div>
              </article>
          {% endwith %}
        {% endfor %}
      </div>
    {% else %}
      <section class="card game-empty-card">
        <div class="card-body">
          <p class="mb-2">Вы ещё не подключили «Домашнюю библиотеку» к игре.</p>
          <p class="mb-0">Добавьте полку и начните получать баллы за прочитанные книги и отзывы, чтобы покупать новые истории.</p>
        </div>
      </section>
    {% endif %}
  </div>
</div>
{% endblock %}