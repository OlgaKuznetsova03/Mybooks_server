{% extends "base.html" %}
{% block title %}{{ game.title }} — игры{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-4">
  <div>
    <h1 class="h4 mb-1">{{ game.title }}</h1>
    <p class="text-muted mb-0">{{ game.description }}</p>
  </div>
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="fw-semibold text-uppercase text-muted small">Сводка</div>
      <div class="fs-4 fw-semibold">{{ overall.points_balance }} баллов</div>
      <div class="small text-muted">Прочитано книг: {{ overall.books_reviewed }} · Куплено: {{ overall.books_purchased }}</div>
      <div class="small text-muted">Книг на полках: {{ overall.total_books }}</div>
    </div>
  </div>
</div>

<div class="row g-4">
  <div class="col-lg-4">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <h2 class="h6 mb-3">Подключить полку</h2>
        {% if enroll_form.fields.shelf.queryset %}
        <form method="post" class="vstack gap-3">
          {% csrf_token %}
          <input type="hidden" name="action" value="enroll">
          <div>
            {{ enroll_form.shelf.label_tag }}
            {{ enroll_form.shelf }}
            {% if enroll_form.shelf.errors %}
              <div class="invalid-feedback d-block">{{ enroll_form.shelf.errors|join:", " }}</div>
            {% endif %}
          </div>
          <button class="btn btn-primary" type="submit">
            <i class="bi bi-plus-lg me-1"></i>Добавить
          </button>
        </form>
        {% else %}
          <p class="text-muted mb-0">Все ваши полки уже участвуют в игре. Создайте новую полку или освободите одну из текущих.</p>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-lg-8">
    {% if states %}
      <div class="vstack gap-3">
        {% for item in states %}
          {% with state=item.state %}
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between flex-wrap gap-3 align-items-start">
                <div>
                  <h3 class="h6 mb-1">{{ state.shelf.name }}</h3>
                  <div class="text-muted small">Баланс: {{ state.points_balance }} · Всего заработано: {{ state.total_points_earned }}</div>
                </div>
                <div class="text-end">
                  {% if item.points_needed > 0 %}
                    <div class="badge text-bg-warning">До покупки: {{ item.points_needed }}</div>
                  {% else %}
                    <div class="badge text-bg-success">Можно купить книгу!</div>
                  {% endif %}
                  <div class="small text-muted">Цена новой книги: {{ purchase_cost }}</div>
                </div>
              </div>
              <hr>
              <div class="row text-center g-3">
                <div class="col-sm-3">
                  <div class="fw-semibold">{{ item.total_books }}</div>
                  <div class="small text-muted">Книг на полке</div>
                </div>
                <div class="col-sm-3">
                  <div class="fw-semibold">{{ state.books_reviewed }}</div>
                  <div class="small text-muted">Написано отзывов</div>
                </div>
                <div class="col-sm-3">
                  <div class="fw-semibold">{{ state.books_purchased }}</div>
                  <div class="small text-muted">Куплено книг</div>
                </div>
                <div class="col-sm-3">
                  <div class="fw-semibold">{{ item.available_purchases }}</div>
                  <div class="small text-muted">Доступных покупок</div>
                </div>
              </div>
              <form method="post" class="mt-3 d-flex flex-wrap gap-2 align-items-center">
                {% csrf_token %}
                <input type="hidden" name="action" value="bulk_purchase">
                <input type="hidden" name="state_id" value="{{ state.id }}">
                <div class="input-group input-group-sm" style="max-width: 220px;">
                  <span class="input-group-text">Куплено книг</span>
                  <input type="number" name="count" min="1" value="1" class="form-control" {% if item.available_purchases %}max="{{ item.available_purchases }}"{% else %}disabled{% endif %}>
                </div>
                <button class="btn btn-sm btn-outline-primary" type="submit" {% if not item.available_purchases %}disabled{% endif %}>
                  <i class="bi bi-bag-check me-1"></i>Списать баллы
                </button>
                {% if not item.available_purchases %}
                  <div class="small text-muted">Недостаточно баллов для покупки.</div>
                {% endif %}
              </form>
              {% if state.purchases.all %}
              <div class="mt-3">
                <div class="small text-muted text-uppercase">Последние покупки</div>
                <ul class="list-unstyled mb-0 small">
                  {% for purchase in state.purchases.all|slice:":3" %}
                    <li>
                      {% if purchase.book %}
                        {{ purchase.book.title }}
                      {% else %}
                        Покупка без указания книги
                      {% endif %}
                      — {{ purchase.points_spent }} баллов ({{ purchase.created_at|date:"d.m.Y" }})
                    </li>
                  {% endfor %}
                </ul>
              </div>
              {% endif %}
            </div>
          </div>
          {% endwith %}
        {% endfor %}
      </div>
    {% else %}
      <div class="card shadow-sm">
        <div class="card-body text-center text-muted py-5">
          <p class="mb-2">Вы ещё не подключили ни одну полку к игре.</p>
          <p class="mb-0">Создайте новую полку со своими книгами или используйте «Хочу прочитать», чтобы начать.</p>
        </div>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}