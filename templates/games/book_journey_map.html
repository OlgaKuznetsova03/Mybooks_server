{% extends "base.html" %}
{% load static %}
{% block title %}{{ map_title }} — интерактивная карта{% endblock %}
{% block content %}
<div class="row g-4 align-items-start">
  <div class="col-lg-7">
    <section class="card shadow-sm border-0 overflow-hidden journey-map">
      <div class="card-header bg-body-tertiary border-bottom">
        <h1 class="h5 mb-1">{{ map_title }}</h1>
        <p class="text-muted mb-0">{{ map_description }}</p>
      </div>
      <div class="journey-map__canvas position-relative">
        <img
          src="{% static 'games/book-journey-map.png' %}
          alt="Карты с островами Гюго, Чехова, Шекспира, Достоевского и Кафки"
          class="journey-map__image"
        >
          {% for stage in stages %}
          <button
            type="button"
            class="journey-map__marker terrain-{{ stage.terrain }} journey-map__marker--{{ stage.status }}"
            style="top: {{ stage.top }}%; left: {{ stage.left }}%;"
            data-stage="{{ stage.number }}"
            aria-label="Этап #{{ stage.number }}: {{ stage.title }}"
            data-bs-toggle="offcanvas"
            data-bs-target="#journey-stage-panel"
          >
            <span class="journey-map__marker-index">{{ stage.number }}</span>
          </button>
        {% endfor %}
      </div>
      <div class="card-footer bg-white">
        <div class="d-flex flex-wrap gap-3 align-items-center justify-content-between">
          <div class="fw-semibold small text-uppercase text-muted">Легенда</div>
          <div class="d-flex flex-wrap gap-2 align-items-center">
            {% for key, item in terrain_legend %}
              <span class="badge rounded-pill journey-map__legend-badge terrain-{{ key }}">{{ item.label }}</span>
            {% endfor %}
          </div>
        </div>
        <ul class="list-unstyled small text-muted mb-0 mt-2">
          {% for key, item in terrain_legend %}
            <li><span class="fw-semibold">{{ item.label }}:</span> {{ item.hint }}</li>
          {% endfor %}
        </ul>
      </div>
    </section>
  </div>
  <div class="col-lg-5">
    <section class="card shadow-sm border-0">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
          <div>
            <h2 class="h6 mb-1">Как играть</h2>
            <p class="small text-muted mb-0">Всего {{ stage_count }} заданий — исследуйте острова в своём темпе.</p>
          </div>
          <a class="btn btn-outline-primary btn-sm" href="{% url 'games:read_before_buy' %}">
            <i class="bi bi-controller me-1"></i>К другим играм
          </a>
        </div>
        <ol class="ps-3 small">
          {% for item in checklist %}
            <li class="mb-2">{{ item }}</li>
          {% endfor %}
        </ol>
        {% if not is_authenticated %}
          <div class="alert alert-info small" role="status">
            <div class="fw-semibold">Войдите, чтобы прикреплять книги</div>
            <p class="mb-0">После авторизации вы сможете выбирать задания и отслеживать прогресс прямо с карты.</p>
          </div>
        {% elif active_stage_number %}
          <div class="alert alert-primary small mb-0" role="status">
            <div class="fw-semibold">Активный этап</div>
            <p class="mb-0">Сейчас в работе этап #{{ active_stage_number }}. Завершите его, чтобы открыть следующий.</p>
          </div>
        {% endif %}
      </div>
    </section>
    <section class="card shadow-sm border-0 mt-4">
      <div class="card-header bg-body-tertiary border-bottom d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">Этапы путешествия</h2>
        <span class="badge text-bg-light">{{ stage_count }} заданий</span>
      </div>
      <div class="card-body p-0">
        <div class="list-group list-group-flush journey-stage-list">
          {% for stage in stages %}
            <button
              type="button"
              class="list-group-item list-group-item-action d-flex justify-content-between align-items-start gap-3 journey-stage-list__item"
              data-stage="{{ stage.number }}"
              data-bs-toggle="offcanvas"
              data-bs-target="#journey-stage-panel"
            >
              <div class="text-start">
                <div class="fw-semibold">#{{ stage.number }} · {{ stage.title }}</div>
                <div class="small text-muted">{{ stage.requirement }}</div>
                {% if stage.assignment %}
                  <div class="small mt-1">
                    <i class="bi bi-book me-1 text-primary"></i>
                    <span class="text-body-secondary">{{ stage.assignment.book_title }}</span>
                  </div>
                {% endif %}
              </div>
              <span class="badge rounded-pill journey-stage-list__status journey-stage-list__status--{{ stage.status }}">
                {% if stage.status == 'completed' %}
                  Выполнено
                {% elif stage.status == 'in_progress' %}
                  В процессе
                {% else %}
                  Свободно
                {% endif %}
              </span>
            </button>
          {% endfor %}
        </div>
      </div>
    </section>
  </div>
</div>

<div
  class="offcanvas offcanvas-end journey-stage-panel"
  tabindex="-1"
  id="journey-stage-panel"
  aria-labelledby="journey-stage-panel-title"
>
  <div class="offcanvas-header border-bottom">
    <div>
      <div class="small text-uppercase text-muted mb-1">Этап <span id="journey-stage-number"></span></div>
      <h2 class="h5 mb-0" id="journey-stage-panel-title"></h2>
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Закрыть"></button>
  </div>
  <div class="offcanvas-body">
    <p class="text-muted" id="journey-stage-requirement"></p>
    <p id="journey-stage-description" class="mb-4"></p>
    <div class="mb-4">
      <div class="small text-uppercase text-muted fw-semibold mb-1">Статус</div>
      <div class="d-flex align-items-center gap-2">
        <span class="badge journey-stage-panel__status" id="journey-stage-status"></span>
        <span class="small" id="journey-stage-status-hint"></span>
      </div>
    </div>
    <div id="journey-stage-assignment" class="mb-4 d-none">
      <div class="card border-0 bg-body-tertiary">
        <div class="card-body">
          <div class="d-flex flex-column gap-2">
            <div>
              <div class="small text-muted">Выбранная книга</div>
              <div class="fw-semibold" id="journey-stage-book"></div>
            </div>
            <div class="small text-muted" id="journey-stage-progress"></div>
            <div class="d-flex flex-wrap gap-2" id="journey-stage-links"></div>
          </div>
        </div>
      </div>
    </div>
    {% if is_authenticated and assignment_form %}
      <form method="post" class="journey-stage-panel__form" id="journey-stage-assign-form" novalidate>
        {% csrf_token %}
        <input type="hidden" name="action" value="assign">
        {{ assignment_form.stage_number }}
        {% if not assignment_form.fields.book.queryset %}
          <div class="alert alert-warning small" role="status">
            Добавьте книги на свои полки, чтобы прикреплять их к заданиям на карте.
          </div>
        {% endif %}
        <div class="mb-3">
          <label class="form-label" for="id_book">{{ assignment_form.book.label }}</label>
          {{ assignment_form.book }}
          {% if assignment_form.book.errors %}
            <div class="invalid-feedback d-block">
              {{ assignment_form.book.errors|striptags }}
            </div>
          {% endif %}
        </div>
        {% if assignment_form.non_field_errors %}
          <div class="alert alert-danger py-2 small">{{ assignment_form.non_field_errors|striptags }}</div>
        {% endif %}
        <button type="submit" class="btn btn-primary w-100">Прикрепить книгу</button>
      </form>
      <form method="post" class="mt-3 journey-stage-panel__form d-none" id="journey-stage-release-form">
        {% csrf_token %}
        <input type="hidden" name="action" value="release">
        {{ release_form.stage_number }}
        <button type="submit" class="btn btn-outline-secondary w-100">Снять книгу с этапа</button>
      </form>
    {% elif not is_authenticated %}
      <div class="alert alert-info" role="status">
        Войдите в систему, чтобы прикрепить книгу и отслеживать выполнение задания.
      </div>
    {% endif %}
  </div>
</div>

{{ stages|json_script:"journey-stages-data" }}
{% if assignment_stage_value %}
  <script id="journey-stage-prefill" type="application/json">{{ assignment_stage_value }}</script>
{% endif %}
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
  (function () {
    const stageDataNode = document.getElementById('journey-stages-data');
    if (!stageDataNode) {
      return;
    }
    const stages = JSON.parse(stageDataNode.textContent || '[]');
    const stageIndex = new Map(stages.map((stage) => [stage.number, stage]));
    const offcanvasEl = document.getElementById('journey-stage-panel');
    if (!offcanvasEl) {
      return;
    }
    const offcanvas = bootstrap.Offcanvas.getOrCreateInstance(offcanvasEl);
    const statusLabels = {
      available: 'Свободно',
      in_progress: 'В процессе',
      completed: 'Выполнено',
    };
    const statusHints = {
      available: 'Можно выбрать любую подходящую книгу.',
      in_progress: 'Книга прикреплена — завершите чтение и отзыв.',
      completed: 'Задание выполнено: книга прочитана и отзыв опубликован.',
    };

    const numberEl = document.getElementById('journey-stage-number');
    const titleEl = document.getElementById('journey-stage-panel-title');
    const requirementEl = document.getElementById('journey-stage-requirement');
    const descriptionEl = document.getElementById('journey-stage-description');
    const statusBadgeEl = document.getElementById('journey-stage-status');
    const statusHintEl = document.getElementById('journey-stage-status-hint');
    const assignmentWrap = document.getElementById('journey-stage-assignment');
    const bookEl = document.getElementById('journey-stage-book');
    const progressEl = document.getElementById('journey-stage-progress');
    const linksEl = document.getElementById('journey-stage-links');
    const assignForm = document.getElementById('journey-stage-assign-form');
    const releaseForm = document.getElementById('journey-stage-release-form');

    function formatPercent(value) {
      if (value === null || value === undefined) {
        return null;
      }
      const num = Number(value);
      if (Number.isNaN(num)) {
        return null;
      }
      return `${Math.min(100, Math.max(0, num)).toFixed(0)}%`;
    }

    function updateForms(stageNumber, stage) {
      if (!assignForm) {
        return;
      }
      const stageField = assignForm.querySelector('input[name="stage_number"]');
      if (stageField) {
        stageField.value = stageNumber;
      }
      if (releaseForm) {
        const releaseField = releaseForm.querySelector('input[name="stage_number"]');
        if (releaseField) {
          releaseField.value = stageNumber;
        }
        releaseForm.classList.toggle('d-none', !(stage.assignment && stage.status === 'in_progress'));
      }
      assignForm.classList.toggle('d-none', stage.status === 'completed');
    }

    function renderStage(stageNumber) {
      const stage = stageIndex.get(stageNumber);
      if (!stage) {
        return;
      }
      numberEl.textContent = `#${stage.number}`;
      titleEl.textContent = stage.title;
      requirementEl.textContent = stage.requirement;
      descriptionEl.textContent = stage.description;
      const statusKey = stage.status in statusLabels ? stage.status : 'available';
      statusBadgeEl.textContent = statusLabels[statusKey];
      statusBadgeEl.className = 'badge journey-stage-panel__status journey-stage-panel__status--' + statusKey;
      statusHintEl.textContent = statusHints[statusKey] || '';

      if (stage.assignment) {
        assignmentWrap.classList.remove('d-none');
        bookEl.textContent = stage.assignment.book_title;
        const percent = formatPercent(stage.assignment.progress_percent);
        const reviewStatus = stage.assignment.has_review ? 'Отзыв опубликован.' : 'Отзыв ещё не написан.';
        if (percent) {
          progressEl.textContent = `${percent} • ${reviewStatus}`;
        } else {
          progressEl.textContent = reviewStatus;
        }
        linksEl.innerHTML = '';
        const detailLink = document.createElement('a');
        detailLink.className = 'btn btn-outline-primary btn-sm';
        detailLink.href = stage.assignment.detail_url;
        detailLink.textContent = 'О книге';
        linksEl.appendChild(detailLink);
        const readingLink = document.createElement('a');
        readingLink.className = 'btn btn-outline-secondary btn-sm';
        readingLink.href = stage.assignment.reading_url;
        readingLink.textContent = 'Прогресс чтения';
        linksEl.appendChild(readingLink);
        const reviewLink = document.createElement('a');
        reviewLink.className = 'btn btn-outline-success btn-sm';
        reviewLink.href = stage.assignment.review_url;
        reviewLink.textContent = stage.assignment.has_review ? 'Обновить отзыв' : 'Написать отзыв';
        linksEl.appendChild(reviewLink);
      } else {
        assignmentWrap.classList.add('d-none');
      }

      updateForms(stageNumber, stage);
    }

    function attachHandlers(selector) {
      document.querySelectorAll(selector).forEach((element) => {
        element.addEventListener('click', () => {
          const stageNumber = Number(element.dataset.stage);
          renderStage(stageNumber);
        });
        });
    }

    attachHandlers('.journey-map__marker');
    attachHandlers('.journey-stage-list__item');

    const prefillNode = document.getElementById('journey-stage-prefill');
    if (prefillNode && prefillNode.textContent) {
      const stageNumber = Number(prefillNode.textContent);
      if (!Number.isNaN(stageNumber) && stageIndex.has(stageNumber)) {
        renderStage(stageNumber);
        offcanvas.show();
      }
    }

    offcanvasEl.addEventListener('show.bs.offcanvas', (event) => {
      const trigger = event.relatedTarget;
      if (trigger) {
        const stageNumber = Number(trigger.getAttribute('data-stage'));
        if (!Number.isNaN(stageNumber) && stageIndex.has(stageNumber)) {
          renderStage(stageNumber);
        }
      }
    });
  })();
</script>
{% endblock %}